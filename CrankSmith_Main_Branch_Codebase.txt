# CrankSmith v1.1 - Complete Codebase (Main Branch)
# Generated: 2025-01-28T20:07:15Z
# Git Branch: cursor/update-header-and-create-codebase-snapshot-3464
# Git Commit: a0aa59c
# Last Commit: 2025-07-17 20:07:15 +0000
#
# üö¥‚Äç‚ôÇÔ∏è CRANKSMITH - BIKE PERFORMANCE OPTIMIZER
# ‚úÖ Impact site verification meta tag added (8d751d83-117e-4b87-b7c0-253d7bb08754)
# ‚úÖ Updated tracking implementation in pages/_app.js
# ‚úÖ Comprehensive codebase snapshot

# =============================================================================
# PROJECT STRUCTURE & SOURCE CODE
# =============================================================================

### package.json
```
{
  "name": "cranksmith-v2",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "type-check": "tsc --noEmit"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "@supabase/supabase-js": "^2.50.0",
    "@upstash/redis": "^1.35.1",
    "autoprefixer": "^10.4.17",
    "chart.js": "^4.5.0",
    "jspdf": "^3.0.1",
    "next": "^15.3.3",
    "nodemailer": "^7.0.3",
    "postcss": "^8.4.35",
    "react": "^19.1.0",
    "react-dom": "^19.1.0",
    "react-window": "^1.8.11",
    "recharts": "^2.15.3",
    "tailwindcss": "^3.4.1"
  },
  "devDependencies": {
    "@types/node": "^20.10.0",
    "@types/nodemailer": "^6.4.14",
    "@types/react": "^18.2.45",
    "@types/react-dom": "^18.2.18",
    "@types/react-window": "^1.8.8",
    "@typescript-eslint/eslint-plugin": "^8.37.0",
    "@typescript-eslint/parser": "^8.37.0",
    "eslint": "^8.56.0",
    "eslint-config-next": "^14.1.0",
    "eslint-plugin-unused-imports": "^4.1.4",
    "typescript": "^5.8.3"
  }
}
```

### next.config.js
```
/** @type {import('next').NextConfig} */
const nextConfig = {
  // Remove the swcMinify line if it's there
  webpack: (config, { isServer }) => {
    if (isServer) {
      // Exclude service worker from server-side bundling
      config.resolve.alias = {
        ...config.resolve.alias,
        'sw.js': false,
      };
    }
    return config;
  },
};

module.exports = nextConfig;
```

### tailwind.config.js
```
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './pages/**/*.{js,ts,jsx,tsx,mdx}',
    './components/**/*.{js,ts,jsx,tsx,mdx}',
    './app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  darkMode: ['class', '[data-theme="dark"]'],
  theme: {
    extend: {
      colors: {
        brand: {
          orange: 'rgb(var(--brand-orange) / <alpha-value>)',
          yellow: 'rgb(var(--brand-yellow) / <alpha-value>)',
          blue: 'rgb(var(--brand-blue) / <alpha-value>)',
          purple: 'rgb(var(--brand-purple) / <alpha-value>)',
          green: 'rgb(var(--brand-green) / <alpha-value>)',
          red: 'rgb(var(--brand-red) / <alpha-value>)',
        },
        neutral: {
          50: 'rgb(var(--neutral-50) / <alpha-value>)',
          100: 'rgb(var(--neutral-100) / <alpha-value>)',
          200: 'rgb(var(--neutral-200) / <alpha-value>)',
          300: 'rgb(var(--neutral-300) / <alpha-value>)',
          400: 'rgb(var(--neutral-400) / <alpha-value>)',
          500: 'rgb(var(--neutral-500) / <alpha-value>)',
          600: 'rgb(var(--neutral-600) / <alpha-value>)',
          700: 'rgb(var(--neutral-700) / <alpha-value>)',
          800: 'rgb(var(--neutral-800) / <alpha-value>)',
          900: 'rgb(var(--neutral-900) / <alpha-value>)',
          950: 'rgb(var(--neutral-950) / <alpha-value>)',
        },
      },
      fontFamily: {
        sans: ['-apple-system', 'BlinkMacSystemFont', '"SF Pro Display"', '"Segoe UI"', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
        mono: ['"SF Mono"', 'Monaco', 'Consolas', '"Liberation Mono"', '"Courier New"', 'monospace'],
      },
      spacing: {
        '18': '4.5rem',
        '88': '22rem',
        '120': '30rem',
      },
      animation: {
        'fade-in': 'fadeIn 0.5s ease-out',
        'slide-up': 'slideUp 0.3s ease-out',
        'spin-slow': 'spin 3s linear infinite',
        'pulse-slow': 'pulse 3s ease-in-out infinite',
        'bounce-slow': 'bounce 2s infinite',
      },
      borderRadius: {
        '4xl': '2rem',
      },
      boxShadow: {
        'glow-sm': '0 0 10px rgb(var(--brand-blue) / 0.3)',
        'glow-md': '0 0 20px rgb(var(--brand-blue) / 0.4)',
        'glow-lg': '0 0 40px rgb(var(--brand-blue) / 0.5)',
        'inner-lg': 'inset 0 2px 4px 0 rgb(0 0 0 / 0.1)',
      },
      backgroundImage: {
        'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
        'gradient-conic': 'conic-gradient(from 180deg at 50% 50%, var(--tw-gradient-stops))',
        'gradient-performance': 'var(--gradient-performance)',
        'gradient-premium': 'var(--gradient-premium)',
        'gradient-success': 'var(--gradient-success)',
      },
      transitionTimingFunction: {
        'out-expo': 'cubic-bezier(0.16, 1, 0.3, 1)',
      },
    },
  },
  plugins: [
    function({ addUtilities }) {
      const newUtilities = {
        '.text-balance': {
          'text-wrap': 'balance',
        },
        '.animation-delay-100': {
          'animation-delay': '100ms',
        },
        '.animation-delay-200': {
          'animation-delay': '200ms',
        },
        '.animation-delay-300': {
          'animation-delay': '300ms',
        },
        '.animation-delay-500': {
          'animation-delay': '500ms',
        },
        '.animation-delay-1000': {
          'animation-delay': '1000ms',
        },
      }
      addUtilities(newUtilities)
    },
  ],
}
```

### tsconfig.json
```
{
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "es6"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "baseUrl": ".",
    "paths": {
      "@/*": ["./*"]
    },
    "strictNullChecks": true,
    "noImplicitAny": true,
    "noImplicitReturns": true,
    "noImplicitThis": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts"
  ],
  "exclude": [
    "node_modules",
    ".next",
    "out"
  ]
}```

### .eslintrc.json
```
{
  "extends": [
    "next/core-web-vitals"
  ],
  "plugins": [
    "unused-imports"
  ],
  "rules": {
    // Focus on unused imports and variables
    "unused-imports/no-unused-imports": "warn",
    "unused-imports/no-unused-vars": [
      "warn",
      {
        "vars": "all",
        "varsIgnorePattern": "^_",
        "args": "after-used",
        "argsIgnorePattern": "^_"
      }
    ],
    
    // Basic code quality
    "no-unused-vars": "off", // Let unused-imports handle this
    "prefer-const": "warn",
    "no-var": "error",
    
    // Temporarily disable problematic rules blocking the build
    "react/no-unescaped-entities": "off",
    "react-hooks/rules-of-hooks": "warn",
    "@next/next/no-html-link-for-pages": "warn",
    "@next/next/no-img-element": "warn"
  },
  "overrides": [
    {
      "files": ["*.ts", "*.tsx"],
      "extends": ["next/core-web-vitals"],
      "parser": "@typescript-eslint/parser",
      "plugins": ["@typescript-eslint", "unused-imports"],
      "rules": {
        // TypeScript specific rules for .ts/.tsx files only
        "@typescript-eslint/no-unused-vars": "off", // Let unused-imports handle this
        "@typescript-eslint/no-explicit-any": "warn",
        "unused-imports/no-unused-imports": "warn",
        "unused-imports/no-unused-vars": [
          "warn",
          {
            "vars": "all",
            "varsIgnorePattern": "^_",
            "args": "after-used", 
            "argsIgnorePattern": "^_"
          }
        ],
        
        // Disable problematic rules for TypeScript files too
        "react/no-unescaped-entities": "off",
        "react-hooks/rules-of-hooks": "warn"
      }
    }
  ]
}```

### postcss.config.js
```
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}```

### .yarnrc.yml
```
nodeLinker: node-modules
```

### pages/_app.js
```
// pages/_app.js - FIXED VERSION
// Critical Bug Fix: Simplified mobile routing that doesn't confuse users
// Quick Win: Less intrusive mobile detection

import '../styles/globals.css';
import Head from 'next/head';
import Layout from '../components/Layout';
import Script from 'next/script';
import { useEffect } from 'react';
import { useRouter } from 'next/router';
import { registerServiceWorker, handleMobileRouting, isMobileApp } from '../lib/pwa-utils';
import ErrorBoundary from '../components/ErrorBoundary';
import { ToastContainer } from '../components/Toast';

export default function App({ Component, pageProps }) {
  const router = useRouter();

  useEffect(() => {
    // Register service worker for PWA functionality
    registerServiceWorker();
    
    // Handle mobile routing suggestions (non-intrusive)
    handleMobileRouting(router);
  }, [router]);

  // Use different layout for mobile app
  const isMobileAppPage = isMobileApp(router.pathname);
  
  if (isMobileAppPage) {
    return (
      <>
        <Head>
          <title>CrankSmith Mobile</title>
          <meta name="description" content="Mobile bike gear calculator" />
          <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
          <meta name="theme-color" content="#3B82F6" />
          <meta name="mobile-web-app-capable" content="yes" />
          <meta name="apple-mobile-web-app-status-bar-style" content="default" />
          <meta name="apple-mobile-web-app-title" content="CrankSmith" />
          <meta name='impact-site-verification' value='8d751d83-117e-4b87-b7c0-253d7bb08754' />
          <link rel="manifest" href="/manifest.json" />
          <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
        </Head>
        
        {/* Google Analytics */}
        <Script
          src="https://www.googletagmanager.com/gtag/js?id=G-TR57T617HK"
          strategy="afterInteractive"
        />
        <Script id="ga-init" strategy="afterInteractive">
          {`
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-TR57T617HK', {
              page_path: window.location.pathname,
            });
          `}
        </Script>
        
        {/* Mobile App with Error Boundary */}
        <ErrorBoundary context="page">
          <Component {...pageProps} />
        </ErrorBoundary>
      </>
    );
  }

  return (
    <>
      <Head>
        <title>CrankSmith</title>
        <meta name="description" content="Optimize your bike's performance with CrankSmith's gear ratio calculator" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="theme-color" content="#3B82F6" />
        <meta name="mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="default" />
        <meta name="apple-mobile-web-app-title" content="CrankSmith" />
        <meta name='impact-site-verification' value='8d751d83-117e-4b87-b7c0-253d7bb08754' />
        <link rel="manifest" href="/manifest.json" />
        <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
        <link rel="shortcut icon" href="/favicon.ico" />
      </Head>
      
      {/* Google Analytics */}
      <Script
        src="https://www.googletagmanager.com/gtag/js?id=G-TR57T617HK"
        strategy="afterInteractive"
      />
      <Script id="ga-init" strategy="afterInteractive">
        {`
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-TR57T617HK', {
            page_path: window.location.pathname,
          });
        `}
      </Script>
      
      {/* Main App Content with Error Boundary */}
      <ErrorBoundary context="page">
        <Layout>
          <Component {...pageProps} />
        </Layout>
      </ErrorBoundary>
      
      {/* Toast Notifications */}
      <ToastContainer />
    </>
  );
}```

### pages/index.js
```
import { useState, useEffect } from 'react';
import { useRouter } from 'next/router';
import Link from 'next/link';
import Image from 'next/image';
import SEOHead from '../components/SEOHead';

export default function Home() {
  const router = useRouter();
  const [isVisible, setIsVisible] = useState(false);

  useEffect(() => {
    setIsVisible(true);
  }, []);

  const features = [
    {
      icon: '‚öôÔ∏è',
      title: 'Bike Gear Calculator',
      description: 'Professional gear ratio calculator for road, mountain, gravel, and touring bikes. Compare drivetrain components and optimize your bike gearing setup.',
      color: 'from-brand-orange to-brand-yellow'
    },
    {
      icon: 'üö¥‚Äç‚ôÇÔ∏è',
      title: 'Professional Bike Fit Calculator',
      description: 'Calculate optimal saddle height, reach, and stack using LeMond, Holmes, and Hamley bike fitting methods based on your body measurements.',
      color: 'from-purple-500 to-pink-500'
    },
    {
      icon: 'üîß',
      title: 'Cycling Tire Pressure Calculator',
      description: 'Get perfect tire pressure for road, mountain, and gravel bikes based on your weight, terrain, and riding style for optimal performance.',
      color: 'from-brand-blue to-brand-purple'
    },
    {
      icon: 'üìä',
      title: 'Cycling Performance Analysis',
      description: 'Deep insights into cycling speed, cadence, and efficiency across different terrains. Optimize your bike setup for maximum performance.',
      color: 'from-brand-green to-emerald-400'
    }
  ];

  const benefits = [
    {
      icon: 'üí∞',
      title: 'Save Money on Bike Components',
      description: 'Avoid costly mistakes by understanding bike component compatibility and drivetrain matching before you buy cycling gear'
    },
    {
      icon: 'üéØ',
      title: 'Perfect Bike Setup',
      description: 'Get personalized bike recommendations based on your cycling style, body measurements, and performance goals'
    },
    {
      icon: 'üöÄ',
      title: 'Real Cycling Data',
      description: 'Access accurate specifications for thousands of bike components, drivetrains, and cycling equipment from top brands'
    },
    {
      icon: 'ü§ñ',
      title: 'AI Cycling Expert',
      description: 'Get answers to technical bike questions with Riley, your AI cycling and bike mechanic expert assistant'
    }
  ];

  return (
    <>
      <SEOHead
        title="CrankSmith - Professional Bike Gear Calculator, Bike Fit & Cycling Tools"
        description="Free professional bike gear calculator, bike fit calculator, and cycling optimization tools. Calculate gear ratios, drivetrain compatibility, bike fitting, and optimize your road, mountain, gravel, or touring bike setup. Used by cyclists and bike shops worldwide."
        url="https://cranksmith.com"
        image="/og-image.jpg"
        keywords="bike gear calculator, bike fit calculator, gear ratio calculator, cycling gear calculator, bicycle gear ratios, drivetrain compatibility, bike fitting calculator, cycling tools, bike setup calculator, bicycle calculator, bike gearing, cycling optimization, bike mechanics tools, cycling gear optimization, bicycle fitting, bike shop tools"
        structuredData={{
          "@context": "https://schema.org",
          "@type": "WebApplication",
          "name": "CrankSmith",
          "alternateName": ["Bike Gear Calculator", "Cycling Calculator", "Bike Fit Calculator"],
          "description": "Professional bike gear calculator, bike fit calculator, and cycling optimization tools for cyclists and bike shops",
          "url": "https://cranksmith.com",
          "applicationCategory": "Sports & Recreation",
          "operatingSystem": "Web Browser",
          "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
          },
          "featureList": [
            "Bike Gear Ratio Calculator",
            "Drivetrain Compatibility Checker", 
            "Professional Bike Fit Calculator",
            "Tire Pressure Calculator",
            "Cycling Performance Optimization",
            "Multi-Bike Type Support (Road, Mountain, Gravel, Touring)"
          ],
          "audience": [
            {
              "@type": "Audience",
              "audienceType": "Cyclists"
            },
            {
              "@type": "Audience", 
              "audienceType": "Bike Mechanics"
            },
            {
              "@type": "Audience",
              "audienceType": "Bike Shops"
            },
            {
              "@type": "Audience",
              "audienceType": "Cycling Enthusiasts"
            }
          ],
          "creator": {
            "@type": "Organization",
            "name": "CrankSmith",
            "url": "https://cranksmith.com",
            "description": "Professional cycling tools and calculators",
            "sameAs": [
              "https://instagram.com/cranksmithapp"
            ]
          },
          "mainEntity": [
            {
              "@type": "SoftwareApplication",
              "name": "Bike Gear Calculator",
              "description": "Calculate optimal gear ratios for any bike",
              "url": "https://cranksmith.com/calculator"
            },
            {
              "@type": "SoftwareApplication", 
              "name": "Bike Fit Calculator",
              "description": "Professional bike fitting based on body measurements",
              "url": "https://cranksmith.com/bike-fit"
            }
          ],
          "keywords": "bike gear calculator, bike fit calculator, cycling tools, bicycle calculator, gear ratio calculator, bike fitting",
          "inLanguage": "en-US",
          "isAccessibleForFree": true,
          "usageInfo": "Free cycling tools for gear calculation and bike fitting",
          "supportingData": "Professional bike fitting methods and gear ratio calculations"
        }}
      />

      <div className="min-h-screen bg-neutral-50 dark:bg-neutral-950">
        {/* Hero Section */}
        <section className="relative overflow-hidden">
          {/* Background Pattern */}
          <div className="absolute inset-0 opacity-5">
            <div className="absolute inset-0 bg-gradient-to-br from-brand-orange via-brand-yellow to-brand-blue" />
          </div>
          
          <div className="container-responsive py-20 lg:py-32 relative">
            <div className={`max-w-4xl mx-auto text-center transition-all duration-1000 ${
              isVisible ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-8'
            }`}>
              {/* Logo */}
              <div className="flex justify-center mb-8">
                <div className="relative">
                  <div className="absolute inset-0 bg-gradient-performance rounded-3xl blur-2xl opacity-30" />
                  <div className="relative w-20 h-20 bg-white dark:bg-neutral-800 rounded-3xl flex items-center justify-center shadow-2xl p-3">
                    <Image 
                      src="/cranksmith-logo.png" 
                      alt="CrankSmith" 
                      width={56}
                      height={56}
                      className="object-contain"
                    />
                  </div>
                </div>
              </div>

              <h1 className="text-responsive-5xl font-bold text-balance mb-6 text-neutral-900 dark:text-white">
                <span className="text-gradient-performance">Professional</span> Bike Gear Calculator & <span className="text-gradient-premium">Cycling</span> Tools
              </h1>
              
              <p className="text-responsive-xl text-neutral-600 dark:text-neutral-300 max-w-2xl mx-auto mb-8 text-balance">
                Calculate gear ratios, optimize bike fit, check compatibility, and perfect your setup with professional-grade tools trusted by cyclists worldwide.
              </p>

              <div className="flex flex-col sm:flex-row gap-4 justify-center items-center">
                <Link href="/calculator" className="btn-primary">
                  <span>Start Calculating</span>
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" />
                  </svg>
                </Link>
                
                <Link href="/tire-pressure" className="btn-secondary">
                  <span>Tire Pressure Tool</span>
                </Link>
              </div>

              <div className="mt-12 text-sm text-neutral-500 dark:text-neutral-400">
                Free ‚Ä¢ No signup required ‚Ä¢ Works offline
              </div>
            </div>
          </div>
        </section>

        {/* Features Section */}
        <section className="py-20 bg-neutral-100 dark:bg-neutral-900">
          <div className="container-responsive">
            <div className="text-center mb-16">
              <h2 className="text-responsive-3xl font-bold mb-4 text-neutral-900 dark:text-white">
                Professional Tools
              </h2>
              <p className="text-responsive-lg text-neutral-600 dark:text-neutral-300 max-w-2xl mx-auto">
                Everything you need to analyze and optimize your bike setup
              </p>
            </div>

            <div className="grid-responsive">
              {features.map((feature, index) => {
                const getFeatureHref = (title) => {
                  switch (title) {
                    case 'Bike Gear Calculator': return '/calculator';
                    case 'Professional Bike Fit Calculator': return '/bike-fit';
                    case 'Cycling Tire Pressure Calculator': return '/tire-pressure';
                    case 'Cycling Performance Analysis': return '/performance-analysis';
                    case 'AI Cycling Expert': return '/ask-riley';
                    default: return '/calculator';
                  }
                };
                const href = getFeatureHref(feature.title);
                
                return (
                  <Link
                    key={feature.title}
                    href={href}
                    className={`card-premium p-8 text-center hover-lift animation-delay-${index * 100} cursor-pointer`}
                  >
                    <div className={`w-16 h-16 mx-auto mb-6 rounded-2xl bg-gradient-to-br ${feature.color} flex items-center justify-center shadow-lg`}>
                      <span className="text-3xl">{feature.icon}</span>
                    </div>
                    <h3 className="text-xl font-semibold mb-3 text-neutral-900 dark:text-white">
                      {feature.title}
                    </h3>
                    <p className="text-neutral-600 dark:text-neutral-300 leading-relaxed">
                      {feature.description}
                    </p>
                  </Link>
                );
              })}
            </div>
          </div>
        </section>

        {/* Benefits Section */}
        <section className="py-20">
          <div className="container-responsive">
            <div className="text-center mb-16">
              <div className="flex items-center justify-center gap-3 mb-4">
                <div className="w-10 h-10 rounded-xl flex items-center justify-center p-1.5 shadow-lg bg-white dark:bg-neutral-800">
                  <Image 
                    src="/cranksmith-logo.png" 
                    alt="CrankSmith" 
                    width={32}
                    height={32}
                    className="object-contain"
                  />
                </div>
                <h2 className="text-responsive-3xl font-bold text-neutral-900 dark:text-white">
                  Why Choose <span className="bg-gradient-performance bg-clip-text text-transparent">CrankSmith</span>?
                </h2>
              </div>
              <p className="text-responsive-lg text-neutral-600 dark:text-neutral-300 max-w-2xl mx-auto">
                Trusted by cyclists, shops, and professionals worldwide
              </p>
            </div>

            <div className="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
              {benefits.map((benefit, index) => (
                <div
                  key={benefit.title}
                  className={`card-premium p-6 flex items-start gap-4 hover-lift animation-delay-${index * 100}`}
                >
                  <div className="w-12 h-12 rounded-xl bg-gradient-premium flex items-center justify-center text-white text-xl flex-shrink-0">
                    {benefit.icon}
                  </div>
                  <div>
                    <h3 className="text-lg font-semibold mb-2 text-neutral-900 dark:text-white">
                      {benefit.title}
                    </h3>
                    <p className="text-neutral-600 dark:text-neutral-300">
                      {benefit.description}
                    </p>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </section>

        {/* Ask Riley CTA Section */}
        <section className="py-20 bg-gradient-to-br from-neutral-900 to-neutral-800 text-white">
          <div className="container-responsive">
            <div className="max-w-4xl mx-auto text-center">
              <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-gradient-to-br from-brand-blue to-brand-purple flex items-center justify-center">
                <span className="text-4xl">ü§ñ</span>
              </div>
              <h2 className="text-responsive-3xl font-bold mb-4">
                Meet Riley, Your AI Bike Expert
              </h2>
              <p className="text-responsive-lg text-neutral-300 max-w-2xl mx-auto mb-8">
                Get instant answers to your bike questions from Riley, trained on thousands of maintenance manuals and brand support docs. Whether it's upgrades, installations, or compatibility - Riley knows bikes.
              </p>
              <div className="flex flex-col sm:flex-row gap-4 justify-center items-center mb-8">
                <Link href="/ask-riley" className="btn-secondary bg-white text-neutral-900 hover:bg-neutral-100">
                  <span>Ask Riley Now</span>
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                  </svg>
                </Link>
              </div>
              <div className="flex flex-wrap gap-3 justify-center text-sm">
                <span className="px-3 py-1 bg-white/20 rounded-full">Upgrade Questions</span>
                <span className="px-3 py-1 bg-white/20 rounded-full">Installation Guides</span>
                <span className="px-3 py-1 bg-white/20 rounded-full">Compatibility Checks</span>
                <span className="px-3 py-1 bg-white/20 rounded-full">Maintenance Tips</span>
              </div>
            </div>
          </div>
        </section>

        {/* CTA Section */}
        <section className="py-20 bg-gradient-to-br from-brand-blue to-brand-purple">
          <div className="container-responsive text-center">
            <h2 className="text-responsive-3xl font-bold mb-4 text-white">
              Ready to Optimize Your Setup?
            </h2>
            <p className="text-responsive-lg text-blue-100 max-w-2xl mx-auto mb-8">
              Join thousands of cyclists who've already optimized their bike setup with CrankSmith
            </p>
            <Link href="/calculator" className="btn-secondary bg-white text-brand-blue hover:bg-neutral-100">
              Get Started Free
            </Link>
          </div>
        </section>
      </div>
    </>
  );
} ```

### pages/calculator.js
```
// pages/calculator.js - Enhanced calculator with Riley AI integration and compatibility checking
// CORRECTED: Replaced all inline styles with Tailwind classes, converted JS hover effects to CSS, and implemented a React-based toast notification system.
// UPDATED: Removed email verification requirements - free access for all users

import { useState, useEffect } from 'react';
import GearSelectorPanel from '../components/GearSelectorPanel';
import SimulationResults from '../components/SimulationResults';
import PerformanceChart from '../components/PerformanceChart';
import BuildSummaryCard from '../components/BuildSummaryCard';
import { RileyChat } from '../lib/rileyAI';
import { CompatibilityChecker } from '../lib/compatibilityChecker';
import { bikeConfig, componentDatabase } from '../lib/components';
import SEOHead from '../components/SEOHead';
import { useCalculatorState } from '../hooks/useCalculatorState';
import ErrorBoundary from '../components/ErrorBoundary';

// Enhanced compatibility display component
const CompatibilityDisplay = ({ compatibilityResults, className = "" }) => {
  if (!compatibilityResults) return null;

  const { status, title, message, actionItems, criticalIssues, minorWarnings } = compatibilityResults;

  const statusStyles = {
    compatible: {
      bg: 'bg-green-500/10',
      border: 'border-green-500',
      iconBg: 'bg-green-500',
      titleColor: 'text-green-600 dark:text-green-400'
    },
    warning: {
      bg: 'bg-yellow-500/10',
      border: 'border-yellow-500',
      iconBg: 'bg-yellow-500',
      titleColor: 'text-yellow-600 dark:text-yellow-400'
    },
    error: {
      bg: 'bg-red-500/10',
      border: 'border-red-500',
      iconBg: 'bg-red-500',
      titleColor: 'text-red-600 dark:text-red-400'
    }
  };

  const styles = statusStyles[status] || {
    bg: 'bg-[var(--surface-elevated)]',
    border: 'border-[var(--border-subtle)]',
              iconBg: 'bg-neutral-400',
    titleColor: 'text-[var(--text-primary)]'
  };

  return (
    <div className={`p-4 rounded-lg border ${className} ${styles.bg} ${styles.border}`}>
      <div className="flex items-start gap-3">
        <div className="flex-shrink-0 mt-1">
          <div className={`w-6 h-6 rounded-full flex items-center justify-center text-white text-sm font-bold ${styles.iconBg}`}>
            {status === 'compatible' ? '‚úì' : status === 'warning' ? '!' : '√ó'}
          </div>
        </div>
        
        <div className="flex-1 min-w-0">
          <h3 className={`font-medium text-sm mb-1 ${styles.titleColor}`}>
            {title}
          </h3>
          <p className="text-sm mb-3 text-[var(--text-secondary)]">
            {message}
          </p>
          
          {criticalIssues?.length > 0 && (
            <div className="mb-3">
              <div className="text-xs font-medium mb-1 text-red-500">
                Critical Issues:
              </div>
              {criticalIssues.map((issue, index) => (
                <div key={index} className="text-xs mb-1 text-[var(--text-secondary)]">‚Ä¢ {issue}</div>
              ))}
            </div>
          )}
          
          {minorWarnings?.length > 0 && (
            <div className="mb-3">
              <div className="text-xs font-medium mb-1 text-yellow-500">
                Considerations:
              </div>
              {minorWarnings.slice(0, 2).map((warning, index) => (
                <div key={index} className="text-xs mb-1 text-[var(--text-secondary)]">‚Ä¢ {warning}</div>
              ))}
            </div>
          )}
          
          {actionItems?.length > 0 && (
            <div>
              <div className="text-xs font-medium mb-1 text-[var(--text-secondary)]">
                Recommendations:
              </div>
              {actionItems.slice(0, 2).map((item, index) => (
                <div key={index} className="text-xs mb-1 text-[var(--text-tertiary)]">‚Ä¢ {item}</div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

// Simple localStorage functions
const localStorageDB = {
  getConfigs: () => {
    try {
      const saved = localStorage.getItem('cranksmith_configs');
      return { data: saved ? JSON.parse(saved) : [] };
    } catch (error) {
      console.error('Error loading configs:', error);
      return { data: [] };
    }
  },
  saveConfig: async (config) => {
    try {
      const existing = await localStorageDB.getConfigs();
      const newConfig = { ...config, id: Date.now(), created_at: new Date().toISOString() };
      const updated = [...existing.data, newConfig];
      localStorage.setItem('cranksmith_configs', JSON.stringify(updated));
      return { error: null };
    } catch (error) {
      console.error('Error saving config:', error);
      return { error: 'Failed to save configuration' };
    }
  },
  deleteConfig: async (id) => {
    try {
      const existing = await localStorageDB.getConfigs();
      const updated = existing.data.filter(config => config.id !== id);
      localStorage.setItem('cranksmith_configs', JSON.stringify(updated));
      return { error: null };
    } catch (error) {
      console.error('Error deleting config:', error);
      return { error: 'Failed to delete configuration' };
    }
  }
};

// Bike type icons
const BikeIcons = {
  road: (
    <svg viewBox="0 0 100 60" className="w-full h-full">
      <circle cx="20" cy="45" r="12" fill="none" stroke="currentColor" strokeWidth="2"/>
      <circle cx="80" cy="45" r="12" fill="none" stroke="currentColor" strokeWidth="2"/>
      <path d="M20 45 L35 25 L45 30 L55 20 L70 25 L80 45" fill="none" stroke="currentColor" strokeWidth="2"/>
      <path d="M35 25 L45 35" stroke="currentColor" strokeWidth="2"/>
      <path d="M30 20 L40 20 L35 25" fill="none" stroke="currentColor" strokeWidth="2"/>
    </svg>
  ),
  gravel: (
    <svg viewBox="0 0 100 60" className="w-full h-full">
      <circle cx="20" cy="45" r="12" fill="none" stroke="currentColor" strokeWidth="2.5"/>
      <circle cx="80" cy="45" r="12" fill="none" stroke="currentColor" strokeWidth="2.5"/>
      <path d="M20 45 L35 28 L45 32 L55 22 L70 28 L80 45" fill="none" stroke="currentColor" strokeWidth="2"/>
      <path d="M35 28 L45 35" stroke="currentColor" strokeWidth="2"/>
      <path d="M28 22 L42 22 L35 28" fill="none" stroke="currentColor" strokeWidth="2"/>
    </svg>
  ),
  mtb: (
    <svg viewBox="0 0 100 60" className="w-full h-full">
      <circle cx="20" cy="45" r="12" fill="none" stroke="currentColor" strokeWidth="3"/>
      <circle cx="80" cy="45" r="12" fill="none" stroke="currentColor" strokeWidth="3"/>
      <path d="M20 45 L35 30 L45 35 L55 25 L70 30 L80 45" fill="none" stroke="currentColor" strokeWidth="2"/>
      <path d="M35 30 L45 35" stroke="currentColor" strokeWidth="2"/>
      <path d="M30 25 L40 25" stroke="currentColor" strokeWidth="3"/>
    </svg>
  )
};

// Toast Notification Component
const Toast = ({ message, show, onDismiss }) => {
  useEffect(() => {
    if (show) {
      const timer = setTimeout(() => {
        onDismiss();
      }, 3000);
      return () => clearTimeout(timer);
    }
  }, [show, onDismiss]);

  return (
    <div className={`fixed top-4 right-4 z-[10001] p-4 rounded-lg shadow-lg max-w-sm bg-green-500 text-white transition-transform duration-300 ${show ? 'translate-x-0' : 'translate-x-[calc(100%+2rem)]'}`}>
      ‚úÖ {message}
    </div>
  );
};


export default function Home() {
  const {
    bikeType, currentSetup, proposedSetup, results, loading, speedUnit,
    compatibilityResults, validation, setBikeType, updateCurrentSetup,
    updateProposedSetup, setResults, setCompatibilityResults,
    resetCalculator, calculateResults
  } = useCalculatorState();

  const [savedConfigs, setSavedConfigs] = useState([]);
  const [showSaved, setShowSaved] = useState(false);
  const [showRiley, setShowRiley] = useState(false);
  const [compatibilityChecker] = useState(new CompatibilityChecker());
  const [toast, setToast] = useState({ show: false, message: '' });

  useEffect(() => {
    const handler = () => { resetCalculator(); setShowRiley(false); };
    window.addEventListener('reset-calculator', handler);
    return () => window.removeEventListener('reset-calculator', handler);
  }, [resetCalculator]);

  useEffect(() => {
    const loadSavedConfigs = async () => {
      const { data } = await localStorageDB.getConfigs();
      if (data) setSavedConfigs(data);
    };
    loadSavedConfigs();
  }, []);

  const checkCompatibility = () => {
    if (proposedSetup.crankset && proposedSetup.cassette && bikeType) {
      const compatibility = compatibilityChecker.checkCompatibility(proposedSetup, bikeType);
      const summary = compatibilityChecker.generateCompatibilitySummary(compatibility);
      setCompatibilityResults(summary);
    }
  };

  const handleCurrentWheelChange = (v) => updateCurrentSetup({ wheel: v });
  const handleCurrentTireChange = (v) => updateCurrentSetup({ tire: v });
  const handleProposedWheelChange = (v) => updateProposedSetup({ wheel: v });
  const handleProposedTireChange = (v) => updateProposedSetup({ tire: v });
  const handleCurrentCranksetChange = (v) => updateCurrentSetup({ crankset: v });
  const handleCurrentCassetteChange = (v) => updateCurrentSetup({ cassette: v });
  const handleProposedCranksetChange = (v) => updateProposedSetup({ crankset: v });
  const handleProposedCassetteChange = (v) => updateProposedSetup({ cassette: v });

  const handleCalculate = async () => {
    try {
      await calculateResults();
      setTimeout(() => setShowRiley(true), 2000);
      checkCompatibility();
    } catch (error) { console.error('Calculation failed:', error); }
  };

  const showToast = (message) => {
    setToast({ show: true, message });
  };
  
  const handleSaveConfig = async () => {
    if (!results) { showToast('Please calculate results before saving'); return; }
    const config = {
      name: `${bikeType.charAt(0).toUpperCase() + bikeType.slice(1)} Setup ${new Date().toLocaleDateString()}`,
      bikeType, currentSetup, proposedSetup, results, compatibilityResults,
    };
    const { error } = await localStorageDB.saveConfig(config);
    if (error) { showToast('Failed to save configuration.'); } 
    else {
      const { data } = await localStorageDB.getConfigs();
      setSavedConfigs(data || []);
      showToast('Configuration saved to garage!');
    }
  };

  const handleLoadConfig = (config) => {
    updateCurrentSetup(config.currentSetup);
    updateProposedSetup(config.proposedSetup);
    setResults(config.results);
    setBikeType(config.bikeType);
    setCompatibilityResults(config.compatibilityResults);
    showToast(`Loaded "${config.name}" successfully!`);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const handleDeleteConfig = async (id) => {
    if (window.confirm(`Are you sure you want to delete this configuration?`)) {
        const { error } = await localStorageDB.deleteConfig(id);
        if (error) { showToast('Failed to delete configuration.'); } 
        else {
          const { data } = await localStorageDB.getConfigs();
          setSavedConfigs(data || []);
          showToast('Configuration deleted.');
        }
    }
  };

  return (
    <>
      <SEOHead
        title="CrankSmith - Bike Gear Calculator & Compatibility Checker"
        description="Calculate gear ratios, check drivetrain compatibility, and optimize your bike setup. Perfect for cyclists and bike shops."
        url="https://cranksmith.com/calculator"
        image="/og-image.jpg"
      />
      <Toast message={toast.message} show={toast.show} onDismiss={() => setToast({ show: false, message: '' })} />

      <main className="main-container container mx-auto px-4 py-12 max-w-7xl">
        <div className="text-center mb-12">
          <h1 className="hero-title">Compare. Calculate. Optimize.</h1>
          <p className="hero-subtitle max-w-2xl mx-auto">
            See exactly how component changes affect your bike's performance with real-world data and AI-powered insights.
          </p>
          {(bikeType || results) && (
            <button
              onClick={resetCalculator}
              className="mt-6 px-6 py-3 rounded-xl font-medium transition-all text-base bg-[var(--accent-blue)] text-white border border-[var(--accent-blue)]"
            >
              <svg className="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
              Start New Analysis
            </button>
          )}
        </div>

        {!bikeType && (
          <div className="max-w-4xl mx-auto mb-12">
            <div className="mb-8">
              <h2 className="text-4xl font-extrabold mb-2 text-center text-[var(--text-primary)]">
                Select Your Bike Type
              </h2>
              <p className="text-lg text-center mb-6 text-[var(--text-secondary)]">
                Choose your bike style to unlock the full gear configurator with AI-powered compatibility checking and personalized recommendations.
              </p>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                {Object.entries(bikeConfig).map(([type, config]) => (
                  <button
                    key={type}
                    onClick={() => setBikeType(type)}
                    className="p-6 rounded-lg border-2 transition-all duration-200 hover:scale-105 border-[var(--border-light)] bg-[var(--bg-primary)] hover:border-[var(--accent-blue)] hover:bg-blue-500/5"
                  >
                    <div className="w-16 h-16 mx-auto mb-4 text-[var(--accent-blue)]">
                      {BikeIcons[type]}
                    </div>
                    <h3 className="text-lg font-semibold mb-2 text-[var(--text-primary)]">{config.name}</h3>
                    <p className="text-sm text-[var(--text-secondary)]">{config.description}</p>
                  </button>
                ))}
              </div>
            </div>
          </div>
        )}

        {bikeType && (
          <div className="space-y-8">
            <div className="calculator-section grid md:grid-cols-2 gap-8">
              <ErrorBoundary context="component" fallback={<div className="p-8 text-center" style={{ color: 'var(--text-tertiary)' }}>Error loading current setup panel</div>}>
                <GearSelectorPanel
                  title="Current Setup"
                  subtitle="Your current components"
                  setup={currentSetup}
                  setSetup={updateCurrentSetup}
                  config={{
                    wheelSizes: bikeConfig[bikeType].wheelSizes,
                    tireWidths: bikeConfig[bikeType].tireWidths,
                    onWheelChange: handleCurrentWheelChange,
                    onTireChange: handleCurrentTireChange,
                    onCranksetChange: handleCurrentCranksetChange,
                    onCassetteChange: handleCurrentCassetteChange
                  }}
                  bikeType={bikeType}
                  icon={<svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                  </svg>}
                />
              </ErrorBoundary>
              <ErrorBoundary context="component" fallback={<div className="p-8 text-center" style={{ color: 'var(--text-tertiary)' }}>Error loading proposed setup panel</div>}>
                <GearSelectorPanel
                  title="Proposed Setup"
                  subtitle="Components you're considering"
                  setup={proposedSetup}
                  setSetup={updateProposedSetup}
                  config={{
                    wheelSizes: bikeConfig[bikeType].wheelSizes,
                    tireWidths: bikeConfig[bikeType].tireWidths,
                    onWheelChange: handleProposedWheelChange,
                    onTireChange: handleProposedTireChange,
                    onCranksetChange: handleProposedCranksetChange,
                    onCassetteChange: handleProposedCassetteChange
                  }}
                  bikeType={bikeType}
                  icon={<svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                  </svg>}
                />
              </ErrorBoundary>
            </div>

            {compatibilityResults && (
              <div className="max-w-4xl mx-auto">
                <CompatibilityDisplay compatibilityResults={compatibilityResults} className="mb-4"/>
              </div>
            )}

            <div className="max-w-4xl mx-auto">
              <div className="card">
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                  <div className="space-y-2">
                    <div className="flex items-center gap-2">
                      <div className="w-2 h-2 rounded-full bg-[var(--accent-blue)]" />
                      <span className="text-sm text-[var(--text-secondary)]">Current Setup: {isNaN(validation.current.completion) ? '0' : Math.round(validation.current.completion)}%</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <div className="w-2 h-2 rounded-full bg-[var(--success-green)]" />
                      <span className="text-sm text-[var(--text-secondary)]">Proposed Setup: {isNaN(validation.proposed.completion) ? '0' : Math.round(validation.proposed.completion)}%</span>
                    </div>
                    {compatibilityResults && (
                      <div className="flex items-center gap-2">
                        <div className={`w-2 h-2 rounded-full ${compatibilityResults.status === 'compatible' ? 'bg-green-500' : compatibilityResults.status === 'warning' ? 'bg-yellow-500' : 'bg-red-500'}`} />
                        <span className="text-sm text-[var(--text-secondary)]">
                          Compatibility: {compatibilityResults.status === 'compatible' ? 'Good' : compatibilityResults.status === 'warning' ? 'Review needed' : 'Issues found'}
                        </span>
                      </div>
                    )}
                  </div>

                  <div className="flex gap-3">
                    {(proposedSetup.crankset || proposedSetup.cassette) && (
                      <button
                        onClick={() => setShowRiley(!showRiley)}
                        className={`px-4 py-2 rounded-xl font-medium transition-all text-sm border border-[var(--border-subtle)] ${showRiley ? 'bg-[var(--warning-orange)] text-white' : 'bg-[var(--surface-elevated)] text-[var(--text-primary)]'}`}
                      >
                        <span className="mr-2">üîß</span>
                        {showRiley ? 'Hide Riley' : 'Ask Riley'}
                      </button>
                    )}

                    <button
                      onClick={handleCalculate}
                      disabled={!validation.canAnalyze || loading}
                      className="px-6 py-3 rounded-xl font-medium transition-all bg-[var(--accent-blue)] text-white disabled:opacity-50 disabled:cursor-not-allowed hover:enabled:opacity-90"
                    >
                      {loading ? (
                        <span className="flex items-center gap-2">
                          <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                          </svg>
                          Analyzing...
                        </span>
                      ) : (
                        <span className="flex items-center gap-2">
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                          </svg>
                          Analyze Performance
                        </span>
                      )}
                    </button>
                  </div>
                </div>
              </div>
            </div>

            {showRiley && (
              <div className="max-w-4xl mx-auto">
                <ErrorBoundary context="component" fallback={<div className="p-8 text-center" style={{ color: 'var(--text-tertiary)' }}>Error loading Riley AI chat. Please try refreshing the page.</div>}>
                  <RileyChat 
                    userSetup={proposedSetup}
                    analysisResults={results}
                    componentDatabase={componentDatabase}
                    bikeType={bikeType}
                  />
                </ErrorBoundary>
              </div>
            )}
          </div>
        )}

        {results && (
          <div className="max-w-4xl mx-auto mt-12">
            <ErrorBoundary context="component" fallback={<div className="p-8 text-center" style={{ color: 'var(--text-tertiary)' }}>Error loading simulation results</div>}>
              <SimulationResults 
                results={results}
                speedUnit={speedUnit}
                bikeType={bikeType}
              />
            </ErrorBoundary>
            <ErrorBoundary context="component" fallback={<div className="p-8 text-center" style={{ color: 'var(--text-tertiary)' }}>Error loading performance chart</div>}>
              <PerformanceChart 
                current={results.current}
                proposed={results.proposed}
                speedUnit={speedUnit}
              />
            </ErrorBoundary>
            <ErrorBoundary context="component" fallback={<div className="p-8 text-center" style={{ color: 'var(--text-tertiary)' }}>Error loading build summary</div>}>
              <BuildSummaryCard 
                currentSetup={currentSetup}
                proposedSetup={proposedSetup}
                results={results}
                onSave={handleSaveConfig}
              />
            </ErrorBoundary>

            {!showRiley && (
              <div className="mt-8 p-6 rounded-xl bg-[var(--surface-elevated)] border border-[var(--border-subtle)]">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-full flex items-center justify-center bg-[var(--warning-orange)] text-white">üîß</div>
                    <div>
                      <h3 className="font-medium text-[var(--text-primary)]">Questions about your analysis?</h3>
                      <p className="text-sm text-[var(--text-secondary)]">Riley can explain your results and suggest optimizations.</p>
                    </div>
                  </div>
                  <button onClick={() => setShowRiley(true)} className="px-4 py-2 rounded-lg font-medium transition-all bg-[var(--warning-orange)] text-white">
                    Ask Riley
                  </button>
                </div>
              </div>
            )}
          </div>
        )}

        <div id="garage-section" className="mt-16">
          <div className="text-center mb-8">
            <div className="flex items-center justify-center space-x-3 mb-4">
              <svg className="w-8 h-8 text-[var(--accent-blue)]" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12,2L2,7V10H3V20H11V18H13V20H21V10H22V7L12,2M12,4.4L18.8,8H5.2L12,4.4M11,10V12H13V10H11M4,10H9V11H4V10M15,10H20V11H15V10M4,12H9V13H4V12M15,12H20V13H15V12M4,14H9V15H4V14M15,14H20V15H15V14M4,16H9V17H4V16M15,16H20V17H15V16M4,18H9V19H4V18M15,18H20V19H15V18Z"/>
              </svg>
              <h2 className="text-3xl font-bold text-[var(--text-primary)]">My Garage</h2>
            </div>
            <p className="max-w-2xl mx-auto mb-6 text-[var(--text-secondary)]">
              Your saved bike configurations with compatibility analysis and AI insights.
            </p>
            {savedConfigs.length > 0 && (
              <button
                onClick={() => setShowSaved(!showSaved)}
                className="text-lg font-medium transition-colors text-[var(--accent-blue)] hover:opacity-80"
              >
                {showSaved ? 'Hide Garage' : 'Show Garage'} ({savedConfigs.length} configurations)
              </button>
            )}
          </div>

          {savedConfigs.length > 0 && showSaved && (
            <div className="garage-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-6">
              {savedConfigs.map((config) => (
                <GarageCard
                  key={config.id}
                  config={config}
                  onLoad={handleLoadConfig}
                  onDelete={handleDeleteConfig}
                />
              ))}
            </div>
          )}

          {savedConfigs.length === 0 && (
             <div className="flex justify-center">
              <div className="max-w-md w-full p-6 rounded-lg border-2 shadow-lg bg-[var(--bg-primary)] border-[var(--accent-blue)] shadow-blue-500/10">
                <div className="text-center">
                  <div className="w-16 h-16 mx-auto mb-4 text-[var(--accent-blue)]">
                    <svg fill="currentColor" viewBox="0 0 24 24" className="w-full h-full">
                      <path d="M12,2L2,7V10H3V20H11V18H13V20H21V10H22V7L12,2M12,4.4L18.8,8H5.2L12,4.4M11,10V12H13V10H11M4,10H9V11H4V10M15,10H20V11H15V10M4,12H9V13H4V12M15,12H20V13H15V12M4,14H9V15H4V14M15,14H20V15H15V14M4,16H9V17H4V16M15,16H20V17H15V16M4,18H9V19H4V18M15,18H20V19H15V18Z"/>
                    </svg>
                  </div>
                  <h3 className="text-xl font-semibold mb-2 text-[var(--text-primary)]">Empty Garage</h3>
                  <p className="text-sm leading-relaxed text-[var(--text-secondary)]">
                    Save your first bike configuration to start building your garage.
                  </p>
                </div>
              </div>
            </div>
          )}
        </div>
      </main>
    </>
  );
}

const GarageCard = ({ config, onLoad, onDelete }) => {
  const [isLoading, setIsLoading] = useState(false);

  const handleLoadConfig = async () => {
    setIsLoading(true);
    await new Promise(resolve => setTimeout(resolve, 300));
    onLoad(config);
    setIsLoading(false);
  };

  return (
    <div className="garage-card">
      <div className="flex items-start justify-between mb-4">
        <div className="flex-1">
          <h3 className="text-lg font-semibold mb-1 text-[var(--text-primary)]">{config.name}</h3>
          <p className="text-sm text-[var(--text-tertiary)]">{config.bikeType ? config.bikeType.charAt(0).toUpperCase() + config.bikeType.slice(1) : 'Unknown'} Bike</p>
        </div>
        <button onClick={() => onDelete(config.id)} className="p-2 rounded-lg transition-colors text-[var(--text-tertiary)] hover:bg-red-100 dark:hover:bg-red-900/50" title="Delete configuration">
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
        </button>
      </div>

      {config.compatibilityResults && (<div className="mb-4"><CompatibilityDisplay compatibilityResults={config.compatibilityResults} className="text-xs"/></div>)}
      
      <div className="space-y-3 mb-4">
        <div>
          <h4 className="text-sm font-medium mb-2 text-[var(--text-secondary)]">Components</h4>
          <div className="space-y-1 text-sm text-[var(--text-tertiary)]">
            <div className="flex justify-between"><span>Crankset:</span><span className="font-medium text-[var(--text-secondary)]">{config.proposedSetup?.crankset?.model || 'Not set'}</span></div>
            <div className="flex justify-between"><span>Cassette:</span><span className="font-medium text-[var(--text-secondary)]">{config.proposedSetup?.cassette?.model || 'Not set'}</span></div>
            <div className="flex justify-between"><span>Wheel:</span><span className="font-medium text-[var(--text-secondary)]">{config.proposedSetup?.wheel || 'Not set'}</span></div>
            <div className="flex justify-between"><span>Tire:</span><span className="font-medium text-[var(--text-secondary)]">{config.proposedSetup?.tire || 'Not set'}</span></div>
          </div>
        </div>
        {config.results && (
          <div>
            <h4 className="text-sm font-medium mb-2 text-[var(--text-secondary)]">Performance</h4>
            <div className="grid grid-cols-2 gap-2 text-sm">
              <div className="text-center p-2 rounded bg-[var(--surface-elevated)]"><div className="font-semibold text-[var(--text-primary)]">{config.results.proposed?.totalWeight}g</div><div className="text-xs text-[var(--text-tertiary)]">Weight</div></div>
              <div className="text-center p-2 rounded bg-[var(--surface-elevated)]"><div className="font-semibold text-[var(--text-primary)]">{config.results.proposed?.gearRange}%</div><div className="text-xs text-[var(--text-tertiary)]">Range</div></div>
            </div>
          </div>
        )}
      </div>
      
              <button onClick={handleLoadConfig} disabled={isLoading} className="garage-load-btn w-full py-3 rounded font-semibold transition-all text-white bg-[var(--accent-blue)] disabled:cursor-not-allowed disabled:opacity-60 hover:enabled:opacity-90" style={{ 
          backgroundColor: isLoading ? 'var(--bg-tertiary)' : 'var(--accent-blue)',
          color: isLoading ? 'var(--text-disabled)' : 'white'
        }}>
        {isLoading ? (
          <span className="flex items-center justify-center gap-2">
            <svg className="animate-spin h-4 w-4" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" /><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" /></svg>
            Loading...
          </span>
        ) : ( 'Load Configuration' )}
      </button>
    </div>
  );
};
```

### pages/bike-fit.tsx
```
// pages/bike-fit.tsx - Comprehensive bike fit calculator with TypeScript
import React, { useState, useEffect } from 'react';
import Head from 'next/head';
import Layout from '../components/Layout';
import ErrorBoundary from '../components/ErrorBoundary';
import { toast } from '../components/Toast';
import { 
  BodyMeasurements, 
  BikeFitResults, 
  BikeFitCalculations,
  FlexibilityLevel,
  RidingStyle,
  ExperienceLevel,
  MeasurementValidationRanges,
  MeasurementValidationResult
} from '../types';

// Validation ranges for body measurements (in millimeters)
const validationRanges: MeasurementValidationRanges = {
  inseam: { min: 250, max: 1200 }, // 25cm to 120cm (9.8" to 47.2")
  torso: { min: 200, max: 850 },   // 20cm to 85cm (7.9" to 33.5")  
  armLength: { min: 200, max: 950 } // 20cm to 95cm (7.9" to 37.4")
};

// Input validation function
const validateMeasurement = (
  field: 'inseam' | 'torso' | 'armLength', 
  value: string, 
  units: 'metric' | 'imperial'
): MeasurementValidationResult => {
  // Check if input is empty
  if (!value || value.trim() === '') {
    return { isValid: false, valueInMm: null };
  }

  // Parse the numeric value
  const numValue = parseFloat(value.trim());
  
  // Check if it's a valid number
  if (isNaN(numValue)) {
    return { 
      isValid: false, 
      valueInMm: null, 
      error: `Please enter a valid number for ${field}` 
    };
  }

  // Check for negative values
  if (numValue <= 0) {
    return { 
      isValid: false, 
      valueInMm: null, 
      error: `${field} must be a positive number` 
    };
  }

  // Convert to millimeters for validation
  const valueInMm = units === 'imperial' ? numValue * 25.4 : numValue * 10;
  const range = validationRanges[field];

  // Check realistic ranges
  if (valueInMm < range.min || valueInMm > range.max) {
    const minDisplay = units === 'imperial' ? 
      (range.min / 25.4).toFixed(1) : (range.min / 10).toFixed(1);
    const maxDisplay = units === 'imperial' ? 
      (range.max / 25.4).toFixed(1) : (range.max / 10).toFixed(1);
    const unitLabel = units === 'imperial' ? 'inches' : 'cm';
    
    return { 
      isValid: false, 
      valueInMm: null, 
      error: `${field} must be between ${minDisplay} and ${maxDisplay} ${unitLabel}` 
    };
  }

  return { isValid: true, valueInMm: Math.round(valueInMm) };
};

// Bike fit calculation methods and formulas
const bikeFitCalculations: BikeFitCalculations = {
  // Saddle height calculations using different methods
  saddleHeight: {
    lemond: (inseam: number) => inseam * 0.883,
    holmes: (inseam: number) => inseam * 0.885,
    hamley: (inseam: number) => inseam * 1.09,
    competitive: (inseam: number) => inseam * 0.875
  },
  
  // Reach calculations based on torso and arm length
  reach: (torso: number, armLength: number, flexibility: FlexibilityLevel, ridingStyle: RidingStyle) => {
    const baseReach = torso * 0.47 + armLength * 0.15;
    const flexibilityFactor = {
      low: 0.92,
      average: 1.0,
      high: 1.08
    }[flexibility] || 1.0;
    
    const styleFactor = {
      comfort: 0.90,
      endurance: 0.95,
      sport: 1.0,
      aggressive: 1.05,
      racing: 1.08
    }[ridingStyle] || 1.0;
    
    return baseReach * flexibilityFactor * styleFactor;
  },
  
  // Stack calculations for handlebar height
  stack: (torso: number, flexibility: FlexibilityLevel, ridingStyle: RidingStyle, experience: ExperienceLevel) => {
    const baseStack = torso * 0.48;
    
    const flexibilityFactor = {
      low: 1.15,
      average: 1.08,
      high: 1.0
    }[flexibility] || 1.08;
    
    const styleFactor = {
      comfort: 1.20,
      endurance: 1.10,
      sport: 1.0,
      aggressive: 0.92,
      racing: 0.85
    }[ridingStyle] || 1.0;
    
    const experienceFactor = {
      beginner: 1.10,
      intermediate: 1.05,
      advanced: 1.0,
      professional: 0.95
    }[experience] || 1.0;
    
    return baseStack * flexibilityFactor * styleFactor * experienceFactor;
  }
};

export default function BikeFit(): JSX.Element {
  // Body measurements state
  const [measurements, setMeasurements] = useState<BodyMeasurements>({
    inseam: null,
    torso: null,
    armLength: null,
    flexibility: 'average',
    ridingStyle: 'endurance',
    experience: 'intermediate',
    units: 'metric'
  });

  // Temporary display values for inputs during typing
  const [displayValues, setDisplayValues] = useState<{[key: string]: string}>({
    inseam: '',
    torso: '',
    armLength: ''
  });

  // Results state
  const [results, setResults] = useState<BikeFitResults | null>(null);
  const [showAdvanced, setShowAdvanced] = useState<boolean>(false);

  // Calculate bike fit when measurements change
  useEffect(() => {
    const { inseam, torso, armLength, flexibility, ridingStyle, experience } = measurements;
    
    // Only calculate if all measurements are valid numbers
    if (inseam !== null && torso !== null && armLength !== null && 
        inseam > 0 && torso > 0 && armLength > 0) {
      
      try {
        const calculatedStack = bikeFitCalculations.stack(torso, flexibility, ridingStyle, experience);
        
        const newResults: BikeFitResults = {
          saddleHeight: {
            lemond: bikeFitCalculations.saddleHeight.lemond(inseam),
            holmes: bikeFitCalculations.saddleHeight.holmes(inseam),
            hamley: bikeFitCalculations.saddleHeight.hamley(inseam),
            competitive: bikeFitCalculations.saddleHeight.competitive(inseam)
          },
          reach: bikeFitCalculations.reach(torso, armLength, flexibility, ridingStyle),
          stack: calculatedStack,
          handlebarDrop: {
            comfort: calculatedStack - 20,
            sport: calculatedStack - 40,
            aggressive: calculatedStack - 60
          }
        };
        
        setResults(newResults);
      } catch (error) {
        console.error('Bike fit calculation error:', error);
        setResults(null);
        toast.error('Calculation error. Please check your measurements.');
      }
    } else {
      // Clear results if measurements are incomplete
      setResults(null);
    }
  }, [measurements]);

  const handleMeasurementChange = (field: keyof BodyMeasurements, value: any) => {
    setMeasurements(prev => ({
      ...prev,
      [field]: value
    }));
  };

  const formatMeasurement = (value: number, showMm: boolean = true): string => {
    if (!value || isNaN(value)) return '--';
    
    if (measurements.units === 'imperial') {
      const inches = value / 25.4;
      return `${inches.toFixed(1)}"`;
    }
    
    return showMm ? `${Math.round(value)}mm` : `${(value / 10).toFixed(1)}cm`;
  };

  const convertToDisplayUnits = (mm: number | null): string => {
    if (mm === null) return '';
    if (measurements.units === 'imperial') {
      return (mm / 25.4).toFixed(1);
    }
    // For metric, show whole numbers when possible, otherwise 1 decimal
    const cm = mm / 10;
    return cm % 1 === 0 ? cm.toString() : cm.toFixed(1);
  };

  const getUnitLabel = (): string => {
    return measurements.units === 'imperial' ? 'inches' : 'cm';
  };

  const handleInputChange = (field: 'inseam' | 'torso' | 'armLength', value: string): void => {
    // Update display value immediately so user sees what they're typing
    setDisplayValues(prev => ({ ...prev, [field]: value }));

    // If input is empty, set to null
    if (!value || value.trim() === '') {
      handleMeasurementChange(field, null);
      return;
    }

    // Additional NaN protection and input sanitization
    const numValue = parseFloat(value.trim());
    if (isNaN(numValue) || !isFinite(numValue)) {
      // Only show error for clearly invalid input (not incomplete numbers)
      if (value.trim().length > 0 && !value.match(/^\d*\.?\d*$/)) {
        toast.error(`Please enter a valid number for ${field}`);
      }
      return;
    }

    // Try to validate and store the value
    const validation = validateMeasurement(field, value, measurements.units);
    
    if (validation.isValid && validation.valueInMm !== null) {
      // Valid input - store the value in mm
      handleMeasurementChange(field, validation.valueInMm);
    }
    // For invalid/incomplete input, don't show validation errors during typing
    // The display value is already updated above, validation will happen on blur
  };

  const handleInputBlur = (field: 'inseam' | 'torso' | 'armLength', value: string): void => {
    // Clear the display value since we're done typing
    setDisplayValues(prev => ({ ...prev, [field]: '' }));

    // Only validate on blur if there's actually a value
    if (!value || value.trim() === '') {
      return;
    }

    const numValue = parseFloat(value.trim());
    if (isNaN(numValue) || !isFinite(numValue)) {
      toast.error(`Please enter a valid number for ${field}`);
      return;
    }

    // Validate the final input
    const validation = validateMeasurement(field, value, measurements.units);
    
    if (validation.isValid && validation.valueInMm !== null) {
      // Valid input - store the value in mm
      handleMeasurementChange(field, validation.valueInMm);
    } else if (validation.error) {
      // Show validation error on blur
      toast.error(validation.error);
    }
  };

  const resetCalculator = (): void => {
    setMeasurements({
      inseam: null,
      torso: null,
      armLength: null,
      flexibility: 'average',
      ridingStyle: 'endurance',
      experience: 'intermediate',
      units: 'metric'
    });
    setResults(null);
    toast.info('Calculator reset successfully');
  };

  return (
    <>
      <Head>
        <title>Professional Bike Fit Calculator | Body Measurements to Bike Setup | CrankSmith</title>
        <meta name="description" content="Free professional bike fit calculator. Calculate optimal saddle height, reach, and stack based on your body measurements. LeMond, Holmes, Hamley methods. Perfect bike fitting for road, mountain, gravel bikes." />
        <meta name="keywords" content="bike fit calculator, bike fitting, saddle height calculator, bike reach calculator, bike stack calculator, LeMond method, Holmes method, bike fit measurements, bicycle fitting, bike position calculator, cycling fit, bike geometry calculator" />
        
        {/* Structured Data for Bike Fit Calculator */}
        <script
          type="application/ld+json"
          dangerouslySetInnerHTML={{
            __html: JSON.stringify({
              "@context": "https://schema.org",
              "@type": "WebApplication",
              "name": "Professional Bike Fit Calculator",
              "description": "Calculate optimal saddle height, reach, and stack based on your body measurements using professional bike fitting methods",
              "url": "https://cranksmith.com/bike-fit",
              "applicationCategory": "Sports & Recreation",
              "operatingSystem": "Web Browser",
              "offers": {
                "@type": "Offer",
                "price": "0",
                "priceCurrency": "USD"
              },
              "featureList": [
                "Saddle Height Calculation (LeMond Method)",
                "Saddle Height Calculation (Holmes Method)", 
                "Saddle Height Calculation (Hamley Method)",
                "Saddle Height Calculation (Competitive Method)",
                "Reach Calculation",
                "Stack Calculation",
                "Dual Unit Support (Metric/Imperial)",
                "Real-time Calculations"
              ],
              "audience": {
                "@type": "Audience",
                "audienceType": "Cyclists, Bike Fitters, Bike Shops"
              },
              "creator": {
                "@type": "Organization",
                "name": "CrankSmith",
                "url": "https://cranksmith.com"
              },
              "mainEntity": {
                "@type": "HowTo",
                "name": "How to Calculate Bike Fit Measurements",
                "description": "Step-by-step guide to calculate optimal bike fit using body measurements",
                "step": [
                  {
                    "@type": "HowToStep",
                    "name": "Measure Inseam",
                    "text": "Measure from floor to crotch while barefoot"
                  },
                  {
                    "@type": "HowToStep", 
                    "name": "Measure Torso",
                    "text": "Measure from shoulder to hip bone"
                  },
                  {
                    "@type": "HowToStep",
                    "name": "Measure Arm Length", 
                    "text": "Measure from shoulder to fingertip"
                  },
                  {
                    "@type": "HowToStep",
                    "name": "Select Riding Style",
                    "text": "Choose from comfort, endurance, sport, aggressive, or racing"
                  },
                  {
                    "@type": "HowToStep",
                    "name": "Get Results",
                    "text": "View calculated saddle height, reach, and stack measurements"
                  }
                ]
              },
              "keywords": "bike fit calculator, bike fitting, saddle height calculator, bike measurements",
              "inLanguage": "en-US",
              "isAccessibleForFree": true
            })
          }}
        />
        
        {/* Open Graph for Bike Fit */}
        <meta property="og:title" content="Professional Bike Fit Calculator | Body Measurements to Bike Setup | CrankSmith" />
        <meta property="og:description" content="Free professional bike fit calculator. Calculate optimal saddle height, reach, and stack based on your body measurements. LeMond, Holmes, Hamley methods." />
        <meta property="og:url" content="https://cranksmith.com/bike-fit" />
        <meta property="og:type" content="website" />
        <meta property="og:image" content="https://cranksmith.com/og-bike-fit.jpg" />
        
        {/* Twitter Card for Bike Fit */}
        <meta name="twitter:title" content="Professional Bike Fit Calculator | Body Measurements to Bike Setup" />
        <meta name="twitter:description" content="Free professional bike fit calculator. Calculate optimal saddle height, reach, and stack based on your body measurements." />
        <meta name="twitter:image" content="https://cranksmith.com/og-bike-fit.jpg" />
        
        {/* Canonical URL */}
        <link rel="canonical" href="https://cranksmith.com/bike-fit" />
      </Head>

      <Layout>
        <div className="bg-[var(--bg-primary)]">
          {/* Header */}
          <div className="bg-gradient-to-r from-blue-600 to-blue-700 text-white">
            <div className="container mx-auto px-4 py-16">
              <div className="max-w-4xl mx-auto text-center">
                <h1 className="text-4xl md:text-5xl font-bold mb-6">
                  Bike Fit Calculator
                </h1>
                <p className="text-xl text-blue-100 mb-8 max-w-3xl mx-auto">
                  Calculate optimal saddle height, reach, and stack based on your body measurements. 
                  Get professional bike fitting recommendations tailored to your riding style.
                </p>
                
                {/* Quick stats */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
                  <div className="bg-blue-500/30 rounded-lg p-4">
                    <div className="text-2xl font-bold">4 Methods</div>
                    <div className="text-blue-100">Saddle height calculations</div>
                  </div>
                  <div className="bg-blue-500/30 rounded-lg p-4">
                    <div className="text-2xl font-bold">5 Styles</div>
                    <div className="text-blue-100">Riding position options</div>
                  </div>
                  <div className="bg-blue-500/30 rounded-lg p-4">
                    <div className="text-2xl font-bold">Instant</div>
                    <div className="text-blue-100">Real-time calculations</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div className="container mx-auto px-4 py-8">
            <div className="max-w-6xl mx-auto">
              <ErrorBoundary context="bike-fit">
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                  
                  {/* Input Panel */}
                  <div className="lg:col-span-1">
                    <div className="card sticky top-4">
                      <div className="flex items-center justify-between mb-6">
                        <h2 className="text-xl font-semibold text-[var(--text-primary)]">
                          Body Measurements
                        </h2>
                        <div className="flex items-center gap-2">
                          <button
                            onClick={() => handleMeasurementChange('units', measurements.units === 'metric' ? 'imperial' : 'metric')}
                            className="px-3 py-1 text-sm rounded-md border border-[var(--border-primary)] hover:bg-[var(--bg-secondary)] transition-colors"
                          >
                            {measurements.units === 'metric' ? 'cm' : 'in'}
                          </button>
                          <button
                            onClick={resetCalculator}
                            className="text-sm text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors"
                          >
                            Reset
                          </button>
                        </div>
                      </div>

                      <div className="space-y-6">
                        {/* Basic Measurements */}
                        <div>
                          <label className="block text-sm font-medium mb-2 text-[var(--text-primary)]">
                            Inseam Length ({getUnitLabel()})
                          </label>
                          <input
                            type="number"
                            value={displayValues.inseam || convertToDisplayUnits(measurements.inseam)}
                            onChange={(e) => handleInputChange('inseam', e.target.value)}
                            onBlur={(e) => handleInputBlur('inseam', e.target.value)}
                            className="input-field w-full"
                            placeholder={`Enter inseam in ${getUnitLabel()}`}
                            step={measurements.units === 'metric' ? "1" : "0.5"}
                            min={measurements.units === 'metric' ? "25" : "9.8"}
                            max={measurements.units === 'metric' ? "120" : "47.2"}
                          />
                          <p className="text-xs text-[var(--text-secondary)] mt-1">
                            Measure from floor to crotch while barefoot
                          </p>
                        </div>

                        <div>
                          <label className="block text-sm font-medium mb-2 text-[var(--text-primary)]">
                            Torso Length ({getUnitLabel()})
                          </label>
                          <input
                            type="number"
                            value={displayValues.torso || convertToDisplayUnits(measurements.torso)}
                            onChange={(e) => handleInputChange('torso', e.target.value)}
                            onBlur={(e) => handleInputBlur('torso', e.target.value)}
                            className="input-field w-full"
                            placeholder={`Enter torso in ${getUnitLabel()}`}
                            step={measurements.units === 'metric' ? "1" : "0.5"}
                            min={measurements.units === 'metric' ? "20" : "7.9"}
                            max={measurements.units === 'metric' ? "85" : "33.5"}
                          />
                          <p className="text-xs text-[var(--text-secondary)] mt-1">
                            From shoulder to hip bone
                          </p>
                        </div>

                        <div>
                          <label className="block text-sm font-medium mb-2 text-[var(--text-primary)]">
                            Arm Length ({getUnitLabel()})
                          </label>
                          <input
                            type="number"
                            value={displayValues.armLength || convertToDisplayUnits(measurements.armLength)}
                            onChange={(e) => handleInputChange('armLength', e.target.value)}
                            onBlur={(e) => handleInputBlur('armLength', e.target.value)}
                            className="input-field w-full"
                            placeholder={`Enter arm length in ${getUnitLabel()}`}
                            step={measurements.units === 'metric' ? "1" : "0.5"}
                            min={measurements.units === 'metric' ? "20" : "7.9"}
                            max={measurements.units === 'metric' ? "95" : "37.4"}
                          />
                          <p className="text-xs text-[var(--text-secondary)] mt-1">
                            From shoulder to fingertip
                          </p>
                        </div>

                        {/* Riding Characteristics */}
                        <div>
                          <label className="block text-sm font-medium mb-2 text-[var(--text-primary)]">
                            Flexibility Level
                          </label>
                          <select
                            value={measurements.flexibility}
                            onChange={(e) => handleMeasurementChange('flexibility', e.target.value)}
                            className="input-field w-full"
                          >
                            <option value="low">Low - Limited flexibility</option>
                            <option value="average">Average - Normal flexibility</option>
                            <option value="high">High - Very flexible</option>
                          </select>
                        </div>

                        <div>
                          <label className="block text-sm font-medium mb-2 text-[var(--text-primary)]">
                            Riding Style
                          </label>
                          <select
                            value={measurements.ridingStyle}
                            onChange={(e) => handleMeasurementChange('ridingStyle', e.target.value)}
                            className="input-field w-full"
                          >
                            <option value="comfort">Comfort - Upright, relaxed</option>
                            <option value="endurance">Endurance - Balanced performance</option>
                            <option value="sport">Sport - Performance oriented</option>
                            <option value="aggressive">Aggressive - Racing position</option>
                            <option value="racing">Racing - Maximum aerodynamics</option>
                          </select>
                        </div>

                        <div>
                          <label className="block text-sm font-medium mb-2 text-[var(--text-primary)]">
                            Experience Level
                          </label>
                          <select
                            value={measurements.experience}
                            onChange={(e) => handleMeasurementChange('experience', e.target.value)}
                            className="input-field w-full"
                          >
                            <option value="beginner">Beginner - New to cycling</option>
                            <option value="intermediate">Intermediate - Regular rider</option>
                            <option value="advanced">Advanced - Experienced cyclist</option>
                            <option value="professional">Professional - Competitive racer</option>
                          </select>
                        </div>

                        <button
                          onClick={() => setShowAdvanced(!showAdvanced)}
                          className="text-sm text-blue-600 hover:text-blue-700 transition-colors"
                        >
                          {showAdvanced ? 'Hide' : 'Show'} Advanced Options
                        </button>
                      </div>
                    </div>
                  </div>

                  {/* Results Panel */}
                  <div className="lg:col-span-2">
                    {results ? (
                      <div className="space-y-6">
                        
                        {/* Saddle Height Results */}
                        <div className="card">
                          <h3 className="text-lg font-semibold mb-4 text-[var(--text-primary)] flex items-center gap-2">
                            <span className="text-blue-500">üìè</span>
                            Saddle Height Recommendations
                          </h3>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-[var(--bg-secondary)] rounded-lg p-4">
                              <div className="text-sm text-[var(--text-secondary)] mb-1">LeMond Method (Recommended)</div>
                              <div className="text-2xl font-bold text-[var(--text-primary)]">
                                {formatMeasurement(results.saddleHeight.lemond)}
                              </div>
                              <div className="text-xs text-[var(--text-secondary)] mt-1">
                                Most widely used formula
                              </div>
                            </div>
                            <div className="bg-[var(--bg-secondary)] rounded-lg p-4">
                              <div className="text-sm text-[var(--text-secondary)] mb-1">Holmes Method</div>
                              <div className="text-xl font-semibold text-[var(--text-primary)]">
                                {formatMeasurement(results.saddleHeight.holmes)}
                              </div>
                              <div className="text-xs text-[var(--text-secondary)] mt-1">
                                Alternative calculation
                              </div>
                            </div>
                            {showAdvanced && (
                              <>
                                <div className="bg-[var(--bg-secondary)] rounded-lg p-4">
                                  <div className="text-sm text-[var(--text-secondary)] mb-1">Hamley Method</div>
                                  <div className="text-xl font-semibold text-[var(--text-primary)]">
                                    {formatMeasurement(results.saddleHeight.hamley)}
                                  </div>
                                  <div className="text-xs text-[var(--text-secondary)] mt-1">
                                    109% of inseam
                                  </div>
                                </div>
                                <div className="bg-[var(--bg-secondary)] rounded-lg p-4">
                                  <div className="text-sm text-[var(--text-secondary)] mb-1">Competitive Method</div>
                                  <div className="text-xl font-semibold text-[var(--text-primary)]">
                                    {formatMeasurement(results.saddleHeight.competitive)}
                                  </div>
                                  <div className="text-xs text-[var(--text-secondary)] mt-1">
                                    For racing positions
                                  </div>
                                </div>
                              </>
                            )}
                          </div>
                          <div className="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                            <p className="text-sm text-blue-700 dark:text-blue-300">
                              üí° <strong>Tip:</strong> Start with the LeMond method and adjust ¬±5-10mm based on comfort and pedaling efficiency.
                            </p>
                          </div>
                        </div>

                        {/* Reach and Stack Results */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <div className="card">
                            <h3 className="text-lg font-semibold mb-4 text-[var(--text-primary)] flex items-center gap-2">
                              <span className="text-green-500">‚ÜîÔ∏è</span>
                              Reach
                            </h3>
                            <div className="text-center">
                              <div className="text-3xl font-bold text-[var(--text-primary)] mb-2">
                                {formatMeasurement(results.reach)}
                              </div>
                              <div className="text-sm text-[var(--text-secondary)]">
                                Horizontal distance from saddle to handlebars
                              </div>
                            </div>
                            <div className="mt-4 space-y-2 text-sm">
                              <div className="flex justify-between">
                                <span>Riding Style:</span>
                                <span className="capitalize font-medium">{measurements.ridingStyle}</span>
                              </div>
                              <div className="flex justify-between">
                                <span>Flexibility:</span>
                                <span className="capitalize font-medium">{measurements.flexibility}</span>
                              </div>
                            </div>
                          </div>

                          <div className="card">
                            <h3 className="text-lg font-semibold mb-4 text-[var(--text-primary)] flex items-center gap-2">
                              <span className="text-purple-500">‚ÜïÔ∏è</span>
                              Stack
                            </h3>
                            <div className="text-center">
                              <div className="text-3xl font-bold text-[var(--text-primary)] mb-2">
                                {formatMeasurement(results.stack)}
                              </div>
                              <div className="text-sm text-[var(--text-secondary)]">
                                Vertical distance from bottom bracket to handlebars
                              </div>
                            </div>
                            <div className="mt-4 space-y-2 text-sm">
                              <div className="flex justify-between">
                                <span>Experience:</span>
                                <span className="capitalize font-medium">{measurements.experience}</span>
                              </div>
                              <div className="flex justify-between">
                                <span>Style Factor:</span>
                                <span className="capitalize font-medium">{measurements.ridingStyle}</span>
                              </div>
                            </div>
                          </div>
                        </div>

                        {/* Additional Recommendations */}
                        <div className="card">
                          <h3 className="text-lg font-semibold mb-4 text-[var(--text-primary)] flex items-center gap-2">
                            <span className="text-orange-500">üéØ</span>
                            Additional Recommendations
                          </h3>
                          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="text-center p-4 bg-[var(--bg-secondary)] rounded-lg">
                              <div className="text-sm text-[var(--text-secondary)] mb-1">Handlebar Drop (Comfort)</div>
                              <div className="text-lg font-semibold text-[var(--text-primary)]">
                                {formatMeasurement(results.handlebarDrop.comfort)}
                              </div>
                            </div>
                            <div className="text-center p-4 bg-[var(--bg-secondary)] rounded-lg">
                              <div className="text-sm text-[var(--text-secondary)] mb-1">Handlebar Drop (Sport)</div>
                              <div className="text-lg font-semibold text-[var(--text-primary)]">
                                {formatMeasurement(results.handlebarDrop.sport)}
                              </div>
                            </div>
                            <div className="text-center p-4 bg-[var(--bg-secondary)] rounded-lg">
                              <div className="text-sm text-[var(--text-secondary)] mb-1">Handlebar Drop (Aggressive)</div>
                              <div className="text-lg font-semibold text-[var(--text-primary)]">
                                {formatMeasurement(results.handlebarDrop.aggressive)}
                              </div>
                            </div>
                          </div>
                          
                          <div className="mt-6 p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                            <h4 className="font-semibold text-yellow-800 dark:text-yellow-200 mb-2">Important Notes:</h4>
                            <ul className="text-sm text-yellow-700 dark:text-yellow-300 space-y-1">
                              <li>‚Ä¢ These are starting point recommendations - fine-tuning is essential</li>
                              <li>‚Ä¢ Consider professional bike fitting for optimal results</li>
                              <li>‚Ä¢ Make small adjustments (2-3mm) and test over multiple rides</li>
                              <li>‚Ä¢ Account for saddle tilt, cleat position, and handlebar width</li>
                            </ul>
                          </div>
                        </div>

                      </div>
                    ) : (
                      <div className="card">
                        <div className="text-center py-16">
                          <div className="text-6xl mb-4">üö¥‚Äç‚ôÇÔ∏è</div>
                          <h3 className="text-xl font-semibold mb-2 text-[var(--text-primary)]">
                            Enter Your Measurements
                          </h3>
                          <p className="text-[var(--text-secondary)] max-w-md mx-auto">
                            Fill in your body measurements on the left to get personalized bike fit recommendations.
                          </p>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </ErrorBoundary>
            </div>
          </div>
        </div>
      </Layout>
    </>
  );
}```

### pages/mobile.js
```
// pages/mobile.js - Mobile-first PWA version of CrankSmith
import { useState, useEffect } from 'react';
import { useRouter } from 'next/router';
import Head from 'next/head';
import MobileLayout from '../components/mobile/MobileLayout';
import BikeTypeSelector from '../components/mobile/BikeTypeSelector';
import ComponentSelector from '../components/mobile/ComponentSelector';
import ResultsScreen from '../components/mobile/ResultsScreen';
import GarageScreen from '../components/mobile/GarageScreen';
import SettingsScreen from '../components/mobile/SettingsScreen';
import MobileInstallPrompt from '../components/mobile/InstallPrompt';
import { calculateRealPerformance, validateSetupComplete } from '../lib/calculateRealPerformance';
import { bikeConfig, getComponentsForBikeType, componentDatabase } from '../lib/components';
import { CompatibilityChecker } from '../lib/compatibilityChecker';
import ErrorBoundary from '../components/ErrorBoundary';
import { toast } from '../components/Toast';
import { useCalculatorState } from '../hooks/useCalculatorState';

export default function MobileApp() {
  const router = useRouter();
  
  // Use centralized calculator state
  const {
    bikeType, currentSetup, proposedSetup, results, loading, speedUnit,
    setBikeType, updateCurrentSetup, updateProposedSetup, setResults, 
    setSpeedUnit, resetCalculator, calculateResults: centralizedCalculateResults
  } = useCalculatorState();
  
  // Mobile-specific state only
  const [currentScreen, setCurrentScreen] = useState('calculator'); // calculator, results, garage, settings
  const [savedConfigs, setSavedConfigs] = useState([]);

  // Mobile-specific state
  const [setupStep, setSetupStep] = useState(1); // 1: bike type, 2: current setup, 3: proposed setup
  const [isOnline, setIsOnline] = useState(true);
  const [installPrompt, setInstallPrompt] = useState(null);

  const compatibilityChecker = new CompatibilityChecker();

  // Check online status
  useEffect(() => {
    const handleOnline = () => setIsOnline(true);
    const handleOffline = () => setIsOnline(false);
    
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
    
    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  // Handle PWA install prompt
  useEffect(() => {
    const handleBeforeInstallPrompt = (e) => {
      e.preventDefault();
      setInstallPrompt(e);
    };

    window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
    
    return () => {
      window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
    };
  }, []);

  // Load saved data from localStorage
  useEffect(() => {
    try {
      const savedUnit = localStorage.getItem('cranksmith_speed_unit');
      if (savedUnit) setSpeedUnit(savedUnit);

      const savedConfigs = localStorage.getItem('cranksmith_configs');
      if (savedConfigs) setSavedConfigs(JSON.parse(savedConfigs));
    } catch (error) {
      console.error('Error loading saved data:', error);
    }
  }, []);

  const handleInstallApp = async () => {
    if (!installPrompt) return;
    
    const result = await installPrompt.prompt();
    if (result.outcome === 'accepted') {
      setInstallPrompt(null);
    }
  };

  const calculateResults = async () => {
    try {
      // Use centralized calculation logic
      await centralizedCalculateResults();
      
      // Mobile-specific: navigate to results screen after calculation
      setCurrentScreen('results');
    } catch (error) {
      console.error('Error calculating results:', error);
    }
  };

  const saveConfiguration = () => {
    if (!results) return;

    const config = {
      id: Date.now(),
      name: `${bikeType.charAt(0).toUpperCase() + bikeType.slice(1)} Setup ${new Date().toLocaleDateString()}`,
      bikeType,
      currentSetup,
      proposedSetup,
      results,
      created_at: new Date().toISOString()
    };

    try {
      const updatedConfigs = [...savedConfigs, config];
      setSavedConfigs(updatedConfigs);
      localStorage.setItem('cranksmith_configs', JSON.stringify(updatedConfigs));
      
      // Show success feedback
      toast.success('Configuration saved to garage!');
    } catch (error) {
      console.error('Error saving configuration:', error);
      toast.error('Failed to save configuration. Please try again.');
    }
  };

  const handleResetCalculator = () => {
    // Use centralized reset logic
    resetCalculator();
    // Mobile-specific reset actions
    setSetupStep(1);
    setCurrentScreen('calculator');
  };

  const renderCurrentScreen = () => {
    switch (currentScreen) {
      case 'calculator':
        if (setupStep === 1 || !bikeType) {
          return (
            <BikeTypeSelector
              bikeType={bikeType}
              setBikeType={setBikeType}
              onNext={() => setSetupStep(2)}
            />
          );
        }
        return (
          <ComponentSelector
            bikeType={bikeType}
            currentSetup={currentSetup}
            setCurrentSetup={updateCurrentSetup}
            proposedSetup={proposedSetup}
            setProposedSetup={updateProposedSetup}
            setupStep={setupStep}
            setSetupStep={setSetupStep}
            onCalculate={calculateResults}
            loading={loading}
            onReset={handleResetCalculator}
          />
        );
      
      case 'results':
        return (
          <ResultsScreen
            results={results}
            speedUnit={speedUnit}
            bikeType={bikeType}
            onSave={saveConfiguration}
            onBack={() => setCurrentScreen('calculator')}
            onNewCalculation={handleResetCalculator}
          />
        );
      
      case 'garage':
        return (
          <GarageScreen
            savedConfigs={savedConfigs}
            setSavedConfigs={setSavedConfigs}
            onLoadConfig={(config) => {
              setBikeType(config.bikeType);
              updateCurrentSetup(config.currentSetup);
              updateProposedSetup(config.proposedSetup);
              setResults(config.results);
              setCurrentScreen('results');
            }}
          />
        );
      
      case 'settings':
        return (
          <SettingsScreen
            speedUnit={speedUnit}
            setSpeedUnit={setSpeedUnit}
            isOnline={isOnline}
            installPrompt={installPrompt}
            onInstallApp={handleInstallApp}
            onExportData={() => {
              const dataStr = JSON.stringify(savedConfigs, null, 2);
              const dataBlob = new Blob([dataStr], {type: 'application/json'});
              const url = URL.createObjectURL(dataBlob);
              const link = document.createElement('a');
              link.href = url;
              link.download = 'cranksmith-backup.json';
              link.click();
            }}
          />
        );
      
      default:
        return <div>Screen not found</div>;
    }
  };

  return (
    <>
      <Head>
        <title>CrankSmith Mobile - Bike Gear Calculator</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
        <meta name="theme-color" content="#3B82F6" />
        <meta name="mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="default" />
        <meta name="apple-mobile-web-app-title" content="CrankSmith" />
        <link rel="manifest" href="/manifest.json" />
        <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
      </Head>

      <MobileLayout
        currentScreen={currentScreen}
        setCurrentScreen={setCurrentScreen}
        isOnline={isOnline}
        hasResults={!!results}
      >
        <ErrorBoundary context="page" fallback={<div className="p-8 text-center" style={{ color: 'var(--text-tertiary)' }}>Error loading mobile screen. Please try refreshing the page.</div>}>
          {renderCurrentScreen()}
        </ErrorBoundary>
      </MobileLayout>

      {/* Mobile Install Prompt */}
      <MobileInstallPrompt />
    </>
  );
}```

### pages/landing.js
```
// pages/landing.js
import { useState } from 'react';
import SEOHead from '../components/SEOHead';
import AppDownloadCTA from '../components/AppDownloadCTA';
import { useRouter } from 'next/router';
import Link from 'next/link';

export default function Landing() {
  const router = useRouter();
  const [email, setEmail] = useState('');
  const [loading, setLoading] = useState(false);
  const [status, setStatus] = useState({ type: '', message: '' });
  const [logoError, setLogoError] = useState(false); // State for robust image fallback

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    // If no email provided, just redirect to calculator
    if (!email.trim()) {
      router.push('/calculator');
      return;
    }

    setLoading(true);
    setStatus({ type: '', message: '' });

    try {
      // Sign up for community updates
      const response = await fetch('/api/early-access', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });

      const data = await response.json();

      if (data.success) {
        setStatus({ type: 'success', message: 'üéâ Welcome to the community! You\'ll receive updates about new features and cycling tips.' });
        setEmail('');
        
        // Track conversion
        if (typeof window !== 'undefined' && window.gtag) {
          window.gtag('event', 'sign_up', {
            event_category: 'engagement',
            event_label: 'community_updates'
          });
        }
        
        // Redirect to calculator after a brief delay
        setTimeout(() => {
          router.push('/calculator');
        }, 2000);
      } else {
        setStatus({ type: 'error', message: data.error || 'Something went wrong. Please try again.' });
      }
    } catch (error) {
      setStatus({ type: 'error', message: 'Network error. Please try again.' });
    } finally {
      setLoading(false);
    }
  };

  return (
    <>
      <SEOHead
        title="CrankSmith - Free Bike Gear Calculator"
        description="Free bike gear ratio calculator and component compatibility checker. No signup required. Calculate gear ratios, check drivetrain compatibility, and optimize your bike setup instantly."
        url="https://cranksmith.com"
        image="/og-image.jpg"
      />

      <div className="min-h-screen" style={{ background: 'var(--bg-primary)' }}>
        {/* Hero Section - Simplified */}
        <div className="container mx-auto px-4 py-20 text-center">
          <div className="max-w-3xl mx-auto">
            {/* Logo with robust fallback */}
            <div className="mb-12">
              {!logoError ? (
                <img 
                  src="/beta-hero.png" 
                  alt="CrankSmith" 
                  className="max-w-[180px] md:max-w-[260px] w-full h-auto mx-auto mb-4 object-contain"
                  onError={() => setLogoError(true)}
                />
              ) : (
                <div 
                  className="w-80 h-80 md:w-96 md:h-96 mx-auto rounded-xl flex items-center justify-center text-white font-bold text-7xl"
                  style={{ background: 'linear-gradient(135deg, #ff6b35 0%, #f7931e 50%, #007aff 100%)' }}>
                  C
                </div>
              )}
            </div>

            <h2 className="text-3xl md:text-4xl font-bold mb-2 text-center" style={{ color: 'var(--text-primary)' }}>
              The best bike gear calculator is here!
            </h2>
            <p className="text-lg md:text-xl mb-8 max-w-2xl mx-auto text-center" style={{ color: 'var(--text-secondary)' }}>
              Calculate gear ratios, check compatibility, and optimize your bike setup. Completely free to use, no email required!
            </p>

            {/* Direct Access Button */}
            <div className="mb-8">
              <Link 
                href="/calculator"
                className="inline-block px-12 py-4 rounded-xl font-medium transition-all text-lg text-white bg-[var(--accent-blue)] shadow-[0_4px_12px_rgba(0,115,230,0.2)] hover:-translate-y-px hover:shadow-[0_6px_16px_rgba(0,115,230,0.3)]"
              >
                üöÄ Start Using CrankSmith Now
              </Link>
            </div>

            <div className="text-center mb-4" style={{ color: 'var(--text-tertiary)' }}>
              <p className="text-sm">‚Äî or ‚Äî</p>
            </div>

            <p className="text-base mb-4 max-w-2xl mx-auto text-center" style={{ color: 'var(--text-secondary)' }}>
              Want to stay updated on new features and cycling tech content? Join our community (optional):
            </p>

            {/* Optional Email Signup */}
            <div className="max-w-md mx-auto mb-16">
              <form onSubmit={handleSubmit} className="space-y-4">
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="Enter your email (optional)"
                  className="input-field text-lg"
                />
                <button
                  type="submit"
                  disabled={loading}
                  className="w-full px-8 py-4 rounded-xl font-medium transition-all text-lg text-white shadow-[0_4px_12px_rgba(0,0,0,0.1)] hover:-translate-y-px hover:shadow-[0_6px_16px_rgba(0,0,0,0.2)] disabled:opacity-70 disabled:cursor-not-allowed"
                  style={{ 
                    backgroundColor: 'var(--bg-tertiary)',
                    color: 'var(--text-primary)'
                  }}
                  onMouseEnter={(e) => {
                    e.target.style.backgroundColor = 'var(--bg-secondary)';
                  }}
                  onMouseLeave={(e) => {
                    e.target.style.backgroundColor = 'var(--bg-tertiary)';
                  }}
                >
                  {loading ? 'Checking...' : 'Join Community Updates'}
                </button>
              </form>
              
              {status.message && (
                <div className={`mt-4 p-4 rounded-lg ${
                  status.type === 'success' ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'
                }`}>
                  {status.message}
                </div>
              )}
            </div>

            <p className="text-sm" style={{ color: 'var(--text-tertiary)' }}>
              ‚ú® Join 150+ cyclists already optimizing their rides
            </p>
          </div>
        </div>

        {/* Features Grid - Simplified */}
        <div className="container mx-auto px-4 py-20">
          <div className="grid md:grid-cols-3 gap-8 max-w-5xl mx-auto">
            {/* These gradients will now work correctly due to the CSS fix */}
            <div className="card text-center">
              <div className="w-16 h-16 mx-auto mb-4 rounded-xl bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center text-white">
                <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
              </div>
              <h3 className="text-xl font-semibold mb-3" style={{ color: 'var(--text-primary)' }}>Gear Calculator</h3>
              <p style={{ color: 'var(--text-tertiary)' }}>
                Compare components and see exact performance impacts
              </p>
            </div>

            <div className="card text-center">
              <div className="w-16 h-16 mx-auto mb-4 rounded-xl bg-gradient-to-br from-red-500 to-pink-500 flex items-center justify-center text-white">
                <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                </svg>
              </div>
              <h3 className="text-xl font-semibold mb-3" style={{ color: 'var(--text-primary)' }}>Tire Pressure</h3>
              <p style={{ color: 'var(--text-tertiary)' }}>
                Get perfect tire pressure for your weight and terrain
              </p>
            </div>

            <Link href="/ask-riley" className="card text-center hover:shadow-lg transition-shadow cursor-pointer">
              <div className="w-16 h-16 mx-auto mb-4 rounded-xl bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white">
                <span className="text-2xl">ü§ñ</span>
              </div>
              <h3 className="text-xl font-semibold mb-3" style={{ color: 'var(--text-primary)' }}>Ask Riley</h3>
              <p style={{ color: 'var(--text-tertiary)' }}>
                Get personalized advice from your AI bike expert
              </p>
            </Link>
          </div>
        </div>
        
        {/* Tools Showcase (section removed for brevity as it was very similar to the above, assuming similar fixes apply) */}
        {/* The principles are the same: use text-gray-50, text-gray-300 etc. instead of inline styles. */}

        {/* Key Benefits */}
        <div className="container mx-auto px-4 py-20">
          <div className="max-w-3xl mx-auto text-center">
            <h2 className="text-3xl font-bold mb-12" style={{ color: 'var(--text-primary)' }}>Why CrankSmith?</h2>
            <div className="grid md:grid-cols-2 gap-6">
              <div className="card text-left">
                <h3 className="text-xl font-semibold mb-3" style={{ color: 'var(--text-primary)' }}>Real Component Data</h3>
                <p style={{ color: 'var(--text-secondary)' }}>
                  Access accurate specifications and compatibility data for thousands of bike components. No more guesswork or outdated information.
                </p>
              </div>
              <div className="card text-left">
                <h3 className="text-xl font-semibold mb-3" style={{ color: 'var(--text-primary)' }}>Smart Analysis</h3>
                <p style={{ color: 'var(--text-secondary)' }}>
                  Get personalized recommendations based on your riding style, terrain, and goals. Make informed decisions about your setup.
                </p>
              </div>
              <div className="card text-left">
                <h3 className="text-xl font-semibold mb-3" style={{ color: 'var(--text-primary)' }}>Save Money</h3>
                <p style={{ color: 'var(--text-secondary)' }}>
                  Avoid costly mistakes by understanding component compatibility before you buy. Get the right parts the first time.
                </p>
              </div>
              <Link href="/ask-riley" className="card text-left hover:shadow-lg transition-shadow cursor-pointer">
                <h3 className="text-xl font-semibold mb-3" style={{ color: 'var(--text-primary)' }}>Ask Riley - AI Expert</h3>
                <p style={{ color: 'var(--text-secondary)' }}>
                  Get instant answers to your technical questions with Riley, your AI bike expert trained on thousands of maintenance manuals. No more conflicting advice from forums.
                </p>
              </Link>
            </div>
          </div>
        </div>

        {/* App Download CTA */}
        <AppDownloadCTA />
      </div>
    </>
  );
}
```

### pages/about.js
```
export default function About() {
    return (
      <main className="container mx-auto px-4 py-12 max-w-4xl">
        {/* Hero */}
        <div className="text-center mb-16">
          <h1 className="hero-title">About CrankSmith</h1>
          <p className="hero-subtitle max-w-2xl mx-auto">
            Born from a lifelong cyclist's frustration with clunky gear calculators and expensive trial-and-error upgrades.
          </p>
        </div>
  
        {/* Story */}
        <div className="space-y-12">
          <section className="card">
            <h2 className="text-2xl font-semibold mb-6" style={{ color: 'var(--text-primary)' }}>
              The Problem We Solve
            </h2>
            <div className="space-y-4" style={{ color: 'var(--text-secondary)' }}>
              <p>
                As a lifelong cyclist, NICA coach, and competitive gravel racer, I&apos;ve built countless bikes and witnessed the same struggles repeatedly: cyclists wanting to optimize their setups but facing confusing math, expensive components, and limited resources.
              </p>
              <p>
                                  Existing tools on forums and basic gear calculators are clunky, outdated, and don&apos;t reflect modern component reality. Meanwhile, cyclists are stuck buying expensive parts to &quot;see what happens&quot; or settling for suboptimal setups.
              </p>
            </div>
          </section>
  
          <section className="card">
            <h2 className="text-2xl font-semibold mb-6" style={{ color: 'var(--text-primary)' }}>
              Our Solution
            </h2>
            <div className="space-y-4" style={{ color: 'var(--text-secondary)' }}>
              <p>
                CrankSmith brings professional-grade gear analysis to every cyclist. We've built a comprehensive database of real components with accurate specs, modern crossover options (gravel + MTB), and intelligent analysis that considers weight, speed, and compatibility.
              </p>
              <p>
                Our AI mechanic Riley provides expert advice 24/7, answering the questions that arise after seeing your analysis. No more guessing about compatibility or wondering if an upgrade is worth it.
              </p>
            </div>
          </section>
  
          <section className="card">
            <h2 className="text-2xl font-semibold mb-6" style={{ color: 'var(--text-primary)' }}>
              Why CrankSmith?
            </h2>
            <div className="grid md:grid-cols-2 gap-6">
              <div>
                <h3 className="text-lg font-medium mb-3" style={{ color: 'var(--text-primary)' }}>
                  üö¥‚Äç‚ôÇÔ∏è Built by Cyclists
                </h3>
                <p className="text-sm" style={{ color: 'var(--text-tertiary)' }}>
                  Created by someone who coaches NICA, races gravel competitively, and has built hundreds of bikes. We understand real-world cycling needs.
                </p>
              </div>
              
              <div>
                <h3 className="text-lg font-medium mb-3" style={{ color: 'var(--text-primary)' }}>
                  üîß Real Components
                </h3>
                <p className="text-sm" style={{ color: 'var(--text-tertiary)' }}>
                  Accurate database with actual model numbers, weights, and specs. SRAM GX Eagle XG-1275, not just "SRAM cassette."
                </p>
              </div>
              
              <div>
                <h3 className="text-lg font-medium mb-3" style={{ color: 'var(--text-primary)' }}>
                  üìä Modern Analysis
                </h3>
                <p className="text-sm" style={{ color: 'var(--text-tertiary)' }}>
                  Beautiful, shareable results that cyclists actually want to screenshot and discuss with riding buddies.
                </p>
              </div>
              
              <div>
                <h3 className="text-lg font-medium mb-3" style={{ color: 'var(--text-primary)' }}>
                  ü§ñ Expert AI Advice
                </h3>
                <p className="text-sm" style={{ color: 'var(--text-tertiary)' }}>
                  Riley, our AI mechanic, provides personalized advice based on your exact setup and riding style.
                </p>
              </div>
            </div>
          </section>
  
          <section className="card">
            <h2 className="text-2xl font-semibold mb-6" style={{ color: 'var(--text-primary)' }}>
              Contact
            </h2>
            <div className="space-y-4" style={{ color: 'var(--text-secondary)' }}>
              <p>
                Have questions, feedback, or want to contribute to making CrankSmith better? We'd love to hear from you.
              </p>
              <div className="flex flex-col sm:flex-row gap-4">
                <a 
                  href="mailto:mike@cranksmith.com" 
                  className="btn-primary inline-flex items-center justify-center"
                >
                  <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                          d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                  </svg>
                  Get in Touch
                </a>
              </div>
            </div>
          </section>
        </div>
      </main>
    );
  }```

### pages/docs.js
```
// pages/docs.js
import SEOHead from '../components/SEOHead';

export default function DocsPage() {
  return (
    <>
      <SEOHead 
        title="CrankSmith User Guide & FAQ"
        description="Learn how to use CrankSmith's gear calculator, compatibility checker, and tire pressure tools."
        url="https://cranksmith.com/docs"
      />
      
      <div className="min-h-screen bg-[var(--bg-primary)] text-[var(--text-primary)]">
        <div className="max-w-4xl mx-auto px-4 py-12">
          {/* Header */}
          <div className="mb-12">
            <h1 className="text-4xl font-bold mb-4">User Guide & FAQ</h1>
            <p className="text-[var(--text-secondary)] text-lg">
              Everything you need to know about using CrankSmith
            </p>
          </div>

          {/* Quick Start Guide */}
          <section className="mb-12">
            <h2 className="text-2xl font-bold mb-6 text-[var(--accent-blue)]">Quick Start Guide</h2>
            
            <div className="bg-[var(--bg-secondary)] rounded-lg p-6 mb-6">
              <h3 className="text-xl font-semibold mb-4">Using the Gear Calculator</h3>
              <ol className="space-y-3 text-[var(--text-secondary)]">
                <li><strong>1.</strong> Select your crankset (chainrings)</li>
                <li><strong>2.</strong> Choose your cassette (rear cogs)</li>
                <li><strong>3.</strong> Pick your derailleur</li>
                <li><strong>4.</strong> Review compatibility warnings</li>
                <li><strong>5.</strong> Check your gear ratios and cadence ranges</li>
              </ol>
            </div>

            <div className="bg-[var(--bg-secondary)] rounded-lg p-6">
              <h3 className="text-xl font-semibold mb-4">Understanding Your Results</h3>
              <ul className="space-y-2 text-[var(--text-secondary)]">
                <li><strong>Gear Inches:</strong> Higher numbers = harder to pedal, faster speeds</li>
                <li><strong>Cadence:</strong> Your pedaling rate (aim for 80-100 RPM)</li>
                <li><strong>Compatibility:</strong> Green = good, Yellow = caution, Red = won't work</li>
              </ul>
            </div>
          </section>

          {/* FAQ Section */}
          <section>
            <h2 className="text-2xl font-bold mb-6 text-[var(--accent-blue)]">Frequently Asked Questions</h2>
            
            <div className="space-y-4">
              <FAQItem 
                question="What does 'chain capacity exceeded' mean?"
                answer="Your derailleur can't handle the difference between your biggest and smallest gears. Try a long-cage derailleur or smaller cassette range."
              />
              
              <FAQItem 
                question="Why is my setup showing compatibility warnings?"
                answer="Common issues include derailleur capacity limits, chain line problems, or mismatched speeds (10-speed vs 11-speed). Check the specific warning for details."
              />
              
              <FAQItem 
                question="What gear ratio should I use for climbing?"
                answer="For steep climbs, aim for gear inches around 20-30. This gives you a low enough gear to maintain 70-80 RPM cadence uphill."
              />
              
              <FAQItem 
                question="How do I save my bike builds?"
                answer="Use the 'Save to Garage' button after configuring your setup. You can name and organize multiple builds for different bikes or riding styles."
              />
            </div>
          </section>
        </div>
      </div>
    </>
  );
}

// FAQ Item Component
function FAQItem({ question, answer }) {
  return (
    <div className="bg-[var(--bg-secondary)] rounded-lg p-6">
      <h3 className="text-lg font-semibold mb-3 text-[var(--text-primary)]">{question}</h3>
      <p className="text-[var(--text-secondary)]">{answer}</p>
    </div>
  );
}```

### pages/builder.js
```
import React, { useState } from 'react';
import SEOHead from '../components/SEOHead';

export default function DrivetrainBuilder() {
  const [config, setConfig] = useState({
    chainring: '',
    cassette: [],
    wheelSize: '',
  });

  return (
    <div>
      <SEOHead
        title="CrankSmith - Custom Drivetrain Builder"
        description="Build and analyze your custom drivetrain configuration"
        url="https://cranksmith.com/builder"
        image="/og-image.jpg"
      />

      <main className="container mx-auto px-4 py-8">
        <h1 className="text-4xl font-bold mb-6">Drivetrain Builder</h1>
        
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div className="p-6 border-[var(--border-light)] rounded-lg shadow-sm">
            <h2 className="text-2xl font-semibold mb-4">Configuration</h2>
            {/* Configuration form will go here */}
            <p className="text-[var(--text-secondary)]">Builder interface coming soon...</p>
          </div>
          
          <div className="p-6 border-[var(--border-light)] rounded-lg shadow-sm">
            <h2 className="text-2xl font-semibold mb-4">Analysis</h2>
            {/* Analysis results will go here */}
            <p className="text-[var(--text-secondary)]">Analysis results will appear here...</p>
          </div>
        </div>
      </main>
    </div>
  );
} ```

### pages/ask-riley.js
```
import { useState, useRef, useEffect } from 'react';
import SEOHead from '../components/SEOHead';
import Link from 'next/link';
import { RileyAI } from '../lib/rileyAI';

export default function AskRiley() {
  const [riley] = useState(() => new RileyAI(null, null));
  const [messages, setMessages] = useState([
    {
      id: 1,
      role: 'assistant',
      content: "Hi! I'm Riley, your AI bike expert. I've been trained on thousands of bike maintenance manuals and brand support docs. I can help you with upgrade questions, installation guides, compatibility checks, and general bike maintenance advice. What can I help you with today?",
      timestamp: new Date()
    }
  ]);
  const [inputMessage, setInputMessage] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const messagesEndRef = useRef(null);
  const inputRef = useRef(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const quickQuestions = [
    "What tire pressure should I use for road cycling?",
    "How do I know if my chain needs replacing?",
    "What's the difference between 11-speed and 12-speed?",
    "Can I upgrade from rim brakes to disc brakes?",
    "How do I choose the right gear ratio?",
    "What tools do I need for basic bike maintenance?"
  ];

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!inputMessage.trim() || isLoading) return;

    const userMessage = {
      id: Date.now(),
      role: 'user',
      content: inputMessage.trim(),
      timestamp: new Date()
    };

    setMessages(prev => [...prev, userMessage]);
    setInputMessage('');
    setIsLoading(true);

    try {
      // Use the existing Riley AI implementation
      const rileyResponse = await riley.askRiley(userMessage.content);

      const botMessage = {
        id: Date.now() + 1,
        role: 'assistant',
        content: rileyResponse.success ? stripHtml(rileyResponse.response) : rileyResponse.error,
        timestamp: new Date()
      };

      setMessages(prev => [...prev, botMessage]);
    } catch (error) {
      console.error('Error sending message:', error);
      const errorMessage = {
        id: Date.now() + 1,
        role: 'assistant',
        content: "I'm sorry, I'm having trouble connecting right now. Please try again in a moment.",
        timestamp: new Date()
      };
      setMessages(prev => [...prev, errorMessage]);
    } finally {
      setIsLoading(false);
    }
  };

  const handleQuickQuestion = (question) => {
    setInputMessage(question);
    inputRef.current?.focus();
  };

  // Function to strip HTML tags for chat display
  const stripHtml = (html) => {
    if (typeof html !== 'string') return html;
    return html.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();
  };

  return (
    <>
      <SEOHead
        title="Ask Riley - AI Bike Expert | CrankSmith"
        description="Get instant answers to your bike questions from Riley, our AI expert trained on thousands of bike maintenance manuals. Ask about upgrades, installations, compatibility, and more."
        url="https://cranksmith.com/ask-riley"
        image="/og-image.jpg"
      />

      <div className="min-h-screen bg-neutral-50 dark:bg-neutral-950">
        {/* Hero Section */}
        <section className="bg-gradient-to-br from-brand-blue to-brand-purple text-white py-16">
          <div className="container-responsive">
            <div className="max-w-3xl mx-auto text-center">
              <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center">
                <span className="text-4xl">ü§ñ</span>
              </div>
              <h1 className="text-4xl md:text-5xl font-bold mb-4">
                Meet Riley
              </h1>
              <p className="text-xl text-blue-100 mb-6">
                Your AI-powered bike expert trained on thousands of maintenance manuals and brand support docs
              </p>
              <div className="flex flex-wrap gap-2 justify-center text-sm">
                <span className="px-3 py-1 bg-white/20 rounded-full">Upgrade Questions</span>
                <span className="px-3 py-1 bg-white/20 rounded-full">Installation Guides</span>
                <span className="px-3 py-1 bg-white/20 rounded-full">Compatibility Checks</span>
                <span className="px-3 py-1 bg-white/20 rounded-full">Maintenance Tips</span>
              </div>
            </div>
          </div>
        </section>

        {/* Chat Interface */}
        <section className="py-8">
          <div className="container-responsive max-w-4xl">
            <div className="bg-white dark:bg-neutral-900 rounded-2xl shadow-xl overflow-hidden">
              {/* Chat Header */}
              <div className="border-b border-neutral-200 dark:border-neutral-800 p-6 bg-neutral-50 dark:bg-neutral-800">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-full bg-gradient-to-br from-brand-blue to-brand-purple flex items-center justify-center">
                    <span className="text-xl">ü§ñ</span>
                  </div>
                  <div>
                    <h3 className="font-semibold text-neutral-900 dark:text-white">Riley</h3>
                    <p className="text-sm text-neutral-600 dark:text-neutral-400">AI Bike Expert ‚Ä¢ Online</p>
                  </div>
                </div>
              </div>

              {/* Messages */}
              <div className="h-96 overflow-y-auto p-6 space-y-4">
                {messages.map((message) => (
                  <div
                    key={message.id}
                    className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}
                  >
                    <div
                      className={`max-w-xs lg:max-w-md px-4 py-3 rounded-2xl ${
                        message.role === 'user'
                          ? 'bg-brand-blue text-white'
                          : 'bg-neutral-100 dark:bg-neutral-800 text-neutral-900 dark:text-white'
                      }`}
                    >
                      <p className="text-sm leading-relaxed whitespace-pre-wrap">{message.content}</p>
                      <p className={`text-xs mt-2 ${
                        message.role === 'user' ? 'text-blue-100' : 'text-neutral-500 dark:text-neutral-400'
                      }`}>
                        {message.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                      </p>
                    </div>
                  </div>
                ))}
                
                {isLoading && (
                  <div className="flex justify-start">
                    <div className="bg-neutral-100 dark:bg-neutral-800 px-4 py-3 rounded-2xl">
                      <div className="flex space-x-1">
                        <div className="w-2 h-2 bg-neutral-400 rounded-full animate-bounce"></div>
                        <div className="w-2 h-2 bg-neutral-400 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                        <div className="w-2 h-2 bg-neutral-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                      </div>
                    </div>
                  </div>
                )}
                <div ref={messagesEndRef} />
              </div>

              {/* Input */}
              <div className="border-t border-neutral-200 dark:border-neutral-800 p-6">
                <form onSubmit={handleSubmit} className="flex gap-3">
                  <input
                    ref={inputRef}
                    type="text"
                    value={inputMessage}
                    onChange={(e) => setInputMessage(e.target.value)}
                    placeholder="Ask Riley about your bike..."
                    className="flex-1 px-4 py-3 border border-neutral-300 dark:border-neutral-600 rounded-xl bg-white dark:bg-neutral-800 text-neutral-900 dark:text-white placeholder-neutral-500 dark:placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent"
                    disabled={isLoading}
                  />
                  <button
                    type="submit"
                    disabled={isLoading || !inputMessage.trim()}
                    className="px-6 py-3 bg-brand-blue text-white rounded-xl hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                  >
                    Send
                  </button>
                </form>
              </div>
            </div>
          </div>
        </section>

        {/* Quick Questions */}
        <section className="py-8">
          <div className="container-responsive max-w-4xl">
            <h3 className="text-xl font-semibold mb-6 text-neutral-900 dark:text-white">
              Popular Questions
            </h3>
            <div className="grid md:grid-cols-2 gap-4">
              {quickQuestions.map((question, index) => (
                <button
                  key={index}
                  onClick={() => handleQuickQuestion(question)}
                  className="text-left p-4 bg-white dark:bg-neutral-900 rounded-xl border border-neutral-200 dark:border-neutral-800 hover:border-brand-blue dark:hover:border-brand-blue transition-colors"
                >
                  <p className="text-sm text-neutral-600 dark:text-neutral-300">{question}</p>
                </button>
              ))}
            </div>
          </div>
        </section>

        {/* Riley Features */}
        <section className="py-16 bg-neutral-100 dark:bg-neutral-900">
          <div className="container-responsive">
            <div className="text-center mb-12">
              <h2 className="text-3xl font-bold mb-4 text-neutral-900 dark:text-white">
                What Riley Can Help With
              </h2>
              <p className="text-lg text-neutral-600 dark:text-neutral-300 max-w-2xl mx-auto">
                Trained on thousands of bike maintenance manuals and brand support documentation
              </p>
            </div>

            <div className="grid md:grid-cols-3 gap-8">
              <div className="text-center p-6">
                <div className="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center">
                  <span className="text-2xl text-white">üîß</span>
                </div>
                <h3 className="text-xl font-semibold mb-3 text-neutral-900 dark:text-white">Upgrade Questions</h3>
                <p className="text-neutral-600 dark:text-neutral-300">
                  Get advice on component upgrades, compatibility, and performance improvements for your bike.
                </p>
              </div>

              <div className="text-center p-6">
                <div className="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center">
                  <span className="text-2xl text-white">üìã</span>
                </div>
                <h3 className="text-xl font-semibold mb-3 text-neutral-900 dark:text-white">Installation Guides</h3>
                <p className="text-neutral-600 dark:text-neutral-300">
                  Step-by-step installation instructions and troubleshooting tips for bike components.
                </p>
              </div>

              <div className="text-center p-6">
                <div className="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-green-500 to-emerald-500 flex items-center justify-center">
                  <span className="text-2xl text-white">‚úÖ</span>
                </div>
                <h3 className="text-xl font-semibold mb-3 text-neutral-900 dark:text-white">Compatibility Checks</h3>
                <p className="text-neutral-600 dark:text-neutral-300">
                  Verify if components work together and avoid costly compatibility mistakes.
                </p>
              </div>
            </div>
          </div>
        </section>

        {/* CTA to other tools */}
        <section className="py-16">
          <div className="container-responsive text-center">
            <h2 className="text-3xl font-bold mb-4 text-neutral-900 dark:text-white">
              Need More Tools?
            </h2>
            <p className="text-lg text-neutral-600 dark:text-neutral-300 mb-8 max-w-2xl mx-auto">
              Combine Riley's expertise with our precision calculators for the ultimate bike optimization experience
            </p>
            <div className="flex flex-col sm:flex-row gap-4 justify-center">
              <Link href="/calculator" className="btn-primary">
                Gear Calculator
              </Link>
              <Link href="/tire-pressure" className="btn-secondary">
                Tire Pressure Tool
              </Link>
            </div>
          </div>
        </section>
      </div>
    </>
  );
}```

### pages/tire-pressure.js
```
import React, { useState, useEffect } from 'react';
import SEOHead from '../components/SEOHead';

export default function TirePressure() {
  const [riderWeight, setRiderWeight] = useState('');
  const [bikeWeight, setBikeWeight] = useState('');
  const [tireWidth, setTireWidth] = useState('');
  const [surfaceType, setSurfaceType] = useState('road');
  const [isTubeless, setIsTubeless] = useState(true);
  const [weatherCondition, setWeatherCondition] = useState('dry');
  const [ridingStyle, setRidingStyle] = useState('normal');
  const [pressure, setPressure] = useState({
    base: null,
    front: null,
    rear: null,
    ranges: {
      comfort: null,
      balanced: null,
      performance: null
    }
  });
  const [weightUnit, setWeightUnit] = useState('lb');
  const [wheelSize, setWheelSize] = useState('700c');

  const convertWeight = (weight, fromUnit, toUnit) => {
    if (fromUnit === toUnit) return weight;
    if (fromUnit === 'kg' && toUnit === 'lb') return weight * 2.20462;
    if (fromUnit === 'lb' && toUnit === 'kg') return weight / 2.20462;
    return weight;
  };

  const calculatePressure = () => {
    const riderWeightKg = convertWeight(Number(riderWeight), weightUnit, 'kg');
    const bikeWeightKg = convertWeight(Number(bikeWeight), weightUnit, 'kg');
    const totalWeightKg = riderWeightKg + bikeWeightKg;
    
    let basePSI = 0;
    let minPSI = 0;
    let maxPSI = 0;
    let width = Number(tireWidth);

    if (surfaceType === 'road') {
      if (width <= 25) { basePSI = 85 + (totalWeightKg - 70) * 0.8; minPSI = 75; maxPSI = 110; } 
      else if (width <= 32) { basePSI = 65 + (totalWeightKg - 70) * 0.6; minPSI = 55; maxPSI = 85; } 
      else { basePSI = 55 + (totalWeightKg - 70) * 0.5; minPSI = 45; maxPSI = 75; }
    } else if (surfaceType === 'gravel') {
      if (width <= 40) { basePSI = 35 + (totalWeightKg - 70) * 0.4; minPSI = 25; maxPSI = 50; } 
      else if (width <= 47) { basePSI = 30 + (totalWeightKg - 70) * 0.35; minPSI = 22; maxPSI = 45; } 
      else { basePSI = 25 + (totalWeightKg - 70) * 0.3; minPSI = 18; maxPSI = 38; }
    } else if (surfaceType === 'mtb') {
      if (width <= 2.3) { basePSI = 28 + (totalWeightKg - 75) * 0.2; minPSI = 22; maxPSI = 35; } 
      else { basePSI = 24 + (totalWeightKg - 75) * 0.2; minPSI = 18; maxPSI = 30; }
    }

    let wheelSizeFactor = 0;
    if (surfaceType === 'mtb') {
      switch (wheelSize) {
        case '29-inch': wheelSizeFactor = 0; break;
        case '27.5-inch': wheelSizeFactor = 1; break;
        case '26-inch': wheelSizeFactor = 2; break;
      }
    } else {
      switch (wheelSize) {
        case '700c': wheelSizeFactor = 0; break;
        case '650b': wheelSizeFactor = 1; break;
      }
    }

    basePSI += wheelSizeFactor;
    minPSI += wheelSizeFactor;
    maxPSI += wheelSizeFactor;

    if (isTubeless) basePSI -= 3;
    if (weatherCondition === 'wet') basePSI -= 2;
    if (weatherCondition === 'muddy') basePSI -= 4;
    if (ridingStyle === 'comfort') basePSI -= 3;
    if (ridingStyle === 'aggressive') basePSI += 2;

    basePSI = Math.max(minPSI, Math.min(maxPSI, basePSI));

    const range = maxPSI - minPSI;
    const comfortPSI = Math.round(minPSI + (range * 0.1));
    const balancedPSI = Math.round(basePSI);
    const performancePSI = Math.round(minPSI + (range * 0.8));
    const frontPSI = Math.round(basePSI - 2);
    const rearPSI = Math.round(basePSI);

    setPressure({
      base: Math.round(basePSI),
      front: frontPSI,
      rear: rearPSI,
      ranges: { comfort: comfortPSI, balanced: balancedPSI, performance: performancePSI }
    });
  };

  useEffect(() => {
    if (pressure.base && pressure.base < 10) {
      setPressure(prev => ({
        ...prev, base: 25, front: 23, rear: 25,
        ranges: { comfort: 22, balanced: 25, performance: 30 }
      }));
    }
  }, [pressure]);

  return (
    <div className="min-h-screen w-full">
      <SEOHead
        title="CrankSmith - Tire Pressure Calculator"
        description="Calculate optimal tire pressure for your bike based on weight, conditions, and riding style. Get accurate PSI recommendations."
        url="https://cranksmith.com/tire-pressure"
        image="/og-image.jpg"
      />

      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div className="max-w-4xl mx-auto px-4 py-8">
          <h1 className="hero-title text-4xl font-bold mb-4">Tire Pressure Calculator</h1>
          <p className="text-lg mb-8 max-w-2xl text-[var(--text-secondary)]">
            Get optimal tire pressure recommendations based on your weight, tire size, and riding conditions. 
            Algorithm calibrated with industry standards.
          </p>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div className="space-y-6">
              <div>
                <label className="form-label">Weight Unit</label>
                <div className="flex space-x-4">
                  <button onClick={() => setWeightUnit('kg')} className={`flex-1 py-2 px-4 rounded-lg transition-all ${weightUnit === 'kg' ? 'btn-primary' : 'input-field hover:bg-[var(--bg-tertiary)]'}`}>Kilograms (kg)</button>
                  <button onClick={() => setWeightUnit('lb')} className={`flex-1 py-2 px-4 rounded-lg transition-all ${weightUnit === 'lb' ? 'btn-primary' : 'input-field hover:bg-[var(--bg-tertiary)]'}`}>Pounds (lb)</button>
                </div>
              </div>

              <div>
                <label className="form-label">Rider Weight ({weightUnit})</label>
                <input type="number" value={riderWeight} onChange={(e) => setRiderWeight(e.target.value)} className="input-field" placeholder={`Enter weight in ${weightUnit}`} />
              </div>

              <div>
                <label className="form-label">Bike Weight ({weightUnit})</label>
                <input type="number" value={bikeWeight} onChange={(e) => setBikeWeight(e.target.value)} className="input-field" placeholder={`Enter weight in ${weightUnit}`} />
              </div>

              <div>
                <label className="form-label">Tire Width {surfaceType === 'mtb' ? '(inches)' : '(mm)'}</label>
                <input type="number" step={surfaceType === 'mtb' ? '0.1' : '1'} value={tireWidth} onChange={(e) => setTireWidth(e.target.value)} className="input-field" placeholder={surfaceType === 'mtb' ? 'e.g. 2.35' : 'e.g. 47'} />
                <p className="text-xs mt-1 text-[var(--text-tertiary)]">
                  {surfaceType === 'road' && 'Road: 23-35mm typical'}
                  {surfaceType === 'gravel' && 'Gravel: 35-50mm+ typical'}
                  {surfaceType === 'mtb' && 'MTB: 2.1-2.6" typical'}
                </p>
              </div>

              <div>
                <label className="form-label">Surface Type</label>
                <select value={surfaceType} onChange={(e) => setSurfaceType(e.target.value)} className="input-field">
                  <option value="road">Road</option>
                  <option value="gravel">Gravel</option>
                  <option value="mtb">Mountain Bike</option>
                </select>
              </div>

              {(surfaceType === 'gravel' || surfaceType === 'mtb') && (
                <div>
                  <label className="form-label">Wheel Size</label>
                  <select value={wheelSize} onChange={(e) => setWheelSize(e.target.value)} className="input-field">
                    {surfaceType === 'mtb' ? ( <> <option value="29-inch">29"</option> <option value="27.5-inch">27.5"</option> <option value="26-inch">26"</option> </> ) 
                    : ( <> <option value="700c">700c</option> <option value="650b">650b</option> </> )}
                  </select>
                </div>
              )}

              <div>
                <label className="form-label">Setup</label>
                <div className="flex space-x-4">
                  <button onClick={() => setIsTubeless(true)} className={`flex-1 py-2 px-4 rounded-lg transition-all ${isTubeless ? 'btn-primary' : 'input-field hover:bg-[var(--bg-tertiary)]'}`}>Tubeless</button>
                  <button onClick={() => setIsTubeless(false)} className={`flex-1 py-2 px-4 rounded-lg transition-all ${!isTubeless ? 'btn-primary' : 'input-field hover:bg-[var(--bg-tertiary)]'}`}>Tubes</button>
                </div>
              </div>

              <div>
                <label className="form-label">Weather</label>
                <select value={weatherCondition} onChange={(e) => setWeatherCondition(e.target.value)} className="input-field">
                  <option value="dry">Dry</option>
                  <option value="wet">Wet</option>
                  <option value="muddy">Muddy</option>
                </select>
              </div>

              <div>
                <label className="form-label">Riding Style</label>
                <select value={ridingStyle} onChange={(e) => setRidingStyle(e.target.value)} className="input-field">
                  <option value="comfort">Comfort</option>
                  <option value="normal">Normal</option>
                  <option value="aggressive">Aggressive</option>
                </select>
              </div>

              <button
                onClick={calculatePressure}
                disabled={!riderWeight || !bikeWeight || !tireWidth}
                className="w-full px-8 py-4 rounded-xl font-medium transition-all text-lg text-white bg-[var(--accent-blue)] shadow-[0_4px_12px_rgba(0,115,230,0.2)] disabled:opacity-50 disabled:cursor-not-allowed hover:enabled:-translate-y-px hover:enabled:shadow-[0_6px_16px_rgba(0,115,230,0.3)]"
              >
                Calculate Pressure
              </button>
            </div>

            <div className="space-y-6">
              {pressure.base ? (
                <>
                  <div className="card">
                    <h2 className="text-2xl font-bold mb-4 text-[var(--accent-blue)]">Recommended Pressure</h2>
                    <div className="grid grid-cols-2 gap-4 mb-4">
                      <div className="text-center">
                        <div className="text-sm mb-1 text-[var(--text-secondary)]">Front</div>
                        <div className="text-3xl font-bold text-[var(--text-primary)]">{pressure.front} PSI</div>
                      </div>
                      <div className="text-center">
                        <div className="text-sm mb-1 text-[var(--text-secondary)]">Rear</div>
                        <div className="text-3xl font-bold text-[var(--text-primary)]">{pressure.rear} PSI</div>
                      </div>
                    </div>
                    <div className="text-center text-sm text-[var(--text-secondary)]">
                      Range: {pressure.ranges.comfort}‚Äì{pressure.ranges.performance} PSI
                    </div>
                  </div>

                  <div className="space-y-4">
                    <div className="card">
                      <h3 className="text-lg font-semibold mb-2 text-[var(--success-green)]">Comfort Range</h3>
                      <div className="text-2xl font-bold mb-1 text-[var(--text-primary)]">{pressure.ranges.comfort} PSI</div>
                      <p className="text-sm text-[var(--text-secondary)]">
                        Maximum grip and comfort, ideal for rough terrain and long rides
                      </p>
                    </div>

                    <div className="card">
                      <h3 className="text-lg font-semibold mb-2 text-[var(--accent-blue)]">Balanced Range</h3>
                      <div className="text-2xl font-bold mb-1 text-[var(--text-primary)]">{pressure.ranges.balanced} PSI</div>
                      <p className="text-sm text-[var(--text-secondary)]">
                        Optimal balance of grip, comfort, and rolling efficiency
                      </p>
                    </div>

                    <div className="card">
                      <h3 className="text-lg font-semibold mb-2 text-[var(--warning-orange)]">Performance Range</h3>
                      <div className="text-2xl font-bold mb-1 text-[var(--text-primary)]">{pressure.ranges.performance} PSI</div>
                      <p className="text-sm text-[var(--text-secondary)]">
                        Maximum efficiency and speed, ideal for smooth surfaces
                      </p>
                    </div>
                  </div>

                  <div className="p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/50">
                    <p className="text-sm text-yellow-700 dark:text-yellow-300">
                      <strong>Note:</strong> These are starting recommendations. Always check your tire's max pressure and adjust based on feel and performance. 
                      Start in the middle of the range and adjust up/down based on your preferences.
                    </p>
                  </div>
                </>
              ) : (
                <div className="card text-center">
                  <div className="text-6xl mb-4">üìè</div>
                  <h3 className="text-xl font-semibold mb-2 text-[var(--text-primary)]">Ready to Calculate</h3>
                  <p className="text-[var(--text-secondary)]">
                    Enter your weight, tire width, and riding conditions to get personalized tire pressure recommendations.
                  </p>
                </div>
              )}
            </div>
          </div>

          {pressure.base && (
            <div className="mt-8 p-4 rounded-lg bg-blue-500/10 border border-blue-500/50">
              <h4 className="text-sm font-semibold text-blue-600 dark:text-blue-300 mb-2">Algorithm Status</h4>
              <p className="text-xs text-blue-700 dark:text-blue-200">
                Results calibrated with industry standards. For 175lb rider + 20lb bike with 47mm gravel tire: 
                Expected ~32-34 PSI | Your result: {pressure.base} PSI 
                {Math.abs(pressure.base - 33) <= 3 ? ' ‚úÖ' : ' ‚ö†Ô∏è (Check calibration)'}
              </p>
            </div>
          )}
        </div>
      </main>
    </div>
  );
}
```

### pages/performance-analysis.js
```
import React from 'react';
import Link from 'next/link';
import SEOHead from '../components/SEOHead';

export default function PerformanceAnalysis() {
  const comingSoonFeatures = [
    {
      icon: '‚ö°',
      title: 'Speed & Cadence Analysis',
      description: 'Analyze optimal cadence for different terrains and calculate speed predictions based on your gear ratios and power output.'
    },
    {
      icon: 'üìà',
      title: 'Efficiency Optimization',
      description: 'Get insights into your bike setup efficiency with power transfer analysis and aerodynamic positioning recommendations.'
    },
    {
      icon: 'üèîÔ∏è',
      title: 'Terrain-Specific Insights',
      description: 'Detailed performance analysis for climbing, descending, and flat terrain with gear ratio optimization suggestions.'
    },
    {
      icon: '‚è±Ô∏è',
      title: 'Training Zone Calculator',
      description: 'Calculate optimal training zones based on your performance data and bike setup for maximum improvement.'
    }
  ];

  const availableTools = [
    {
      title: 'Bike Gear Calculator',
      description: 'Optimize your drivetrain setup with our comprehensive gear ratio calculator',
      href: '/calculator',
      icon: '‚öôÔ∏è',
      color: 'from-brand-orange to-brand-yellow'
    },
    {
      title: 'Professional Bike Fit',
      description: 'Calculate optimal bike positioning using professional fitting methods',
      href: '/bike-fit',
      icon: 'üö¥‚Äç‚ôÇÔ∏è',
      color: 'from-purple-500 to-pink-500'
    },
    {
      title: 'Tire Pressure Calculator',
      description: 'Get perfect tire pressure for optimal performance and comfort',
      href: '/tire-pressure',
      icon: 'üîß',
      color: 'from-brand-blue to-brand-purple'
    }
  ];

  return (
    <>
      <SEOHead 
        title="Cycling Performance Analysis - Coming Soon | CrankSmith"
        description="Advanced cycling performance analysis tools coming soon to CrankSmith. Speed analysis, efficiency optimization, and terrain-specific insights for cyclists."
        keywords="cycling performance analysis, bike speed calculator, cadence analysis, cycling efficiency, power analysis, training zones"
        url="https://cranksmith.com/performance-analysis"
      />
      
      <div className="min-h-screen bg-gradient-to-br from-brand-blue via-brand-purple to-brand-green">
        {/* Hero Section */}
        <section className="py-20 px-4">
          <div className="container-responsive text-center">
            <div className="mb-8">
              <div className="w-24 h-24 mx-auto mb-6 rounded-3xl bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center shadow-2xl">
                <span className="text-4xl">üìä</span>
              </div>
              <h1 className="text-responsive-4xl font-bold mb-6 text-white">
                Performance Analysis
              </h1>
              <div className="inline-flex items-center gap-2 px-4 py-2 bg-yellow-400/20 rounded-full border border-yellow-400/30 mb-6">
                <span className="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></span>
                <span className="text-yellow-200 font-medium">Coming Soon</span>
              </div>
              <p className="text-responsive-xl text-blue-100 max-w-3xl mx-auto mb-8">
                Advanced cycling performance analysis tools are in development. Get deep insights into your speed, efficiency, and optimization opportunities across different terrains.
              </p>
            </div>
          </div>
        </section>

        {/* Coming Soon Features */}
        <section className="py-16 px-4">
          <div className="container-responsive">
            <h2 className="text-responsive-3xl font-bold text-center mb-12 text-white">
              What's Coming
            </h2>
            <div className="grid-responsive">
              {comingSoonFeatures.map((feature, index) => (
                <div 
                  key={feature.title}
                  className="card bg-white/10 backdrop-blur-sm border border-white/20 p-6 text-center hover:bg-white/15 transition-all duration-300"
                >
                  <div className="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-white/20 to-white/10 flex items-center justify-center">
                    <span className="text-3xl">{feature.icon}</span>
                  </div>
                  <h3 className="text-xl font-semibold mb-3 text-white">
                    {feature.title}
                  </h3>
                  <p className="text-blue-100 leading-relaxed">
                    {feature.description}
                  </p>
                </div>
              ))}
            </div>
          </div>
        </section>

        {/* Available Tools */}
        <section className="py-16 px-4 bg-white/5 backdrop-blur-sm">
          <div className="container-responsive">
            <h2 className="text-responsive-3xl font-bold text-center mb-6 text-white">
              Available Now
            </h2>
            <p className="text-center text-blue-100 mb-12 max-w-2xl mx-auto">
              While performance analysis is in development, explore our other professional cycling tools
            </p>
            <div className="grid-responsive">
              {availableTools.map((tool, index) => (
                <Link
                  key={tool.title}
                  href={tool.href}
                  className="card bg-white/10 backdrop-blur-sm border border-white/20 p-6 text-center hover:bg-white/15 hover-lift transition-all duration-300 cursor-pointer"
                >
                  <div className={`w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br ${tool.color} flex items-center justify-center shadow-lg`}>
                    <span className="text-3xl">{tool.icon}</span>
                  </div>
                  <h3 className="text-xl font-semibold mb-3 text-white">
                    {tool.title}
                  </h3>
                  <p className="text-blue-100 leading-relaxed">
                    {tool.description}
                  </p>
                </Link>
              ))}
            </div>
          </div>
        </section>

        {/* Newsletter Section */}
        <section className="py-16 px-4">
          <div className="container-responsive text-center">
            <div className="max-w-2xl mx-auto">
              <h2 className="text-responsive-3xl font-bold mb-6 text-white">
                Get Notified When It's Ready
              </h2>
              <p className="text-blue-100 mb-8">
                Be the first to access advanced performance analysis tools when they launch
              </p>
              <div className="flex flex-col sm:flex-row gap-4 max-w-md mx-auto mb-8">
                <input
                  type="email"
                  placeholder="Enter your email"
                  className="flex-1 px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-white/30"
                />
                <button className="btn-secondary bg-white text-brand-blue hover:bg-neutral-100 whitespace-nowrap">
                  Notify Me
                </button>
              </div>
              <p className="text-sm text-blue-200">
                No spam, just updates on new cycling tools and features
              </p>
            </div>
          </div>
        </section>

        {/* CTA Section */}
        <section className="py-16 px-4 border-t border-white/10">
          <div className="container-responsive text-center">
            <h2 className="text-responsive-2xl font-bold mb-6 text-white">
              Start Optimizing Today
            </h2>
            <p className="text-blue-100 mb-8 max-w-2xl mx-auto">
              Don't wait for performance analysis - start optimizing your bike setup now with our existing tools
            </p>
            <div className="flex flex-col sm:flex-row gap-4 justify-center items-center">
              <Link href="/calculator" className="btn-primary">
                <span>Gear Calculator</span>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" />
                </svg>
              </Link>
              
              <Link href="/bike-fit" className="btn-secondary bg-white/10 text-white border-white/20 hover:bg-white/20">
                <span>Bike Fit Calculator</span>
              </Link>
            </div>
          </div>
        </section>
      </div>
    </>
  );
}```

### pages/blog.js
```
// pages/blog.js
import Link from 'next/link';
import SEOHead from '../components/SEOHead';

// Sample blog posts - you'll replace this with actual content
const blogPosts = [
  {
    id: 'optimal-climbing-gears',
    title: 'How to Choose Optimal Climbing Gears for Your Next Hill Climb',
    excerpt: 'Learn the science behind gear selection for steep climbs and maintain your cadence when the road goes up.',
    date: '2025-06-15',
    readTime: '5 min read',
    category: 'Gear Selection'
  },
  {
    id: 'gravel-vs-road-gearing',
    title: 'Gravel vs Road Bike Gearing: What\'s the Difference?',
    excerpt: 'Understanding why gravel bikes need different gear ratios and how to optimize for mixed terrain riding.',
    date: '2025-06-10',
    readTime: '7 min read',
    category: 'Bike Setup'
  },
  {
    id: 'tire-pressure-performance',
    title: 'The Hidden Performance Cost of Wrong Tire Pressure',
    excerpt: 'How tire pressure affects rolling resistance, comfort, and speed - plus how to find your optimal PSI.',
    date: '2025-06-05',
    readTime: '4 min read',
    category: 'Performance'
  }
];

export default function BlogPage() {
  return (
    <>
      <SEOHead 
        title="CrankSmith Blog - Bike Gear & Performance Tips"
        description="Expert advice on bike gearing, tire pressure, and performance optimization for cyclists and bike shops."
        url="https://cranksmith.com/blog"
      />
      
      <div className="min-h-screen bg-[var(--bg-primary)] text-[var(--text-primary)]">
        <div className="max-w-4xl mx-auto px-4 py-12">
          {/* Header */}
          <div className="mb-12">
            <h1 className="text-4xl font-bold mb-4">CrankSmith Blog</h1>
            <p className="text-[var(--text-secondary)] text-lg">
              Expert tips on bike gearing, performance, and optimization
            </p>
          </div>

          {/* Blog Posts Grid */}
          <div className="space-y-8">
            {blogPosts.map((post) => (
              <BlogPostCard key={post.id} post={post} />
            ))}
          </div>

          {/* Call to Action */}
          <div className="mt-16 bg-[var(--bg-secondary)] rounded-lg p-8 text-center">
            <h2 className="text-2xl font-bold mb-4">Ready to Optimize Your Setup?</h2>
            <p className="text-[var(--text-secondary)] mb-6">
              Use CrankSmith's gear calculator to find your perfect drivetrain configuration
            </p>
            <Link 
              href="/calculator"
              className="inline-block bg-[var(--accent-blue)] hover:bg-[var(--accent-blue-hover)] px-6 py-3 rounded-lg font-semibold transition-colors"
            >
              Try the Calculator
            </Link>
          </div>
        </div>
      </div>
    </>
  );
}

// Blog Post Card Component
function BlogPostCard({ post }) {
  return (
    <article className="bg-[var(--bg-secondary)] rounded-lg p-6 hover:bg-[var(--bg-tertiary)] transition-colors">
      <div className="flex items-center gap-4 mb-3 text-sm text-[var(--text-secondary)]">
        <span className="bg-[var(--accent-blue)] text-white px-2 py-1 rounded text-xs">
          {post.category}
        </span>
        <time>{new Date(post.date).toLocaleDateString()}</time>
        <span>{post.readTime}</span>
      </div>
      
      <h2 className="text-xl font-bold mb-3 hover:text-[var(--accent-blue)]">
        <Link href={`/blog/${post.id}`}>
          {post.title}
        </Link>
      </h2>
      
      <p className="text-[var(--text-secondary)] mb-4">
        {post.excerpt}
      </p>
      
      <Link 
        href={`/blog/${post.id}`}
        className="text-[var(--accent-blue)] hover:text-[var(--accent-blue-hover)] font-medium"
      >
        Read More ‚Üí
      </Link>
    </article>
  );
}```

### pages/404.js
```
import React, { useEffect, useState } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/router';
import SEOHead from '../components/SEOHead';

export default function Custom404() {
  const router = useRouter();
  const [countdown, setCountdown] = useState(10);
  const [autoRedirect, setAutoRedirect] = useState(true);

  // Popular tools and pages
  const popularPages = [
    {
      title: 'Bike Gear Calculator',
      description: 'Calculate optimal gear ratios for your bike',
      href: '/calculator',
      icon: '‚öôÔ∏è',
      color: 'from-brand-orange to-brand-yellow'
    },
    {
      title: 'Professional Bike Fit',
      description: 'Get your perfect bike fit measurements',
      href: '/bike-fit',
      icon: 'üö¥‚Äç‚ôÇÔ∏è',
      color: 'from-purple-500 to-pink-500'
    },
    {
      title: 'Tire Pressure Calculator',
      description: 'Find optimal tire pressure for your setup',
      href: '/tire-pressure',
      icon: 'üîß',
      color: 'from-brand-blue to-brand-purple'
    },
    {
      title: 'Ask Riley AI',
      description: 'Get expert cycling advice from AI',
      href: '/ask-riley',
      icon: 'ü§ñ',
      color: 'from-brand-green to-emerald-400'
    }
  ];

  // Common page suggestions based on URL patterns
  const getPageSuggestion = (path) => {
    const suggestions = {
      '/performance': '/performance-analysis',
      '/analysis': '/performance-analysis',
      '/gear': '/calculator',
      '/calc': '/calculator',
      '/calculator': '/calculator',
      '/fit': '/bike-fit',
      '/bike-fit': '/bike-fit',
      '/tire': '/tire-pressure',
      '/pressure': '/tire-pressure',
      '/riley': '/ask-riley',
      '/ai': '/ask-riley',
      '/chat': '/ask-riley',
      '/about': '/about',
      '/docs': '/docs',
      '/help': '/docs',
      '/blog': '/blog'
    };

    // Check for partial matches
    for (const [pattern, suggestion] of Object.entries(suggestions)) {
      if (path.toLowerCase().includes(pattern)) {
        return suggestion;
      }
    }
    return '/calculator'; // Default fallback
  };

  const suggestedPage = getPageSuggestion(router.asPath);

  useEffect(() => {
    if (!autoRedirect) return;

    const timer = setInterval(() => {
      setCountdown((prev) => {
        if (prev <= 1) {
          router.push(suggestedPage);
          return 0;
        }
        return prev - 1;
      });
    }, 1000);

    return () => clearInterval(timer);
  }, [autoRedirect, router, suggestedPage]);

  const handleCancelRedirect = () => {
    setAutoRedirect(false);
  };

  return (
    <>
      <SEOHead 
        title="Page Not Found - CrankSmith"
        description="The page you're looking for doesn't exist. Explore our bike calculators and tools instead."
        url="https://cranksmith.com/404"
      />
      
      <div className="min-h-screen bg-gradient-to-br from-brand-blue via-brand-purple to-brand-green flex items-center justify-center px-4">
        <div className="max-w-4xl mx-auto text-center">
          {/* 404 Animation */}
          <div className="mb-8">
            <div className="text-8xl md:text-9xl font-bold text-white/20 mb-4">
              404
            </div>
            <div className="w-32 h-32 mx-auto mb-6 rounded-3xl bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center shadow-2xl animate-bounce">
              <span className="text-5xl">üö¥‚Äç‚ôÇÔ∏è</span>
            </div>
          </div>

          {/* Main Message */}
          <h1 className="text-4xl md:text-5xl font-bold mb-6 text-white">
            Looks like you took a wrong turn!
          </h1>
          <p className="text-xl text-blue-100 mb-8 max-w-2xl mx-auto">
            The page you're looking for doesn't exist, but don't worry - we'll help you find what you need.
          </p>

          {/* Auto Redirect Notice */}
          {autoRedirect && (
            <div className="mb-8 p-4 bg-white/10 rounded-lg border border-white/20 max-w-md mx-auto">
              <p className="text-white mb-2">
                Redirecting you to our{' '}
                <Link href={suggestedPage} className="text-yellow-300 hover:text-yellow-200 underline">
                  {suggestedPage === '/calculator' ? 'Bike Calculator' : 
                   suggestedPage === '/bike-fit' ? 'Bike Fit Calculator' :
                   suggestedPage === '/tire-pressure' ? 'Tire Pressure Calculator' :
                   suggestedPage === '/ask-riley' ? 'AI Expert Riley' :
                   suggestedPage === '/performance-analysis' ? 'Performance Analysis' :
                   'main page'}
                </Link>
                {' '}in {countdown} seconds
              </p>
              <button
                onClick={handleCancelRedirect}
                className="text-sm text-blue-200 hover:text-white underline"
              >
                Cancel auto-redirect
              </button>
            </div>
          )}

          {/* Popular Tools Grid */}
          <div className="mb-12">
            <h2 className="text-2xl font-bold text-white mb-8">
              Popular Cycling Tools
            </h2>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              {popularPages.map((page, index) => (
                <Link
                  key={page.title}
                  href={page.href}
                  className="card bg-white/10 backdrop-blur-sm border border-white/20 p-6 text-center hover:bg-white/15 hover-lift transition-all duration-300 cursor-pointer"
                  onClick={() => setAutoRedirect(false)}
                >
                  <div className={`w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br ${page.color} flex items-center justify-center shadow-lg`}>
                    <span className="text-3xl">{page.icon}</span>
                  </div>
                  <h3 className="text-lg font-semibold mb-2 text-white">
                    {page.title}
                  </h3>
                  <p className="text-sm text-blue-100">
                    {page.description}
                  </p>
                </Link>
              ))}
            </div>
          </div>

          {/* Navigation Links */}
          <div className="flex flex-col sm:flex-row gap-4 justify-center items-center mb-8">
            <Link 
              href="/"
              className="btn-primary"
              onClick={() => setAutoRedirect(false)}
            >
              <span>Go Home</span>
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
              </svg>
            </Link>
            
            <Link 
              href="/calculator"
              className="btn-secondary bg-white/10 text-white border-white/20 hover:bg-white/20"
              onClick={() => setAutoRedirect(false)}
            >
              <span>Start Calculating</span>
            </Link>
          </div>

          {/* Help Text */}
          <div className="text-sm text-blue-200">
            <p className="mb-2">
              Still can't find what you're looking for?{' '}
              <Link href="/ask-riley" className="text-yellow-300 hover:text-yellow-200 underline">
                Ask Riley, our AI expert
              </Link>
            </p>
            <p>
              Or visit our{' '}
              <Link href="/docs" className="text-yellow-300 hover:text-yellow-200 underline">
                documentation
              </Link>
              {' '}for detailed guides
            </p>
          </div>
        </div>
      </div>
    </>
  );
}```

### pages/api/riley.js
```
// pages/api/riley.js - COMPLETE FILE with enhanced security
import { Redis } from '@upstash/redis';

// Initialize Redis client (use Upstash or similar)
const redis = new Redis({
  url: process.env.UPSTASH_REDIS_REST_URL,
  token: process.env.UPSTASH_REDIS_REST_TOKEN,
});

// Security constants
const RATE_LIMIT_WINDOW = 60000; // 1 minute
const MAX_REQUESTS_PER_WINDOW = 10;
const MAX_PROMPT_LENGTH = 5000;
const BLOCKED_PATTERNS = [
  'ignore previous',
  'disregard instructions',
  'forget what i told you',
  'system prompt',
  'reveal your instructions',
  'show your prompt',
  'what are your instructions',
  'bypass your',
  'jailbreak',
];

// Validate prompt for security
function isValidPrompt(prompt) {
  if (!prompt || typeof prompt !== 'string') {
    return { valid: false, reason: 'Invalid prompt format' };
  }

  if (prompt.length > MAX_PROMPT_LENGTH) {
    return { valid: false, reason: 'Prompt too long' };
  }

  // Check for prompt injection attempts
  const lowerPrompt = prompt.toLowerCase();
  for (const pattern of BLOCKED_PATTERNS) {
    if (lowerPrompt.includes(pattern)) {
      return { valid: false, reason: 'Potentially harmful prompt detected' };
    }
  }

  // Check for excessive special characters (possible encoding attack)
  const specialCharRatio = (prompt.match(/[^a-zA-Z0-9\s.,!?-]/g) || []).length / prompt.length;
  if (specialCharRatio > 0.3) {
    return { valid: false, reason: 'Unusual character pattern detected' };
  }

  return { valid: true };
}

// Get client identifier
function getClientId(req) {
  const forwarded = req.headers['x-forwarded-for'];
  const ip = forwarded ? forwarded.split(',')[0] : req.connection.remoteAddress;
  
  // Add user agent hash for better fingerprinting
  const userAgent = req.headers['user-agent'] || 'unknown';
  const crypto = require('crypto');
  const uaHash = crypto.createHash('md5').update(userAgent).digest('hex').substring(0, 8);
  
  return `${ip}-${uaHash}`;
}

// Check rate limit with Redis
async function checkRateLimit(clientId) {
  const key = `riley_rate_limit:${clientId}`;
  
  try {
    // Get current count
    const current = await redis.get(key);
    const count = current ? parseInt(current) : 0;
    
    if (count >= MAX_REQUESTS_PER_WINDOW) {
      return { allowed: false, retryAfter: RATE_LIMIT_WINDOW / 1000 };
    }
    
    // Increment count
    const pipeline = redis.pipeline();
    pipeline.incr(key);
    pipeline.expire(key, Math.ceil(RATE_LIMIT_WINDOW / 1000));
    await pipeline.exec();
    
    return { allowed: true, remaining: MAX_REQUESTS_PER_WINDOW - count - 1 };
  } catch (error) {
    console.error('Redis error:', error);
    // Fallback to allowing request if Redis fails
    return { allowed: true, remaining: -1 };
  }
}

// Log suspicious activity
async function logSuspiciousActivity(clientId, reason) {
  const key = `riley_suspicious:${clientId}`;
  const timestamp = new Date().toISOString();
  
  try {
    await redis.zadd(key, {
      score: Date.now(),
      member: `${timestamp}:${reason}`
    });
    
    // Keep logs for 7 days
    await redis.expire(key, 7 * 24 * 60 * 60);
  } catch (error) {
    console.error('Failed to log suspicious activity:', error);
  }
}

export default async function handler(req, res) {
  // Only allow POST
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const clientId = getClientId(req);
  
  try {
    // Check rate limit
    const rateLimitResult = await checkRateLimit(clientId);
    
    if (!rateLimitResult.allowed) {
      res.setHeader('Retry-After', rateLimitResult.retryAfter);
      return res.status(429).json({ 
        error: 'Rate limit exceeded. Please wait before making another request.',
        retryAfter: rateLimitResult.retryAfter,
        timestamp: new Date().toISOString()
      });
    }
    
    // Add rate limit headers
    if (rateLimitResult.remaining >= 0) {
      res.setHeader('X-RateLimit-Limit', MAX_REQUESTS_PER_WINDOW);
      res.setHeader('X-RateLimit-Remaining', rateLimitResult.remaining);
      res.setHeader('X-RateLimit-Reset', new Date(Date.now() + RATE_LIMIT_WINDOW).toISOString());
    }

    const { prompt } = req.body;
    
    // Validate prompt
    const validation = isValidPrompt(prompt);
    if (!validation.valid) {
      await logSuspiciousActivity(clientId, validation.reason);
      return res.status(400).json({ 
        error: validation.reason,
        timestamp: new Date().toISOString()
      });
    }

    // Check for API key
    if (!process.env.ANTHROPIC_API_KEY) {
      console.error('ANTHROPIC_API_KEY not configured');
      return res.status(500).json({ 
        error: 'Service temporarily unavailable. Please try again later.',
        timestamp: new Date().toISOString()
      });
    }

    // Make API request with timeout
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 30000); // 30 second timeout

    try {
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'x-api-key': process.env.ANTHROPIC_API_KEY,
          'Content-Type': 'application/json',
          'anthropic-version': '2023-06-01'
        },
        body: JSON.stringify({
          model: 'claude-3-5-sonnet-20241022',
          max_tokens: 1024,
          messages: [
            {
              role: 'user',
              content: prompt
            }
          ],
          temperature: 0.7,
          system: "You are Riley, a helpful bike mechanic assistant. Provide concise, accurate advice about bike components and compatibility."
        }),
        signal: controller.signal
      });

      clearTimeout(timeout);

      if (!response.ok) {
        const errorData = await response.text();
        console.error('Claude API error:', response.status, errorData);
        
        return res.status(500).json({
          error: 'Sorry, I\'m having trouble connecting right now. Please try again in a moment.',
          timestamp: new Date().toISOString()
        });
      }

      const data = await response.json();
      
      // Sanitize response
      const responseText = data.content[0].text
        .replace(/<script[^>]*>.*?<\/script>/gi, '') // Remove scripts
        .replace(/javascript:/gi, '') // Remove javascript: URIs
        .substring(0, 2000); // Limit response length
      
      res.status(200).json({
        success: true,
        response: responseText,
        timestamp: new Date().toISOString()
      });

    } catch (fetchError) {
      if (fetchError.name === 'AbortError') {
        return res.status(504).json({
          error: 'Request timeout. Please try again.',
          timestamp: new Date().toISOString()
        });
      }
      throw fetchError;
    }

  } catch (error) {
    console.error('Riley API Error:', error);
    
    // Log error but don't expose internal details
    await logSuspiciousActivity(clientId, `Error: ${error.message}`);
    
    res.status(500).json({
      success: false,
      error: 'An unexpected error occurred. Please try again later.',
      timestamp: new Date().toISOString()
    });
  }
}

// Export config for Vercel
export const config = {
  api: {
    bodyParser: {
      sizeLimit: '10kb',
    },
  },
};
```

### pages/api/early-access.js
```
// pages/api/early-access.js - Community signup with Zoho + Supabase
import nodemailer from 'nodemailer';
import { supabase } from '../../lib/supabase';
import { validateRequestBody } from '../../lib/validation';

// At the top of the file, add development check utility
const isDevelopment = process.env.NODE_ENV === 'development';
const devLog = (...args) => isDevelopment && console.log(...args);

export default async function handler(req, res) {
  devLog('Community signup API called');
  
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  // Validate request body with comprehensive validation
  const validationSchema = {
    email: { type: 'email', required: true },
    source: { type: 'string', maxLength: 50 }
  };
  
  const validation = validateRequestBody(req.body, validationSchema);
  
  if (!validation.isValid) {
    devLog('Validation errors:', validation.errors);
    return res.status(400).json({ 
      success: false, 
      error: 'Validation failed',
      details: validation.errors 
    });
  }
  
  const { email, source = 'landing_page' } = validation.sanitized;
  devLog('Valid email received:', email);

  try {
    devLog('Attempting to save to Supabase...');
    const { data, error } = await supabase
      .from('early_access')
      .insert([{ 
        email, 
        source,
        created_at: new Date().toISOString()
      }])
      .select()
      .single();

    if (error) {
      console.error('Supabase error:', error);
      // If email already exists, that's ok
      if (error.code === '23505') {
        return res.status(200).json({ 
          success: true, 
          message: 'You\'re already on the list!' 
        });
      }
      throw error;
    }

    devLog('Saved to Supabase successfully:', data);

    // Send email with Zoho
    devLog('Setting up Zoho transporter...');
    const transporter = nodemailer.createTransport({
      host: 'smtp.zoho.com',
      port: 465,
      secure: true, // true for 465, false for 587
      auth: {
        user: process.env.ZOHO_EMAIL, // your-email@yourdomain.com
        pass: process.env.ZOHO_PASSWORD // your zoho password or app-specific password
      }
    });

    // Verify transporter
    devLog('Verifying Zoho connection...');
    await transporter.verify();
    devLog('Zoho connection verified');

    // Email HTML template
    const emailHtml = `
      <!DOCTYPE html>
      <html>
        <head>
          <style>
            body { 
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
              line-height: 1.6; 
              color: #333; 
              margin: 0;
              padding: 0;
            }
            .container { 
              max-width: 600px; 
              margin: 0 auto; 
              background: #ffffff;
            }
            .header { 
              background: linear-gradient(135deg, #ff6b35 0%, #f7931e 25%, #007aff 100%); 
              color: white; 
              padding: 40px 30px; 
              text-align: center; 
            }
            .header h1 {
              margin: 0;
              font-size: 32px;
              font-weight: 700;
            }
            .content { 
              padding: 40px 30px; 
              background: #ffffff;
            }
            .content h2 {
              color: #1a1a1a;
              margin-top: 0;
            }
            .button { 
              display: inline-block; 
              padding: 14px 32px; 
              background: linear-gradient(135deg, #007aff 0%, #5856d6 100%); 
              color: white; 
              text-decoration: none; 
              border-radius: 30px; 
              margin: 20px 0; 
              font-weight: 600;
              font-size: 16px;
            }
            .feature-list {
              background: #f8f9fa;
              border-radius: 12px;
              padding: 20px;
              margin: 20px 0;
            }
            .feature-list li {
              margin: 10px 0;
            }
            .footer { 
              text-align: center; 
              padding: 30px; 
              color: #666; 
              font-size: 14px;
              background: #f8f9fa;
            }
            .signature {
              margin-top: 30px;
              padding-top: 20px;
              border-top: 1px solid #eee;
            }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              <h1>Welcome to the CrankSmith community! üö¥‚Äç‚ôÇÔ∏è</h1>
            </div>
            <div class="content">
              <h2>Hey fellow cyclist! üëã</h2>
              
              <p>Thanks for joining our community! CrankSmith is a completely free bike gear calculator and compatibility checker that you can start using right away.</p>
              
              <p>I built CrankSmith because I was tired of:</p>
              <ul>
                <li>Guessing if an upgrade would actually help</li>
                <li>Using clunky calculators with generic data</li>
                <li>Wasting money on components that didn't improve my ride</li>
              </ul>
              
              <div class="feature-list">
                <p><strong>üéØ What's included (completely free):</strong></p>
                <ul>
                  <li>‚úÖ Professional gear ratio calculator</li>
                  <li>‚úÖ Component compatibility checker</li>
                  <li>‚úÖ Tire pressure calculator</li>
                  <li>‚úÖ Performance optimization tools</li>
                  <li>‚úÖ Works offline on your phone</li>
                </ul>
              </div>
              
              <p style="text-align: center;">
                <a href="https://cranksmith.com/calculator" class="button">
                  üöÄ Start Using CrankSmith
                </a>
              </p>
              
              <p style="text-align: center; color: #666; font-size: 14px;">
                <em>No signup required - bookmark it for easy access!</em>
              </p>
              
              <div class="signature">
                <p>By joining our community, you'll get occasional updates about new features, cycling tips, and useful content. Got questions? Just reply to this email. I personally read every message and usually respond within a day.</p>
                
                <p>
                  Ride on!<br>
                  <strong>Mike</strong><br>
                  Founder, CrankSmith<br>
                  <em style="color: #666;">Fellow bike nerd who spent way too much on the wrong cassette once</em>
                </p>
              </div>
            </div>
            <div class="footer">
              <p>You're receiving this because you signed up for community updates at cranksmith.com</p>
              <p>
                <a href="https://cranksmith.com" style="color: #007aff; text-decoration: none;">CrankSmith</a> | 
                Built with ‚ù§Ô∏è by cyclists, for cyclists
              </p>
            </div>
          </div>
        </body>
      </html>
    `;

    // Send email
    devLog('Sending welcome email...');
    const mailOptions = {
      from: `"CrankSmith" <${process.env.ZOHO_EMAIL}>`,
      to: email,
      subject: 'Welcome to the CrankSmith community! üö¥‚Äç‚ôÇÔ∏è',
      html: emailHtml,
      text: `Welcome to the CrankSmith community!

Thanks for joining! CrankSmith is a completely free bike gear calculator and compatibility checker that you can start using right away.

Start using CrankSmith: https://cranksmith.com/calculator

What's included (completely free):
- Professional gear ratio calculator
- Component compatibility checker  
- Tire pressure calculator
- Performance optimization tools
- Works offline on your phone

By joining our community, you'll get occasional updates about new features, cycling tips, and useful content. Got questions? Just reply to this email.

Ride on!
Mike
Founder, CrankSmith`
    };

    await transporter.sendMail(mailOptions);
    devLog('Welcome email sent successfully');

    // Optional: Send yourself a notification
    if (process.env.ADMIN_EMAIL) {
      await transporter.sendMail({
        from: `"CrankSmith" <${process.env.ZOHO_EMAIL}>`,
        to: process.env.ADMIN_EMAIL,
        subject: 'üéâ New CrankSmith Community Member!',
        text: `New community signup: ${email}\n\nTotal signups: Check Supabase dashboard`,
      });
    }
    
    res.status(200).json({ 
      success: true, 
      message: 'Welcome to the community! Check your email and start using the free tools right away.' 
    });
    
  } catch (error) {
    console.error('Community signup error:', error); // Keep error logging
    
    // More specific error messages
    if (error.message?.includes('auth')) {
      console.error('Email auth error - check ZOHO credentials'); // Keep error logging
      return res.status(500).json({ success: false, error: 'Email service configuration error' });
    }
    if (error.message?.includes('supabase') || error.code) {
      console.error('Supabase error - check connection'); // Keep error logging
      return res.status(500).json({ success: false, error: 'Database connection error' });
    }
    
    res.status(500).json({ 
      error: 'Failed to process signup. Please try again or email mike@cranksmith.com directly.' 
    });
  }
}```

### pages/api/verify-beta.js
```
// pages/api/verify-beta.js
import { supabase } from '../../lib/supabase';

export default async function handler(req, res) {
  console.log('Beta verification API called');
  
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const { email } = req.body;
  console.log('Verifying email:', email);

  if (!email || !email.includes('@')) {
    return res.status(400).json({ error: 'Valid email required' });
  }

  try {
    // First, let's see ALL emails in the table for debugging
    console.log('Getting all emails for comparison...');
    const { data: allEmails, error: allError } = await supabase
      .from('early_access')
      .select('email');
    
    console.log('All emails in database:', allEmails);
    
    // Now try the specific query
    console.log('Checking for specific email...');
    const { data, error } = await supabase
      .from('early_access')
      .select('email, created_at')
      .ilike('email', email.trim());

    if (error) {
      console.log('Supabase error:', error);
      throw error;
    }

    console.log('Specific query returned:', data);

    if (data && data.length > 0) {
      console.log('Email found in database:', data[0]);
      return res.status(200).json({ 
        success: true, 
        hasAccess: true,
        message: 'Welcome to the beta!',
        signupDate: data[0].created_at
      });
    } else {
      console.log('No matching email found');
      return res.status(200).json({ 
        success: true, 
        hasAccess: false,
        message: 'Email not found in beta list' 
      });
    }

  } catch (error) {
    console.error('Beta verification error:', error);
    return res.status(500).json({ 
      error: 'Verification failed' 
    });
  }
}```

### pages/blog/gravel-vs-road-gearing.js
```
// pages/blog/gravel-vs-road-gearing.js
import Link from 'next/link';
import SEOHead from '../../components/SEOHead';

export default function GravelVsRoadGearing() {
  return (
    <>
      <SEOHead 
        title="Gravel vs Road Bike Gearing: What's the Difference? - CrankSmith"
        description="Understanding why gravel bikes need different gear ratios and how to optimize for mixed terrain riding."
        url="https://cranksmith.com/blog/gravel-vs-road-gearing"
      />
      
      <div className="min-h-screen bg-[var(--bg-primary)] text-[var(--text-primary)]">
        <div className="max-w-3xl mx-auto px-4 py-12">
          {/* Back Link */}
          <Link href="/blog" className="text-[var(--accent-blue)] hover:text-[var(--accent-blue-hover)] mb-8 inline-block">
            ‚Üê Back to Blog
          </Link>

          {/* Article Header */}
          <header className="mb-8">
            <div className="flex items-center gap-4 mb-4 text-sm text-[var(--text-secondary)]">
              <span className="bg-[var(--success-green)] text-white px-2 py-1 rounded text-xs">
                Bike Setup
              </span>
              <time>June 10, 2025</time>
              <span>7 min read</span>
            </div>
            
            <h1 className="text-4xl font-bold mb-4">
              Gravel vs Road Bike Gearing: What's the Difference?
            </h1>
            
            <p className="text-xl text-[var(--text-secondary)]">
              Understanding why gravel bikes need different gear ratios and how to optimize for mixed terrain riding.
            </p>
          </header>

          {/* Article Content */}
          <article className="prose prose-invert max-w-none">
            <p>
              If you've ever wondered why your road bike feels inadequate on gravel trails, or why gravel bikes have such different gearing, you're not alone. The terrain demands completely different approaches to gear selection.
            </p>

            <h2>The Core Differences</h2>
            <p>
              Road bikes prioritize speed and efficiency on smooth pavement, while gravel bikes need versatility for everything from loose dirt to steep off-road climbs. This fundamental difference drives every gearing decision.
            </p>

            <h3>Gear Range Comparison</h3>
            <p>
              <strong>Road bikes:</strong> Typically 34/50 chainrings with 11-28 or 11-32 cassettes<br/>
              <strong>Gravel bikes:</strong> Often 40/48 or single chainring setups with 11-42 or wider cassettes
            </p>

            <h2>Why Gravel Needs Lower Gears</h2>
            <p>
              Gravel riding presents unique challenges that demand different gearing strategies:
            </p>

            <ul>
              <li><strong>Loose surfaces:</strong> Less traction means you need easier gears to maintain momentum</li>
              <li><strong>Steep, loose climbs:</strong> 15-20% grades on dirt require gears as low as 15-18 gear inches</li>
              <li><strong>Technical sections:</strong> Slow, controlled riding benefits from ultra-low gears</li>
              <li><strong>Loaded touring:</strong> Bikepacking adds weight, demanding easier climbing gears</li>
            </ul>

            <h2>The 1x vs 2x Debate for Gravel</h2>
            <p>
              Many gravel bikes now use single chainring (1x) setups. Here's when each works best:
            </p>

            <h3>Choose 1x When:</h3>
            <ul>
              <li>Simplicity and low maintenance are priorities</li>
              <li>You ride varied terrain but don't need extreme high or low gears</li>
              <li>Typical rides are under 50 miles</li>
            </ul>

            <h3>Choose 2x When:</h3>
            <ul>
              <li>You want the widest possible gear range</li>
              <li>Long road sections are part of your rides</li>
              <li>You prioritize small gear steps for optimal cadence</li>
            </ul>

            <h2>Optimizing Your Gravel Setup</h2>
            <p>
              The ideal gravel gearing depends on your specific riding:
            </p>

            <p>
              <strong>Fire roads and smooth gravel:</strong> 40t chainring with 11-36 cassette<br/>
              <strong>Technical singletrack:</strong> 38t chainring with 11-42 cassette<br/>
              <strong>Bikepacking/loaded touring:</strong> 36t chainring with 11-46+ cassette
            </p>

            <h2>Real-World Gear Recommendations</h2>
            <p>
              For most gravel riders, aim for these gear inch ranges:
            </p>
            <ul>
              <li><strong>Lowest gear:</strong> 18-22 gear inches (for steep, loose climbs)</li>
              <li><strong>Highest gear:</strong> 90-110 gear inches (for road sections and descents)</li>
              <li><strong>Most-used range:</strong> 35-65 gear inches (comfortable cruising)</li>
            </ul>

            {/* CTA Section */}
            <div className="bg-[var(--bg-secondary)] rounded-lg p-6 my-8">
              <h3 className="text-xl font-bold mb-3">Find Your Perfect Gravel Gearing</h3>
              <p className="text-[var(--text-secondary)] mb-4">
                Use CrankSmith's calculator to compare different chainring and cassette combinations for your gravel adventures.
              </p>
              <Link 
                href="/calculator"
                className="inline-block bg-[var(--accent-blue)] hover:bg-[var(--accent-blue-hover)] px-4 py-2 rounded font-semibold transition-colors"
              >
                Calculate Your Setup
              </Link>
            </div>

            <p>
              Remember: the best gravel gearing is the one that gives you confidence on every surface. Whether you choose 1x or 2x, prioritize having the right gear for your steepest climbs and longest road sections.
            </p>
          </article>
        </div>
      </div>
    </>
  );
}```

### pages/blog/optimal-climbing-gears.js
```
// pages/blog/optimal-climbing-gears.js
import Link from 'next/link';
import SEOHead from '../../components/SEOHead';

export default function OptimalClimbingGears() {
  return (
    <>
      <SEOHead 
        title="How to Choose Optimal Climbing Gears - CrankSmith"
        description="Learn the science behind gear selection for steep climbs and maintain your cadence when the road goes up."
        url="https://cranksmith.com/blog/optimal-climbing-gears"
      />
      
      <div className="min-h-screen bg-[var(--bg-primary)] text-[var(--text-primary)]">
        <div className="max-w-3xl mx-auto px-4 py-12">
          {/* Back Link */}
          <Link href="/blog" className="text-[var(--accent-blue)] hover:text-[var(--accent-blue-hover)] mb-8 inline-block">
            ‚Üê Back to Blog
          </Link>

          {/* Article Header */}
          <header className="mb-8">
            <div className="flex items-center gap-4 mb-4 text-sm text-[var(--text-secondary)]">
              <span className="bg-[var(--accent-blue)] text-white px-2 py-1 rounded text-xs">
                Gear Selection
              </span>
              <time>June 15, 2025</time>
              <span>5 min read</span>
            </div>
            
            <h1 className="text-4xl font-bold mb-4">
              How to Choose Optimal Climbing Gears for Your Next Hill Climb
            </h1>
            
            <p className="text-xl text-[var(--text-secondary)]">
              Learn the science behind gear selection for steep climbs and maintain your cadence when the road goes up.
            </p>
          </header>

          {/* Article Content */}
          <article className="prose prose-invert max-w-none">
            <p>
              When the road tilts skyward, your gear selection can make the difference between a smooth, sustainable climb and a leg-burning struggle. The key is understanding how gear ratios, cadence, and power output work together.
            </p>

            <h2>The Science of Climbing Gears</h2>
            <p>
              For most cyclists, maintaining a cadence between 70-80 RPM on climbs is optimal. This keeps your muscles in their efficient power band while preventing the quad-burning low-cadence grind that leads to early fatigue.
            </p>

            <h3>Calculating Your Ideal Climbing Gear</h3>
            <p>
              Here's a simple formula: On a 10% grade at 8 mph, you'll need approximately 25-30 gear inches to maintain 75 RPM. For steeper climbs (12%+), consider gears as low as 20-22 gear inches.
            </p>

            <h2>Common Climbing Gear Mistakes</h2>
            <ul>
              <li><strong>Too high gears:</strong> Forcing big gears uphill burns matches you can't get back</li>
              <li><strong>Late shifting:</strong> Shift before you need to, not when you're already struggling</li>
              <li><strong>Ignoring terrain:</strong> Different climb profiles need different approaches</li>
            </ul>

            <h2>Gear Recommendations by Climb Type</h2>
            <p>
              <strong>Short, steep punches (8-12%):</strong> 22-28 gear inches<br/>
              <strong>Long, steady climbs (4-8%):</strong> 28-35 gear inches<br/>
              <strong>Alpine climbing (10%+):</strong> 18-25 gear inches
            </p>

            {/* CTA Section */}
            <div className="bg-[var(--bg-secondary)] rounded-lg p-6 my-8">
              <h3 className="text-xl font-bold mb-3">Calculate Your Perfect Climbing Setup</h3>
              <p className="text-[var(--text-secondary)] mb-4">
                Use CrankSmith's gear calculator to find the exact chainring and cassette combination for your climbing goals.
              </p>
              <Link 
                href="/calculator"
                className="inline-block bg-[var(--accent-blue)] hover:bg-[var(--accent-blue-hover)] px-4 py-2 rounded font-semibold transition-colors"
              >
                Try the Calculator
              </Link>
            </div>

            <p>
              Remember: the best climbing gear is the one that lets you maintain a steady, sustainable effort all the way to the top. Your legs will thank you on the next climb.
            </p>
          </article>
        </div>
      </div>
    </>
  );
}```

### pages/blog/tire-pressure-performance.js
```
// pages/blog/tire-pressure-performance.js
import Link from 'next/link';
import SEOHead from '../../components/SEOHead';

export default function TirePressurePerformance() {
  return (
    <>
      <SEOHead 
        title="The Hidden Performance Cost of Wrong Tire Pressure - CrankSmith"
        description="How tire pressure affects rolling resistance, comfort, and speed - plus how to find your optimal PSI."
        url="https://cranksmith.com/blog/tire-pressure-performance"
      />
      
      <div className="min-h-screen bg-[var(--bg-primary)] text-[var(--text-primary)]">
        <div className="max-w-3xl mx-auto px-4 py-12">
          {/* Back Link */}
          <Link href="/blog" className="text-[var(--accent-blue)] hover:text-[var(--accent-blue-hover)] mb-8 inline-block">
            ‚Üê Back to Blog
          </Link>

          {/* Article Header */}
          <header className="mb-8">
            <div className="flex items-center gap-4 mb-4 text-sm text-[var(--text-secondary)]">
              <span className="bg-[var(--warning-orange)] text-white px-2 py-1 rounded text-xs">
                Performance
              </span>
              <time>June 5, 2025</time>
              <span>4 min read</span>
            </div>
            
            <h1 className="text-4xl font-bold mb-4">
              The Hidden Performance Cost of Wrong Tire Pressure
            </h1>
            
            <p className="text-xl text-[var(--text-secondary)]">
              How tire pressure affects rolling resistance, comfort, and speed - plus how to find your optimal PSI.
            </p>
          </header>

          {/* Article Content */}
          <article className="prose prose-invert max-w-none">
            <p>
              Most cyclists obsess over lightweight components and aerodynamics, but ignore one of the biggest performance factors: tire pressure. Getting this wrong can cost you more watts than expensive wheels ever save.
            </p>

            <h2>The Science of Rolling Resistance</h2>
            <p>
              Rolling resistance occurs when your tire deforms as it rolls. Too little pressure and your tire flexes excessively, creating heat and drag. Too much pressure and you lose comfort and traction, plus you'll bounce over small bumps instead of rolling smoothly.
            </p>

            <h3>The Performance Numbers</h3>
            <p>
              Research shows that running 20 PSI too high or too low can increase rolling resistance by 10-15 watts at 25 mph. Over a 40-mile ride, that's the equivalent of carrying an extra 2-3 pounds up every hill.
            </p>

            <h2>Finding Your Optimal Pressure</h2>
            <p>
              The ideal tire pressure depends on several factors that work together:
            </p>

            <ul>
              <li><strong>Rider weight:</strong> Heavier riders need higher pressure to prevent tire deformation</li>
              <li><strong>Tire width:</strong> Wider tires run lower pressures for the same contact patch</li>
              <li><strong>Road surface:</strong> Smooth roads favor higher pressure; rough roads favor lower</li>
              <li><strong>Riding style:</strong> Racing demands different pressure than casual riding</li>
            </ul>

            <h2>Pressure by Tire Width</h2>
            <p>
              Here are starting points for a 150-170 lb rider on smooth pavement:
            </p>

            <p>
              <strong>23mm tires:</strong> 100-110 PSI<br/>
              <strong>25mm tires:</strong> 85-95 PSI<br/>
              <strong>28mm tires:</strong> 70-80 PSI<br/>
              <strong>32mm tires:</strong> 60-70 PSI<br/>
              <strong>40mm+ gravel:</strong> 35-50 PSI
            </p>

            <h2>The Front vs Rear Difference</h2>
            <p>
              Your rear tire carries more weight (you + gear), so it needs 5-10 PSI more than the front. This improves comfort without sacrificing performance, since the front tire has less load.
            </p>

            <h2>Adjusting for Real-World Conditions</h2>
            <p>
              Your optimal pressure changes based on conditions:
            </p>

            <ul>
              <li><strong>Rough roads:</strong> Drop pressure 5-10 PSI for better comfort and traction</li>
              <li><strong>Wet conditions:</strong> Lower pressure increases contact patch and grip</li>
              <li><strong>Long rides:</strong> Start 5 PSI higher - pressure drops as tires warm up</li>
              <li><strong>Racing:</strong> Higher pressure for maximum speed on smooth courses</li>
            </ul>

            <h2>Common Pressure Mistakes</h2>
            <p>
              Avoid these performance-killing errors:
            </p>

            <ul>
              <li><strong>Copying pro settings:</strong> Pros weigh 130 lbs and race on perfect roads</li>
              <li><strong>Ignoring tire width:</strong> 25mm and 28mm tires need very different pressures</li>
              <li><strong>Never checking:</strong> Tires lose 1-2 PSI per week naturally</li>
              <li><strong>One-size-fits-all:</strong> Different rides need different pressures</li>
            </ul>

            <h2>The Comfort-Performance Balance</h2>
            <p>
              Modern research shows that slightly lower pressures often roll faster on real roads. The sweet spot balances rolling resistance, comfort, and puncture protection. Start with the recommendations above and adjust based on feel.
            </p>

            {/* CTA Section */}
            <div className="bg-[var(--bg-secondary)] rounded-lg p-6 my-8">
              <h3 className="text-xl font-bold mb-3">Calculate Your Optimal Tire Pressure</h3>
              <p className="text-[var(--text-secondary)] mb-4">
                Use CrankSmith's tire pressure calculator to find your perfect PSI based on your weight, tire size, and riding conditions.
              </p>
              <Link 
                href="/tire-pressure"
                className="inline-block bg-[var(--accent-blue)] hover:bg-[var(--accent-blue-hover)] px-4 py-2 rounded font-semibold transition-colors"
              >
                Try the Pressure Calculator
              </Link>
            </div>

            <p>
              Remember: the fastest tire pressure is the one that rolls smoothly over your actual roads. Experiment within the recommended ranges and pay attention to how your bike feels - your body will tell you when you've found the sweet spot.
            </p>
          </article>
        </div>
      </div>
    </>
  );
}```

### components/Layout.js
```
"use client";

import React, { useState, useEffect } from 'react';
import Link from 'next/link';
import Image from 'next/image';
import { useRouter } from 'next/router';
import InstallBanner from './InstallBanner';
import FloatingInstallButton from './FloatingInstallButton';
import FloatingAskRileyButton from './FloatingAskRileyButton';
import ErrorBoundary from './ErrorBoundary';
import ThemeToggle from './ThemeToggle';

export default function Layout({ children }) {
  const router = useRouter();
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
  const [scrolled, setScrolled] = useState(false);
  const [theme, setTheme] = useState('light');
  useEffect(() => {
    const handleScroll = () => {
      setScrolled(window.scrollY > 20);
    };

    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  useEffect(() => {
    // Load theme preference with fallback for incognito mode
    let savedTheme = 'light';
    
    try {
      // Try to access localStorage (may fail in incognito mode)
      savedTheme = localStorage.getItem('cranksmith-theme');
    } catch (error) {
      console.warn('localStorage not available, using system preference');
    }
    
    // If no saved theme or localStorage failed, use system preference
    if (!savedTheme) {
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        savedTheme = 'dark';
      } else {
        savedTheme = 'light';
      }
    }
    
    setTheme(savedTheme);
    document.documentElement.setAttribute('data-theme', savedTheme);
    
    // Listen for system theme changes
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
    const handleChange = (e) => {
      // Only auto-switch if no saved preference or localStorage is unavailable
      try {
        const hasSavedTheme = localStorage.getItem('cranksmith-theme');
        if (!hasSavedTheme) {
          const systemTheme = e.matches ? 'dark' : 'light';
          setTheme(systemTheme);
          document.documentElement.setAttribute('data-theme', systemTheme);
        }
      } catch (error) {
        // In incognito mode, always follow system preference
        const systemTheme = e.matches ? 'dark' : 'light';
        setTheme(systemTheme);
        document.documentElement.setAttribute('data-theme', systemTheme);
      }
    };
    
    mediaQuery.addEventListener('change', handleChange);
    return () => mediaQuery.removeEventListener('change', handleChange);
  }, []);

  const toggleTheme = () => {
    const newTheme = theme === 'light' ? 'dark' : 'light';
    setTheme(newTheme);
    document.documentElement.setAttribute('data-theme', newTheme);
    
    // Try to save theme preference (may fail in incognito mode)
    try {
      localStorage.setItem('cranksmith-theme', newTheme);
    } catch (error) {
      console.warn('Could not save theme preference - localStorage not available');
    }
  };

  const navLinks = [
    { href: '/calculator', label: 'Gear Calculator', icon: '‚öôÔ∏è' },
    { href: '/bike-fit', label: 'Bike Fit', icon: 'üö¥‚Äç‚ôÇÔ∏è' },
    { href: '/tire-pressure', label: 'Tire Pressure', icon: 'üîß' },
    { href: '/ask-riley', label: 'Ask Riley', icon: 'ü§ñ' },
    { href: '/blog', label: 'Learn', icon: 'üìö' },
    { href: '/about', label: 'About', icon: 'üë•' },
  ];

  const isActiveLink = (href) => {
    return router.pathname === href;
  };

  return (
    <div className="min-h-screen transition-colors duration-300 bg-neutral-50 dark:bg-neutral-950 text-neutral-900 dark:text-white" suppressHydrationWarning>
      <ErrorBoundary context="component">
        <InstallBanner />
      </ErrorBoundary>
      
      {/* Premium Navigation Header */}
      <header 
        className={`fixed top-0 left-0 right-0 z-50 transition-all duration-300 ${
          scrolled 
            ? 'bg-white/80 dark:bg-neutral-950/80 backdrop-blur-premium border-b border-neutral-200 dark:border-neutral-800'
            : 'bg-transparent'
        }`}
        suppressHydrationWarning
      >
        <nav className="container-responsive">
          <div className="flex items-center justify-between h-20">
            {/* Logo */}
            <Link href="/" className="flex items-center gap-3 group">
              <div className="relative">
                <div className="absolute inset-0 bg-gradient-performance rounded-2xl blur-lg opacity-0 group-hover:opacity-50 transition-opacity duration-300" />
                <div className="relative w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg p-1 bg-white dark:bg-neutral-800">
                  <Image 
                    src="/cranksmith-logo.png" 
                    alt="CrankSmith" 
                    width={40}
                    height={40}
                    className="object-contain"
                  />
                </div>
              </div>
              <div className="flex flex-col">
                <span className="text-xl font-bold bg-gradient-performance bg-clip-text text-transparent">
                  CrankSmith
                </span>
                <span className="text-xs font-medium text-neutral-500 dark:text-neutral-400">
                  Precision Gear Analysis
                </span>
              </div>
            </Link>

            {/* Desktop Navigation */}
            <div className="hidden md:flex items-center gap-8">
              {navLinks.map((link) => (
                <Link
                  key={link.href}
                  href={link.href}
                  className={`relative px-4 py-2 text-sm font-medium transition-all duration-300 ${
                    isActiveLink(link.href)
                      ? 'text-brand-blue'
                      : 'text-neutral-600 dark:text-neutral-300 hover:text-neutral-900 dark:hover:text-white'
                  }`}
                >
                  {isActiveLink(link.href) && (
                    <div className="absolute inset-0 bg-brand-blue/10 rounded-xl" />
                  )}
                  <span className="relative flex items-center gap-2">
                    <span className="text-base">{link.icon}</span>
                    {link.label}
                  </span>
                </Link>
              ))}
            </div>

            {/* Right Actions */}
            <div className="hidden md:flex items-center gap-4">
              <ThemeToggle theme={theme} toggleTheme={toggleTheme} />
              
              <Link 
                href="https://instagram.com/cranksmithapp" 
                target="_blank" 
                rel="noopener noreferrer"
                className={`p-2 rounded-xl hover:text-brand-blue transition-colors ${
                  'text-neutral-600 dark:text-neutral-300'
                }`}
              >
                <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                </svg>
              </Link>
            </div>

            {/* Mobile Menu Button */}
            <button
              onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
              className="md:hidden p-2 rounded-xl transition-colors text-neutral-600 dark:text-neutral-300 hover:bg-neutral-100 dark:hover:bg-neutral-800"
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                {isMobileMenuOpen ? (
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                ) : (
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
                )}
              </svg>
            </button>
          </div>
        </nav>

        {/* Mobile Navigation Menu */}
        <div className={`md:hidden transition-all duration-300 ease-out-expo ${
          isMobileMenuOpen ? 'max-h-96 opacity-100' : 'max-h-0 opacity-0'
        } overflow-hidden backdrop-blur-premium border-t bg-white/95 dark:bg-neutral-950/95 border-neutral-200 dark:border-neutral-800`}>
          <nav className="container-responsive py-6">
            <div className="space-y-4">
              {navLinks.map((link) => (
                <Link
                  key={link.href}
                  href={link.href}
                  className={`flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 ${
                    isActiveLink(link.href)
                      ? 'bg-brand-blue/10 text-brand-blue'
                      : 'text-neutral-600 dark:text-neutral-300 hover:bg-neutral-100 dark:hover:bg-neutral-800'
                  }`}
                  onClick={() => setIsMobileMenuOpen(false)}
                >
                  <span className="text-lg">{link.icon}</span>
                  <span className="font-medium">{link.label}</span>
                </Link>
              ))}
            </div>
            
            <div className="flex items-center justify-between mt-6 pt-6 border-t border-neutral-200 dark:border-neutral-800">
              <div className="flex items-center gap-4">
                <ThemeToggle theme={theme} toggleTheme={toggleTheme} />
                <Link 
                  href="https://instagram.com/cranksmithapp" 
                  target="_blank" 
                  rel="noopener noreferrer"
                  className="p-2 rounded-xl hover:text-brand-blue transition-colors text-neutral-600 dark:text-neutral-300"
                >
                  <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                  </svg>
                </Link>
              </div>
            </div>
          </nav>
        </div>
      </header>

      {/* Main Content */}
      <main className="pt-20">
        {children}
      </main>

      {/* Floating Install Button */}
      <ErrorBoundary context="component">
        <FloatingInstallButton />
      </ErrorBoundary>

      {/* Floating Ask Riley Button */}
      <ErrorBoundary context="component">
        <FloatingAskRileyButton />
      </ErrorBoundary>

      {/* Premium Footer */}
      <footer className="border-t mt-20 py-12 border-neutral-200 dark:border-neutral-800 bg-neutral-50 dark:bg-neutral-900">
        <div className="container-responsive">
          <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
            {/* Brand Section */}
            <div>
              <div className="flex items-center gap-3 mb-4">
                <div className={`w-8 h-8 rounded-lg flex items-center justify-center p-1 ${
                  'bg-white dark:bg-neutral-800'
                }`}>
                  <Image 
                    src="/cranksmith-logo.png" 
                    alt="CrankSmith" 
                    width={24}
                    height={24}
                    className="object-contain"
                  />
                </div>
                <span className="text-lg font-bold bg-gradient-performance bg-clip-text text-transparent">
                  CrankSmith
                </span>
              </div>
              <p className={`text-sm leading-relaxed ${
                'text-neutral-600 dark:text-neutral-400'
              }`}>
                Precision tools for modern cyclists. Analyze your gear ratios, optimize your setup, and ride with confidence.
              </p>
            </div>

            {/* Quick Links */}
            <div>
              <h3 className={`font-semibold mb-4 ${
                'text-neutral-900 dark:text-white'
              }`}>Tools</h3>
              <nav className="space-y-2">
                {navLinks.map((link) => (
                  <Link
                    key={link.href}
                    href={link.href}
                    className={`block text-sm hover:text-brand-blue transition-colors ${
                      'text-neutral-600 dark:text-neutral-400'
                    }`}
                  >
                    {link.label}
                  </Link>
                ))}
              </nav>
            </div>

            {/* Contact */}
            <div>
              <h3 className={`font-semibold mb-4 ${
                'text-neutral-900 dark:text-white'
              }`}>Connect</h3>
              <div className="space-y-2">
                <a 
                  href="mailto:mike@cranksmith.com" 
                  className={`block text-sm hover:text-brand-blue transition-colors ${
                    'text-neutral-600 dark:text-neutral-400'
                  }`}
                >
                  mike@cranksmith.com
                </a>
                <a 
                  href="https://instagram.com/cranksmithapp" 
                  target="_blank" 
                  rel="noopener noreferrer"
                  className={`block text-sm hover:text-brand-blue transition-colors ${
                    'text-neutral-600 dark:text-neutral-400'
                  }`}
                >
                  @cranksmithapp
                </a>
              </div>
            </div>
          </div>

          <div className={`border-t mt-8 pt-8 flex flex-col md:flex-row justify-between items-center ${
            'border-neutral-200 dark:border-neutral-800'
          }`}>
            <p className={`text-xs ${
              'text-neutral-500 dark:text-neutral-400'
            }`}>
              ¬© {new Date().getFullYear()} CrankSmith. All rights reserved.
            </p>
            <div className="flex items-center gap-4 mt-4 md:mt-0">
              <Link href="/docs" className={`text-xs hover:text-brand-blue transition-colors ${
                'text-neutral-500 dark:text-neutral-400'
              }`}>
                Docs
              </Link>
              <Link href="/blog" className={`text-xs hover:text-brand-blue transition-colors ${
                'text-neutral-500 dark:text-neutral-400'
              }`}>
                Blog
              </Link>
            </div>
          </div>
        </div>
      </footer>
    </div>
  );
}

```

### components/ErrorBoundary.js
```
// components/ErrorBoundary.js - Error boundary component to catch React errors
import React from 'react';

export default class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null, errorInfo: null };
  }

  static getDerivedStateFromError(error) {
    // Update state so the next render will show the fallback UI
    return { hasError: true };
  }

  componentDidCatch(error, errorInfo) {
    // Log the error to console and any error reporting service
    console.error('ErrorBoundary caught an error:', error);
    console.error('Error info:', errorInfo);
    
    // Store error details for debugging
    this.setState({
      error: error,
      errorInfo: errorInfo
    });

    // You can also log the error to an error reporting service here
    // e.g., Sentry, LogRocket, etc.
  }

  handleReset = () => {
    this.setState({ hasError: false, error: null, errorInfo: null });
  }

  handleReload = () => {
    window.location.reload();
  }

  render() {
    if (this.state.hasError) {
      // Fallback UI based on the context
      const { fallback, context = 'component' } = this.props;
      
      if (fallback) {
        return fallback;
      }

      // Default fallback UI with different styles based on context
      const containerStyle = context === 'page' ? 'min-h-screen' : 'min-h-[200px]';
      const titleSize = context === 'page' ? 'text-xl' : 'text-lg';
      
      return (
        <div className={`${containerStyle} flex items-center justify-center p-8 error-boundary-fallback`}>
          <div className="text-center max-w-md mx-auto">
            <div className="mb-6">
              <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-red-100 flex items-center justify-center">
                <svg className="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
            </div>
            
            <h3 className={`${titleSize} font-semibold mb-2`} style={{ color: 'var(--text-primary)' }}>
              Something went wrong
            </h3>
            
            <p className="text-sm mb-6" style={{ color: 'var(--text-secondary)' }}>
              {context === 'page' 
                ? "We're having trouble loading this page. Please try refreshing or contact support if the issue persists."
                : "This component encountered an error. You can try refreshing the page or continue using other features."
              }
            </p>
            
            <div className="flex flex-col sm:flex-row gap-3 justify-center">
              <button
                onClick={this.handleReset}
                className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm font-medium"
              >
                Try Again
              </button>
              
              <button
                onClick={this.handleReload}
                className="px-4 py-2 border rounded-md transition-colors text-sm font-medium"
                style={{ 
                  borderColor: 'var(--border-light)', 
                  color: 'var(--text-primary)',
                  backgroundColor: 'var(--bg-secondary)'
                }}
                onMouseEnter={(e) => {
                  e.target.style.backgroundColor = 'var(--bg-tertiary)';
                }}
                onMouseLeave={(e) => {
                  e.target.style.backgroundColor = 'var(--bg-secondary)';
                }}
              >
                Refresh Page
              </button>
            </div>
            
            {/* Debug info in development */}
            {process.env.NODE_ENV === 'development' && this.state.error && (
              <details className="mt-6 text-left">
                <summary className="cursor-pointer text-sm font-medium mb-2" style={{ color: 'var(--text-tertiary)' }}>
                  Debug Info (Development Only)
                </summary>
                <pre className="text-xs p-3 rounded overflow-auto max-h-40" style={{ 
              backgroundColor: 'var(--bg-tertiary)',
              color: 'var(--text-primary)',
              border: `1px solid var(--border-primary)`
            }}>
                  {this.state.error.toString()}
                  {this.state.errorInfo && this.state.errorInfo.componentStack}
                </pre>
              </details>
            )}
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}

// HOC wrapper for functional components
export const withErrorBoundary = (Component, errorBoundaryProps = {}) => {
  return function WrappedComponent(props) {
    return (
      <ErrorBoundary {...errorBoundaryProps}>
        <Component {...props} />
      </ErrorBoundary>
    );
  };
}; ```

### components/Toast.tsx
```
import React, { useState, useEffect } from 'react';
import { Toast, ToastType, ToastAPI, ToastAction } from '../types';

let toastId = 0;
const toastStack: Toast[] = [];
let toastListener: ((toasts: Toast[]) => void) | null = null;

export const toast: ToastAPI = {
  success: (message: string, duration = 4000) => {
    showToast({ type: 'success', message, duration });
  },
  error: (message: string, duration = 6000) => {
    showToast({ type: 'error', message, duration });
  },
  warning: (message: string, duration = 5000) => {
    showToast({ type: 'warning', message, duration });
  },
  info: (message: string, duration = 4000) => {
    showToast({ type: 'info', message, duration });
  }
};

function showToast({ type, message, duration, actions }: { 
  type: ToastType; 
  message: string; 
  duration: number; 
  actions?: ToastAction[] 
}): void {
  const id = ++toastId;
  const newToast: Toast = { id, type, message, duration, actions };
  
  toastStack.push(newToast);
  
  if (toastListener) {
    toastListener([...toastStack]);
  }
  
  // Auto remove after duration (but not if there are actions)
  if (!actions || actions.length === 0) {
    setTimeout(() => {
      removeToast(id);
    }, duration);
  } else {
    // For toasts with actions, auto-remove after a longer duration
    setTimeout(() => {
      removeToast(id);
    }, duration * 2);
  }
}

function removeToast(id: number): void {
  const index = toastStack.findIndex(toast => toast.id === id);
  if (index > -1) {
    toastStack.splice(index, 1);
    if (toastListener) {
      toastListener([...toastStack]);
    }
  }
}

export function ToastContainer(): JSX.Element | null {
  const [toasts, setToasts] = useState<Toast[]>([]);

  useEffect(() => {
    toastListener = setToasts;
    setToasts([...toastStack]);

    // Listen for custom mobile suggestion events
    const handleMobileSuggestion = (event: CustomEvent) => {
      const { message, type, duration, actions } = event.detail;
      showToast({ type, message, duration, actions });
    };

    window.addEventListener('show-mobile-suggestion', handleMobileSuggestion as EventListener);
    
    return () => {
      toastListener = null;
      window.removeEventListener('show-mobile-suggestion', handleMobileSuggestion as EventListener);
    };
  }, []);

  if (toasts.length === 0) return null;

  return (
    <div className="fixed top-4 right-4 z-50 space-y-2 max-w-sm">
      {toasts.map((toast) => (
        <ToastItem 
          key={toast.id} 
          toast={toast} 
          onClose={() => removeToast(toast.id)} 
        />
      ))}
    </div>
  );
}

interface ToastItemProps {
  toast: Toast;
  onClose: () => void;
}

function ToastItem({ toast, onClose }: ToastItemProps): JSX.Element {
  const [isVisible, setIsVisible] = useState<boolean>(false);

  useEffect(() => {
    // Trigger animation after mount
    const timer = setTimeout(() => setIsVisible(true), 10);
    return () => clearTimeout(timer);
  }, []);

  const handleClose = (): void => {
    setIsVisible(false);
    setTimeout(onClose, 300); // Wait for animation
  };

  const typeStyles = {
    success: {
      bg: 'bg-green-500/10 border-green-500/30',
      icon: '‚úì',
      iconColor: 'text-green-500'
    },
    error: {
      bg: 'bg-red-500/10 border-red-500/30',
      icon: '‚úï',
      iconColor: 'text-red-500'
    },
    warning: {
      bg: 'bg-yellow-500/10 border-yellow-500/30',
      icon: '‚ö†',
      iconColor: 'text-yellow-500'
    },
    info: {
      bg: 'bg-blue-500/10 border-blue-500/30',
      icon: '‚Ñπ',
      iconColor: 'text-blue-500'
    }
  };

  const style = typeStyles[toast.type] || typeStyles.info;

  return (
    <div
      className={`
        ${style.bg} border backdrop-blur-sm rounded-lg p-4 shadow-lg
        transform transition-all duration-300 ease-out
        ${isVisible ? 'translate-x-0 opacity-100' : 'translate-x-full opacity-0'}
      `}
    >
      <div className="flex items-start gap-3">
        <div className={`${style.iconColor} font-bold text-lg leading-none mt-0.5`}>
          {style.icon}
        </div>
        <div className="flex-1 min-w-0">
          <p className="text-sm text-[var(--text-primary)] break-words">
            {toast.message}
          </p>
          {toast.actions && toast.actions.length > 0 && (
            <div className="flex gap-2 mt-3">
              {toast.actions.map((action, index) => (
                <button
                  key={index}
                  onClick={() => {
                    action.onClick();
                    handleClose();
                  }}
                  className={`
                    px-3 py-1.5 text-xs font-medium rounded-md transition-colors
                    ${action.variant === 'primary' 
                      ? 'bg-blue-600 text-white hover:bg-blue-700' 
                      : 'bg-neutral-200 dark:bg-neutral-700 text-[var(--text-primary)] hover:bg-neutral-300 dark:hover:bg-neutral-600'
                    }
                  `}
                >
                  {action.label}
                </button>
              ))}
            </div>
          )}
        </div>
        <button
          onClick={handleClose}
          className="text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors"
        >
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>
  );
}```

### components/SearchableDropdown.tsx
```
// components/SearchableDropdown.tsx - Enhanced with TypeScript and performance optimizations
import React, { useState, useRef, useEffect, useMemo, useCallback } from 'react';
import { FixedSizeList as List } from 'react-window';
import { DropdownOption, GroupedOptions } from '../types';

interface SearchableDropdownProps {
  options: DropdownOption[];
  value?: DropdownOption | string | null;
  onChange: (value: DropdownOption | null) => void;
  placeholder?: string;
  groupBy?: (option: DropdownOption) => string;
  className?: string;
  searchable?: boolean;
  debounceMs?: number;
}

export default function SearchableDropdown({
  options = [],
  value,
  onChange,
  placeholder = 'Select an option',
  groupBy,
  className = '',
  searchable = true,
  debounceMs = 150
}: SearchableDropdownProps): JSX.Element {

  const [isOpen, setIsOpen] = useState<boolean>(false);
  const [searchTerm, setSearchTerm] = useState<string>('');
  const [debouncedSearchTerm, setDebouncedSearchTerm] = useState<string>('');
  const [highlightedIndex, setHighlightedIndex] = useState<number>(0);
  const triggerRef = useRef<HTMLButtonElement>(null);
  const inputRef = useRef<HTMLInputElement>(null);
  const dropdownRef = useRef<HTMLDivElement>(null);
  const listRef = useRef<List>(null);
  const focusTimeout = useRef<NodeJS.Timeout | null>(null);
  const debounceTimeout = useRef<NodeJS.Timeout | null>(null);

  // Debounced search implementation
  useEffect(() => {
    if (debounceTimeout.current) {
      clearTimeout(debounceTimeout.current);
    }
    
    debounceTimeout.current = setTimeout(() => {
      setDebouncedSearchTerm(searchTerm);
    }, debounceMs);

    return () => {
      if (debounceTimeout.current) {
        clearTimeout(debounceTimeout.current);
      }
    };
  }, [searchTerm, debounceMs]);

  // Find selected option with improved type safety
  const selectedOption = useMemo((): DropdownOption | null => {
    if (!value) return null;
    
    if (typeof value === 'object' && value.id) {
      return options.find(opt => opt.id === value.id) || null;
    } else {
      return options.find(opt => opt.id === value) || null;
    }
  }, [options, value]);

  // Enhanced filtering with debounced search and better performance
  const filteredOptions = useMemo((): DropdownOption[] => {
    if (!debouncedSearchTerm || !searchable) return options;
    
    const searchLower = debouncedSearchTerm.toLowerCase();
    const searchTerms = searchLower.split(' ').filter(Boolean);
    
    return options.filter(option => {
      if (!option) return false;
      
      const searchableText = [
        option.model || '',
        option.variant || '',
        option.label || '',
        option.speeds || '',
        option.weight?.toString() || '',
        option.teeth?.join(',') || ''
      ].join(' ').toLowerCase();
      
      // All search terms must match
      return searchTerms.every(term => searchableText.includes(term));
    });
  }, [options, debouncedSearchTerm, searchable]);

  // Group options if groupBy function provided with better typing
  const groupedOptions = useMemo((): GroupedOptions => {
    if (!groupBy) return { 'All': filteredOptions };
    
    return filteredOptions.reduce((acc: GroupedOptions, option) => {
      const group = groupBy(option);
      if (!acc[group]) acc[group] = [];
      acc[group].push(option);
      return acc;
    }, {});
  }, [filteredOptions, groupBy]);

  // Flatten grouped options for virtualization with proper typing
  interface FlattenedItem {
    type: 'group' | 'option';
    name?: string;
    data?: DropdownOption;
  }

  const flattenedOptions = useMemo((): FlattenedItem[] => {
    const flattened: FlattenedItem[] = [];
    Object.entries(groupedOptions).forEach(([groupName, groupOptions]) => {
      if (groupBy && Object.keys(groupedOptions).length > 1) {
        flattened.push({ type: 'group', name: groupName });
      }
      flattened.push(...groupOptions.map(opt => ({ type: 'option' as const, data: opt })));
    });
    
    return flattened;
  }, [groupedOptions, groupBy]);

  // Handle selection with proper typing
  const handleSelect = useCallback((option: DropdownOption | null): void => {
    if (option) {
      onChange(option);
      setIsOpen(false);
      setSearchTerm('');
      setDebouncedSearchTerm('');
      setHighlightedIndex(0);
    }
  }, [onChange]);

  // Handle keyboard navigation with proper typing
  const handleKeyDown = useCallback((e: React.KeyboardEvent): void => {
    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        setHighlightedIndex(prev => {
          const newIndex = Math.min(prev + 1, flattenedOptions.length - 1);
          // Skip group headers
          if (flattenedOptions[newIndex]?.type === 'group' && newIndex < flattenedOptions.length - 1) {
            return newIndex + 1;
          }
          return newIndex;
        });
        break;
      case 'ArrowUp':
        e.preventDefault();
        setHighlightedIndex(prev => {
          const newIndex = Math.max(prev - 1, 0);
          // Skip group headers
          if (flattenedOptions[newIndex]?.type === 'group' && newIndex > 0) {
            return newIndex - 1;
          }
          return newIndex;
        });
        break;
      case 'Enter':
        e.preventDefault();
        const highlighted = flattenedOptions[highlightedIndex];
        if (highlighted?.type === 'option' && highlighted.data) {
          handleSelect(highlighted.data);
        }
        break;
      case 'Escape':
        e.preventDefault();
        setIsOpen(false);
        break;
    }
  }, [flattenedOptions, highlightedIndex, handleSelect]);

  // Scroll highlighted item into view
  useEffect(() => {
    if (listRef.current && highlightedIndex >= 0) {
      listRef.current.scrollToItem(highlightedIndex, 'smart');
    }
  }, [highlightedIndex]);

  // Click outside to close with proper typing
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent | TouchEvent): void => {
      const target = event.target as Node;
      if (
        dropdownRef.current &&
        !dropdownRef.current.contains(target) &&
        triggerRef.current &&
        !triggerRef.current.contains(target)
      ) {
        setIsOpen(false);
      }
    };

    if (isOpen) {
      document.addEventListener('mousedown', handleClickOutside);
      document.addEventListener('touchstart', handleClickOutside);
      
      // Focus search input with cleanup
      if (inputRef.current && searchable) {
        focusTimeout.current = setTimeout(() => inputRef.current?.focus(), 100);
      }
    }

    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
      document.removeEventListener('touchstart', handleClickOutside);
      
      // Clear focus timeout to prevent memory leaks
      if (focusTimeout.current) {
        clearTimeout(focusTimeout.current);
        focusTimeout.current = null;
      }
    };
  }, [isOpen, searchable]);

  // Reset highlighted index when search changes
  useEffect(() => {
    setHighlightedIndex(0);
  }, [debouncedSearchTerm]);

  const displayValue = selectedOption ? 
    `${selectedOption.model} ${selectedOption.variant}`.trim() : '';

  // Row renderer for react-window with proper typing
  interface RowProps {
    index: number;
    style: React.CSSProperties;
  }

  const Row = ({ index, style }: RowProps): JSX.Element => {
    const item = flattenedOptions[index];
    
    if (item.type === 'group') {
      return (
        <div
          style={{
            ...style,
            padding: '8px 12px',
            background: 'var(--bg-secondary)',
            color: 'var(--text-secondary)',
            borderBottom: '1px solid var(--border-subtle)',
            fontSize: '12px',
            fontWeight: '600',
            position: 'sticky',
            top: 0,
            zIndex: 1
          }}
        >
          {item.name}
        </div>
      );
    }

    const option = item.data;
    if (!option) return <div style={style}></div>;
    
    const isHighlighted = index === highlightedIndex;
    const isSelected = selectedOption?.id === option.id;

    return (
      <div
        style={{
          ...style,
          padding: '12px 16px',
          cursor: 'pointer',
          background: isHighlighted 
            ? 'rgb(var(--brand-blue))' 
            : isSelected 
              ? 'rgb(var(--bg-tertiary))' 
              : 'transparent',
          color: isHighlighted ? 'white' : 'rgb(var(--text-primary))',
          transition: 'background-color 0.1s ease'
        }}
        onClick={() => handleSelect(option)}
        onMouseEnter={() => setHighlightedIndex(index)}
      >
        <div style={{ display: 'flex', alignItems: 'baseline', justifyContent: 'space-between', gap: '12px' }}>
          <div style={{ fontWeight: '500', fontSize: '16px' }}>
            {option.model}
          </div>
          <div 
            style={{ 
              fontSize: '14px',
              fontWeight: '400',
              flexShrink: 0,
              color: isHighlighted 
                ? 'rgba(255,255,255,0.85)' 
                : 'rgb(var(--text-tertiary))'
            }}
          >
            {option.weight}g
          </div>
        </div>
        <div 
          style={{ 
            fontSize: '14px',
            marginTop: '4px',
            color: isHighlighted 
              ? 'rgba(255,255,255,0.75)' 
              : 'rgb(var(--text-tertiary))'
          }}
        >
          {option.variant}
        </div>
      </div>
    );
  };



  return (
    <div className={`relative searchable-dropdown ${className}`}>
      {/* Trigger Button */}
      <button
        ref={triggerRef}
        type="button"
        disabled={options.length === 0}
        onClick={() => {
          if (options.length === 0) {
            // console.log('üñ±Ô∏è Dropdown trigger clicked but no options available');
            return;
          }
          // console.log('üñ±Ô∏è Dropdown trigger clicked:', {
          //   placeholder,
          //   currentIsOpen: isOpen,
          //   willBeOpen: !isOpen,
          //   optionsLength: options?.length || 0,
          //   flattenedOptionsLength: flattenedOptions?.length || 0
          // });
          setIsOpen(!isOpen);
        }}
        className={`input-field flex items-center justify-between w-full ${
          options.length === 0 ? 'cursor-not-allowed opacity-60' : 'cursor-pointer'
        }`}
        style={{ 
          background: isOpen ? 'rgb(var(--bg-elevated))' : 'rgb(var(--bg-secondary))',
          borderColor: isOpen ? 'rgb(var(--border-focus))' : 'rgb(var(--border-primary))',
          color: 'rgb(var(--text-primary))',
          minHeight: '48px'
        }}
      >
        <span className={displayValue ? '' : 'opacity-60'} style={{ fontSize: '16px' }}>
          {displayValue || placeholder}
        </span>
        <svg 
          className={`w-4 h-4 transition-transform ${isOpen ? 'rotate-180' : ''}`}
          fill="none" 
          stroke="currentColor" 
          viewBox="0 0 24 24"
        >
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      {/* Dropdown Portal */}
      {isOpen && (
        <div
          ref={dropdownRef}
          className="absolute z-[9999] w-full mt-1"
          style={{
            background: 'rgb(var(--bg-elevated))',
            boxShadow: 'var(--shadow-lg)',
            borderRadius: '12px',
            border: '1px solid rgb(var(--border-primary))',
            maxHeight: '400px',
            display: 'flex',
            flexDirection: 'column'
          }}
        >
          {/* Search Input */}
          <div className="p-3 border-b" style={{ borderColor: 'rgb(var(--border-primary))' }}>
            <input
              ref={inputRef}
              type="text"
              placeholder="Type to search..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              onKeyDown={handleKeyDown}
              className="input-premium"
              style={{ 
                fontSize: '16px'
              }}
              autoComplete="off"
              autoCorrect="off"
              autoCapitalize="off"
              spellCheck="false"
            />
          </div>

          {/* Options List with Virtualization */}
          <div style={{ flex: 1, minHeight: 0 }}>
            {flattenedOptions.length === 0 ? (
              <div className="px-4 py-6 text-center">
                <div className="text-base mb-2" style={{ color: 'var(--text-secondary)' }}>
                  {searchTerm ? 'No matching components found' : 'No components available'}
                </div>
                {!searchTerm && (
                  <div className="text-sm" style={{ color: 'var(--text-tertiary)' }}>
                    {options.length === 0 ? 'Please select a bike type first' : 'Try adjusting your search'}
                  </div>
                )}
              </div>
            ) : (
              <>
                {/* console.log('üìã About to render List:', {
                  placeholder,
                  flattenedOptionsLength: flattenedOptions.length,
                  listHeight: Math.min(300, flattenedOptions.length * 64),
                  itemCount: flattenedOptions.length
                }) */}
                <List
                  ref={listRef}
                  height={Math.min(300, flattenedOptions.length * 64)}
                  itemCount={flattenedOptions.length}
                  itemSize={64}
                  width="100%"
                  overscanCount={5}
                >
                  {Row}
                </List>
              </>
            )}
          </div>
        </div>
      )}
    </div>
  );
}

// Export grouping functions for backward compatibility
export const groupByBrand = (component: DropdownOption): string => {
  if (component.model?.includes('Shimano')) return 'Shimano';
  if (component.model?.includes('SRAM')) return 'SRAM';
  if (component.model?.includes('Campagnolo')) return 'Campagnolo';
  return 'Other';
};

export const groupBySeries = (component: DropdownOption): string => {
  const model = component.model?.toLowerCase() || '';
  
  // Shimano series
  if (model.includes('xtr') && model.includes('di2')) return 'XTR Di2';
  if (model.includes('dura-ace')) return 'Dura-Ace';
  if (model.includes('ultegra')) return 'Ultegra';
  if (model.includes('105')) return '105';
  if (model.includes('xtr')) return 'XTR';
  if (model.includes('xt ')) return 'XT';
  if (model.includes('slx')) return 'SLX';
  if (model.includes('deore')) return 'Deore';
  if (model.includes('grx')) return 'GRX';
  
  // SRAM series
  if (model.includes('red')) return 'Red';
  if (model.includes('force')) return 'Force';
  if (model.includes('rival')) return 'Rival';
  if (model.includes('gx')) return 'GX';
  if (model.includes('nx')) return 'NX';
  
  return 'Other';
};
```

### components/SearchableDropdown/index.js
```
import React, { useState, useRef, useEffect } from 'react';
import DropdownTrigger from './DropdownTrigger';
import DropdownPortal from './DropdownPortal';

const SearchableDropdown = ({
  options,
  value,
  onChange,
  placeholder,
  groupBy,
  className = ''
}) => {
  const [isOpen, setIsOpen] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [highlightedIndex, setHighlightedIndex] = useState(0);
  const triggerRef = useRef(null);
  const inputRef = useRef(null);

  const selectedOption = options.find(opt => opt.id === value);

  const filteredOptions = options.filter(option => {
    const searchLower = searchTerm.toLowerCase();
    return (
      option.model.toLowerCase().includes(searchLower) ||
      option.variant.toLowerCase().includes(searchLower) ||
      option.weight.toString().includes(searchTerm)
    );
  });

  const groupedOptions = filteredOptions.reduce((acc, option) => {
    const group = groupBy ? option[groupBy] : 'All';
    if (!acc[group]) {
      acc[group] = [];
    }
    acc[group].push(option);
    return acc;
  }, {});

  const handleSelect = (option) => {
    onChange(option.id);
    setIsOpen(false);
    setSearchTerm('');
    setHighlightedIndex(0);
  };

  const handleKeyDown = (e) => {
    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        setHighlightedIndex(prev => 
          prev < filteredOptions.length - 1 ? prev + 1 : prev
        );
        break;
      case 'ArrowUp':
        e.preventDefault();
        setHighlightedIndex(prev => prev > 0 ? prev - 1 : prev);
        break;
      case 'Enter':
        e.preventDefault();
        if (filteredOptions[highlightedIndex]) {
          handleSelect(filteredOptions[highlightedIndex]);
        }
        break;
      case 'Escape':
        e.preventDefault();
        setIsOpen(false);
        break;
    }
  };

  useEffect(() => {
    const handleClickOutside = (e) => {
      if (
        triggerRef.current &&
        !triggerRef.current.contains(e.target) &&
        !e.target.closest('.dropdown-portal')
      ) {
        setIsOpen(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  return (
    <div className={`relative ${className}`}>
      <DropdownTrigger
        isOpen={isOpen}
        displayValue={selectedOption?.model}
        placeholder={placeholder}
        onClick={() => setIsOpen(true)}
        triggerRef={triggerRef}
      />
      <DropdownPortal
        isOpen={isOpen}
        triggerRef={triggerRef}
        searchTerm={searchTerm}
        setSearchTerm={setSearchTerm}
        setHighlightedIndex={setHighlightedIndex}
        handleKeyDown={handleKeyDown}
        inputRef={inputRef}
        groupedOptions={groupedOptions}
        groupBy={groupBy}
        filteredOptions={filteredOptions}
        highlightedIndex={highlightedIndex}
        selectedOption={selectedOption}
        handleSelect={handleSelect}
        onClose={() => setIsOpen(false)}
      />
    </div>
  );
};

export default SearchableDropdown; ```

### components/GearSelectorPanel.js
```
import React, { useCallback, useMemo } from 'react';
import SearchableDropdown from './SearchableDropdown';
import { useComponentDatabase } from '../hooks/useComponentDatabase';

const GearSelectorPanel = React.memo(({ 
  title,
  subtitle,
  badge,
  badgeColor,
  setup,
  setSetup,
  config,
  bikeType,
  icon: Icon 
}) => {
  // Use the optimized hook for component loading (must be called before any conditional returns)
  const { components, loading, error } = useComponentDatabase(bikeType);

  // Transform components data for SearchableDropdown - memoized to prevent recalculation
  const cranksetOptions = useMemo(() => 
    components?.cranksets?.map(crankset => ({
      id: crankset.id,
      label: `${crankset.model} ${crankset.variant}`,
      model: crankset.model,
      variant: crankset.variant,
      teeth: crankset.teeth,
      speeds: crankset.speeds,
      weight: crankset.weight,
      bikeType: crankset.bikeType
    })) || [], [components?.cranksets]
  );

  const cassetteOptions = useMemo(() => 
    components?.cassettes?.map(cassette => ({
      id: cassette.id,
      label: `${cassette.model} ${cassette.variant}`,
      model: cassette.model,
      variant: cassette.variant,
      teeth: cassette.teeth,
      speeds: cassette.speeds,
      weight: cassette.weight,
      bikeType: cassette.bikeType
    })) || [], [components?.cassettes]
  );

  // Memoized event handlers to prevent unnecessary re-renders
  const handleCranksetChange = useCallback((selectedOption) => {
    setSetup({ ...setup, crankset: selectedOption });
    if (config?.onCranksetChange) {
      config.onCranksetChange(selectedOption);
    }
  }, [setup, setSetup, config]);

  const handleCassetteChange = useCallback((selectedOption) => {
    setSetup({ ...setup, cassette: selectedOption });
    if (config?.onCassetteChange) {
      config.onCassetteChange(selectedOption);
    }
  }, [setup, setSetup, config]);

  const handleWheelChange = useCallback((value) => {
    config.onWheelChange(value);
  }, [config]);

  const handleTireChange = useCallback((value) => {
    config.onTireChange(value);
  }, [config]);

  // Early return if bikeType is not set - prevents empty options rendering
  if (!bikeType || bikeType === '') {
    return (
      <div className="card group">
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-lg bg-blue-500/10 text-blue-500">
              {Icon}
            </div>
            <div>
              <h3 className="text-lg font-semibold text-[var(--text-primary)]">{title}</h3>
              <p className="text-sm text-[var(--text-secondary)]">{subtitle}</p>
            </div>
          </div>
          {badge && (
            <div className={`px-3 py-1 rounded-full text-xs font-medium ${badgeColor || 'badge'}`}>
              {badge}
            </div>
          )}
        </div>
        <div className="text-center py-8">
          <div className="text-[var(--text-secondary)] text-sm">
            Please select a bike type to view components
          </div>
        </div>
      </div>
    );
  }

  // Enhanced debug logging with better context
  // console.log(`üîç GearSelectorPanel (${title}):`, {
  //   bikeType,
  //   components,
  //   cranksets: components?.cranksets,
  //   cassettes: components?.cassettes,
  //   cranksetsLength: components?.cranksets?.length,
  //   cassettesLength: components?.cassettes?.length,
  //   setup,
  //   config,
  //   loading,
  //   error,
  //   context: `Rendering for bikeType: ${bikeType}`
  // });

  // console.log(`üîß Transformed options for ${title}:`, {
  //   cranksetOptions: cranksetOptions,
  //   cassetteOptions: cassetteOptions,
  //   cranksetOptionsLength: cranksetOptions?.length || 0,
  //   cassetteOptionsLength: cassetteOptions?.length || 0,
  //   firstCrankset: cranksetOptions[0],
  //   firstCassette: cassetteOptions[0]
  // });



  // Show loading state if components are still loading
  if (loading) {
    return (
      <div className="card group">
        <div className="flex items-center justify-center py-8">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2" style={{ borderColor: 'var(--accent-blue)' }}></div>
          <span className="ml-3" style={{ color: 'var(--text-secondary)' }}>Loading components...</span>
        </div>
      </div>
    );
  }

  // Show error state if there was an error loading components
  if (error) {
    return (
      <div className="card group">
        <div className="flex items-center justify-center py-8">
          <span className="text-red-500">Error loading components: {error}</span>
        </div>
      </div>
    );
  }

  return (
    <div className="card group">
      {/* Card Header */}
      <div className="flex items-start justify-between mb-6">
        <div className="flex items-center space-x-3">
          <div className="w-10 h-10 rounded-xl flex items-center justify-center" 
               style={{ 
                 background: 'var(--surface-elevated)', 
                 color: 'var(--accent-blue)' 
               }}>
            {Icon}
          </div>
          <div>
            <h3 className="text-xl font-semibold" style={{ color: 'var(--text-primary)' }}>
              {title}
            </h3>
            <p className="text-sm" style={{ color: 'var(--text-tertiary)' }}>
              {subtitle}
            </p>
          </div>
        </div>
        <span className="px-3 py-1 rounded-lg text-xs font-semibold text-white"
              style={{ background: badgeColor }}>
          {badge}
        </span>
      </div>

      {/* Form Fields */}
      <div className="space-y-5">
        {/* Wheel Size Selection */}
        <div>
          <label className="form-label">Wheel Size</label>
          <select
            value={setup.wheel}
            onChange={(e) => handleWheelChange(e.target.value)}
            className="input-field"
          >
            <option value="">Select wheel size</option>
            {config.wheelSizes.map((size) => (
              <option key={size} value={size}>
                {size}
              </option>
            ))}
          </select>
        </div>

        {/* Tire Width */}
        <div>
          <label className="form-label">Tire Width</label>
          <select
            value={setup.tire}
            onChange={(e) => handleTireChange(e.target.value)}
            className="input-field"
          >
            <option value="">Select tire width</option>
            {config.tireWidths.map((width) => (
              <option key={width} value={width}>
                {width}
              </option>
            ))}
          </select>
        </div>

        {/* Crankset with Visual Icons */}
        <div>
          <label className="form-label">Crankset</label>
          <SearchableDropdown
            options={cranksetOptions}
            value={setup.crankset}
            onChange={handleCranksetChange}
            placeholder="Search cranksets..."
          />
        </div>

        {/* Cassette with Visual Icons */}
        <div>
          <label className="form-label">Cassette</label>
          <SearchableDropdown
            options={cassetteOptions}
            value={setup.cassette}
            onChange={handleCassetteChange}
            placeholder="Search cassettes..."
          />
        </div>
      </div>
    </div>
  );
});

// Add display name for debugging
GearSelectorPanel.displayName = 'GearSelectorPanel';

export default GearSelectorPanel;

 ```

### components/PerformanceChart.js
```
// PerformanceChart.js - OPTIMIZED VERSION
import React, { useRef, useEffect, useMemo } from 'react';
import Chart from 'chart.js/auto';

export default function PerformanceChart({ current, proposed, speedUnit = 'mph' }) {
  const chartRef = useRef(null);
  const chartInstance = useRef(null);

  // Memoize chart data to prevent unnecessary recalculations
  const chartData = useMemo(() => {
    if (!current || !proposed) return null;

    const currentValues = {
      topSpeed: parseFloat(current.metrics.highSpeed),
      climbingSpeed: parseFloat(current.metrics.lowSpeed),
      weight: current.totalWeight,
      gearRange: parseInt(current.gearRange)
    };

    const proposedValues = {
      topSpeed: parseFloat(proposed.metrics.highSpeed),
      climbingSpeed: parseFloat(proposed.metrics.lowSpeed),
      weight: proposed.totalWeight,
      gearRange: parseInt(proposed.gearRange)
    };

    // Find the ranges for proper scaling
    const maxTopSpeed = Math.max(currentValues.topSpeed, proposedValues.topSpeed) * 1.1;
    const maxClimbingSpeed = Math.max(currentValues.climbingSpeed, proposedValues.climbingSpeed) * 1.1;
    const maxWeight = Math.max(currentValues.weight, proposedValues.weight);
    const minWeight = Math.min(currentValues.weight, proposedValues.weight);
    const maxGearRange = Math.max(currentValues.gearRange, proposedValues.gearRange) * 1.1;

    // Normalize to 0-100 scale
    const normalizeData = (values) => [
      (values.topSpeed / maxTopSpeed) * 100,
      (values.climbingSpeed / maxClimbingSpeed) * 100,
      // Invert weight: lighter weight = higher score
      ((maxWeight + 100 - values.weight) / (maxWeight + 100 - minWeight + 100)) * 100,
      (values.gearRange / maxGearRange) * 100
    ];

    return {
      labels: ['Top Speed', 'Climbing Speed', 'Weight (Better)', 'Gear Range'],
      datasets: [
        {
          label: 'Current Setup',
          data: normalizeData(currentValues),
          backgroundColor: 'rgba(0, 122, 255, 0.2)',
          borderColor: 'rgba(0, 122, 255, 1)',
          borderWidth: 2,
          pointBackgroundColor: 'rgba(0, 122, 255, 1)',
          pointBorderColor: '#fff',
          pointHoverBackgroundColor: '#fff',
          pointHoverBorderColor: 'rgba(0, 122, 255, 1)'
        },
        {
          label: 'Proposed Setup',
          data: normalizeData(proposedValues),
          backgroundColor: 'rgba(88, 86, 214, 0.2)',
          borderColor: 'rgba(88, 86, 214, 1)',
          borderWidth: 2,
          pointBackgroundColor: 'rgba(88, 86, 214, 1)',
          pointBorderColor: '#fff',
          pointHoverBackgroundColor: '#fff',
          pointHoverBorderColor: 'rgba(88, 86, 214, 1)'
        }
      ],
      currentValues,
      proposedValues
    };
  }, [current, proposed]);

  // Memoize chart configuration
  const chartConfig = useMemo(() => {
    if (!chartData) return null;

    return {
      type: 'radar',
      data: {
        labels: chartData.labels,
        datasets: chartData.datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: 500 // Faster animation
        },
        scales: {
          r: {
            angleLines: {
              color: 'rgba(128, 128, 128, 0.2)'
            },
            grid: {
              color: 'rgba(128, 128, 128, 0.2)'
            },
            pointLabels: {
              color: 'var(--text-secondary)',
              font: {
                size: 12
              }
            },
            ticks: {
              color: 'var(--text-tertiary)',
              backdropColor: 'transparent',
              callback: function(value) {
                return Math.round(value) + '%';
              }
            },
            suggestedMin: 0,
            suggestedMax: 100
          }
        },
        plugins: {
          legend: {
            labels: {
              color: 'var(--text-secondary)',
              font: {
                size: 12
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.dataset.label || '';
                const metric = context.label;
                
                // Show actual values in tooltip
                let actualValue;
                if (metric === 'Top Speed') {
                  actualValue = context.datasetIndex === 0 ? 
                    chartData.currentValues.topSpeed : chartData.proposedValues.topSpeed;
                  return `${label}: ${actualValue.toFixed(1)} ${speedUnit}`;
                } else if (metric === 'Climbing Speed') {
                  actualValue = context.datasetIndex === 0 ? 
                    chartData.currentValues.climbingSpeed : chartData.proposedValues.climbingSpeed;
                  return `${label}: ${actualValue.toFixed(1)} ${speedUnit}`;
                } else if (metric === 'Weight (Better)') {
                  actualValue = context.datasetIndex === 0 ? 
                    chartData.currentValues.weight : chartData.proposedValues.weight;
                  return `${label}: ${actualValue}g`;
                } else if (metric === 'Gear Range') {
                  actualValue = context.datasetIndex === 0 ? 
                    chartData.currentValues.gearRange : chartData.proposedValues.gearRange;
                  return `${label}: ${actualValue}%`;
                }
                return `${label}: ${context.raw.toFixed(1)}%`;
              }
            }
          }
        }
      }
    };
  }, [chartData, speedUnit]);

  useEffect(() => {
    if (!chartConfig || !chartRef.current) return;

    // Destroy existing chart
    if (chartInstance.current) {
      chartInstance.current.destroy();
    }

    const ctx = chartRef.current.getContext('2d');
    chartInstance.current = new Chart(ctx, chartConfig);

    return () => {
      if (chartInstance.current) {
        chartInstance.current.destroy();
      }
    };
  }, [chartConfig]);

  if (!chartData) return null;

  return (
    <div className="card">
      <div className="mb-6">
        <h3 className="text-xl font-semibold mb-2" style={{ color: 'var(--text-primary)' }}>
          Performance Comparison
        </h3>
        <p className="text-sm" style={{ color: 'var(--text-tertiary)' }}>
          Visual comparison of your current vs proposed setup
        </p>
      </div>
      
      <div className="relative" style={{ height: '400px' }}>
        <canvas ref={chartRef}></canvas>
      </div>
      
      <div className="mt-4 pt-4 text-xs" 
           style={{ 
             borderTop: '1px solid var(--border-subtle)',
             color: 'var(--text-quaternary)' 
           }}>
        <p>
          Larger area = better performance. Weight shows "better" (lighter = higher score).
        </p>
      </div>
    </div>
  );
}```

### components/SimulationResults.js
```
// components/SimulationResults.js - Enhanced results with real-world performance context and mobile optimization
// UPDATED: Added practical context, terrain analysis, and mobile-friendly performance insights

import { useRef, useEffect, useState } from 'react';

export default function SimulationResults({ results, speedUnit, bikeType }) {
  const resultsRef = useRef(null);
  const [activeView, setActiveView] = useState('overview');

  useEffect(() => {
    if (resultsRef.current) {
      resultsRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }, []);

  const { current, proposed, comparison } = results;

  // Enhanced color logic for changes
  const getChangeColor = (value, isGoodWhenLower = false) => {
    if (Math.abs(value) < 0.1) return 'var(--text-tertiary)';
    const isPositive = value > 0;
    const isGood = isGoodWhenLower ? !isPositive : isPositive;
    return isGood ? 'var(--accent-performance)' : 'var(--accent-critical)';
  };

  const formatChange = (value, unit = '', showPlus = true) => {
    const rounded = Math.round(value * 10) / 10;
    if (Math.abs(rounded) < 0.1) return '‚Äî';
    const sign = showPlus && rounded > 0 ? '+' : '';
    return `${sign}${rounded}${unit}`;
  };

  // Generate gear-by-gear breakdown with real-world context
  const generateGearBreakdown = (setup) => {
    const { crankset, cassette } = setup.setup;
    if (!crankset?.teeth || !cassette?.teeth) return [];

    const gears = [];
    crankset.teeth.forEach((chainring, cIndex) => {
      cassette.teeth.forEach((cog, cassetteIndex) => {
        const ratio = chainring / cog;
        const speed = calculateSpeedAtRatio(ratio, 90, speedUnit);
        const gearInches = ratio * 27; // Approximate for 700c
        const terrainContext = getTerrainContext(ratio, bikeType);
        const cadenceContext = getCadenceContext(ratio, speedUnit);
        
        gears.push({
          id: `${chainring}-${cog}`,
          chainring,
          cog,
          ratio: ratio.toFixed(2),
          speed: speed.toFixed(1),
          gearInches: gearInches.toFixed(0),
          position: cIndex * cassette.teeth.length + cassetteIndex + 1,
          usage: categorizeGear(ratio, bikeType),
          terrainContext,
          cadenceContext
        });
      });
    });

    return gears.sort((a, b) => b.ratio - a.ratio);
  };

  // Real-world terrain context
  const getTerrainContext = (ratio, bikeType) => {
    const contexts = {
      road: {
        low: { threshold: 2.5, terrain: '12%+ climbs', description: 'Steep road climbs' },
        medium: { threshold: 3.5, terrain: '3-8% grades', description: 'Rolling hills' },
        high: { threshold: 999, terrain: 'Flats/descents', description: 'High speed sections' }
      },
      gravel: {
        low: { threshold: 2.0, terrain: '15%+ loose climbs', description: 'Technical ascents' },
        medium: { threshold: 3.0, terrain: 'Mixed terrain', description: 'Adventure pace' },
        high: { threshold: 999, terrain: 'Fire roads', description: 'Fast gravel sections' }
      },
      mtb: {
        low: { threshold: 1.5, terrain: '20%+ technical', description: 'Rock gardens' },
        medium: { threshold: 2.5, terrain: 'Singletrack', description: 'Trail flow' },
        high: { threshold: 999, terrain: 'XC racing', description: 'Fast sections' }
      }
    };

    const typeContexts = contexts[bikeType] || contexts.road;
    
    if (ratio <= typeContexts.low.threshold) {
      return { terrain: typeContexts.low.terrain, description: typeContexts.low.description };
    } else if (ratio <= typeContexts.medium.threshold) {
      return { terrain: typeContexts.medium.terrain, description: typeContexts.medium.description };
    } else {
      return { terrain: typeContexts.high.terrain, description: typeContexts.high.description };
    }
  };

  // Cadence context for different speeds
  const getCadenceContext = (ratio, speedUnit) => {
    const speed80rpm = calculateSpeedAtRatio(ratio, 80, speedUnit);
    const speed100rpm = calculateSpeedAtRatio(ratio, 100, speedUnit);
    
    return {
      comfortable: `${speed80rpm.toFixed(1)} ${speedUnit} @ 80rpm`,
      pushing: `${speed100rpm.toFixed(1)} ${speedUnit} @ 100rpm`,
      efficient: calculateOptimalCadence(ratio, speedUnit)
    };
  };

  const calculateOptimalCadence = (ratio, speedUnit) => {
    // Optimal cadence varies by gear ratio and bike type
    if (ratio < 2.0) return '75-85rpm (climbing)';
    if (ratio < 3.5) return '85-95rpm (cruising)';
    return '90-100rpm (speed)';
  };

  const currentGears = generateGearBreakdown(current);
  const proposedGears = generateGearBreakdown(proposed);

  // Enhanced performance analysis
  const generatePerformanceInsights = () => {
    const insights = [];
    const speedChange = parseFloat(proposed.metrics.highSpeed) - parseFloat(current.metrics.highSpeed);
    const climbingChange = parseFloat(proposed.metrics.lowSpeed) - parseFloat(current.metrics.lowSpeed);
    const weightChange = proposed.totalWeight - current.totalWeight;
    const rangeChange = parseInt(proposed.gearRange) - parseInt(current.gearRange);

    // Speed insights
    if (speedChange > 1) {
      insights.push({
        type: 'improvement',
        icon: 'üöÄ',
        title: 'Significant Speed Gain',
        description: `Your new setup gives you ${speedChange.toFixed(1)} ${speedUnit} more top speed. You'll notice this on descents and when chasing down breakaways.`,
        impact: 'high'
      });
    } else if (speedChange < -1) {
      insights.push({
        type: 'tradeoff',
        icon: '‚öñÔ∏è',
        title: 'Speed vs Other Benefits',
        description: `You're trading ${Math.abs(speedChange).toFixed(1)} ${speedUnit} of top speed for other improvements. Consider if this fits your riding style.`,
        impact: 'medium'
      });
    }

    // Climbing insights  
    if (climbingChange > 0.5) {
      insights.push({
        type: 'improvement',
        icon: '‚õ∞Ô∏è',
        title: 'Better Climbing Power',
        description: `Your easiest gear is now ${climbingChange.toFixed(1)} ${speedUnit} faster at the same effort. Steep climbs will feel more manageable.`,
        impact: 'high'
      });
    }

    // Weight insights
    if (weightChange < -100) {
      insights.push({
        type: 'improvement',
        icon: 'ü™∂',
        title: 'Meaningful Weight Savings',
        description: `Saving ${Math.abs(weightChange)}g is equivalent to removing about ${Math.round(Math.abs(weightChange)/28)} standard water bottles from your bike.`,
        impact: 'medium'
      });
    } else if (weightChange > 100) {
      insights.push({
        type: 'consideration',
        icon: '‚öñÔ∏è',
        title: 'Weight Increase',
        description: `Adding ${weightChange}g is noticeable on climbs. Make sure the performance benefits justify the extra weight.`,
        impact: 'medium'
      });
    }

    // Range insights
    if (rangeChange > 30) {
      insights.push({
        type: 'improvement',
        icon: 'üìè',
        title: 'Dramatically Wider Range',
        description: `${rangeChange}% more gear range opens up new terrain possibilities. Perfect for adventure riding and varied conditions.`,
        impact: 'high'
      });
    }

    // Terrain-specific insights
    const terrainInsight = getTerrainSpecificInsight(bikeType, proposed);
    if (terrainInsight) {
      insights.push(terrainInsight);
    }

    return insights;
  };

  const getTerrainSpecificInsight = (bikeType, proposedSetup) => {
    const lowRatio = parseFloat(proposedSetup.metrics.lowRatio);
    const highRatio = parseFloat(proposedSetup.metrics.highRatio);

    switch (bikeType) {
      case 'road':
        if (lowRatio < 1.8) {
          return {
            type: 'terrain',
            icon: 'üèîÔ∏è',
            title: 'Alpine-Ready Gearing',
            description: 'Your lowest gear handles 15%+ climbs comfortably. Perfect for mountain stages and steep European climbs.',
            impact: 'high'
          };
        }
        break;
      case 'gravel':
        if (lowRatio < 1.5 && highRatio > 3.0) {
          return {
            type: 'terrain',
            icon: 'üåÑ',
            title: 'Adventure-Optimized Range',
            description: 'Ideal for bikepacking and mixed terrain. Handles technical climbs and still efficient on road sections.',
            impact: 'high'
          };
        }
        break;
      case 'mtb':
        if (lowRatio < 1.2) {
          return {
            type: 'terrain',
            icon: 'ü™®',
            title: 'Technical Climbing Machine',
            description: 'Your lowest gear conquers 25%+ grades with traction. Perfect for rock gardens and technical ascents.',
            impact: 'high'
          };
        }
        break;
    }
    return null;
  };

  const performanceInsights = generatePerformanceInsights();

  const MetricCard = ({ 
    title, 
    currentValue, 
    proposedValue, 
    change, 
    unit = '', 
    isGoodWhenLower = false,
    icon,
    context
  }) => {
    const changeColor = getChangeColor(change, isGoodWhenLower);
    
    return (
      <div className="card text-center p-6">
        <div className="flex items-center justify-center mb-4 w-12 h-12 mx-auto" style={{ color: 'var(--accent-blue)' }}>
          {icon}
        </div>
        <h3 className="text-lg font-semibold mb-4" style={{ color: 'var(--text-secondary)' }}>
          {title}
        </h3>
        
        <div className="space-y-3">
          <div className="flex justify-between items-center text-sm">
            <span style={{ color: 'var(--text-tertiary)' }}>Current</span>
            <span className="font-mono text-lg font-semibold" style={{ color: 'var(--text-primary)' }}>
              {currentValue}{unit}
            </span>
          </div>
          
          <div className="flex justify-between items-center text-sm">
            <span style={{ color: 'var(--text-tertiary)' }}>Proposed</span>
            <span className="font-mono text-lg font-semibold" style={{ color: 'var(--text-primary)' }}>
              {proposedValue}{unit}
            </span>
          </div>
          
          <div className="border-t pt-3" style={{ borderColor: 'var(--border-subtle)' }}>
            <div 
              className="text-2xl font-bold mb-1"
              style={{ color: changeColor }}
            >
              {formatChange(change, unit)}
            </div>
            <div className="text-xs" style={{ color: 'var(--text-quaternary)' }}>
              Change
            </div>
          </div>

          {/* Real-world context */}
          {context && (
            <div className="mt-3 pt-3 border-t" style={{ borderColor: 'var(--border-subtle)' }}>
              <div className="text-xs" style={{ color: 'var(--text-tertiary)' }}>
                {context}
              </div>
            </div>
          )}
        </div>
      </div>
    );
  };

  return (
    <div ref={resultsRef} className="space-y-8">
      {/* Results Header */}
      <div className="text-center">
        <h2 className="text-3xl font-bold mb-4" style={{ color: 'var(--text-primary)' }}>
          Performance Analysis
        </h2>
        <p className="text-lg" style={{ color: 'var(--text-tertiary)' }}>
          Real-world performance impact with terrain-specific insights
        </p>
      </div>

      {/* Performance Insights Cards */}
      {performanceInsights.length > 0 && (
        <div className="space-y-4">
          <h3 className="text-xl font-semibold mb-4" style={{ color: 'var(--text-primary)' }}>
            Key Insights
          </h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {performanceInsights.map((insight, index) => (
              <div key={index} 
                   className="p-4 rounded-lg border"
                   style={{ 
                     background: insight.type === 'improvement' ? 'rgba(0, 166, 81, 0.1)' : 
                                insight.type === 'consideration' ? 'rgba(255, 105, 0, 0.1)' : 
                                'var(--surface-elevated)',
                     borderColor: insight.type === 'improvement' ? 'var(--success-green)' : 
                                 insight.type === 'consideration' ? 'var(--warning-orange)' : 
                                 'var(--border-subtle)'
                   }}>
                <div className="flex items-start gap-3">
                  <div className="text-2xl flex-shrink-0">{insight.icon}</div>
                  <div>
                    <h4 className="font-medium mb-1" style={{ color: 'var(--text-primary)' }}>
                      {insight.title}
                    </h4>
                    <p className="text-sm" style={{ color: 'var(--text-secondary)' }}>
                      {insight.description}
                    </p>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* View Toggle */}
      <div className="flex justify-center">
        <div className="flex rounded-xl p-1" 
             style={{ 
               background: 'var(--surface-primary)', 
               border: '1px solid var(--border-subtle)' 
             }}>
          {[
            { key: 'overview', label: 'Overview' },
            { key: 'gears', label: 'All Gears' },
            { key: 'comparison', label: 'Side by Side' }
          ].map(view => (
            <button
              key={view.key}
              onClick={() => setActiveView(view.key)}
              className={`px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 ${
                activeView === view.key 
                  ? 'text-white shadow-sm' 
                  : 'hover:opacity-70'
              }`}
              style={{
                background: activeView === view.key 
                  ? 'var(--accent-blue)' 
                  : 'transparent',
                color: activeView === view.key ? 'white' : 'var(--text-secondary)'
              }}
            >
              {view.label}
            </button>
          ))}
        </div>
      </div>

      {/* Overview - Key Metrics with Context */}
      {activeView === 'overview' && (
        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
          <MetricCard
            title="Top Speed"
            currentValue={current.metrics.highSpeed}
            proposedValue={proposed.metrics.highSpeed}
            change={parseFloat(proposed.metrics.highSpeed) - parseFloat(current.metrics.highSpeed)}
            unit={` ${speedUnit}`}
            context={`At 90rpm: ${proposed.metrics.highSpeed} ${speedUnit}`}
            icon={
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
            }
          />
          
          <MetricCard
            title="Climbing Speed"
            currentValue={current.metrics.lowSpeed}
            proposedValue={proposed.metrics.lowSpeed}
            change={parseFloat(proposed.metrics.lowSpeed) - parseFloat(current.metrics.lowSpeed)}
            unit={` ${speedUnit}`}
            context={getClimbingContext(parseFloat(proposed.metrics.lowRatio), bikeType)}
            icon={
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3l14 9-14 9V3z" />
              </svg>
            }
          />
          
          <MetricCard
            title="Weight"
            currentValue={current.totalWeight}
            proposedValue={proposed.totalWeight}
            change={proposed.totalWeight - current.totalWeight}
            unit="g"
            isGoodWhenLower={true}
            context={getWeightContext(proposed.totalWeight - current.totalWeight)}
            icon={
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
              </svg>
            }
          />
          
          <MetricCard
            title="Gear Range"
            currentValue={current.gearRange}
            proposedValue={proposed.gearRange}
            change={parseInt(proposed.gearRange) - parseInt(current.gearRange)}
            unit="%"
            context={getRangeContext(parseInt(proposed.gearRange), bikeType)}
            icon={
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
            }
          />
        </div>
      )}

      {/* All Gears View with Enhanced Context */}
      {activeView === 'gears' && (
        <div className="space-y-6">
          <div className="card">
            <h3 className="text-xl font-semibold mb-6" style={{ color: 'var(--text-primary)' }}>
              Proposed Setup - All Gears
            </h3>
            <EnhancedGearTable gears={proposedGears} speedUnit={speedUnit} />
          </div>
          
          <div className="card">
            <h3 className="text-xl font-semibold mb-6" style={{ color: 'var(--text-primary)' }}>
              Current Setup - All Gears
            </h3>
            <EnhancedGearTable gears={currentGears} speedUnit={speedUnit} />
          </div>
        </div>
      )}

      {/* Side by Side Comparison */}
      {activeView === 'comparison' && (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="card">
            <h3 className="text-xl font-semibold mb-6" style={{ color: 'var(--text-primary)' }}>
              Current Setup
            </h3>
            <div className="space-y-4">
              <div className="text-2xl font-bold" style={{ color: 'var(--accent-blue)' }}>
                {current.metrics.highSpeed} {speedUnit}
              </div>
              <div className="text-sm" style={{ color: 'var(--text-tertiary)' }}>
                Top speed ‚Ä¢ {currentGears.length} total gears
              </div>
              <EnhancedGearTable gears={currentGears.slice(0, 6)} speedUnit={speedUnit} compact />
            </div>
          </div>
          
          <div className="card">
            <h3 className="text-xl font-semibold mb-6" style={{ color: 'var(--text-primary)' }}>
              Proposed Setup
            </h3>
            <div className="space-y-4">
              <div className="text-2xl font-bold" style={{ color: 'var(--accent-performance)' }}>
                {proposed.metrics.highSpeed} {speedUnit}
              </div>
              <div className="text-sm" style={{ color: 'var(--text-tertiary)' }}>
                Top speed ‚Ä¢ {proposedGears.length} total gears
              </div>
              <EnhancedGearTable gears={proposedGears.slice(0, 6)} speedUnit={speedUnit} compact />
            </div>
          </div>
        </div>
      )}

      {/* Bottom Line Analysis */}
      <div className="card">
        <div 
          className="p-6 rounded-xl"
          style={{ 
            background: 'linear-gradient(135deg, rgba(0, 122, 255, 0.1) 0%, rgba(88, 86, 214, 0.1) 100%)',
            border: '1px solid var(--accent-blue)'
          }}
        >
          <div className="flex items-start gap-4">
            <div 
              className="w-12 h-12 rounded-xl flex items-center justify-center flex-shrink-0"
              style={{ 
                background: 'linear-gradient(135deg, var(--accent-blue) 0%, #5856d6 100%)',
                color: 'white'
              }}
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                      d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div className="flex-1">
              <h3 className="text-xl font-bold mb-3" style={{ color: 'var(--text-primary)' }}>
                Bottom Line
              </h3>
              <p className="text-base leading-relaxed mb-4" style={{ color: 'var(--text-secondary)' }}>
                {generateBottomLine(comparison, speedUnit, bikeType)}
              </p>
              <div className="flex items-center gap-4">
                <div className="flex items-center gap-2">
                  <div className="w-3 h-3 rounded-full" 
                       style={{ background: 'var(--accent-performance)' }}></div>
                  <span className="text-sm font-medium" style={{ color: 'var(--accent-performance)' }}>
                    ‚úì Setup analyzed and optimized
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// Enhanced Gear Table with real-world context
function EnhancedGearTable({ gears, speedUnit, compact = false }) {
  return (
    <div className="overflow-x-auto">
      <table className="w-full text-sm">
        <thead>
          <tr style={{ borderBottom: '1px solid var(--border-subtle)' }}>
            <th className="text-left py-2 px-3">Gear</th>
            <th className="text-right py-2 px-3">Ratio</th>
            <th className="text-right py-2 px-3">Speed @ 90rpm</th>
            {!compact && <th className="text-right py-2 px-3">Best For</th>}
            {!compact && <th className="text-right py-2 px-3">Cadence Range</th>}
          </tr>
        </thead>
        <tbody>
          {gears.map((gear, index) => (
            <tr key={gear.id} style={{ borderBottom: '1px solid var(--border-subtle)' }}>
              <td className="py-2 px-3">
                <div className="flex items-center space-x-2">
                  <div 
                    className="w-3 h-3 rounded"
                    style={{ background: gear.usage.color }}
                  ></div>
                  <span className="font-mono">{gear.chainring}T √ó {gear.cog}T</span>
                </div>
              </td>
              <td className="text-right py-2 px-3 font-mono">{gear.ratio}</td>
              <td className="text-right py-2 px-3 font-mono font-semibold">
                {gear.speed} {speedUnit}
              </td>
              {!compact && (
                <td className="text-right py-2 px-3 text-xs">
                  {gear.terrainContext?.terrain}
                </td>
              )}
              {!compact && (
                <td className="text-right py-2 px-3 text-xs" style={{ color: 'var(--text-tertiary)' }}>
                  {gear.cadenceContext?.efficient}
                </td>
              )}
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}

// Helper context functions
function getClimbingContext(lowRatio, bikeType) {
  if (lowRatio < 1.2) return 'Conquers 20%+ grades';
  if (lowRatio < 1.8) return 'Handles 12-15% climbs';
  if (lowRatio < 2.2) return 'Good for 8-12% grades';
  return 'Best for rolling terrain';
}

function getWeightContext(weightChange) {
  if (Math.abs(weightChange) < 50) return 'Minimal weight impact';
  if (weightChange < -100) return `Saves ~${Math.round(Math.abs(weightChange)/28)} water bottles worth`;
  if (weightChange > 100) return `Adds ~${Math.round(weightChange/28)} water bottles worth`;
  return 'Moderate weight change';
}

function getRangeContext(gearRange, bikeType) {
  const excellent = bikeType === 'mtb' ? 450 : bikeType === 'gravel' ? 350 : 300;
  const good = bikeType === 'mtb' ? 350 : bikeType === 'gravel' ? 280 : 250;
  
  if (gearRange >= excellent) return 'Excellent for varied terrain';
  if (gearRange >= good) return 'Good range for most riding';
  return 'Limited range - specialized use';
}

// Helper Functions (keeping existing)
function calculateSpeedAtRatio(gearRatio, cadence, speedUnit) {
  const wheelCircumference = 2.1; // meters (700c approximation)
  const speedMS = (gearRatio * cadence * wheelCircumference) / 60;
  
  if (speedUnit.toLowerCase() === 'mph') {
    return speedMS * 2.237;
  } else {
    return speedMS * 3.6;
  }
}

function categorizeGear(ratio, bikeType) {
  const thresholds = {
    road: { climbing: 2.5, sprint: 4.0 },
    gravel: { climbing: 2.0, sprint: 3.5 },
    mtb: { climbing: 1.5, sprint: 2.5 }
  };
  
  const threshold = thresholds[bikeType] || thresholds.road;
  
  if (ratio < threshold.climbing) {
    return { label: 'Climbing', color: 'var(--accent-performance)' };
  } else if (ratio > threshold.sprint) {
    return { label: 'Sprint', color: 'var(--accent-critical)' };
  } else {
    return { label: 'All-around', color: 'var(--accent-blue)' };
  }
}

function generateBottomLine(comparison, speedUnit, bikeType) {
  const weightChange = comparison?.weightChange || 0;
  const speedChange = comparison?.speedChange || 0;
  const rangeChange = comparison?.rangeChange || 0;
  
  let message = "Your proposed setup ";
  const benefits = [];
  
  if (weightChange < -50) benefits.push(`saves ${Math.abs(weightChange)}g`);
  if (speedChange > 0.5) benefits.push(`gives you ${speedChange.toFixed(1)} ${speedUnit} more top speed`);
  if (rangeChange > 25) benefits.push(`adds ${rangeChange}% more gear range for varied terrain`);
  
  // Add terrain-specific benefits
  if (bikeType === 'gravel' && rangeChange > 30) {
    benefits.push('opens up new adventure possibilities');
  } else if (bikeType === 'mtb' && rangeChange > 40) {
    benefits.push('handles more technical terrain');
  } else if (bikeType === 'road' && speedChange > 1) {
    benefits.push('noticeable in group rides and races');
  }
  
  if (benefits.length === 0) {
    return `Your proposed setup offers similar performance with different characteristics. The changes are subtle but may better match your specific riding style and terrain.`;
  }
  
  message += benefits.slice(0, 3).join(", ") + ". ";
  
  const majorBenefits = benefits.length >= 2 || Math.abs(weightChange) > 100 || speedChange > 1.5;
  message += majorBenefits ? "This is a meaningful upgrade worth considering." : "Minor improvements - evaluate based on your priorities and budget.";
  
  return message;
}```

### components/SEOHead.js
```
import Head from 'next/head';

export default function SEOHead({ 
  title = "CrankSmith - Professional Bike Gear Calculator & Drivetrain Compatibility Tool",
  description = "Professional bike gear ratio calculator, drivetrain compatibility checker, and bike fit calculator. Perfect for cyclists, bike shops, and bike mechanics. Calculate optimal gearing for road, mountain, gravel, and touring bikes.",
  url = "https://cranksmith.com",
  image = "/og-image.jpg",
  keywords = "bike gear calculator, gear ratio calculator, drivetrain compatibility, bike fit calculator, cycling gear, bicycle gearing, bike setup, cycling tools, bike mechanics, cycling optimization",
  type = "website",
  structuredData = null,
  author = "CrankSmith",
  category = "cycling tools"
}) {
  
  // Default structured data for the site
  const defaultStructuredData = {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "CrankSmith",
    "description": description,
    "url": url,
    "applicationCategory": "Sports & Recreation",
    "operatingSystem": "Web Browser",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "creator": {
      "@type": "Organization",
      "name": "CrankSmith",
      "url": url
    },
    "audience": {
      "@type": "Audience",
      "audienceType": "Cyclists, Bike Mechanics, Bike Shops"
    },
    "keywords": keywords,
    "inLanguage": "en-US",
    "isAccessibleForFree": true
  };

  const finalStructuredData = structuredData || defaultStructuredData;
  
  return (
    <Head>
      {/* Basic Meta Tags */}
      <title>{title}</title>
      <meta name="description" content={description} />
      <meta name="keywords" content={keywords} />
      <meta name="author" content={author} />
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <meta name="language" content="en-US" />
      <meta name="category" content={category} />
      
      {/* Enhanced SEO Meta Tags */}
      <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
      <meta name="googlebot" content="index, follow" />
      <meta name="revisit-after" content="1 days" />
      <meta name="distribution" content="global" />
      <meta name="rating" content="general" />
      <meta name="referrer" content="origin-when-cross-origin" />
      
      {/* Geographic and Industry Targeting */}
      <meta name="geo.region" content="US" />
      <meta name="geo.placename" content="United States" />
      <meta name="target" content="cyclists, bike mechanics, cycling enthusiasts" />
      <meta name="audience" content="cyclists" />
      <meta name="coverage" content="worldwide" />
      
      {/* Open Graph (Facebook/Social) Enhanced */}
      <meta property="og:type" content={type} />
      <meta property="og:site_name" content="CrankSmith" />
      <meta property="og:title" content={title} />
      <meta property="og:description" content={description} />
      <meta property="og:url" content={url} />
      <meta property="og:image" content={image} />
      <meta property="og:image:alt" content="CrankSmith - Professional Bike Gear Calculator" />
      <meta property="og:image:width" content="1200" />
      <meta property="og:image:height" content="630" />
      <meta property="og:locale" content="en_US" />
      
      {/* Twitter Card Enhanced */}
      <meta name="twitter:card" content="summary_large_image" />
      <meta name="twitter:site" content="@cranksmithapp" />
      <meta name="twitter:creator" content="@cranksmithapp" />
      <meta name="twitter:title" content={title} />
      <meta name="twitter:description" content={description} />
      <meta name="twitter:image" content={image} />
      <meta name="twitter:image:alt" content="CrankSmith - Professional Bike Gear Calculator" />
      
      {/* Additional Platform Meta Tags */}
      <meta property="fb:app_id" content="CrankSmith" />
      <meta name="pinterest-rich-pin" content="true" />
      
      {/* Search Engine Optimization */}
      <link rel="canonical" href={url} />
      <meta name="format-detection" content="telephone=no" />
      
      {/* Structured Data (JSON-LD) */}
      <script
        type="application/ld+json"
        dangerouslySetInnerHTML={{
          __html: JSON.stringify(finalStructuredData)
        }}
      />
      
      {/* Additional Bike-Specific Meta Tags */}
      <meta name="subject" content="Cycling Tools and Calculators" />
      <meta name="topic" content="Bicycle Gear Ratios and Compatibility" />
      <meta name="summary" content="Professional bike gear calculator and compatibility checker for cyclists" />
      <meta name="classification" content="Sports & Recreation - Cycling" />
      <meta name="owner" content="CrankSmith" />
      <meta name="url" content={url} />
      <meta name="identifier-URL" content={url} />
      <meta name="directory" content="submission" />
      <meta name="pagename" content={title} />
      <meta name="page-topic" content="cycling gear calculation" />
      <meta name="page-type" content="tool" />
      
      {/* Search Engine Verification Tags */}
      <meta name="google-site-verification" content="_OejAgyGekugOzvl7MqpGFmUY6cqxE1tF3frnHRb2vk" />
      {/* <meta name="msvalidate.01" content="YOUR_BING_VERIFICATION_CODE" /> */}
      {/* <meta name="yandex-verification" content="YOUR_YANDEX_VERIFICATION_CODE" /> */}
    </Head>
  );
} ```

### components/ThemeToggle.js
```
import React from 'react';

export default function ThemeToggle({ theme, toggleTheme }) {
  return (
    <button
      onClick={toggleTheme}
      className="relative p-2 rounded-xl bg-neutral-100 dark:bg-neutral-800 hover:bg-neutral-200 dark:hover:bg-neutral-700 transition-all duration-200 group"
      aria-label={`Switch to ${theme === 'light' ? 'dark' : 'light'} mode`}
    >
      <div className="relative w-6 h-6">
        {/* Sun Icon */}
        <svg
          className={`absolute inset-0 w-6 h-6 transition-all duration-300 ${
            theme === 'light' 
              ? 'opacity-100 rotate-0 scale-100' 
              : 'opacity-0 rotate-180 scale-50'
          }`}
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <circle cx="12" cy="12" r="4" />
          <path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
        </svg>
        
        {/* Moon Icon */}
        <svg
          className={`absolute inset-0 w-6 h-6 transition-all duration-300 ${
            theme === 'dark' 
              ? 'opacity-100 rotate-0 scale-100' 
              : 'opacity-0 -rotate-180 scale-50'
          }`}
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
        </svg>
      </div>
      
      {/* Tooltip */}
      <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-1 bg-neutral-900 dark:bg-neutral-100 text-white dark:text-neutral-900 text-sm rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap">
        {theme === 'light' ? 'Dark mode' : 'Light mode'}
        <div className="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-neutral-900 dark:border-t-neutral-100" />
      </div>
    </button>
  );
} ```

### components/InstallPrompt.js
```
// components/InstallPrompt.js - PWA Install Prompt
import { useState, useEffect } from 'react';
import { canInstall, getInstallPrompt, installPWA, checkIfPWA, isIOS } from '../lib/pwa-utils';

export default function InstallPrompt({ variant = 'banner' }) {
  const [deferredPrompt, setDeferredPrompt] = useState(null);
  const [isInstalling, setIsInstalling] = useState(false);
  const [showIOSGuide, setShowIOSGuide] = useState(false);
  const [isChromeIOS, setIsChromeIOS] = useState(false);
  const [isVisible, setIsVisible] = useState(false);

  useEffect(() => {
    // Check if it's Chrome on iOS
    const isIOSDevice = isIOS();
    const isChrome = navigator.userAgent.includes('CriOS') || navigator.userAgent.includes('Chrome');
    setIsChromeIOS(isIOSDevice && isChrome);

    // Don't show install prompt if already installed as PWA
    if (checkIfPWA()) {
      setIsVisible(false);
      return;
    }

    // Listen for install prompt
    const handleBeforeInstallPrompt = (e) => {
      console.log('üéâ Install prompt detected!', e);
      e.preventDefault();
      setDeferredPrompt(e);
      setIsVisible(true);
    };

    // Show prompt for iOS devices (even without native prompt)
    if (isIOSDevice && !checkIfPWA()) {
      setShowIOSGuide(true);
      setIsVisible(true);
    }

    window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
    
    return () => {
      window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
    };
  }, []);

  const handleInstall = async () => {
    if (!deferredPrompt) {
      alert('No install prompt available.');
      return;
    }
    
    setIsInstalling(true);
    try {
      const result = await deferredPrompt.prompt();
      
      if (result.outcome === 'accepted') {
        console.log('üéâ CrankSmith installed successfully!');
        setDeferredPrompt(null);
        setIsVisible(false);
      } else {
        console.log('‚ùå Installation was cancelled');
      }
    } catch (error) {
      console.error('Install failed:', error);
      alert('Installation failed: ' + error.message);
    } finally {
      setIsInstalling(false);
    }
  };

  const handleIOSInstall = () => {
    if (isChromeIOS) {
      // For Chrome on iOS, show instructions to use Safari
      if (navigator.share) {
        navigator.share({
          title: 'CrankSmith - Bike Gear Calculator',
          text: 'Check out this awesome bike gear calculator! Open in Safari for the best experience.',
          url: window.location.href
        });
      } else {
        alert('Chrome on iOS has limited PWA support.\n\nFor the best experience:\n1. Open this site in Safari\n2. Tap the share button (square with arrow)\n3. Tap "Add to Home Screen"\n\nOr bookmark this page in Chrome for quick access.');
      }
    } else {
      // For Safari on iOS, try to trigger share sheet
      if (navigator.share) {
        navigator.share({
          title: 'CrankSmith - Bike Gear Calculator',
          text: 'Add CrankSmith to your home screen for quick access!',
          url: window.location.href
        });
      } else {
        alert('Tap the share button (square with arrow) in Safari, then scroll down to "Add to Home Screen"');
      }
    }
  };

  const handleDismiss = () => {
    setIsVisible(false);
    // Store dismissal in localStorage to avoid showing again immediately
    localStorage.setItem('pwa-install-dismissed', Date.now().toString());
  };

  // Don't render if not visible
  if (!isVisible) return null;

  // Banner variant
  if (variant === 'banner') {
    return (
      <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        background: isChromeIOS ? 'linear-gradient(135deg, #EF4444, #DC2626)' : 'linear-gradient(135deg, #3B82F6, #1D4ED8)',
        color: 'white',
        padding: '12px 20px',
        zIndex: 1000,
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        boxShadow: '0 2px 10px rgba(0,0,0,0.1)'
      }}>
        <div style={{ flex: 1 }}>
          <div style={{ fontWeight: 'bold', fontSize: '14px' }}>
            {isChromeIOS ? '‚ö†Ô∏è Chrome iOS Detected' : 'üì± Install CrankSmith'}
          </div>
          <div style={{ fontSize: '12px', opacity: 0.9 }}>
            {isChromeIOS 
              ? 'For the best experience, open in Safari' 
              : 'Get quick access to your gear calculator'
            }
          </div>
        </div>
        
        <div style={{ display: 'flex', gap: '8px' }}>
          {deferredPrompt && (
            <button
              onClick={handleInstall}
              disabled={isInstalling}
              style={{
                background: 'rgba(255,255,255,0.2)',
                color: 'white',
                border: '1px solid rgba(255,255,255,0.3)',
                padding: '6px 12px',
                borderRadius: '6px',
                cursor: isInstalling ? 'not-allowed' : 'pointer',
                fontSize: '12px'
              }}
            >
              {isInstalling ? 'Installing...' : 'Install'}
            </button>
          )}
          
          {showIOSGuide && (
            <button
              onClick={handleIOSInstall}
              style={{
                background: 'rgba(255,255,255,0.2)',
                color: 'white',
                border: '1px solid rgba(255,255,255,0.3)',
                padding: '6px 12px',
                borderRadius: '6px',
                cursor: 'pointer',
                fontSize: '12px'
              }}
            >
              {isChromeIOS ? 'Safari Guide' : 'Add to Home'}
            </button>
          )}
          
          <button
            onClick={handleDismiss}
            style={{
              background: 'none',
              color: 'white',
              border: 'none',
              padding: '6px',
              cursor: 'pointer',
              fontSize: '16px'
            }}
          >
            √ó
          </button>
        </div>
      </div>
    );
  }

  // Floating button variant
  if (variant === 'floating') {
    return (
      <div style={{
        position: 'fixed',
        bottom: '20px',
        right: '20px',
        zIndex: 1000
      }}>
        <button
          onClick={deferredPrompt ? handleInstall : handleIOSInstall}
          disabled={isInstalling}
          style={{
            background: isChromeIOS ? '#EF4444' : '#3B82F6',
            color: 'white',
            border: 'none',
            borderRadius: '50px',
            padding: '12px 20px',
            cursor: isInstalling ? 'not-allowed' : 'pointer',
            boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
            fontSize: '14px',
            fontWeight: 'bold',
            display: 'flex',
            alignItems: 'center',
            gap: '8px'
          }}
        >
          {isInstalling ? (
            <>‚è≥ Installing...</>
          ) : isChromeIOS ? (
            <>‚ö†Ô∏è Safari Guide</>
          ) : deferredPrompt ? (
            <>üì± Install App</>
          ) : (
            <>üì± Add to Home</>
          )}
        </button>
      </div>
    );
  }

  // Default card variant
  return (
    <div style={{
      background: 'white',
      border: '1px solid #E5E7EB',
      borderRadius: '12px',
      padding: '20px',
      margin: '20px 0',
      boxShadow: '0 4px 6px rgba(0,0,0,0.05)'
    }}>
      <div style={{ display: 'flex', alignItems: 'center', marginBottom: '15px' }}>
        <div style={{
          background: isChromeIOS ? '#EF4444' : '#3B82F6',
          color: 'white',
          borderRadius: '50%',
          width: '40px',
          height: '40px',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          marginRight: '15px'
        }}>
          {isChromeIOS ? '‚ö†Ô∏è' : 'üì±'}
        </div>
        <div>
          <h3 style={{ margin: 0, fontSize: '18px' }}>
            {isChromeIOS ? 'Chrome iOS Detected' : 'Install CrankSmith'}
          </h3>
          <p style={{ margin: '5px 0 0 0', color: '#6B7280', fontSize: '14px' }}>
            {isChromeIOS 
              ? 'For the best experience, open in Safari' 
              : 'Get quick access to your gear calculator'
            }
          </p>
        </div>
      </div>

      <div style={{ display: 'flex', gap: '10px' }}>
        {deferredPrompt && (
          <button
            onClick={handleInstall}
            disabled={isInstalling}
            style={{
              background: '#3B82F6',
              color: 'white',
              border: 'none',
              padding: '10px 20px',
              borderRadius: '8px',
              cursor: isInstalling ? 'not-allowed' : 'pointer',
              fontWeight: 'bold'
            }}
          >
            {isInstalling ? 'Installing...' : 'Install Now'}
          </button>
        )}
        
        {showIOSGuide && (
          <button
            onClick={handleIOSInstall}
            style={{
              background: isChromeIOS ? '#EF4444' : '#F59E0B',
              color: 'white',
              border: 'none',
              padding: '10px 20px',
              borderRadius: '8px',
              cursor: 'pointer',
              fontWeight: 'bold'
            }}
          >
            {isChromeIOS ? 'Open in Safari' : 'Add to Home Screen'}
          </button>
        )}
        
        <button
          onClick={handleDismiss}
          style={{
            background: 'none',
            color: '#6B7280',
            border: '1px solid #D1D5DB',
            padding: '10px 20px',
            borderRadius: '8px',
            cursor: 'pointer'
          }}
        >
          Maybe Later
        </button>
      </div>

      {isChromeIOS && (
        <div style={{ 
          marginTop: '15px', 
          padding: '12px', 
          background: '#FEF2F2', 
          border: '1px solid #FECACA', 
          borderRadius: '8px',
          fontSize: '13px',
          color: '#991B1B'
        }}>
          <strong>Chrome iOS Limitation:</strong> Chrome on iOS doesn't support PWA installation. 
          For the full app experience, please open this site in Safari and use "Add to Home Screen".
        </div>
      )}
    </div>
  );
} ```

### components/InstallBanner.js
```
// components/InstallBanner.js - Top banner for app installation
import { useState, useEffect } from 'react';
import { canInstall, getInstallPrompt, installPWA, checkIfPWA } from '../lib/pwa-utils';
import { toast } from './Toast';

// Global state to prevent multiple banners
let globalBannerShown = false;

export default function InstallBanner() {
  const [showBanner, setShowBanner] = useState(false);
  const [deferredPrompt, setDeferredPrompt] = useState(null);
  const [isInstalling, setIsInstalling] = useState(false);

  useEffect(() => {
    const checkInstallability = async () => {
      // Don't show if already installed as PWA
      if (checkIfPWA()) return;
      
      // Don't show if another banner is already shown globally
      if (globalBannerShown) return;
      
      // Don't show if user dismissed recently
      const dismissedTime = localStorage.getItem('cranksmith_banner_dismissed');
      if (dismissedTime && Date.now() - parseInt(dismissedTime) < 60 * 60 * 1000) { // 1 hour
        return;
      }

      // Check if app can be installed
      if (canInstall()) {
        const prompt = await getInstallPrompt();
        if (prompt) {
          setDeferredPrompt(prompt);
          setShowBanner(true);
          globalBannerShown = true;
        }
      }
    };

    // Check after page loads
    const timer = setTimeout(checkInstallability, 3000);
    
    return () => clearTimeout(timer);
  }, []);

  const handleInstall = async () => {
    if (!deferredPrompt) return;
    
    setIsInstalling(true);
    try {
      const success = await installPWA(deferredPrompt);
      if (success) {
        setShowBanner(false);
        globalBannerShown = false;
        // Show success message
        toast.success('üéâ CrankSmith installed successfully! You can now access it from your home screen.');
      }
    } catch (error) {
      console.error('Install failed:', error);
    } finally {
      setIsInstalling(false);
    }
  };

  const handleDismiss = () => {
    setShowBanner(false);
    globalBannerShown = false;
    // Remember dismissal for 1 hour
    localStorage.setItem('cranksmith_banner_dismissed', Date.now().toString());
  };

  if (!showBanner) return null;

  return (
    <div className="install-banner" style={{
      background: 'linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%)',
      color: 'white',
      padding: '12px 20px',
      position: 'relative',
      zIndex: 1000,
      boxShadow: '0 2px 8px rgba(0, 0, 0, 0.1)'
    }}>
      <div className="flex items-center justify-between max-w-6xl mx-auto">
        <div className="flex items-center gap-3">
          <div style={{
            width: '32px',
            height: '32px',
            background: 'rgba(255, 255, 255, 0.2)',
            borderRadius: '8px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '16px'
          }}>
            üö¥
          </div>
          <div>
            <div className="font-semibold text-sm">Install CrankSmith App</div>
            <div className="text-xs opacity-90">Get offline access & home screen shortcut</div>
          </div>
        </div>
        
        <div className="flex items-center gap-2">
          <button
            onClick={handleInstall}
            disabled={isInstalling}
            style={{
              background: 'rgba(255, 255, 255, 0.2)',
              color: 'white',
              border: '1px solid rgba(255, 255, 255, 0.3)',
              borderRadius: '6px',
              padding: '6px 12px',
              fontSize: '12px',
              fontWeight: '600',
              cursor: isInstalling ? 'not-allowed' : 'pointer',
              opacity: isInstalling ? 0.7 : 1,
              transition: 'all 0.2s ease'
            }}
          >
            {isInstalling ? 'Installing...' : 'Install'}
          </button>
          
          <button
            onClick={handleDismiss}
            style={{
              background: 'transparent',
              color: 'rgba(255, 255, 255, 0.8)',
              border: 'none',
              padding: '6px',
              cursor: 'pointer',
              fontSize: '16px',
              lineHeight: 1
            }}
          >
            √ó
          </button>
        </div>
      </div>
    </div>
  );
} ```

### components/FloatingInstallButton.js
```
// components/FloatingInstallButton.js - Floating install button
import { useState, useEffect } from 'react';
import { canInstall, getInstallPrompt, installPWA, checkIfPWA } from '../lib/pwa-utils';

export default function FloatingInstallButton() {
  const [showButton, setShowButton] = useState(false);
  const [deferredPrompt, setDeferredPrompt] = useState(null);
  const [isInstalling, setIsInstalling] = useState(false);

  useEffect(() => {
    const checkInstallability = async () => {
      // Don't show if already installed as PWA
      if (checkIfPWA()) return;
      
      // Check if app can be installed
      if (canInstall()) {
        const prompt = await getInstallPrompt();
        if (prompt) {
          setDeferredPrompt(prompt);
          setShowButton(true);
        }
      }
    };

    // Check after a short delay
    const timer = setTimeout(checkInstallability, 2000);
    
    return () => clearTimeout(timer);
  }, []);

  const handleInstall = async () => {
    if (!deferredPrompt) return;
    
    setIsInstalling(true);
    try {
      const success = await installPWA(deferredPrompt);
      if (success) {
        setShowButton(false);
        // Show success message
        alert('üéâ CrankSmith installed successfully! You can now access it from your home screen.');
      }
    } catch (error) {
      console.error('Install failed:', error);
    } finally {
      setIsInstalling(false);
    }
  };

  if (!showButton) return null;

  return (
    <div className="floating-install-button" style={{
      position: 'fixed',
      bottom: '20px',
      right: '20px',
      zIndex: 1000
    }}>
      <button
        onClick={handleInstall}
        disabled={isInstalling}
        style={{
          background: 'linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%)',
          color: 'white',
          border: 'none',
          borderRadius: '50px',
          padding: '12px 20px',
          fontSize: '14px',
          fontWeight: '600',
          cursor: isInstalling ? 'not-allowed' : 'pointer',
          opacity: isInstalling ? 0.7 : 1,
          transition: 'all 0.2s ease',
          boxShadow: '0 4px 12px rgba(59, 130, 246, 0.4)',
          display: 'flex',
          alignItems: 'center',
          gap: '8px',
          minWidth: '140px',
          justifyContent: 'center'
        }}
        onMouseEnter={(e) => {
          e.target.style.transform = 'translateY(-2px)';
          e.target.style.boxShadow = '0 6px 20px rgba(59, 130, 246, 0.6)';
        }}
        onMouseLeave={(e) => {
          e.target.style.transform = 'translateY(0)';
          e.target.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.4)';
        }}
      >
        {isInstalling ? (
          <>
            <div className="loading-spinner" style={{
              width: '16px',
              height: '16px',
              border: '2px solid rgba(255, 255, 255, 0.3)',
              borderTop: '2px solid white',
              borderRadius: '50%',
              animation: 'spin 1s linear infinite'
            }}></div>
            Installing...
          </>
        ) : (
          <>
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                    d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
            </svg>
            Install App
          </>
        )}
      </button>

      <style jsx>{`
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      `}</style>
    </div>
  );
} ```

### components/FloatingAskRileyButton.js
```
import { useState, useEffect } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/router';

export default function FloatingAskRileyButton() {
  const [isVisible, setIsVisible] = useState(false);
  const [isExpanded, setIsExpanded] = useState(false);
  const router = useRouter();

  useEffect(() => {
    const timer = setTimeout(() => {
      setIsVisible(true);
    }, 3000); // Show after 3 seconds

    return () => clearTimeout(timer);
  }, []);

  // Don't show on the Ask Riley page itself
  if (router.pathname === '/ask-riley') {
    return null;
  }

  const handleMouseEnter = () => {
    setIsExpanded(true);
  };

  const handleMouseLeave = () => {
    setIsExpanded(false);
  };

  if (!isVisible) return null;

  return (
    <div className="fixed bottom-6 right-6 z-50">
      <Link
        href="/ask-riley"
        className={`group flex items-center gap-3 bg-gradient-to-r from-brand-blue to-brand-purple text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105 ${
          isExpanded ? 'px-6 py-4' : 'p-4'
        }`}
        onMouseEnter={handleMouseEnter}
        onMouseLeave={handleMouseLeave}
      >
        {/* Robot Icon */}
        <div className="w-6 h-6 flex items-center justify-center">
          <span className="text-xl">ü§ñ</span>
        </div>

        {/* Expandable Text */}
        <div
          className={`overflow-hidden transition-all duration-300 whitespace-nowrap ${
            isExpanded ? 'max-w-32 opacity-100' : 'max-w-0 opacity-0'
          }`}
        >
          <span className="font-medium text-sm">Ask Riley</span>
        </div>

        {/* Pulse animation for attention */}
        <div className="absolute inset-0 rounded-full bg-gradient-to-r from-brand-blue to-brand-purple opacity-75 animate-ping" />
      </Link>

      {/* Tooltip for when not expanded */}
      {!isExpanded && (
        <div className="absolute bottom-full right-0 mb-2 px-3 py-2 bg-neutral-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap">
          Ask Riley your bike questions
          <div className="absolute top-full right-4 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-neutral-900" />
        </div>
      )}
    </div>
  );
}```

### components/AppDownloadCTA.js
```
// components/AppDownloadCTA.js - Landing page CTA for app download
import { useState, useEffect } from 'react';
import { canInstall, getInstallPrompt, installPWA, checkIfPWA, isMobileDevice } from '../lib/pwa-utils';

export default function AppDownloadCTA() {
  const [showInstallButton, setShowInstallButton] = useState(false);
  const [deferredPrompt, setDeferredPrompt] = useState(null);
  const [isInstalling, setIsInstalling] = useState(false);
  const [isMobile, setIsMobile] = useState(false);

  useEffect(() => {
    setIsMobile(isMobileDevice());
    
    const checkInstallability = async () => {
      if (checkIfPWA()) return;
      
      if (canInstall()) {
        const prompt = await getInstallPrompt();
        if (prompt) {
          setDeferredPrompt(prompt);
          setShowInstallButton(true);
        }
      }
    };

    checkInstallability();
  }, []);

  const handleInstall = async () => {
    if (!deferredPrompt) return;
    
    setIsInstalling(true);
    try {
      const success = await installPWA(deferredPrompt);
      if (success) {
        setShowInstallButton(false);
        alert('üéâ CrankSmith installed successfully! You can now access it from your home screen.');
      }
    } catch (error) {
      console.error('Install failed:', error);
    } finally {
      setIsInstalling(false);
    }
  };

  return (
    <section className="app-download-cta py-16" style={{
      background: 'var(--bg-secondary)',
      borderTop: '1px solid var(--border-light)',
      borderBottom: '1px solid var(--border-light)'
    }}>
      <div className="max-w-6xl mx-auto px-6">
        <div className="text-center mb-12">
          <h2 className="text-4xl md:text-5xl font-bold mb-6" style={{ color: 'var(--text-primary)' }}>
            Get the Full CrankSmith Experience
          </h2>
                      <p className="text-xl max-w-3xl mx-auto leading-relaxed" style={{ color: 'var(--text-secondary)' }}>
            Download our mobile app for offline access, faster performance, and a native app experience
          </p>
        </div>

        <div className="grid md:grid-cols-2 gap-12 items-center">
          {/* App Features */}
          <div className="space-y-6">
            <div className="card">
              <div className="flex items-start gap-4">
                <div style={{
                  width: '48px',
                  height: '48px',
                  background: 'linear-gradient(135deg, #10B981 0%, #059669 100%)',
                  borderRadius: '12px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontSize: '20px'
                }}>
                  üì±
                </div>
                <div>
                  <h3 className="text-xl font-semibold mb-2 text-white">Mobile App</h3>
                  <p style={{ color: 'var(--text-secondary)' }}>
                    Optimized for mobile devices with touch-friendly interface and gesture controls
                  </p>
                </div>
              </div>
            </div>

            <div className="card">
              <div className="flex items-start gap-4">
                <div style={{
                  width: '48px',
                  height: '48px',
                  background: 'linear-gradient(135deg, #F59E0B 0%, #D97706 100%)',
                  borderRadius: '12px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontSize: '20px'
                }}>
                  üîÑ
                </div>
                <div>
                  <h3 className="text-xl font-semibold mb-2 text-white">Offline Access</h3>
                  <p style={{ color: 'var(--text-secondary)' }}>
                    Works without internet connection - perfect for bike shops and trailside calculations
                  </p>
                </div>
              </div>
            </div>

            <div className="card">
              <div className="flex items-start gap-4">
                <div style={{
                  width: '48px',
                  height: '48px',
                  background: 'linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%)',
                  borderRadius: '12px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontSize: '20px'
                }}>
                  ‚ö°
                </div>
                <div>
                  <h3 className="text-xl font-semibold mb-2 text-white">Lightning Fast</h3>
                  <p style={{ color: 'var(--text-secondary)' }}>
                    Instant calculations and smooth animations for the best user experience
                  </p>
                </div>
              </div>
            </div>
          </div>

          {/* Download Section */}
          <div className="text-center">
            <div style={{
              background: 'linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%)',
              borderRadius: '24px',
              padding: '40px',
              border: '1px solid rgba(255, 255, 255, 0.1)',
              boxShadow: '0 20px 40px rgba(59, 130, 246, 0.3)'
            }}>
              <div style={{
                width: '120px',
                height: '120px',
                background: 'rgba(255, 255, 255, 0.2)',
                borderRadius: '24px',
                margin: '0 auto 24px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: '48px'
              }}>
                üö¥
              </div>
              
              <h3 className="text-2xl font-bold text-white mb-4">Download CrankSmith</h3>
              <p className="mb-8" style={{ color: 'var(--text-secondary)' }}>
                Get the complete bike gear calculator experience on your device
              </p>

              {showInstallButton ? (
                <button
                  onClick={handleInstall}
                  disabled={isInstalling}
                  style={{
                    background: 'rgba(255, 255, 255, 0.2)',
                    color: 'white',
                    border: '2px solid rgba(255, 255, 255, 0.3)',
                    borderRadius: '16px',
                    padding: '16px 32px',
                    fontSize: '18px',
                    fontWeight: '600',
                    cursor: isInstalling ? 'not-allowed' : 'pointer',
                    opacity: isInstalling ? 0.7 : 1,
                    transition: 'all 0.2s ease',
                    width: '100%',
                    maxWidth: '280px'
                  }}
                >
                  {isInstalling ? 'Installing...' : 'Install App'}
                </button>
              ) : (
                <div className="space-y-4">
                  <a
                    href="/mobile"
                    style={{
                      background: 'rgba(255, 255, 255, 0.2)',
                      color: 'white',
                      border: '2px solid rgba(255, 255, 255, 0.3)',
                      borderRadius: '16px',
                      padding: '16px 32px',
                      fontSize: '18px',
                      fontWeight: '600',
                      textDecoration: 'none',
                      display: 'inline-block',
                      transition: 'all 0.2s ease',
                      width: '100%',
                      maxWidth: '280px'
                    }}
                  >
                    Try Mobile App
                  </a>
                  
                  {isMobile && (
                    <p className="text-sm" style={{ color: 'var(--text-secondary)' }}>
                      Tap "Add to Home Screen" in your browser menu
                    </p>
                  )}
                </div>
              )}

              <div className="mt-6 text-xs" style={{ color: 'var(--text-secondary)' }}>
                <p>Free ‚Ä¢ No ads ‚Ä¢ Privacy focused</p>
                <p>Works on iOS, Android & Desktop</p>
              </div>
            </div>
          </div>
        </div>

        {/* Testimonials */}
        <div className="mt-16 text-center">
          <h3 className="text-2xl font-semibold mb-8 text-white">What Cyclists Say</h3>
          <div className="grid md:grid-cols-3 gap-6">
            <div className="card">
              <div className="text-2xl mb-2">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
              <p style={{ color: 'var(--text-secondary)' }} className="mb-4">"Finally, a gear calculator that actually works offline!"</p>
              <p className="text-sm" style={{ color: 'var(--text-tertiary)' }}>- Mountain Biker</p>
            </div>
            <div className="card">
              <div className="text-2xl mb-2">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
              <p style={{ color: 'var(--text-secondary)' }} className="mb-4">"The mobile app is so much faster than the website"</p>
              <p className="text-sm" style={{ color: 'var(--text-tertiary)' }}>- Road Cyclist</p>
            </div>
            <div className="card">
              <div className="text-2xl mb-2">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
              <p style={{ color: 'var(--text-secondary)' }} className="mb-4">"Perfect for bike shop consultations"</p>
              <p className="text-sm" style={{ color: 'var(--text-tertiary)' }}>- Bike Mechanic</p>
            </div>
          </div>
        </div>
      </div>
    </section>
  );
} ```

### components/BuildSummaryCard.js
```
// components/BuildSummaryCard.js - FIXED VERSION
// Critical Bug Fix: PDF export now has proper fallback handling
// Quick Win: Added simplified export options

import { useState } from 'react';

export default function BuildSummaryCard({ 
  currentSetup, 
  proposedSetup, 
  results, 
  onSave 
}) {
  const [isExporting, setIsExporting] = useState(false);

  const { current, proposed, comparison } = results;

  // Helper functions
  const formatSpecs = (setup) => ({
    crankset: `${setup.crankset.name} (${setup.crankset.teeth.join('/')})`,
    cassette: `${setup.cassette.name} (${setup.cassette.teeth.join('-')})`,
    wheel: `${setup.wheel.name}`,
    tire: `${setup.tire.name} (${setup.tire.width}mm)`
  });

  // Fixed compatibility checking
  const checkCompatibility = () => {
    const issues = [];
    const warnings = [];
    
    // Speed compatibility check
    if (currentSetup.cassette.speeds !== proposedSetup.cassette.speeds) {
      issues.push(`Speed mismatch: ${currentSetup.cassette.speeds}s vs ${proposedSetup.cassette.speeds}s`);
    }
    
    // Chain line and derailleur capacity warnings
    if (proposedSetup.crankset.teeth && proposedSetup.cassette.teeth) {
      const crankRange = Math.max(...proposedSetup.crankset.teeth) - Math.min(...proposedSetup.crankset.teeth);
      const cassetteRange = Math.max(...proposedSetup.cassette.teeth) - Math.min(...proposedSetup.cassette.teeth);
      
      if (crankRange > 20 && cassetteRange > 400) {
        warnings.push("Wide range setup may have chain line issues");
      }
    }
    
    return {
      status: issues.length > 0 ? 'error' : warnings.length > 0 ? 'warning' : 'compatible',
      issues,
      warnings
    };
  };

  const compatibility = checkCompatibility();
  const currentSpecs = formatSpecs(currentSetup);
  const proposedSpecs = formatSpecs(proposedSetup);

  // Smart recommendation generator
  const generateBottomLine = () => {
    const weightChange = comparison.weightChange || 0;
    const speedChange = parseFloat(proposed.metrics.highSpeed) - parseFloat(current.metrics.highSpeed);
    const rangeChange = parseInt(proposed.gearRange) - parseInt(current.gearRange);
    
    let message = "Your proposed setup ";
    const benefits = [];
    
    if (weightChange < -10) benefits.push(`saves ${Math.abs(weightChange)}g`);
    else if (weightChange > 10) benefits.push(`adds ${weightChange}g`);
    
    if (speedChange > 0.3) benefits.push(`gives you ${speedChange.toFixed(1)} ${comparison.speedUnit} more top speed`);
    else if (speedChange < -0.3) benefits.push(`reduces top speed by ${Math.abs(speedChange).toFixed(1)} ${comparison.speedUnit}`);
    
    if (rangeChange > 20) benefits.push(`adds ${rangeChange.toFixed(1)}% more gear range`);
    else if (rangeChange < -20) benefits.push(`reduces gear range by ${Math.abs(rangeChange).toFixed(1)}%`);
    
    if (benefits.length === 0) {
      return "Your proposed setup offers similar performance with different characteristics.";
    }
    
    message += benefits.join(", ") + ". ";
    
    const majorBenefits = benefits.length >= 2 || weightChange < -50 || speedChange > 1 || rangeChange > 50;
    message += majorBenefits ? "Worth the upgrade!" : "Minor improvement - consider your priorities.";
    
    return message;
  };

  // FIXED: Robust export function with proper fallback
  const exportToPDF = async () => {
    setIsExporting(true);
    
    try {
      // First try PDF export
      const jsPDFModule = await import('jspdf').catch(() => null);
      
      if (jsPDFModule) {
        await generatePDF(jsPDFModule.jsPDF);
      } else {
        // Fallback to JSON export if PDF fails
        console.warn('PDF library not available, exporting as JSON');
        exportToJSON();
      }
    } catch (error) {
      console.error('Export failed:', error);
      // Always fallback to JSON export
      exportToJSON();
    } finally {
      setIsExporting(false);
    }
  };

  // PDF generation function
  const generatePDF = async (jsPDF) => {
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth();
    
    // Header
    doc.setFontSize(24);
    doc.setTextColor(0, 122, 255);
    doc.text('CrankSmith Build Summary', pageWidth / 2, 30, { align: 'center' });
    
    doc.setFontSize(12);
    doc.setTextColor(100);
    doc.text(`Generated on ${new Date().toLocaleDateString()}`, pageWidth / 2, 40, { align: 'center' });
    
    // Current Setup Section
    let yPosition = 60;
    doc.setFontSize(16);
    doc.setTextColor(0);
    doc.text('Current Setup', 20, yPosition);
    
    yPosition += 15;
    doc.setFontSize(10);
    doc.setTextColor(60);
    
    const currentItems = [
      `Crankset: ${currentSpecs.crankset}`,
      `Cassette: ${currentSpecs.cassette}`,
      `Wheel: ${currentSpecs.wheel}`,
      `Tire: ${currentSpecs.tire}`,
      `Top Speed: ${current.metrics.highSpeed} ${comparison.speedUnit}`,
      `Weight: ${current.totalWeight}g`
    ];
    
    currentItems.forEach(item => {
      doc.text(item, 25, yPosition);
      yPosition += 6;
    });
    
    // Proposed Setup Section
    yPosition += 20;
    doc.setFontSize(16);
    doc.setTextColor(0);
    doc.text('Proposed Setup', 20, yPosition);
    
    yPosition += 15;
    doc.setFontSize(10);
    doc.setTextColor(60);
    
    const proposedItems = [
      `Crankset: ${proposedSpecs.crankset}`,
      `Cassette: ${proposedSpecs.cassette}`,
      `Wheel: ${proposedSpecs.wheel}`,
      `Tire: ${proposedSpecs.tire}`,
      `Top Speed: ${proposed.metrics.highSpeed} ${comparison.speedUnit}`,
      `Weight: ${proposed.totalWeight}g`
    ];
    
    proposedItems.forEach(item => {
      doc.text(item, 25, yPosition);
      yPosition += 6;
    });
    
    // Analysis Section
    yPosition += 20;
    doc.setFontSize(16);
    doc.setTextColor(0);
    doc.text('Analysis', 20, yPosition);
    
    yPosition += 15;
    doc.setFontSize(10);
    doc.setTextColor(60);
    doc.text(generateBottomLine(), 25, yPosition, { maxWidth: pageWidth - 50 });
    
    // Save the PDF
    doc.save(`cranksmith-build-summary-${Date.now()}.pdf`);
  };

  // JSON export fallback
  const exportToJSON = () => {
    const exportData = {
      timestamp: new Date().toISOString(),
      current: { setup: currentSetup, results: current },
      proposed: { setup: proposedSetup, results: proposed },
      comparison,
      compatibility,
      analysis: generateBottomLine()
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `cranksmith-analysis-${Date.now()}.json`;
    link.click();
    URL.revokeObjectURL(url);
  };

  return (
    <div className="bg-[var(--surface-elevated)] border border-[var(--border-subtle)] rounded-xl p-6 mb-8">
      {/* Header */}
      <div className="text-center mb-6">
        <h2 className="text-2xl font-bold text-[var(--text-primary)] mb-2">
          Build Summary
        </h2>
        <p className="text-[var(--text-secondary)]">
          {generateBottomLine()}
        </p>
      </div>

      {/* Compatibility Status - FIXED */}
      <div className="mb-6 p-4 rounded-lg border" style={{
        backgroundColor: compatibility.status === 'error' ? 'rgba(239, 68, 68, 0.1)' : 
                         compatibility.status === 'warning' ? 'rgba(245, 158, 11, 0.1)' : 
                         'rgba(76, 175, 80, 0.1)',
        borderColor: compatibility.status === 'error' ? '#dc3545' : 
                     compatibility.status === 'warning' ? '#ffc107' : 
                     '#4CAF50'
      }}>
        <div className="flex items-center mb-2">
          <div className="w-3 h-3 rounded-full mr-3" style={{
            backgroundColor: compatibility.status === 'error' ? '#dc3545' : 
                             compatibility.status === 'warning' ? '#ffc107' : 
                             '#4CAF50'
          }}></div>
          <span className="text-base font-medium" style={{ 
            color: compatibility.status === 'error' ? '#dc3545' : 
                   compatibility.status === 'warning' ? '#ffc107' : 
                   '#4CAF50'
          }}>
            {compatibility.status === 'error' ? '‚ö†Ô∏è Compatibility Issues' : 
             compatibility.status === 'warning' ? '‚ö†Ô∏è Compatibility Warnings' : 
             '‚úì Components are compatible'}
          </span>
        </div>
        
        {compatibility.issues.length > 0 && (
          <div className="mb-2">
            <p className="text-sm font-medium text-red-600 mb-1">Issues:</p>
            {compatibility.issues.map((issue, index) => (
              <p key={index} className="text-sm text-red-700">‚Ä¢ {issue}</p>
            ))}
          </div>
        )}
        
        {compatibility.warnings.length > 0 && (
          <div>
            <p className="text-sm font-medium text-yellow-600 mb-1">Warnings:</p>
            {compatibility.warnings.map((warning, index) => (
              <p key={index} className="text-sm text-yellow-700">‚Ä¢ {warning}</p>
            ))}
          </div>
        )}
      </div>

      {/* Action Buttons - FIXED */}
      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <button
          onClick={onSave}
          className="bg-[var(--accent-blue)] hover:bg-blue-600 text-white font-medium py-3 px-6 rounded-xl transition-all text-lg"
        >
          <svg className="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                  d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12"/>
          </svg>
          Save to Garage
        </button>
        
        <button
          onClick={exportToPDF}
          disabled={isExporting}
          className="text-white font-medium py-3 px-6 rounded-xl transition-all text-lg"
          style={{ 
            backgroundColor: (!proposedSetup.crankset || !proposedSetup.cassette) ? 'var(--bg-tertiary)' : 'var(--brand-green)',
            color: (!proposedSetup.crankset || !proposedSetup.cassette) ? 'var(--text-disabled)' : 'white'
          }}
          onMouseEnter={(e) => {
            if (!e.target.disabled) {
              e.target.style.backgroundColor = 'rgba(var(--brand-green) / 0.8)';
            }
          }}
          onMouseLeave={(e) => {
            if (!e.target.disabled) {
              e.target.style.backgroundColor = 'var(--brand-green)';
            }
          }}
        >
          <svg className="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                  d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          {isExporting ? 'Exporting...' : 'Export Analysis'}
        </button>
        
        <button
          onClick={() => window.print()}
          className="text-white font-medium py-3 px-6 rounded-xl transition-all text-lg"
          style={{ 
            backgroundColor: 'var(--bg-tertiary)',
            color: 'var(--text-primary)'
          }}
          onMouseEnter={(e) => {
            e.target.style.backgroundColor = 'var(--bg-secondary)';
          }}
          onMouseLeave={(e) => {
            e.target.style.backgroundColor = 'var(--bg-tertiary)';
          }}
        >
          <svg className="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                  d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
          </svg>
          Print
        </button>
      </div>
    </div>
  );
}```

### components/ImportExportManager.js
```
// components/ErrorBoundary.js - IMPROVED VERSION
// Critical Bug Fix: Better error handling and more helpful fallback UI
// Quick Win: Automatic error reporting and recovery suggestions

import React from 'react';

export default class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { 
      hasError: false, 
      error: null, 
      errorInfo: null,
      errorId: null
    };
  }

  static getDerivedStateFromError(error) {
    // Update state so the next render will show the fallback UI
    return { 
      hasError: true,
      errorId: Date.now() // Unique error ID for tracking
    };
  }

  componentDidCatch(error, errorInfo) {
    // Enhanced error logging
    const errorDetails = {
      error: error.toString(),
      componentStack: errorInfo.componentStack,
      errorBoundary: this.props.context || 'unknown',
      timestamp: new Date().toISOString(),
      userAgent: navigator.userAgent,
      url: window.location.href,
      errorId: this.state.errorId || Date.now()
    };

    console.error('ErrorBoundary caught an error:', errorDetails);
    
    // Store error details for debugging and user reporting
    this.setState({
      error: error,
      errorInfo: errorInfo
    });

    // Report to analytics if available
    if (typeof window !== 'undefined' && window.gtag) {
      window.gtag('event', 'exception', {
        description: error.toString(),
        fatal: false,
        custom_map: {
          component: this.props.context || 'unknown'
        }
      });
    }

    // Store error in localStorage for potential user reporting
    try {
      const existingErrors = JSON.parse(localStorage.getItem('cranksmith_errors') || '[]');
      existingErrors.push(errorDetails);
      // Keep only last 5 errors to prevent storage bloat
      const recentErrors = existingErrors.slice(-5);
      localStorage.setItem('cranksmith_errors', JSON.stringify(recentErrors));
    } catch (storageError) {
      console.warn('Failed to store error details:', storageError);
    }
  }

  handleReset = () => {
    this.setState({ 
      hasError: false, 
      error: null, 
      errorInfo: null,
      errorId: null 
    });
  }

  handleReload = () => {
    // Clear any cached data that might be causing issues
    if ('caches' in window) {
      caches.keys().then(names => {
        names.forEach(name => {
          caches.delete(name);
        });
      }).then(() => {
        window.location.reload();
      });
    } else {
      window.location.reload();
    }
  }

  handleReportError = () => {
    const errorDetails = {
      errorId: this.state.errorId,
      timestamp: new Date().toISOString(),
      component: this.props.context || 'unknown',
      error: this.state.error?.toString() || 'Unknown error',
      userAgent: navigator.userAgent.substring(0, 100) // Truncate for privacy
    };

    const mailtoLink = `mailto:support@cranksmith.com?subject=Error Report - ${errorDetails.errorId}&body=${encodeURIComponent(
      `Error Report\n\n` +
      `Error ID: ${errorDetails.errorId}\n` +
      `Component: ${errorDetails.component}\n` +
      `Time: ${errorDetails.timestamp}\n` +
      `Browser: ${errorDetails.userAgent}\n\n` +
      `Error Details:\n${errorDetails.error}\n\n` +
      `Please describe what you were doing when this error occurred:\n\n`
    )}`;

    window.location.href = mailtoLink;
  }

  getErrorSuggestions = () => {
    const { context } = this.props;
    const errorString = this.state.error?.toString() || '';

    // Common error patterns and suggestions
    if (errorString.includes('ChunkLoadError') || errorString.includes('Loading chunk')) {
      return {
        title: 'Loading Error',
        suggestions: [
          'Your internet connection may be unstable',
          'Try refreshing the page',
          'Clear your browser cache',
          'Check if you have an ad blocker interfering'
        ]
      };
    }

    if (errorString.includes('Cannot read property') || errorString.includes('Cannot read properties')) {
      return {
        title: 'Data Error',
        suggestions: [
          'Some component data may be corrupted',
          'Try resetting this component',
          'Clear your browser data for this site',
          'Try using a different browser'
        ]
      };
    }

    if (context === 'page') {
      return {
        title: 'Page Error',
        suggestions: [
          'Try refreshing the page',
          'Go back to the home page',
          'Clear your browser cache',
          'Try using an incognito/private window'
        ]
      };
    }

    // Default suggestions
    return {
      title: 'Component Error',
      suggestions: [
        'Try refreshing the page',
        'The error may be temporary',
        'Try using a different browser',
        'Clear your browser data if the problem persists'
      ]
    };
  }

  render() {
    if (this.state.hasError) {
      // Custom fallback UI
      const { fallback, context = 'component' } = this.props;
      
      if (fallback) {
        return fallback;
      }

      const containerClass = context === 'page' ? 'min-h-screen' : 'min-h-[200px]';
      const errorSuggestions = this.getErrorSuggestions();
      
      return (
        <div className={`${containerClass} flex items-center justify-center p-8`} style={{ backgroundColor: 'var(--bg-secondary)' }}>
          <div className="text-center max-w-lg mx-auto">
            {/* Error Icon */}
            <div className="mb-6">
              <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-red-100 dark:bg-red-900 flex items-center justify-center">
                <svg className="w-8 h-8 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
            </div>
            
            {/* Error Title */}
            <h3 className="text-xl font-semibold mb-2" style={{ color: 'var(--text-primary)' }}>
              {errorSuggestions.title}
            </h3>
            
            {/* Error Description */}
            <p className="text-sm mb-6" style={{ color: 'var(--text-secondary)' }}>
              {context === 'page' 
                ? "We're having trouble loading this page. This is usually temporary."
                : "This component encountered an error. You can try the suggestions below or continue using other features."
              }
            </p>

            {/* Error ID for support */}
            <div className="mb-6 p-3 rounded-lg" style={{ backgroundColor: 'var(--bg-tertiary)' }}>
              <p className="text-xs" style={{ color: 'var(--text-tertiary)' }}>
                Error ID: <span className="font-mono">{this.state.errorId}</span>
              </p>
            </div>

            {/* Suggestions */}
            <div className="mb-6 text-left">
                          <h4 className="font-medium mb-2" style={{ color: 'var(--text-primary)' }}>What you can try:</h4>
            <ul className="text-sm space-y-1" style={{ color: 'var(--text-secondary)' }}>
                {errorSuggestions.suggestions.map((suggestion, index) => (
                  <li key={index} className="flex items-start gap-2">
                    <span className="text-blue-600 dark:text-blue-400 mt-0.5">‚Ä¢</span>
                    <span>{suggestion}</span>
                  </li>
                ))}
              </ul>
            </div>
            
            {/* Action Buttons */}
            <div className="flex flex-col sm:flex-row gap-3 justify-center">
              <button
                onClick={this.handleReset}
                className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm font-medium"
              >
                Try Again
              </button>
              
              <button
                onClick={this.handleReload}
                className="px-4 py-2 border rounded-md transition-colors text-sm font-medium"
                style={{ 
                  borderColor: 'var(--border-primary)',
                  color: 'var(--text-primary)',
                  backgroundColor: 'var(--bg-secondary)'
                }}
                onMouseEnter={(e) => {
                  e.target.style.backgroundColor = 'var(--bg-tertiary)';
                }}
                onMouseLeave={(e) => {
                  e.target.style.backgroundColor = 'var(--bg-secondary)';
                }}
              >
                Refresh Page
              </button>

              <button
                onClick={this.handleReportError}
                className="px-4 py-2 border rounded-md transition-colors text-sm font-medium"
                style={{ 
                  borderColor: 'var(--border-primary)',
                  color: 'var(--text-primary)',
                  backgroundColor: 'var(--bg-secondary)'
                }}
                onMouseEnter={(e) => {
                  e.target.style.backgroundColor = 'var(--bg-tertiary)';
                }}
                onMouseLeave={(e) => {
                  e.target.style.backgroundColor = 'var(--bg-secondary)';
                }}
              >
                Report Error
              </button>
            </div>
            
            {/* Debug info in development */}
            {process.env.NODE_ENV === 'development' && this.state.error && (
              <details className="mt-6 text-left">
                <summary className="cursor-pointer text-sm font-medium mb-2" style={{ color: 'var(--text-tertiary)' }}>
                  Debug Info (Development Only)
                </summary>
                <pre className="text-xs p-3 rounded overflow-auto max-h-40" style={{ 
                  backgroundColor: 'var(--bg-tertiary)',
                  color: 'var(--text-primary)',
                  border: `1px solid var(--border-primary)`
                }}>
                  {this.state.error.toString()}
                  {this.state.errorInfo && this.state.errorInfo.componentStack}
                </pre>
              </details>
            )}
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}

// HOC wrapper for functional components
export const withErrorBoundary = (Component, errorBoundaryProps = {}) => {
  return function WrappedComponent(props) {
    return (
      <ErrorBoundary {...errorBoundaryProps}>
        <Component {...props} />
      </ErrorBoundary>
    );
  };
};

// Hook for error reporting from functional components
export const useErrorReporting = () => {
  const reportError = (error, context = 'component') => {
    const errorDetails = {
      error: error.toString(),
      context,
      timestamp: new Date().toISOString(),
      url: window.location.href
    };

    console.error('Manual error report:', errorDetails);

    // Report to analytics
    if (typeof window !== 'undefined' && window.gtag) {
      window.gtag('event', 'exception', {
        description: error.toString(),
        fatal: false
      });
    }
  };

  return { reportError };
};```

### components/mobile/MobileLayout.js
```
// components/mobile/MobileLayout.js - Mobile-first layout with bottom navigation
import { useState, useEffect } from 'react';

export default function MobileLayout({ 
  children, 
  currentScreen, 
  setCurrentScreen, 
  isOnline,
  hasResults 
}) {
  const [safeAreaTop, setSafeAreaTop] = useState(0);
  const [safeAreaBottom, setSafeAreaBottom] = useState(0);

  // Handle safe area for notched devices
  useEffect(() => {
    const updateSafeArea = () => {
      const computedStyle = getComputedStyle(document.documentElement);
      const top = computedStyle.getPropertyValue('env(safe-area-inset-top)') || '0px';
      const bottom = computedStyle.getPropertyValue('env(safe-area-inset-bottom)') || '0px';
      
      setSafeAreaTop(parseInt(top) || 0);
      setSafeAreaBottom(parseInt(bottom) || 0);
    };

    updateSafeArea();
    window.addEventListener('resize', updateSafeArea);
    return () => window.removeEventListener('resize', updateSafeArea);
  }, []);

  const navigationItems = [
    {
      id: 'calculator',
      label: 'Calculator',
      icon: (
        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16a2 2 0 002 2z" />
        </svg>
      )
    },
    {
      id: 'results',
      label: 'Results',
      icon: (
        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
      ),
      disabled: !hasResults
    },
    {
      id: 'garage',
      label: 'Garage',
      icon: (
        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
        </svg>
      )
    },
    {
      id: 'settings',
      label: 'Settings',
      icon: (
        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
      )
    }
  ];

  return (
    <div 
      className="mobile-app"
      style={{
        height: '100vh',
        height: '100dvh', // Dynamic viewport height for mobile
        display: 'flex',
        flexDirection: 'column',
        background: '#010309',
        color: 'white',
        paddingTop: `${safeAreaTop}px`,
        paddingBottom: `${safeAreaBottom}px`,
        overflow: 'hidden'
      }}
    >
      {/* Status Bar */}
      <div className="mobile-status-bar px-4 py-2 flex justify-between items-center text-xs"
           style={{ 
             background: 'rgba(0, 0, 0, 0.1)',
             borderBottom: '1px solid rgba(255, 255, 255, 0.1)'
           }}>
        <div className="flex items-center space-x-2">
          <div className="w-2 h-2 rounded-full" 
               style={{ background: isOnline ? '#00A651' : '#DC2626' }}></div>
          <span>{isOnline ? 'Online' : 'Offline'}</span>
        </div>
        <div className="flex items-center space-x-1">
          <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M2 17h20v2H2zm1.15-4.05L4 11.47l.85 1.48L12 5.45l7.15 7.5L20 11.47l-.85 1.48L12 7.05l-7.15 7.9z"/>
          </svg>
          <span>100%</span>
        </div>
      </div>

      {/* Main Content Area */}
      <div 
        className="mobile-content"
        style={{
          flex: 1,
          overflow: 'auto',
          WebkitOverflowScrolling: 'touch',
          padding: '0',
          position: 'relative'
        }}
      >
        {children}
      </div>

      {/* Bottom Navigation */}
      <nav 
        className="mobile-nav"
        style={{
          display: 'flex',
          background: 'rgba(0, 0, 0, 0.9)',
          backdropFilter: 'blur(10px)',
          borderTop: '1px solid rgba(255, 255, 255, 0.1)',
          padding: '8px 0',
          position: 'relative',
          zIndex: 100
        }}
      >
        {navigationItems.map((item) => (
          <button
            key={item.id}
            onClick={() => !item.disabled && setCurrentScreen(item.id)}
            disabled={item.disabled}
            className="nav-item"
            style={{
              flex: 1,
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              padding: '8px 4px',
              background: 'none',
              border: 'none',
              color: currentScreen === item.id ? '#3B82F6' : item.disabled ? '#666' : '#999',
              transition: 'color 0.2s ease',
              minHeight: '56px',
              cursor: item.disabled ? 'not-allowed' : 'pointer'
            }}
          >
            <div className="mb-1" style={{ 
              opacity: item.disabled ? 0.3 : 1,
              transform: currentScreen === item.id ? 'scale(1.1)' : 'scale(1)',
              transition: 'all 0.2s ease'
            }}>
              {item.icon}
            </div>
            <span className="text-xs font-medium">{item.label}</span>
            {currentScreen === item.id && (
              <div 
                className="nav-indicator"
                style={{
                  position: 'absolute',
                  bottom: 0,
                  width: '24px',
                  height: '2px',
                  background: '#3B82F6',
                  borderRadius: '1px 1px 0 0'
                }}
              />
            )}
          </button>
        ))}
      </nav>
    </div>
  );
}```

### components/mobile/BikeTypeSelector.js
```
// components/mobile/BikeTypeSelector.js - Mobile-optimized bike type selection
import { bikeConfig } from '../../lib/components';

export default function BikeTypeSelector({ bikeType, setBikeType, onNext }) {
  const bikeTypes = [
    {
      id: 'road',
      name: 'Road Bike',
      description: 'Speed and efficiency on paved roads',
      emoji: 'üö¥‚Äç‚ôÇÔ∏è',
      gradient: 'linear-gradient(135deg, #FF6B35 0%, #F7931E 100%)',
      features: ['Lightweight', 'Aerodynamic', 'Fast']
    },
    {
      id: 'gravel',
      name: 'Gravel Bike', 
      description: 'Versatile for mixed terrain adventures',
      emoji: 'üöµ‚Äç‚ôÄÔ∏è',
      gradient: 'linear-gradient(135deg, #8B5CF6 0%, #A855F7 100%)',
      features: ['Versatile', 'Comfortable', 'Durable']
    },
    {
      id: 'mtb',
      name: 'Mountain Bike',
      description: 'Built for off-road trails and technical terrain',
      emoji: 'üöµ‚Äç‚ôÇÔ∏è',
      gradient: 'linear-gradient(135deg, #10B981 0%, #059669 100%)',
      features: ['Rugged', 'Suspension', 'Technical']
    }
  ];

  const handleSelection = (typeId) => {
    setBikeType(typeId);
    // Small delay for better UX feedback
    setTimeout(() => {
      onNext();
    }, 200);
  };

  return (
    <div className="mobile-screen" style={{ padding: '20px' }}>
      {/* Header */}
      <div className="text-center mb-8">
        <h1 className="text-3xl font-bold mb-3" style={{ color: 'white' }}>
          Choose Your Bike
        </h1>
        <p className="text-lg" style={{ color: 'var(--text-secondary)' }}>
          Select your bike type to get started with gear optimization
        </p>
      </div>

      {/* Bike Type Cards */}
      <div className="space-y-4">
        {bikeTypes.map((type) => (
          <button
            key={type.id}
            onClick={() => handleSelection(type.id)}
            className="bike-type-card w-full text-left"
            style={{
              background: bikeType === type.id ? type.gradient : 'rgba(255, 255, 255, 0.05)',
              border: `2px solid ${bikeType === type.id ? 'transparent' : 'rgba(255, 255, 255, 0.1)'}`,
              borderRadius: '16px',
              padding: '20px',
              transition: 'all 0.3s ease',
              transform: bikeType === type.id ? 'scale(1.02)' : 'scale(1)',
              boxShadow: bikeType === type.id ? '0 8px 32px rgba(0, 0, 0, 0.3)' : 'none'
            }}
          >
            <div className="flex items-start space-x-4">
              <div className="text-4xl">{type.emoji}</div>
              <div className="flex-1">
                <h3 className="text-xl font-bold mb-2" style={{ color: 'white' }}>
                  {type.name}
                </h3>
                <p className="mb-3 text-base leading-relaxed" style={{ color: 'var(--text-secondary)' }}>
                  {type.description}
                </p>
                <div className="flex flex-wrap gap-2">
                  {type.features.map((feature, index) => (
                    <span
                      key={index}
                      className="feature-tag"
                      style={{
                        background: bikeType === type.id ? 'rgba(255, 255, 255, 0.2)' : 'rgba(255, 255, 255, 0.1)',
                        color: 'white',
                        padding: '4px 12px',
                        borderRadius: '12px',
                        fontSize: '12px',
                        fontWeight: '500'
                      }}
                    >
                      {feature}
                    </span>
                  ))}
                </div>
              </div>
              {bikeType === type.id && (
                <div className="check-icon">
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} 
                          d="M5 13l4 4L19 7" style={{ color: 'white' }} />
                  </svg>
                </div>
              )}
            </div>
          </button>
        ))}
      </div>

      {/* Continue Button */}
      {bikeType && (
        <div className="mt-8">
          <button
            onClick={onNext}
            className="continue-btn w-full"
            style={{
              background: 'linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%)',
              color: 'white',
              padding: '16px 24px',
              borderRadius: '12px',
              border: 'none',
              fontSize: '18px',
              fontWeight: '600',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              gap: '8px',
              transition: 'all 0.2s ease',
              boxShadow: '0 4px 16px rgba(59, 130, 246, 0.3)'
            }}
          >
            <span>Continue Setup</span>
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
            </svg>
          </button>
        </div>
      )}

      {/* Help Text */}
      <div className="mt-6 text-center">
                  <p className="text-sm" style={{ color: 'var(--text-tertiary)' }}>
          Don't worry, you can always change this later in settings
        </p>
      </div>
    </div>
  );
}```

### components/mobile/ComponentSelector.js
```
// components/mobile/ComponentSelector.js - Fixed z-index and layout issues
import { useState } from 'react';
import { bikeConfig, getComponentsForBikeType } from '../../lib/components';
import MobileDropdown from './MobileDropdown';

export default function ComponentSelector({
  bikeType,
  currentSetup,
  setCurrentSetup,
  proposedSetup,
  setProposedSetup,
  setupStep,
  setSetupStep,
  onCalculate,
  loading,
  onReset
}) {
  const [activeSetup, setActiveSetup] = useState('current'); // 'current' or 'proposed'
  
  const config = bikeConfig[bikeType];
  const components = getComponentsForBikeType(bikeType);
  
  const isCurrentSetup = activeSetup === 'current';
  const setup = isCurrentSetup ? currentSetup : proposedSetup;
  const setSetup = isCurrentSetup ? setCurrentSetup : setProposedSetup;

  const calculateCompletion = (setup) => {
    const required = ['wheel', 'tire', 'crankset', 'cassette'];
    const completed = required.filter(field => {
      const value = setup[field];
      if (field === 'crankset' || field === 'cassette') {
        return value && typeof value === 'object' && Object.keys(value).length > 0;
      }
      // Simple check for non-empty string values
      return value && (typeof value !== 'string' || value.trim() !== '');
    });
    return (completed.length / required.length) * 100;
  };

  const currentCompletion = calculateCompletion(currentSetup);
  const proposedCompletion = calculateCompletion(proposedSetup);
  const totalCompletion = (currentCompletion + proposedCompletion) / 2;

  const canCalculate = !isNaN(currentCompletion) && !isNaN(proposedCompletion) && currentCompletion === 100 && proposedCompletion === 100;

  const handleComponentChange = (field, value) => {
    setSetup(prev => ({ ...prev, [field]: value }));
  };

  const formatComponentOptions = (components, type) => {
    return components.map(component => ({
      id: component.id,
      label: `${component.model} ${component.variant}`,
      subtitle: `${component.weight}g ‚Ä¢ ${component.speeds}`,
      value: component
    }));
  };

  return (
    <div className="mobile-screen" style={{ 
      padding: '0',
      height: '100%',
      display: 'flex',
      flexDirection: 'column',
      overflow: 'hidden'
    }}>
      {/* Header */}
      <div className="mobile-header" style={{ 
        padding: '20px 20px 16px 20px',
        background: 'linear-gradient(180deg, rgba(0, 0, 0, 0.1) 0%, transparent 100%)',
        borderBottom: '1px solid rgba(255, 255, 255, 0.1)',
        flexShrink: 0
      }}>
        <div className="flex items-center justify-between mb-4">
          <button
            onClick={onReset}
            className="reset-btn"
            style={{
              background: 'rgba(255, 255, 255, 0.1)',
              border: 'none',
              borderRadius: '8px',
              padding: '8px 12px',
              color: 'white',
              fontSize: '14px'
            }}
          >
            ‚Üê Back
          </button>
          <h1 className="text-xl font-bold" style={{ color: 'white' }}>
            {config.name} Setup
          </h1>
          <div className="w-16" /> {/* Spacer */}
        </div>

        {/* Progress Bar */}
        <div className="progress-container mb-4">
          <div className="flex justify-between text-sm mb-2" style={{ color: 'var(--text-secondary)' }}>
            <span>Setup Progress</span>
            <span>{isNaN(totalCompletion) ? '0' : Math.round(totalCompletion)}%</span>
          </div>
          <div 
            className="progress-bar"
            style={{
              width: '100%',
              height: '4px',
              background: 'rgba(255, 255, 255, 0.1)',
              borderRadius: '2px',
              overflow: 'hidden'
            }}
          >
            <div 
              className="progress-fill"
              style={{
                width: `${isNaN(totalCompletion) ? 0 : totalCompletion}%`,
                height: '100%',
                background: 'linear-gradient(90deg, #3B82F6 0%, #10B981 100%)',
                borderRadius: '2px',
                transition: 'width 0.3s ease'
              }}
            />
          </div>
        </div>

        {/* Setup Toggle */}
        <div className="setup-toggle" style={{
          display: 'flex',
          background: 'rgba(255, 255, 255, 0.1)',
          borderRadius: '12px',
          padding: '4px'
        }}>
          <button
            onClick={() => setActiveSetup('current')}
            className="toggle-btn"
            style={{
              flex: 1,
              padding: '12px',
              border: 'none',
              borderRadius: '8px',
              background: activeSetup === 'current' ? 'white' : 'transparent',
              color: activeSetup === 'current' ? '#000' : 'white',
              fontWeight: '600',
              transition: 'all 0.2s ease'
            }}
          >
            Current ({isNaN(currentCompletion) ? '0' : Math.round(currentCompletion)}%)
          </button>
          <button
            onClick={() => setActiveSetup('proposed')}
            className="toggle-btn"
            style={{
              flex: 1,
              padding: '12px',
              border: 'none',
              borderRadius: '8px',
              background: activeSetup === 'proposed' ? 'white' : 'transparent',
              color: activeSetup === 'proposed' ? '#000' : 'white',
              fontWeight: '600',
              transition: 'all 0.2s ease'
            }}
          >
            Proposed ({isNaN(proposedCompletion) ? '0' : Math.round(proposedCompletion)}%)
          </button>
        </div>
      </div>

      {/* Component Selection */}
      <div className="component-form" style={{ 
        flex: 1,
        overflow: 'auto',
        WebkitOverflowScrolling: 'touch',
        padding: '20px',
        paddingBottom: '200px' // Extra space for the fixed bottom actions
      }}>
        <div className="space-y-6">
          {/* Wheel Size */}
          <div>
            <label className="mobile-label">Wheel Size</label>
            <MobileDropdown
              options={config.wheelSizes.map(size => ({
                id: size,
                label: size === '700c' ? '700c (Road/Gravel)' : 
                       size === '650b' ? '650b (Gravel)' : 
                       size === '26-inch' ? '26" (MTB)' :
                       size === '27.5-inch' ? '27.5" (MTB)' :
                       size === '29-inch' ? '29" (MTB)' : size,
                value: size
              }))}
              value={setup.wheel}
              onChange={(value) => handleComponentChange('wheel', value)}
              placeholder="Select wheel size"
            />
          </div>

          {/* Tire Width */}
          <div>
            <label className="mobile-label">Tire Width</label>
            <MobileDropdown
              options={config.tireWidths.map(width => ({
                id: width,
                label: typeof width === 'number' && width < 10 ? `${width}"` : `${width}mm`,
                value: width
              }))}
              value={setup.tire}
              onChange={(value) => handleComponentChange('tire', value)}
              placeholder="Select tire width"
            />
          </div>

          {/* Crankset */}
          <div>
            <label className="mobile-label">Crankset</label>
            <MobileDropdown
              options={formatComponentOptions(components.cranksets, 'crankset')}
              value={setup.crankset}
              onChange={(value) => handleComponentChange('crankset', value)}
              placeholder="Select crankset"
              searchable
            />
          </div>

          {/* Cassette */}
          <div>
            <label className="mobile-label">Cassette</label>
            <MobileDropdown
              options={formatComponentOptions(components.cassettes, 'cassette')}
              value={setup.cassette}
              onChange={(value) => handleComponentChange('cassette', value)}
              placeholder="Select cassette"
              searchable
            />
          </div>
        </div>
      </div>

      {/* Bottom Action Area */}
      <div className="bottom-actions" style={{
        position: 'absolute',
        bottom: 0,
        left: 0,
        right: 0,
        background: 'linear-gradient(180deg, transparent 0%, rgba(0, 0, 0, 0.95) 10%, rgba(0, 0, 0, 1) 100%)',
        padding: '20px',
        borderTop: '1px solid rgba(255, 255, 255, 0.1)',
        zIndex: 10 // Low z-index, dropdowns will be above this
      }}>
        {/* Quick Setup Status */}
        <div className="status-cards" style={{ 
          display: 'grid', 
          gridTemplateColumns: '1fr 1fr', 
          gap: '12px',
          marginBottom: '16px'
        }}>
          <div className="status-card" style={{
            background: currentCompletion === 100 ? 'rgba(16, 185, 129, 0.2)' : 'rgba(255, 255, 255, 0.05)',
            border: `1px solid ${currentCompletion === 100 ? '#10B981' : 'rgba(255, 255, 255, 0.1)'}`,
            borderRadius: '8px',
            padding: '12px',
            textAlign: 'center'
          }}>
            <div className="text-sm" style={{ color: 'var(--text-secondary)' }}>Current</div>
            <div className="text-lg font-bold" style={{ 
              color: currentCompletion === 100 ? '#10B981' : 'white' 
            }}>
              {isNaN(currentCompletion) ? '0' : Math.round(currentCompletion)}%
            </div>
          </div>
          <div className="status-card" style={{
            background: proposedCompletion === 100 ? 'rgba(16, 185, 129, 0.2)' : 'rgba(255, 255, 255, 0.05)',
            border: `1px solid ${proposedCompletion === 100 ? '#10B981' : 'rgba(255, 255, 255, 0.1)'}`,
            borderRadius: '8px',
            padding: '12px',
            textAlign: 'center'
          }}>
            <div className="text-sm" style={{ color: 'var(--text-secondary)' }}>Proposed</div>
            <div className="text-lg font-bold" style={{ 
              color: proposedCompletion === 100 ? '#10B981' : 'white' 
            }}>
              {isNaN(proposedCompletion) ? '0' : Math.round(proposedCompletion)}%
            </div>
          </div>
        </div>

        {/* Calculate Button */}
        <button
          onClick={onCalculate}
          disabled={!canCalculate || loading}
          className="calculate-btn"
          style={{
            width: '100%',
            background: canCalculate && !loading ? 
              'linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%)' : 
              'rgba(255, 255, 255, 0.1)',
            color: canCalculate && !loading ? 'white' : '#666',
            border: 'none',
            borderRadius: '12px',
            padding: '16px 24px',
            fontSize: '18px',
            fontWeight: '600',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            gap: '8px',
            transition: 'all 0.2s ease',
            cursor: canCalculate && !loading ? 'pointer' : 'not-allowed'
          }}
        >
          {loading ? (
            <>
              <svg className="animate-spin w-5 h-5" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
              </svg>
              Analyzing...
            </>
          ) : (
            <>
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                      d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              Analyze Performance
            </>
          )}
        </button>

        {!canCalculate && (
          <p className="text-center text-sm mt-3" style={{ color: 'var(--text-tertiary)' }}>
            Complete both setups to analyze performance
          </p>
        )}
      </div>

      <style jsx>{`
        .mobile-label {
          display: block;
          font-size: 16px;
          font-weight: 600;
          color: white;
          margin-bottom: 8px;
        }
      `}</style>
    </div>
  );
}```

### components/mobile/GarageScreen.js
```
// components/mobile/GarageScreen.js - Mobile garage for saved configurations
import { useState } from 'react';

export default function GarageScreen({ savedConfigs, setSavedConfigs, onLoadConfig }) {
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(null);

  const handleDeleteConfig = (configId) => {
    try {
      const updatedConfigs = savedConfigs.filter(config => config.id !== configId);
      setSavedConfigs(updatedConfigs);
      localStorage.setItem('cranksmith_configs', JSON.stringify(updatedConfigs));
      setShowDeleteConfirm(null);
    } catch (error) {
      console.error('Error deleting configuration:', error);
      alert('Failed to delete configuration');
    }
  };

  const formatDate = (dateString) => {
    return new Date(dateString).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    });
  };

  const getBikeTypeEmoji = (bikeType) => {
    switch (bikeType) {
      case 'road': return 'üö¥‚Äç‚ôÇÔ∏è';
      case 'gravel': return 'üöµ‚Äç‚ôÄÔ∏è';
      case 'mtb': return 'üöµ‚Äç‚ôÇÔ∏è';
      default: return 'üö≤';
    }
  };

  return (
    <div className="mobile-screen garage-screen" style={{ padding: '0', height: '100%' }}>
      {/* Header */}
      <div className="garage-header" style={{
        padding: '20px',
        background: 'linear-gradient(135deg, #8B5CF6 0%, #A855F7 100%)',
        color: 'white'
      }}>
        <h1 className="text-2xl font-bold mb-2">My Garage</h1>
        <p className="text-purple-100">
          {savedConfigs.length} saved configuration{savedConfigs.length !== 1 ? 's' : ''}
        </p>
      </div>

      {/* Configurations List */}
      <div className="configurations-list" style={{
        flex: 1,
        overflow: 'auto',
        WebkitOverflowScrolling: 'touch',
        padding: '20px'
      }}>
        {savedConfigs.length > 0 ? (
          <div className="space-y-4">
            {savedConfigs.map((config) => (
              <div
                key={config.id}
                className="config-card"
                style={{
                  background: 'rgba(255, 255, 255, 0.05)',
                  border: '1px solid rgba(255, 255, 255, 0.1)',
                  borderRadius: '16px',
                  padding: '16px',
                  position: 'relative'
                }}
              >
                {/* Card Header */}
                <div className="flex items-start justify-between mb-3">
                  <div className="flex items-center gap-3">
                    <div className="bike-emoji text-2xl">
                      {getBikeTypeEmoji(config.bikeType)}
                    </div>
                    <div>
                      <h3 className="font-semibold text-white text-base leading-tight">
                        {config.name}
                      </h3>
                      <p className="text-sm" style={{ color: 'var(--text-tertiary)' }}>
                        {formatDate(config.created_at)}
                      </p>
                    </div>
                  </div>
                  <button
                    onClick={() => setShowDeleteConfirm(config.id)}
                    style={{
                      background: 'rgba(239, 68, 68, 0.2)',
                      border: 'none',
                      borderRadius: '8px',
                      padding: '6px',
                      color: '#EF4444'
                    }}
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                  </button>
                </div>

                {/* Performance Summary */}
                {config.results && (
                  <div className="performance-summary mb-4">
                    <div className="grid grid-cols-3 gap-3">
                      <div className="stat" style={{
                        background: 'rgba(255, 255, 255, 0.05)',
                        borderRadius: '8px',
                        padding: '8px',
                        textAlign: 'center'
                      }}>
                        <div className="text-xs" style={{ color: 'var(--text-tertiary)' }}>Weight</div>
                        <div className="text-sm font-semibold text-white">
                          {config.results.proposed?.totalWeight}g
                        </div>
                      </div>
                      <div className="stat" style={{
                        background: 'rgba(255, 255, 255, 0.05)',
                        borderRadius: '8px',
                        padding: '8px',
                        textAlign: 'center'
                      }}>
                        <div className="text-xs" style={{ color: 'var(--text-tertiary)' }}>Range</div>
                        <div className="text-sm font-semibold text-white">
                          {config.results.proposed?.gearRange}%
                        </div>
                      </div>
                      <div className="stat" style={{
                        background: 'rgba(255, 255, 255, 0.05)',
                        borderRadius: '8px',
                        padding: '8px',
                        textAlign: 'center'
                      }}>
                        <div className="text-xs" style={{ color: 'var(--text-tertiary)' }}>Top Speed</div>
                        <div className="text-sm font-semibold text-white">
                          {config.results.proposed?.metrics?.highSpeed} mph
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Components Summary */}
                <div className="components-summary mb-4">
                  <div className="space-y-2 text-sm">
                    <div className="flex justify-between">
                      <span style={{ color: 'var(--text-tertiary)' }}>Crankset:</span>
                      <span className="text-white font-medium text-right flex-1 ml-2 truncate">
                        {config.proposedSetup?.crankset?.model || 'Not set'}
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span style={{ color: 'var(--text-tertiary)' }}>Cassette:</span>
                      <span className="text-white font-medium text-right flex-1 ml-2 truncate">
                        {config.proposedSetup?.cassette?.model || 'Not set'}
                      </span>
                    </div>
                  </div>
                </div>

                {/* Load Button */}
                <button
                  onClick={() => onLoadConfig(config)}
                  className="load-btn"
                  style={{
                    width: '100%',
                    background: 'linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%)',
                    color: 'white',
                    border: 'none',
                    borderRadius: '10px',
                    padding: '12px 16px',
                    fontSize: '16px',
                    fontWeight: '600',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '8px'
                  }}
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                  </svg>
                  Load Configuration
                </button>
              </div>
            ))}
          </div>
        ) : (
          <div className="empty-garage" style={{
            textAlign: 'center',
            padding: '60px 20px',
            color: 'rgba(255, 255, 255, 0.6)'
          }}>
            <div className="empty-icon text-6xl mb-4">üè†</div>
            <h3 className="text-xl font-semibold mb-2 text-white">Empty Garage</h3>
            <p className="text-base leading-relaxed">
              Save your first bike configuration to start building your garage. 
              Perfect setups deserve to be remembered.
            </p>
          </div>
        )}
      </div>

      {/* Delete Confirmation Modal */}
      {showDeleteConfirm && (
        <div 
          className="delete-modal"
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.8)',
            zIndex: 10001,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '20px'
          }}
        >
          <div 
            className="modal-content"
            style={{
              background: 'rgba(20, 20, 20, 0.95)',
              borderRadius: '16px',
              padding: '24px',
              width: '100%',
              maxWidth: '320px',
              backdropFilter: 'blur(10px)'
            }}
          >
            <div className="modal-header mb-4 text-center">
              <div className="text-4xl mb-3">üóëÔ∏è</div>
              <h3 className="text-lg font-semibold text-white mb-2">Delete Configuration?</h3>
              <p className="text-sm" style={{ color: 'var(--text-secondary)' }}>
                This action cannot be undone. The configuration will be permanently removed.
              </p>
            </div>
            <div className="modal-actions space-y-3">
              <button
                onClick={() => handleDeleteConfig(showDeleteConfirm)}
                style={{
                  width: '100%',
                  background: 'linear-gradient(135deg, #EF4444 0%, #DC2626 100%)',
                  color: 'white',
                  border: 'none',
                  borderRadius: '12px',
                  padding: '14px 16px',
                  fontSize: '16px',
                  fontWeight: '600'
                }}
              >
                Delete
              </button>
              <button
                onClick={() => setShowDeleteConfirm(null)}
                style={{
                  width: '100%',
                  background: 'rgba(255, 255, 255, 0.1)',
                  color: 'white',
                  border: '1px solid rgba(255, 255, 255, 0.2)',
                  borderRadius: '12px',
                  padding: '14px 16px',
                  fontSize: '16px',
                  fontWeight: '600'
                }}
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}```

### components/mobile/ResultsScreen.js
```
// components/mobile/ResultsScreen.js - Mobile-optimized results display
import { useState, useRef, useEffect } from 'react';
import Chart from 'chart.js/auto';

export default function ResultsScreen({
  results,
  speedUnit,
  bikeType,
  onSave,
  onBack,
  onNewCalculation
}) {
  const [activeTab, setActiveTab] = useState('overview');
  const [showShareMenu, setShowShareMenu] = useState(false);
  const chartRef = useRef(null);
  const chartInstance = useRef(null);

  // Radar Chart Effect (must be called before any conditional returns)
  useEffect(() => {
    if (!results || !activeTab) return;
    const { current, proposed } = results;
    if (!current || !proposed || activeTab !== 'chart') return;

    if (chartInstance.current) {
      chartInstance.current.destroy();
    }

    const ctx = chartRef.current?.getContext('2d');
    if (!ctx) return;

    // Get actual values
    const currentValues = {
      topSpeed: parseFloat(current.metrics.highSpeed),
      climbingSpeed: parseFloat(current.metrics.lowSpeed),
      weight: current.totalWeight,
      gearRange: parseInt(current.gearRange)
    };

    const proposedValues = {
      topSpeed: parseFloat(proposed.metrics.highSpeed),
      climbingSpeed: parseFloat(proposed.metrics.lowSpeed),
      weight: proposed.totalWeight,
      gearRange: parseInt(proposed.gearRange)
    };

    // Find the ranges for proper scaling
    const maxTopSpeed = Math.max(currentValues.topSpeed, proposedValues.topSpeed) * 1.1;
    const maxClimbingSpeed = Math.max(currentValues.climbingSpeed, proposedValues.climbingSpeed) * 1.1;
    
    // For weight, we need the heaviest weight as our reference point
    const maxWeight = Math.max(currentValues.weight, proposedValues.weight);
    const minWeight = Math.min(currentValues.weight, proposedValues.weight);
    const weightRange = maxWeight - minWeight + 100; // Add buffer for scaling
    
    const maxGearRange = Math.max(currentValues.gearRange, proposedValues.gearRange) * 1.1;

    // Normalize to 0-100 scale properly
    const normalizeData = (values) => [
      (values.topSpeed / maxTopSpeed) * 100,
      (values.climbingSpeed / maxClimbingSpeed) * 100,
      // Invert weight: lighter weight = higher score on radar
      ((maxWeight + 100 - values.weight) / (maxWeight + 100 - minWeight + 100)) * 100,
      (values.gearRange / maxGearRange) * 100
    ];

    const data = {
      labels: ['Top Speed', 'Climbing', 'Weight', 'Range'],
      datasets: [
        {
          label: 'Current',
          data: normalizeData(currentValues),
          backgroundColor: 'rgba(59, 130, 246, 0.2)',
          borderColor: 'rgba(59, 130, 246, 1)',
          borderWidth: 2,
          pointBackgroundColor: 'rgba(59, 130, 246, 1)',
          pointBorderColor: '#fff',
          pointHoverBackgroundColor: '#fff',
          pointHoverBorderColor: 'rgba(59, 130, 246, 1)'
        },
        {
          label: 'Proposed',
          data: normalizeData(proposedValues),
          backgroundColor: 'rgba(16, 185, 129, 0.2)',
          borderColor: 'rgba(16, 185, 129, 1)',
          borderWidth: 2,
          pointBackgroundColor: 'rgba(16, 185, 129, 1)',
          pointBorderColor: '#fff',
          pointHoverBackgroundColor: '#fff',
          pointHoverBorderColor: 'rgba(16, 185, 129, 1)'
        }
      ]
    };

    const config = {
      type: 'radar',
      data: data,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          r: {
            angleLines: {
              color: 'rgba(255, 255, 255, 0.1)'
            },
            grid: {
              color: 'rgba(255, 255, 255, 0.1)'
            },
            pointLabels: {
              color: 'rgba(255, 255, 255, 0.8)',
              font: {
                size: 11,
                weight: '600'
              }
            },
            ticks: {
              color: 'rgba(255, 255, 255, 0.5)',
              backdropColor: 'transparent',
              font: {
                size: 10
              },
              callback: function(value) {
                return Math.round(value) + '%';
              }
            },
            suggestedMin: 0,
            suggestedMax: 100
          }
        },
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: 'rgba(255, 255, 255, 0.8)',
              font: {
                size: 12,
                weight: '600'
              },
              usePointStyle: true,
              padding: 15
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.9)',
            titleColor: 'rgba(255, 255, 255, 0.9)',
            bodyColor: 'rgba(255, 255, 255, 0.8)',
            borderColor: 'rgba(255, 255, 255, 0.2)',
            borderWidth: 1,
            cornerRadius: 8,
            callbacks: {
              label: function(context) {
                const label = context.dataset.label || '';
                const metric = context.label;
                
                // Show actual values in tooltip
                let actualValue;
                if (metric === 'Top Speed') {
                  actualValue = context.datasetIndex === 0 ? 
                    currentValues.topSpeed : proposedValues.topSpeed;
                  return `${label}: ${actualValue.toFixed(1)} ${speedUnit}`;
                } else if (metric === 'Climbing') {
                  actualValue = context.datasetIndex === 0 ? 
                    currentValues.climbingSpeed : proposedValues.climbingSpeed;
                  return `${label}: ${actualValue.toFixed(1)} ${speedUnit}`;
                } else if (metric === 'Weight') {
                  actualValue = context.datasetIndex === 0 ? 
                    currentValues.weight : proposedValues.weight;
                  return `${label}: ${actualValue}g`;
                } else if (metric === 'Range') {
                  actualValue = context.datasetIndex === 0 ? 
                    currentValues.gearRange : proposedValues.gearRange;
                  return `${label}: ${actualValue}%`;
                }
                return `${label}: ${context.raw.toFixed(1)}%`;
              }
            }
          }
        }
      }
    };

    chartInstance.current = new Chart(ctx, config);

    return () => {
      if (chartInstance.current) {
        chartInstance.current.destroy();
      }
    };
  }, [current, proposed, speedUnit, activeTab]);

  if (!results) return null;

  const { current, proposed, comparison, compatibility } = results;

  const metrics = [
    {
      title: 'Top Speed',
      icon: '‚ö°',
      current: current.metrics.highSpeed,
      proposed: proposed.metrics.highSpeed,
      unit: ` ${speedUnit}`,
      change: parseFloat(proposed.metrics.highSpeed) - parseFloat(current.metrics.highSpeed),
      isGoodWhenHigher: true
    },
    {
      title: 'Climbing',
      icon: '‚õ∞Ô∏è',
      current: current.metrics.lowSpeed,
      proposed: proposed.metrics.lowSpeed,
      unit: ` ${speedUnit}`,
      change: parseFloat(proposed.metrics.lowSpeed) - parseFloat(current.metrics.lowSpeed),
      isGoodWhenHigher: true
    },
    {
      title: 'Weight',
      icon: '‚öñÔ∏è',
      current: current.totalWeight,
      proposed: proposed.totalWeight,
      unit: 'g',
      change: proposed.totalWeight - current.totalWeight,
      isGoodWhenHigher: false
    },
    {
      title: 'Range',
      icon: 'üìä',
      current: current.gearRange,
      proposed: proposed.gearRange,
      unit: '%',
      change: parseInt(proposed.gearRange) - parseInt(current.gearRange),
      isGoodWhenHigher: true
    }
  ];

  const getChangeColor = (change, isGoodWhenHigher) => {
    if (Math.abs(change) < 0.1) return '#666';
    const isPositive = change > 0;
    const isGood = isGoodWhenHigher ? isPositive : !isPositive;
    return isGood ? '#10B981' : '#EF4444';
  };

  const formatChange = (change, unit = '') => {
    const rounded = Math.round(change * 10) / 10;
    if (Math.abs(rounded) < 0.1) return '‚Äî';
    const sign = rounded > 0 ? '+' : '';
    return `${sign}${rounded}${unit}`;
  };

  const generateBottomLine = () => {
    const weightChange = comparison?.weightChange || 0;
    const speedChange = comparison?.speedChange || 0;
    const rangeChange = comparison?.rangeChange || 0;
    
    let message = "Your proposed setup ";
    const benefits = [];
    
    if (weightChange < -10) benefits.push(`saves ${Math.abs(weightChange)}g`);
    if (speedChange > 0.3) benefits.push(`gives you ${speedChange.toFixed(1)} ${speedUnit} more top speed`);
    if (rangeChange > 20) benefits.push(`adds ${rangeChange}% more gear range`);
    
    if (benefits.length === 0) {
      return "offers similar performance with different characteristics.";
    }
    
    message += benefits.join(", ") + ". ";
    const majorBenefits = benefits.length >= 2 || Math.abs(weightChange) > 50;
    message += majorBenefits ? "Thats a solid improvement!" : "Minor improvement.";
    
    return message;
  };

  const handleShare = async () => {
    const shareText = `Check out my bike gear analysis on CrankSmith! ${generateBottomLine()}`;
    
    if (navigator.share) {
      try {
        await navigator.share({
          title: 'CrankSmith Gear Analysis',
          text: shareText,
          url: window.location.href
        });
      } catch (error) {
        // Fallback to clipboard
        handleCopyLink();
      }
    } else {
      handleCopyLink();
    }
  };

  const handleCopyLink = async () => {
    try {
      await navigator.clipboard.writeText(window.location.href);
      alert('Link copied to clipboard!');
    } catch (error) {
      console.error('Failed to copy link:', error);
    }
  };

  const tabs = [
    { id: 'overview', label: 'Overview', icon: 'üìä' },
    { id: 'chart', label: 'Chart', icon: 'üìà' },
    { id: 'details', label: 'Details', icon: 'üîç' },
    { id: 'compatibility', label: 'Compatibility', icon: 'üîß' }
  ];

  return (
    <div className="mobile-screen results-screen" style={{ 
      padding: '0', 
      height: '100vh', 
      display: 'flex',
      flexDirection: 'column',
      overflow: 'hidden' 
    }}>
      {/* Header */}
      <div className="results-header" style={{
        padding: '20px',
        background: 'linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%)',
        color: 'white',
        flexShrink: 0
      }}>
        <div className="flex items-center justify-between mb-4">
          <button
            onClick={onBack}
            style={{
              background: 'rgba(255, 255, 255, 0.2)',
              border: 'none',
              borderRadius: '8px',
              padding: '8px 12px',
              color: 'white'
            }}
          >
            ‚Üê Back
          </button>
          <h1 className="text-xl font-bold">Performance Analysis</h1>
          <button
            onClick={() => setShowShareMenu(!showShareMenu)}
            style={{
              background: 'rgba(255, 255, 255, 0.2)',
              border: 'none',
              borderRadius: '8px',
              padding: '8px',
              color: 'white'
            }}
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                    d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"/>
            </svg>
          </button>
        </div>

        {/* Bottom Line Summary */}
        <div className="bottom-line" style={{
          background: 'rgba(255, 255, 255, 0.15)',
          borderRadius: '12px',
          padding: '16px'
        }}>
          <p className="text-base leading-relaxed">
            {generateBottomLine()}
          </p>
        </div>
      </div>

      {/* Tab Navigation */}
      <div className="tab-nav" style={{
        display: 'flex',
        background: 'rgba(0, 0, 0, 0.05)',
        borderBottom: '1px solid rgba(255, 255, 255, 0.1)',
        flexShrink: 0
      }}>
        {tabs.map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className="tab-btn"
            style={{
              flex: 1,
              padding: '12px 8px',
              border: 'none',
              background: activeTab === tab.id ? 'rgba(59, 130, 246, 0.1)' : 'transparent',
              color: activeTab === tab.id ? '#3B82F6' : '#999',
              fontSize: '14px',
              fontWeight: '600',
              borderBottom: `2px solid ${activeTab === tab.id ? '#3B82F6' : 'transparent'}`,
              transition: 'all 0.2s ease'
            }}
          >
            <div className="flex flex-col items-center gap-1">
              <span>{tab.icon}</span>
              <span>{tab.label}</span>
            </div>
          </button>
        ))}
      </div>

      {/* Tab Content */}
      <div className="tab-content" style={{
        flex: 1,
        overflow: 'auto',
        WebkitOverflowScrolling: 'touch',
        padding: '20px',
        minHeight: 0
      }}>
        {activeTab === 'overview' && (
          <div className="overview-tab space-y-6">
            {/* Metrics Grid */}
            <div className="metrics-grid" style={{
              display: 'grid',
              gridTemplateColumns: 'repeat(2, 1fr)',
              gap: '16px'
            }}>
              {metrics.map((metric, index) => (
                <div
                  key={index}
                  className="metric-card"
                  style={{
                    background: 'rgba(255, 255, 255, 0.05)',
                    border: '1px solid rgba(255, 255, 255, 0.1)',
                    borderRadius: '12px',
                    padding: '16px',
                    textAlign: 'center'
                  }}
                >
                  <div className="metric-icon text-2xl mb-2">{metric.icon}</div>
                  <div className="metric-title text-sm mb-3" style={{ color: 'var(--text-tertiary)' }}>{metric.title}</div>
                  
                  <div className="metric-values space-y-2">
                    <div className="flex justify-between text-xs">
                      <span style={{ color: 'var(--text-placeholder)' }}>Current</span>
                      <span className="font-mono text-white">{metric.current}{metric.unit}</span>
                    </div>
                    <div className="flex justify-between text-xs">
                      <span style={{ color: 'var(--text-placeholder)' }}>Proposed</span>
                      <span className="font-mono text-white">{metric.proposed}{metric.unit}</span>
                    </div>
                    <div className="border-t pt-2" style={{ borderColor: 'var(--border-primary)' }}>
                      <div
                        className="text-lg font-bold"
                        style={{ color: getChangeColor(metric.change, metric.isGoodWhenHigher) }}
                      >
                        {formatChange(metric.change, metric.unit)}
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>

            {/* Component Summary */}
            <div className="component-summary">
              <h3 className="text-lg font-semibold mb-3 text-white">Component Changes</h3>
              <div className="space-y-3">
                <div className="component-row" style={{
                  background: 'rgba(255, 255, 255, 0.05)',
                  borderRadius: '8px',
                  padding: '12px'
                }}>
                  <div className="text-sm" style={{ color: 'var(--text-tertiary)' }}>Crankset</div>
                  <div className="text-white font-medium">
                    {proposed.setup.crankset?.model} {proposed.setup.crankset?.variant}
                  </div>
                </div>
                <div className="component-row" style={{
                  background: 'rgba(255, 255, 255, 0.05)',
                  borderRadius: '8px',
                  padding: '12px'
                }}>
                  <div className="text-sm" style={{ color: 'var(--text-tertiary)' }}>Cassette</div>
                  <div className="text-white font-medium">
                    {proposed.setup.cassette?.model} {proposed.setup.cassette?.variant}
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'chart' && (
          <div className="chart-tab space-y-6">
            {/* Chart Header */}
            <div className="chart-header text-center">
              <h3 className="text-lg font-semibold mb-2 text-white">Performance Comparison</h3>
              <p className="text-sm" style={{ color: 'var(--text-tertiary)' }}>Visual comparison of your setups</p>
            </div>

            {/* Chart Container */}
            <div className="chart-container" style={{
              background: 'rgba(255, 255, 255, 0.05)',
              borderRadius: '16px',
              padding: '20px',
              border: '1px solid rgba(255, 255, 255, 0.1)'
            }}>
              <div style={{
                height: '280px',
                position: 'relative'
              }}>
                <canvas ref={chartRef} style={{
                  position: 'absolute',
                  top: 0,
                  left: 0,
                  width: '100%',
                  height: '100%'
                }}></canvas>
              </div>
            </div>

            {/* Chart Explanation */}
            <div className="chart-explanation" style={{
              background: 'rgba(59, 130, 246, 0.1)',
              borderRadius: '12px',
              padding: '16px',
              border: '1px solid rgba(59, 130, 246, 0.2)'
            }}>
              <h4 className="font-medium text-white mb-2">How to read this chart:</h4>
              <div className="space-y-2 text-sm" style={{ color: 'var(--text-secondary)' }}>
                <div className="flex items-center gap-2">
                  <div className="w-3 h-3 rounded-full" style={{ background: 'rgba(59, 130, 246, 1)' }}></div>
                  <span>Current setup</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-3 h-3 rounded-full" style={{ background: 'rgba(16, 185, 129, 1)' }}></div>
                  <span>Proposed setup</span>
                </div>
                <p className="mt-3 text-xs" style={{ color: 'var(--text-tertiary)' }}>
                  Larger area = better performance. Weight shows "better" (lighter = higher score).
                </p>
              </div>
            </div>

            {/* Quick Stats */}
            <div className="quick-stats" style={{
              display: 'grid',
              gridTemplateColumns: 'repeat(2, 1fr)',
              gap: '12px'
            }}>
              <div style={{
                background: 'rgba(255, 255, 255, 0.05)',
                borderRadius: '12px',
                padding: '16px',
                textAlign: 'center'
              }}>
                <div className="text-2xl font-bold text-white">
                  {Math.round((parseFloat(proposed.metrics.highSpeed) / parseFloat(current.metrics.highSpeed)) * 100)}%
                </div>
                <div className="text-xs" style={{ color: 'var(--text-tertiary)' }}>Top Speed</div>
              </div>
              <div style={{
                background: 'rgba(255, 255, 255, 0.05)',
                borderRadius: '12px',
                padding: '16px',
                textAlign: 'center'
              }}>
                <div className="text-2xl font-bold text-white">
                  {Math.round((parseFloat(proposed.metrics.lowSpeed) / parseFloat(current.metrics.lowSpeed)) * 100)}%
                </div>
                <div className="text-xs" style={{ color: 'var(--text-tertiary)' }}>Climbing</div>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'details' && (
          <div className="details-tab space-y-6">
            {/* Detailed Metrics */}
            <div className="detailed-metrics">
              <h3 className="text-lg font-semibold mb-4 text-white">Performance Details</h3>
              <div className="space-y-4">
                <div className="detail-card" style={{
                  background: 'rgba(255, 255, 255, 0.05)',
                  borderRadius: '12px',
                  padding: '16px'
                }}>
                  <h4 className="font-medium text-white mb-3">Gear Ratios</h4>
                  <div className="space-y-2 text-sm">
                    <div className="flex justify-between">
                      <span style={{ color: 'var(--text-tertiary)' }}>High Ratio:</span>
                      <span className="font-mono text-white">
                        {current.metrics.highRatio} ‚Üí {proposed.metrics.highRatio}
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span style={{ color: 'var(--text-tertiary)' }}>Low Ratio:</span>
                      <span className="font-mono text-white">
                        {current.metrics.lowRatio} ‚Üí {proposed.metrics.lowRatio}
                      </span>
                    </div>
                  </div>
                </div>

                <div className="detail-card" style={{
                  background: 'rgba(255, 255, 255, 0.05)',
                  borderRadius: '12px',
                  padding: '16px'
                }}>
                  <h4 className="font-medium text-white mb-3">Speed Analysis</h4>
                  <div className="space-y-2 text-sm">
                    <div className="flex justify-between">
                      <span style={{ color: 'var(--text-tertiary)' }}>Top Speed @ 90 RPM:</span>
                      <span className="font-mono text-white">
                        {proposed.metrics.highSpeed} {speedUnit}
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span style={{ color: 'var(--text-tertiary)' }}>Climbing Speed @ 90 RPM:</span>
                      <span className="font-mono text-white">
                        {proposed.metrics.lowSpeed} {speedUnit}
                      </span>
                    </div>
                  </div>
                </div>

                <div className="detail-card" style={{
                  background: 'rgba(255, 255, 255, 0.05)',
                  borderRadius: '12px',
                  padding: '16px'
                }}>
                  <h4 className="font-medium text-white mb-3">Weight Breakdown</h4>
                  <div className="space-y-2 text-sm">
                    <div className="flex justify-between">
                      <span style={{ color: 'var(--text-tertiary)' }}>Total Weight:</span>
                      <span className="font-mono text-white">{proposed.totalWeight}g</span>
                    </div>
                    <div className="flex justify-between">
                      <span style={{ color: 'var(--text-tertiary)' }}>Weight Change:</span>
                      <span className="font-mono" style={{ 
                        color: getChangeColor(proposed.totalWeight - current.totalWeight, false) 
                      }}>
                        {formatChange(proposed.totalWeight - current.totalWeight, 'g')}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'compatibility' && (
          <div className="compatibility-tab">
            {compatibility ? (
              <div className="compatibility-status" style={{
                background: compatibility.status === 'compatible' ? 'rgba(16, 185, 129, 0.1)' : 
                           compatibility.status === 'warning' ? 'rgba(245, 158, 11, 0.1)' : 
                           'rgba(239, 68, 68, 0.1)',
                border: `1px solid ${compatibility.status === 'compatible' ? '#10B981' : 
                                   compatibility.status === 'warning' ? '#F59E0B' : '#EF4444'}`,
                borderRadius: '12px',
                padding: '20px'
              }}>
                <div className="flex items-center gap-3 mb-4">
                  <div className="status-icon text-2xl">
                    {compatibility.status === 'compatible' ? '‚úÖ' : 
                     compatibility.status === 'warning' ? '‚ö†Ô∏è' : '‚ùå'}
                  </div>
                  <div>
                    <h3 className="font-semibold text-white">{compatibility.title}</h3>
                    <p className="text-sm" style={{ color: 'var(--text-secondary)' }}>{compatibility.message}</p>
                  </div>
                </div>

                {compatibility.criticalIssues && compatibility.criticalIssues.length > 0 && (
                  <div className="issues-section mb-4">
                    <h4 className="font-medium text-red-400 mb-2">Critical Issues:</h4>
                    {compatibility.criticalIssues.map((issue, index) => (
                      <div key={index} className="text-sm text-red-300 mb-1">‚Ä¢ {issue}</div>
                    ))}
                  </div>
                )}

                {compatibility.minorWarnings && compatibility.minorWarnings.length > 0 && (
                  <div className="warnings-section mb-4">
                    <h4 className="font-medium text-yellow-400 mb-2">Considerations:</h4>
                    {compatibility.minorWarnings.map((warning, index) => (
                      <div key={index} className="text-sm text-yellow-300 mb-1">‚Ä¢ {warning}</div>
                    ))}
                  </div>
                )}

                {compatibility.actionItems && compatibility.actionItems.length > 0 && (
                  <div className="recommendations-section">
                    <h4 className="font-medium text-blue-400 mb-2">Recommendations:</h4>
                    {compatibility.actionItems.map((item, index) => (
                      <div key={index} className="text-sm text-blue-300 mb-1">‚Ä¢ {item}</div>
                    ))}
                  </div>
                )}
              </div>
            ) : (
              <div className="no-compatibility" style={{
                textAlign: 'center',
                padding: '40px 20px',
                color: 'rgba(255, 255, 255, 0.6)'
              }}>
                <div className="text-6xl mb-4">üîß</div>
                <p>No compatibility analysis available</p>
              </div>
            )}
          </div>
        )}
      </div>

      {/* Bottom Actions */}
      <div className="bottom-actions" style={{
        padding: '20px',
        background: 'rgba(0, 0, 0, 0.5)',
        borderTop: '1px solid rgba(255, 255, 255, 0.1)'
      }}>
        <div className="action-buttons" style={{
          display: 'grid',
          gridTemplateColumns: '1fr 1fr',
          gap: '12px'
        }}>
          <button
            onClick={onSave}
            className="save-btn"
            style={{
              background: 'linear-gradient(135deg, #10B981 0%, #059669 100%)',
              color: 'white',
              border: 'none',
              borderRadius: '12px',
              padding: '14px 20px',
              fontSize: '16px',
              fontWeight: '600',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              gap: '8px'
            }}
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                    d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
            Save
          </button>
          <button
            onClick={onNewCalculation}
            className="new-calc-btn"
            style={{
              background: 'rgba(255, 255, 255, 0.1)',
              color: 'white',
              border: '1px solid rgba(255, 255, 255, 0.2)',
              borderRadius: '12px',
              padding: '14px 20px',
              fontSize: '16px',
              fontWeight: '600',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              gap: '8px'
            }}
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
            </svg>
            New
          </button>
        </div>
      </div>

      {/* Share Menu */}
      {showShareMenu && (
        <div 
          className="share-menu"
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.8)',
            zIndex: 10001,
            display: 'flex',
            alignItems: 'flex-end'
          }}
          onClick={() => setShowShareMenu(false)}
        >
          <div 
            className="share-panel"
            style={{
              width: '100%',
              background: 'rgba(20, 20, 20, 0.95)',
              borderRadius: '20px 20px 0 0',
              padding: '20px',
              backdropFilter: 'blur(10px)'
            }}
            onClick={(e) => e.stopPropagation()}
          >
            <div className="share-header mb-4">
              <h3 className="text-lg font-semibold text-white text-center">Share Results</h3>
            </div>
            <div className="share-options space-y-3">
              <button
                onClick={handleShare}
                className="share-option"
                style={{
                  width: '100%',
                  background: 'rgba(255, 255, 255, 0.1)',
                  border: 'none',
                  borderRadius: '12px',
                  padding: '16px',
                  color: 'white',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '12px'
                }}
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                        d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"/>
                </svg>
                Share Analysis
              </button>
              <button
                onClick={handleCopyLink}
                className="share-option"
                style={{
                  width: '100%',
                  background: 'rgba(255, 255, 255, 0.1)',
                  border: 'none',
                  borderRadius: '12px',
                  padding: '16px',
                  color: 'white',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '12px'
                }}
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                        d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                </svg>
                Copy Link
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}```

### components/mobile/SettingsScreen.js
```
// components/mobile/SettingsScreen.js - Mobile settings and app management
import { useState } from 'react';

export default function SettingsScreen({
  speedUnit,
  setSpeedUnit,
  isOnline,
  installPrompt,
  onInstallApp,
  onExportData
}) {
  const [showAbout, setShowAbout] = useState(false);

  const handleSpeedUnitChange = (unit) => {
    setSpeedUnit(unit);
    localStorage.setItem('cranksmith_speed_unit', unit);
  };

  const clearAllData = () => {
    if (window.confirm('Are you sure you want to clear all saved data? This cannot be undone.')) {
      localStorage.removeItem('cranksmith_configs');
      localStorage.removeItem('cranksmith_speed_unit');
      window.location.reload();
    }
  };

  const settingSections = [
    {
      title: 'Preferences',
      items: [
        {
          id: 'speed-unit',
          label: 'Speed Unit',
          type: 'toggle',
          value: speedUnit,
          options: [
            { value: 'mph', label: 'MPH' },
            { value: 'kmh', label: 'KM/H' }
          ],
          onChange: handleSpeedUnitChange
        }
      ]
    },
    {
      title: 'App',
      items: [
        ...(installPrompt ? [{
          id: 'install',
          label: 'Install App',
          type: 'action',
          icon: 'üì±',
          description: 'Add CrankSmith to your home screen',
          action: onInstallApp
        }] : []),
        {
          id: 'export',
          label: 'Export Data',
          type: 'action',
          icon: 'üì§',
          description: 'Download your saved configurations',
          action: onExportData
        },
        {
          id: 'clear',
          label: 'Clear All Data',
          type: 'action',
          icon: 'üóëÔ∏è',
          description: 'Remove all saved configurations',
          action: clearAllData,
          destructive: true
        }
      ]
    },
    {
      title: 'About',
      items: [
        {
          id: 'about',
          label: 'About CrankSmith',
          type: 'action',
          icon: '‚ÑπÔ∏è',
          description: 'Learn more about the app',
          action: () => setShowAbout(true)
        },
        {
          id: 'version',
          label: 'Version',
          type: 'info',
          value: '1.0.0 (Mobile Beta)'
        },
        {
          id: 'status',
          label: 'Connection Status',
          type: 'status',
          value: isOnline ? 'Online' : 'Offline',
          color: isOnline ? '#10B981' : '#EF4444'
        }
      ]
    }
  ];

  return (
    <div className="mobile-screen settings-screen" style={{ padding: '0', height: '100%' }}>
      {/* Header */}
      <div className="settings-header" style={{
        padding: '20px',
        background: 'linear-gradient(135deg, #6B7280 0%, #4B5563 100%)',
        color: 'white'
      }}>
        <h1 className="text-2xl font-bold mb-2">Settings</h1>
        <p style={{ color: 'var(--text-secondary)' }}>
          Customize your CrankSmith experience
        </p>
      </div>

      {/* Settings Content */}
      <div className="settings-content" style={{
        flex: 1,
        overflow: 'auto',
        WebkitOverflowScrolling: 'touch',
        padding: '20px'
      }}>
        <div className="space-y-8">
          {settingSections.map((section) => (
            <div key={section.title} className="setting-section">
              <h2 className="section-title text-lg font-semibold mb-4 text-white">
                {section.title}
              </h2>
              <div className="section-items space-y-3">
                {section.items.map((item) => (
                  <div
                    key={item.id}
                    className="setting-item"
                    style={{
                      background: 'rgba(255, 255, 255, 0.05)',
                      border: '1px solid rgba(255, 255, 255, 0.1)',
                      borderRadius: '12px',
                      padding: '16px'
                    }}
                  >
                    {/* Toggle Type (Speed Unit) */}
                    {item.type === 'toggle' && (
                      <div className="flex items-center justify-between">
                        <div>
                          <div className="font-medium text-white">{item.label}</div>
                        </div>
                        <div className="toggle-container" style={{
                          display: 'flex',
                          background: 'rgba(255, 255, 255, 0.1)',
                          borderRadius: '8px',
                          padding: '2px'
                        }}>
                          {item.options.map((option) => (
                            <button
                              key={option.value}
                              onClick={() => item.onChange(option.value)}
                              className="toggle-option"
                              style={{
                                padding: '8px 16px',
                                border: 'none',
                                borderRadius: '6px',
                                background: item.value === option.value ? 'white' : 'transparent',
                                color: item.value === option.value ? '#000' : 'white',
                                fontSize: '14px',
                                fontWeight: '600',
                                transition: 'all 0.2s ease'
                              }}
                            >
                              {option.label}
                            </button>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Action Type */}
                    {item.type === 'action' && (
                      <button
                        onClick={item.action}
                        className="action-item w-full text-left"
                        style={{
                          background: 'none',
                          border: 'none',
                          color: item.destructive ? '#EF4444' : 'white',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '12px'
                        }}
                      >
                        <div className="action-icon text-xl">{item.icon}</div>
                        <div className="flex-1">
                          <div className="font-medium">{item.label}</div>
                          {item.description && (
                                          <div className="text-sm mt-1" style={{ color: 'var(--text-tertiary)' }}>
                {item.description}
              </div>
                          )}
                        </div>
                                        <svg className="w-5 h-5" style={{ color: 'var(--text-tertiary)' }} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                </svg>
                      </button>
                    )}

                    {/* Info Type */}
                    {item.type === 'info' && (
                      <div className="flex items-center justify-between">
                        <div className="font-medium text-white">{item.label}</div>
                        <div style={{ color: 'var(--text-tertiary)' }}>{item.value}</div>
                      </div>
                    )}

                    {/* Status Type */}
                    {item.type === 'status' && (
                      <div className="flex items-center justify-between">
                        <div className="font-medium text-white">{item.label}</div>
                        <div className="flex items-center gap-2">
                          <div 
                            className="w-2 h-2 rounded-full"
                            style={{ background: item.color }}
                          />
                          <span style={{ color: item.color }}>{item.value}</span>
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          ))}
        </div>

        {/* Footer */}
        <div className="settings-footer mt-8 pt-6" style={{
          borderTop: '1px solid rgba(255, 255, 255, 0.1)',
          textAlign: 'center'
        }}>
          <p className="text-sm" style={{ color: 'var(--text-tertiary)' }}>
            Made with ‚ù§Ô∏è by cyclists, for cyclists
          </p>
          <p className="text-xs mt-2" style={{ color: 'var(--text-placeholder)' }}>
            ¬© 2024 CrankSmith. All rights reserved.
          </p>
        </div>
      </div>

      {/* About Modal */}
      {showAbout && (
        <div 
          className="about-modal"
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.9)',
            zIndex: 10001,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '20px'
          }}
        >
          <div 
            className="modal-content"
            style={{
              background: 'rgba(20, 20, 20, 0.95)',
              borderRadius: '16px',
              padding: '24px',
              width: '100%',
              maxWidth: '400px',
              maxHeight: '80vh',
              overflow: 'auto',
              backdropFilter: 'blur(10px)'
            }}
          >
            <div className="modal-header mb-6 text-center">
              <div className="text-4xl mb-3">üîß</div>
              <h3 className="text-xl font-bold text-white mb-2">About CrankSmith</h3>
              <p className="text-sm" style={{ color: 'var(--text-secondary)' }}>
                The ultimate bike gear calculator
              </p>
            </div>

            <div className="modal-body space-y-4 text-sm">
              <div>
                <h4 className="font-semibold text-white mb-2">What We Do</h4>
                <p className="leading-relaxed" style={{ color: 'var(--text-secondary)' }}>
                  CrankSmith helps cyclists optimize their bike setups with real component data, 
                  compatibility checking, and performance analysis. Make informed decisions about 
                  your gear upgrades.
                </p>
              </div>

              <div>
                <h4 className="font-semibold text-white mb-2">Features</h4>
                <ul className="space-y-1" style={{ color: 'var(--text-secondary)' }}>
                  <li>‚Ä¢ Real component database</li>
                  <li>‚Ä¢ Compatibility analysis</li>
                  <li>‚Ä¢ Performance calculations</li>
                  <li>‚Ä¢ Save configurations</li>
                  <li>‚Ä¢ Mobile-optimized experience</li>
                </ul>
              </div>

              <div>
                <h4 className="font-semibold text-white mb-2">Built For Cyclists</h4>
                <p className="leading-relaxed" style={{ color: 'var(--text-secondary)' }}>
                  Created by riders who understand the frustration of incompatible parts and 
                  suboptimal setups. Every calculation is based on real-world data.
                </p>
              </div>
            </div>

            <div className="modal-actions mt-6">
              <button
                onClick={() => setShowAbout(false)}
                style={{
                  width: '100%',
                  background: 'linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%)',
                  color: 'white',
                  border: 'none',
                  borderRadius: '12px',
                  padding: '14px 16px',
                  fontSize: '16px',
                  fontWeight: '600'
                }}
              >
                Got it!
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}```

### components/mobile/MobileDropdown.js
```
// components/mobile/MobileDropdown.js - Touch-optimized dropdown for mobile with proper opacity fix
import { useState, useRef, useEffect } from 'react';
import { createPortal } from 'react-dom';

export default function MobileDropdown({
  options = [],
  value,
  onChange,
  placeholder = 'Select option',
  searchable = false
}) {
  const [isOpen, setIsOpen] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [filteredOptions, setFilteredOptions] = useState(options);
  const dropdownRef = useRef(null);
  const searchInputRef = useRef(null);
  const portalRef = useRef(null);

  // Filter options based on search
  useEffect(() => {
    if (!searchable || !searchTerm) {
      setFilteredOptions(options);
      return;
    }

    const filtered = options.filter(option => {
      if (!option || !option.label) return false;
      
      const searchLower = searchTerm.toLowerCase();
      const labelMatch = option.label.toLowerCase().includes(searchLower);
      const subtitleMatch = option.subtitle ? 
        option.subtitle.toLowerCase().includes(searchLower) : 
        false;
      
      return labelMatch || subtitleMatch;
    });
    setFilteredOptions(filtered);
  }, [options, searchTerm, searchable]);

  // Handle click outside to close
  useEffect(() => {
    let focusTimeoutId = null;
    
    const handleClickOutside = (event) => {
      if (
        (dropdownRef.current && dropdownRef.current.contains(event.target)) ||
        (portalRef.current && portalRef.current.contains(event.target))
      ) {
        // Click is inside dropdown trigger or portal panel, do nothing
        return;
      }
      setIsOpen(false);
    };

    if (isOpen) {
      document.addEventListener('touchstart', handleClickOutside);
      document.addEventListener('mousedown', handleClickOutside);
      
      // Prevent body scroll when dropdown is open
      document.body.style.overflow = 'hidden';
      
      // Focus search input if searchable
      if (searchable && searchInputRef.current) {
        focusTimeoutId = setTimeout(() => {
          searchInputRef.current.focus();
        }, 100);
      }
    } else {
      document.body.style.overflow = '';
    }

    return () => {
      document.removeEventListener('touchstart', handleClickOutside);
      document.removeEventListener('mousedown', handleClickOutside);
      document.body.style.overflow = '';
      
      // Clear focus timeout to prevent memory leaks
      if (focusTimeoutId) {
        clearTimeout(focusTimeoutId);
      }
    };
  }, [isOpen, searchable]);

  const handleSelect = (option) => {
    if (option && option.value !== undefined) {
      onChange(option.value);
      setIsOpen(false);
      setSearchTerm('');
    }
  };

  const handleOpen = () => {
    setIsOpen(true);
    setSearchTerm('');
  };

  // Get display value with safety checks
  const displayValue = value ? 
    (typeof value === 'object' ? 
      `${value.model || ''} ${value.variant || ''}`.trim() : 
      options.find(opt => opt && opt.value === value)?.label || String(value)
    ) : '';

  return (
    <div className="mobile-dropdown" ref={dropdownRef} style={{ position: 'relative' }}>
      {/* Trigger Button */}
      <button
        type="button"
        onClick={handleOpen}
        className="input-premium"
        style={{
          minHeight: '56px',
          cursor: 'pointer',
          position: 'relative',
          zIndex: 30,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          textAlign: 'left'
        }}
      >
        <div className="flex-1">
          {displayValue ? (
            <div>
              <div className="font-medium" style={{ color: 'rgb(var(--text-primary))' }}>{displayValue}</div>
              {typeof value === 'object' && value && value.weight && (
                <div className="text-sm" style={{ color: 'rgb(var(--text-tertiary))' }}>{value.weight}g ‚Ä¢ {value.speeds || ''}</div>
              )}
            </div>
          ) : (
            <span style={{ color: 'rgb(var(--text-placeholder))' }}>
              {placeholder}
            </span>
          )}
        </div>
        <svg 
          className={`w-5 h-5 transition-transform ${isOpen ? 'rotate-180' : ''}`}
          fill="none" 
          stroke="currentColor" 
          viewBox="0 0 24 24"
        >
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      {/* Dropdown Panel - Now rendered in a Portal */}
      {isOpen &&
        createPortal(
          <div 
            ref={portalRef}
            className="mobile-dropdown-overlay"
            style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              backgroundColor: 'rgb(var(--bg-primary))',
            }}
          >
            <div 
              className="dropdown-panel"
              style={{
                width: '100%',
                height: '100%',
                display: 'flex',
                flexDirection: 'column',
              }}
            >
              {/* Header */}
              <div className="dropdown-header" style={{
                padding: '20px',
                borderBottom: '1px solid rgb(var(--border-primary))',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                backgroundColor: 'rgb(var(--bg-secondary))',
                flexShrink: 0
              }}>
                <h3 className="text-lg font-semibold" style={{ color: 'rgb(var(--text-primary))' }}>
                  {placeholder}
                </h3>
                <button
                  onClick={() => setIsOpen(false)}
                  className="btn-secondary p-2"
                  style={{
                    minWidth: 'auto',
                    minHeight: 'auto'
                  }}
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>

              {/* Search Input */}
              {searchable && (
                <div className="search-container" style={{ 
                  padding: '16px 20px', 
                  flexShrink: 0 
                }}>
                  <input
                    ref={searchInputRef}
                    type="text"
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    placeholder="Search components..."
                    className="input-premium"
                    style={{
                      WebkitAppearance: 'none'
                    }}
                  />
                </div>
              )}

              {/* Options List */}
              <div 
                className="options-container"
                style={{
                  flex: 1,
                  overflow: 'auto',
                  WebkitOverflowScrolling: 'touch',
                  padding: '0 20px 20px 20px',
                }}
              >
                {filteredOptions.length > 0 ? (
                  <div className="options-list space-y-2">
                    {filteredOptions.map((option) => {
                      if (!option || !option.id) return null;
                      return (
                        <button
                          key={option.id}
                          onClick={() => handleSelect(option)}
                          className={`option-item ${value === option.value ? "card-premium bg-brand-blue/10 border-brand-blue" : "card-premium"}`}
                          style={{
                            width: '100%',
                            color: 'rgb(var(--text-primary))',
                            textAlign: 'left',
                            minHeight: '60px',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'space-between',
                            padding: '16px'
                          }}
                        >
                          <div className="flex-1">
                            <div className="font-medium text-base" style={{ color: 'rgb(var(--text-primary))' }}>{option.label || ''}</div>
                            {option.subtitle && (
                              <div className="text-sm mt-1" style={{ color: 'rgb(var(--text-tertiary))' }}>{option.subtitle}</div>
                            )}
                          </div>
                          {value === option.value && (
                            <svg className="w-5 h-5" style={{ color: 'rgb(var(--brand-blue))' }} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                            </svg>
                          )}
                        </button>
                      );
                    })}
                  </div>
                ) : (
                  <div className="no-options" style={{
                    textAlign: 'center',
                    padding: '40px 20px',
                    color: 'rgb(var(--text-tertiary))'
                  }}>
                    <svg className="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 20.4a7.962 7.962 0 01-5-1.691c-.9-.69-1.628-1.565-2.13-2.548L3 12l1.87-4.161C5.372 6.296 6.6 4.785 8.5 3.734A7.96 7.96 0 0112 3c1.441 0 2.783.302 4.013.834 1.9 1.051 3.128 2.562 3.63 4.105L21 12l-1.357 3.839A7.967 7.967 0 0112 20.4z" />
                    </svg>
                    <p>No options found</p>
                    {searchable && searchTerm && (
                      <p className="text-sm mt-2">Try adjusting your search</p>
                    )}
                  </div>
                )}
              </div>
            </div>
          </div>,
          document.body
        )}
    </div>
  );
}```

### components/mobile/InstallPrompt.js
```
// components/mobile/InstallPrompt.js - Mobile-specific install prompt
import { useState, useEffect } from 'react';
import { canInstall, getInstallPrompt, installPWA, checkIfPWA } from '../../lib/pwa-utils';
import { toast } from '../Toast';

export default function MobileInstallPrompt() {
  const [showPrompt, setShowPrompt] = useState(false);
  const [deferredPrompt, setDeferredPrompt] = useState(null);
  const [isInstalling, setIsInstalling] = useState(false);

  useEffect(() => {
    let timeoutId = null;
    
    const checkInstallability = async () => {
      // Don't show if already installed as PWA
      if (checkIfPWA()) return;
      
      // Don't show if user dismissed recently
      const dismissedTime = localStorage.getItem('cranksmith_mobile_install_dismissed');
      if (dismissedTime && Date.now() - parseInt(dismissedTime) < 12 * 60 * 60 * 1000) { // 12 hours
        return;
      }

      // Check if app can be installed
      if (canInstall()) {
        const prompt = await getInstallPrompt();
        if (prompt) {
          setDeferredPrompt(prompt);
          // Show after user has used the app for a bit
          timeoutId = setTimeout(() => setShowPrompt(true), 10000);
        }
      }
    };

    checkInstallability();

    // Cleanup timeout to prevent memory leaks
    return () => {
      if (timeoutId) {
        clearTimeout(timeoutId);
      }
    };
  }, []);

  const handleInstall = async () => {
    if (!deferredPrompt) return;
    
    setIsInstalling(true);
    try {
      const success = await installPWA(deferredPrompt);
      if (success) {
        setShowPrompt(false);
        // Show success message
        toast.success('üéâ CrankSmith installed! You can now access it from your home screen.');
      }
    } catch (error) {
      console.error('Install failed:', error);
    } finally {
      setIsInstalling(false);
    }
  };

  const handleDismiss = () => {
    setShowPrompt(false);
    // Remember dismissal for 12 hours
    localStorage.setItem('cranksmith_mobile_install_dismissed', Date.now().toString());
  };

  if (!showPrompt) return null;

  return (
    <div className="mobile-install-prompt" style={{
      position: 'fixed',
      bottom: '20px',
      left: '20px',
      right: '20px',
      background: 'linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%)',
      borderRadius: '16px',
      padding: '20px',
      color: 'white',
      zIndex: 1000,
      boxShadow: '0 8px 32px rgba(59, 130, 246, 0.3)',
      border: '1px solid rgba(255, 255, 255, 0.1)'
    }}>
      <div className="flex items-center gap-4 mb-4">
        <div style={{
          width: '48px',
          height: '48px',
          background: 'rgba(255, 255, 255, 0.2)',
          borderRadius: '12px',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          fontSize: '24px'
        }}>
          üö¥
        </div>
        <div>
          <h3 className="font-bold text-lg">Install CrankSmith</h3>
          <p className="text-sm opacity-90">Get the full app experience</p>
        </div>
      </div>

      <div className="benefits mb-4 space-y-2">
        <div className="flex items-center gap-2 text-sm">
          <span>‚úì</span>
          <span>Works offline</span>
        </div>
        <div className="flex items-center gap-2 text-sm">
          <span>‚úì</span>
          <span>Home screen access</span>
        </div>
        <div className="flex items-center gap-2 text-sm">
          <span>‚úì</span>
          <span>Faster loading</span>
        </div>
      </div>

      <div className="flex gap-3">
        <button
          onClick={handleInstall}
          disabled={isInstalling}
          style={{
            flex: 1,
            background: 'rgba(255, 255, 255, 0.2)',
            color: 'white',
            border: '1px solid rgba(255, 255, 255, 0.3)',
            borderRadius: '12px',
            padding: '12px 16px',
            fontSize: '14px',
            fontWeight: '600',
            cursor: isInstalling ? 'not-allowed' : 'pointer',
            opacity: isInstalling ? 0.7 : 1
          }}
        >
          {isInstalling ? 'Installing...' : 'Install App'}
        </button>
        
        <button
          onClick={handleDismiss}
          style={{
            background: 'transparent',
            color: 'rgba(255, 255, 255, 0.7)',
            border: '1px solid rgba(255, 255, 255, 0.2)',
            borderRadius: '12px',
            padding: '12px 16px',
            fontSize: '14px',
            cursor: 'pointer'
          }}
        >
          Later
        </button>
      </div>
    </div>
  );
} ```

### lib/calculations.js
```
// Constants
export const CADENCE_RPM = 90
export const MM_TO_KM = 1e-6
export const KMH_TO_MPH = 0.621371

// Wheel sizes in mm (ISO standard)
export const WHEEL_SIZES = {
  '700c': 622,
  '650b': 584,
  '26-inch': 559,
  '27.5-inch': 584,
  '29-inch': 622
}

// Calculate wheel circumference in mm
export function calculateWheelCircumference(wheelSize, tireWidth) {
  const rimDiameter = WHEEL_SIZES[wheelSize]
  if (!rimDiameter) throw new Error(`Invalid wheel size: ${wheelSize}`)
  
  const totalDiameter = rimDiameter + (2 * parseFloat(tireWidth))
  return Math.PI * totalDiameter
}

// Calculate gear ratio
export function calculateGearRatio(chainringTeeth, cogTeeth) {
  return chainringTeeth / cogTeeth
}

// Calculate speed at given cadence
export function calculateSpeed(gearRatio, wheelCircumference, unit = 'KMH') {
  const distancePerRevolution = gearRatio * wheelCircumference
  const speedKmh = distancePerRevolution * CADENCE_RPM * MM_TO_KM * 60
  
  if (unit === 'MPH') {
    return (speedKmh * KMH_TO_MPH).toFixed(1)
  }
  return speedKmh.toFixed(1)
}

// Calculate gear inches
export function calculateGearInches(gearRatio, wheelSize, tireWidth) {
  const wheelDiameterMm = WHEEL_SIZES[wheelSize] + (2 * parseFloat(tireWidth))
  const wheelDiameterInches = wheelDiameterMm / 25.4
  return gearRatio * wheelDiameterInches
}

// Check derailleur compatibility
export function checkDerailleurCompatibility(crankset, cassette) {
  const warnings = []
  
  // Safety checks for malformed data
  if (!cassette?.teeth || !Array.isArray(cassette.teeth) || cassette.teeth.length === 0) {
    warnings.push('Invalid cassette data - compatibility cannot be determined')
    return warnings
  }
  
  if (!crankset?.teeth || !Array.isArray(crankset.teeth) || crankset.teeth.length === 0) {
    warnings.push('Invalid crankset data - compatibility cannot be determined')
    return warnings
  }
  
  const maxCog = Math.max(...cassette.teeth)
  const minCog = Math.min(...cassette.teeth)
  const maxChainring = Math.max(...crankset.teeth)
  const minChainring = Math.min(...crankset.teeth)
  
  // Total capacity calculation
  const totalCapacity = (maxChainring - minChainring) + (maxCog - minCog)
  
  if (maxCog > 34) {
    warnings.push(`Large cassette (${maxCog}T) may require long-cage derailleur`)
  }
  
  if (totalCapacity > 37) {
    warnings.push(`Total capacity (${totalCapacity}T) exceeds standard derailleur limits`)
  }
  
  // Chain line issues
  const extremeRatio = minChainring / maxCog
  if (extremeRatio < 0.8) {
    warnings.push('Extreme gear ratios may cause chain line issues')
  }
  
  return warnings
}

// Compare two setups
export function compareSetups(currentSetup, proposedSetup, speedUnit = 'KMH') {
  // Safety checks for setup data integrity
  if (!currentSetup?.crankset?.teeth || !Array.isArray(currentSetup.crankset.teeth) || currentSetup.crankset.teeth.length === 0) {
    throw new Error('Invalid current crankset data')
  }
  
  if (!currentSetup?.cassette?.teeth || !Array.isArray(currentSetup.cassette.teeth) || currentSetup.cassette.teeth.length === 0) {
    throw new Error('Invalid current cassette data')
  }
  
  if (!proposedSetup?.crankset?.teeth || !Array.isArray(proposedSetup.crankset.teeth) || proposedSetup.crankset.teeth.length === 0) {
    throw new Error('Invalid proposed crankset data')
  }
  
  if (!proposedSetup?.cassette?.teeth || !Array.isArray(proposedSetup.cassette.teeth) || proposedSetup.cassette.teeth.length === 0) {
    throw new Error('Invalid proposed cassette data')
  }
  
  const currentWheelCircumference = calculateWheelCircumference(currentSetup.wheel, currentSetup.tire)
  const proposedWheelCircumference = calculateWheelCircumference(proposedSetup.wheel, proposedSetup.tire)
  
  // Calculate gear ratios with safety checks
  const currentHighRatio = calculateGearRatio(
    currentSetup.crankset.teeth[0], 
    currentSetup.cassette.teeth[0]
  )
  const proposedHighRatio = calculateGearRatio(
    proposedSetup.crankset.teeth[0], 
    proposedSetup.cassette.teeth[0]
  )
  
  const currentLowRatio = calculateGearRatio(
    currentSetup.crankset.teeth[currentSetup.crankset.teeth.length - 1], 
    currentSetup.cassette.teeth[currentSetup.cassette.teeth.length - 1]
  )
  const proposedLowRatio = calculateGearRatio(
    proposedSetup.crankset.teeth[proposedSetup.crankset.teeth.length - 1], 
    proposedSetup.cassette.teeth[proposedSetup.cassette.teeth.length - 1]
  )
  
  // Calculate weights with safety checks for missing weight data
  const currentWeight = (currentSetup.crankset.weight || 0) + (currentSetup.cassette.weight || 0) + 257 + 232 // Chain + derailleur
  const proposedWeight = (proposedSetup.crankset.weight || 0) + (proposedSetup.cassette.weight || 0) + 257 + 232
  
  // Calculate gear ranges (cassette range as percentage) - Fixed to use industry standard formula
  const currentGearRange = (((currentSetup.cassette.teeth[currentSetup.cassette.teeth.length - 1] / currentSetup.cassette.teeth[0]) - 1) * 100).toFixed(0)
  const proposedGearRange = (((proposedSetup.cassette.teeth[proposedSetup.cassette.teeth.length - 1] / proposedSetup.cassette.teeth[0]) - 1) * 100).toFixed(0)
  
  return {
    current: {
      metrics: {
        highSpeed: calculateSpeed(currentHighRatio, currentWheelCircumference, speedUnit),
        lowSpeed: calculateSpeed(currentLowRatio, currentWheelCircumference, speedUnit),
        highRatio: currentHighRatio.toFixed(2),
        lowRatio: currentLowRatio.toFixed(2),
        gearRange: currentGearRange
      },
      totalWeight: currentWeight,
      gearRange: currentGearRange,
      warnings: checkDerailleurCompatibility(currentSetup.crankset, currentSetup.cassette),
    },
    proposed: {
      metrics: {
        highSpeed: calculateSpeed(proposedHighRatio, proposedWheelCircumference, speedUnit),
        lowSpeed: calculateSpeed(proposedLowRatio, proposedWheelCircumference, speedUnit),
        highRatio: proposedHighRatio.toFixed(2),
        lowRatio: proposedLowRatio.toFixed(2),
        gearRange: proposedGearRange
      },
      totalWeight: proposedWeight,
      gearRange: proposedGearRange,
      warnings: checkDerailleurCompatibility(proposedSetup.crankset, proposedSetup.cassette),
    },
    comparison: {
      weightChange: proposedWeight - currentWeight,
      speedGain: parseFloat(calculateSpeed(proposedHighRatio, proposedWheelCircumference, speedUnit)) - parseFloat(calculateSpeed(currentHighRatio, currentWheelCircumference, speedUnit)),
      climbingImprovement: currentLowRatio - proposedLowRatio,
      rangeIncrease: parseInt(proposedGearRange) - parseInt(currentGearRange),
      speedUnit: speedUnit
    },
  }
}```

### lib/components.js
```
/**
 * =============================================================================
 * BIKE CONFIGURATION & COMPONENT DATABASE
 *
 * This file contains the configuration for different bike types and a
 * comprehensive database of modern road, gravel, and MTB components.
 *
 * Last Updated: Based on 2024 component specifications.
 *
 * Changes in this version:
 * - Fact-checked and corrected weights and specs for all components.
 * - Removed duplicate and ambiguously named components.
 * - Standardized component IDs for clarity (e.g., 'shimano-105-r7000-50-34').
 * - Removed entries for chainrings-only and add-on cogs to maintain focus on full components.
 * - Added new relevant components (e.g., SRAM Apex 12-speed).
 * - Updated 'speeds' property for FSA/Praxis to be more specific ('10/11-speed').
 * - Updated bikeConfig default setups to use new, precise component IDs.
 * =============================================================================
 */

export const bikeConfig = {
  road: {
    name: "Road Bike",
    description: "Optimized for speed and efficiency on paved roads",
    wheelSizes: ["700c"],
    tireWidths: [23, 25, 28, 32, 35, 38],
    defaultSetup: {
      wheel: "700c",
      tire: "25",
      crankset: "shimano-105-r7000-50-34", // Updated ID
      cassette: "shimano-105-r7000-11-28",
    },
  },
  gravel: {
    name: "Gravel Bike",
    description: "Versatile design for mixed terrain and adventure riding",
    wheelSizes: ["700c", "650b"],
    tireWidths: [32, 35, 38, 40, 42, 45, 47, 50, 2.0, 2.1, 2.2, 2.25, 2.35],
    defaultSetup: {
      wheel: "700c",
      tire: "40",
      crankset: "shimano-grx-rx600-46-30", // Updated ID
      cassette: "shimano-grx-rx600-11-42",
    },
  },
  mtb: {
    name: "Mountain Bike",
    description: "Built for off-road trails and technical terrain",
    wheelSizes: ["26-inch", "27.5-inch", "29-inch"],
    tireWidths: [2.1, 2.25, 2.35, 2.4, 2.5, 2.6],
    defaultSetup: {
      wheel: "29-inch",
      tire: "2.35",
      crankset: "sram-gx-eagle", // Kept this general ID as it's common
      cassette: "sram-gx-eagle-10-52",
    },
  },
};

export const componentDatabase = {
  cranksets: [
    // ================================
    // SHIMANO ROAD CRANKSETS
    // ================================

    // Claris (8-Speed)
    { id: "shimano-claris-r2000-50-34", model: "Shimano Claris R2000", variant: "50/34T", weight: 900, bikeType: "road", teeth: [50, 34], speeds: "8-speed" },
    { id: "shimano-claris-r2000-52-36", model: "Shimano Claris R2000", variant: "52/36T", weight: 920, bikeType: "road", teeth: [52, 36], speeds: "8-speed" },
    { id: "shimano-claris-r2000-50-39-30", model: "Shimano Claris R2000", variant: "50/39/30T", weight: 950, bikeType: "road", teeth: [50, 39, 30], speeds: "8-speed" },

    // Sora (9-Speed)
    { id: "shimano-sora-r3000-50-34", model: "Shimano Sora R3000", variant: "50/34T", weight: 850, bikeType: "road", teeth: [50, 34], speeds: "9-speed" },
    { id: "shimano-sora-r3000-52-36", model: "Shimano Sora R3000", variant: "52/36T", weight: 870, bikeType: "road", teeth: [52, 36], speeds: "9-speed" },
    { id: "shimano-sora-r3000-50-39-30", model: "Shimano Sora R3000", variant: "50/39/30T", weight: 900, bikeType: "road", teeth: [50, 39, 30], speeds: "9-speed" },

    // Tiagra (10-Speed)
    { id: "shimano-tiagra-r4700-50-34", model: "Shimano Tiagra R4700", variant: "50/34T", weight: 785, bikeType: "road", teeth: [50, 34], speeds: "10-speed" },
    { id: "shimano-tiagra-r4700-52-36", model: "Shimano Tiagra R4700", variant: "52/36T", weight: 795, bikeType: "road", teeth: [52, 36], speeds: "10-speed" },
    { id: "shimano-tiagra-r4700-48-34", model: "Shimano Tiagra R4700", variant: "48/34T", weight: 780, bikeType: "road", teeth: [48, 34], speeds: "10-speed" },

    // 105 R7000 (11-Speed) - Corrected & Consolidated
    { id: "shimano-105-r7000-50-34", model: "Shimano 105 R7000", variant: "50/34T", weight: 713, bikeType: "road", teeth: [50, 34], speeds: "11-speed" },
    { id: "shimano-105-r7000-52-36", model: "Shimano 105 R7000", variant: "52/36T", weight: 742, bikeType: "road", teeth: [52, 36], speeds: "11-speed" },
    { id: "shimano-105-r7000-53-39", model: "Shimano 105 R7000", variant: "53/39T", weight: 754, bikeType: "road", teeth: [53, 39], speeds: "11-speed" },

    // 105 R7100 (12-Speed)
    { id: "shimano-105-r7100-50-34", model: "Shimano 105 R7100", variant: "50/34T", weight: 754, bikeType: "road", teeth: [50, 34], speeds: "12-speed" },
    { id: "shimano-105-r7100-52-36", model: "Shimano 105 R7100", variant: "52/36T", weight: 765, bikeType: "road", teeth: [52, 36], speeds: "12-speed" },

    // Ultegra R8000 (11-Speed) - Corrected & Consolidated
    { id: "shimano-ultegra-r8000-50-34", model: "Shimano Ultegra R8000", variant: "50/34T", weight: 674, bikeType: "road", teeth: [50, 34], speeds: "11-speed" },
    { id: "shimano-ultegra-r8000-52-36", model: "Shimano Ultegra R8000", variant: "52/36T", weight: 681, bikeType: "road", teeth: [52, 36], speeds: "11-speed" },
    { id: "shimano-ultegra-r8000-53-39", model: "Shimano Ultegra R8000", variant: "53/39T", weight: 690, bikeType: "road", teeth: [53, 39], speeds: "11-speed" },

    // Ultegra R8100 (12-Speed)
    { id: "shimano-ultegra-r8100-50-34", model: "Shimano Ultegra R8100", variant: "50/34T", weight: 700, bikeType: "road", teeth: [50, 34], speeds: "12-speed" },
    { id: "shimano-ultegra-r8100-52-36", model: "Shimano Ultegra R8100", variant: "52/36T", weight: 711, bikeType: "road", teeth: [52, 36], speeds: "12-speed" },

    // Dura-Ace R9100 (11-Speed)
    { id: "shimano-dura-ace-r9100-50-34", model: "Shimano Dura-Ace R9100", variant: "50/34T", weight: 609, bikeType: "road", teeth: [50, 34], speeds: "11-speed" },
    { id: "shimano-dura-ace-r9100-52-36", model: "Shimano Dura-Ace R9100", variant: "52/36T", weight: 618, bikeType: "road", teeth: [52, 36], speeds: "11-speed" },
    { id: "shimano-dura-ace-r9100-53-39", model: "Shimano Dura-Ace R9100", variant: "53/39T", weight: 621, bikeType: "road", teeth: [53, 39], speeds: "11-speed" },

    // Dura-Ace R9200 (12-Speed)
    { id: "shimano-dura-ace-r9200-50-34", model: "Shimano Dura-Ace R9200", variant: "50/34T", weight: 685, bikeType: "road", teeth: [50, 34], speeds: "12-speed" },
    { id: "shimano-dura-ace-r9200-52-36", model: "Shimano Dura-Ace R9200", variant: "52/36T", weight: 692, bikeType: "road", teeth: [52, 36], speeds: "12-speed" },
    { id: "shimano-dura-ace-r9200-54-40", model: "Shimano Dura-Ace R9200", variant: "54/40T", weight: 714, bikeType: "road", teeth: [54, 40], speeds: "12-speed" },

    // ================================
    // SHIMANO GRAVEL CRANKSETS
    // ================================

    // GRX RX400 (10-Speed)
    { id: "shimano-grx-rx400-46-30", model: "Shimano GRX RX400", variant: "46/30T", weight: 819, bikeType: "gravel", teeth: [46, 30], speeds: "10-speed" },

    // GRX RX600 (11-Speed) - Corrected & Consolidated
    { id: "shimano-grx-rx600-46-30", model: "Shimano GRX RX600", variant: "46/30T", weight: 806, bikeType: "gravel", teeth: [46, 30], speeds: "11-speed" },
    { id: "shimano-grx-rx600-1x-40", model: "Shimano GRX RX600 1x", variant: "40T", weight: 743, bikeType: "gravel", teeth: [40], speeds: "11-speed" },
    { id: "shimano-grx-rx600-1x-42", model: "Shimano GRX RX600 1x", variant: "42T", weight: 751, bikeType: "gravel", teeth: [42], speeds: "11-speed" },

    // GRX RX810 (11-Speed)
    { id: "shimano-grx-rx810-48-31", model: "Shimano GRX RX810", variant: "48/31T", weight: 710, bikeType: "gravel", teeth: [48, 31], speeds: "11-speed" },
    { id: "shimano-grx-rx810-1x-40", model: "Shimano GRX RX810 1x", variant: "40T", weight: 644, bikeType: "gravel", teeth: [40], speeds: "11-speed" },
    { id: "shimano-grx-rx810-1x-42", model: "Shimano GRX RX810 1x", variant: "42T", weight: 655, bikeType: "gravel", teeth: [42], speeds: "11-speed" },

    // GRX RX820 (12-Speed)
    { id: "shimano-grx-rx820-48-31", model: "Shimano GRX RX820", variant: "48/31T", weight: 721, bikeType: "gravel", teeth: [48, 31], speeds: "12-speed" },
    { id: "shimano-grx-rx820-1x-40", model: "Shimano GRX RX820 1x", variant: "40T", weight: 655, bikeType: "gravel", teeth: [40], speeds: "12-speed" },
    { id: "shimano-grx-rx820-1x-42", model: "Shimano GRX RX820 1x", variant: "42T", weight: 668, bikeType: "gravel", teeth: [42], speeds: "12-speed" },

    // ================================
    // SHIMANO MTB CRANKSETS
    // ================================

    // CUES U6000 (10/11-speed)
    { id: "shimano-cues-u6000-30", model: "Shimano CUES U6000", variant: "30T", weight: 780, bikeType: "mtb", teeth: [30], speeds: "10/11-speed" },
    { id: "shimano-cues-u6000-32", model: "Shimano CUES U6000", variant: "32T", weight: 785, bikeType: "mtb", teeth: [32], speeds: "10/11-speed" },

    // Deore M5100 (11-Speed)
    { id: "shimano-deore-m5100-30", model: "Shimano Deore M5100", variant: "30T", weight: 782, bikeType: "mtb", teeth: [30], speeds: "11-speed" },
    { id: "shimano-deore-m5100-32", model: "Shimano Deore M5100", variant: "32T", weight: 788, bikeType: "mtb", teeth: [32], speeds: "11-speed" },

    // Deore M6100 (12-Speed) - Corrected Weight
    { id: "shimano-deore-m6100-30", model: "Shimano Deore M6100", variant: "30T", weight: 784, bikeType: "mtb", teeth: [30], speeds: "12-speed" },
    { id: "shimano-deore-m6100-32", model: "Shimano Deore M6100", variant: "32T", weight: 790, bikeType: "mtb", teeth: [32], speeds: "12-speed" },

    // SLX M7100 (12-Speed) - Corrected Weight
    { id: "shimano-slx-m7100-30", model: "Shimano SLX M7100", variant: "30T", weight: 631, bikeType: "mtb", teeth: [30], speeds: "12-speed" },
    { id: "shimano-slx-m7100-32", model: "Shimano SLX M7100", variant: "32T", weight: 646, bikeType: "mtb", teeth: [32], speeds: "12-speed" },
    { id: "shimano-slx-m7100-34", model: "Shimano SLX M7100", variant: "34T", weight: 658, bikeType: "mtb", teeth: [34], speeds: "12-speed" },

    // XT M8100 (12-Speed) - Corrected Weight
    { id: "shimano-xt-m8100-30", model: "Shimano XT M8100", variant: "30T", weight: 620, bikeType: "mtb", teeth: [30], speeds: "12-speed" },
    { id: "shimano-xt-m8100", model: "Shimano XT M8100", variant: "32T", weight: 628, bikeType: "mtb", teeth: [32], speeds: "12-speed" },
    { id: "shimano-xt-m8100-34", model: "Shimano XT M8100", variant: "34T", weight: 636, bikeType: "mtb", teeth: [34], speeds: "12-speed" },
    { id: "shimano-xt-m8100-36", model: "Shimano XT M8100", variant: "36T", weight: 651, bikeType: "mtb", teeth: [36], speeds: "12-speed" },

    // XTR M9100 (12-Speed)
    { id: "shimano-xtr-m9100-30", model: "Shimano XTR M9100", variant: "30T", weight: 516, bikeType: "mtb", teeth: [30], speeds: "12-speed" },
    { id: "shimano-xtr-m9100-32", model: "Shimano XTR M9100", variant: "32T", weight: 528, bikeType: "mtb", teeth: [32], speeds: "12-speed" },
    { id: "shimano-xtr-m9100-34", model: "Shimano XTR M9100", variant: "34T", weight: 539, bikeType: "mtb", teeth: [34], speeds: "12-speed" },
    { id: "shimano-xtr-m9100-36", model: "Shimano XTR M9100", variant: "36T", weight: 551, bikeType: "mtb", teeth: [36], speeds: "12-speed" },

    // ================================
    // SRAM ROAD CRANKSETS
    // ================================

    // Apex 12-Speed (Mechanical & AXS) - ADDED
    { id: "sram-apex-d1-dub-40t", model: "SRAM Apex D1 DUB", variant: "40T", weight: 785, bikeType: "road", teeth: [40], speeds: "12-speed" },
    { id: "sram-apex-d1-dub-wide-43-30", model: "SRAM Apex D1 DUB Wide", variant: "43/30T", weight: 815, bikeType: "road", teeth: [43, 30], speeds: "12-speed" },

    // Rival AXS (12-Speed)
    { id: "sram-rival-axs-46-33", model: "SRAM Rival eTap AXS", variant: "46/33T", weight: 822, bikeType: "road", teeth: [46, 33], speeds: "12-speed" },
    { id: "sram-rival-axs-48-35", model: "SRAM Rival eTap AXS", variant: "48/35T", weight: 825, bikeType: "road", teeth: [48, 35], speeds: "12-speed" },
    { id: "sram-rival-axs-1x-40", model: "SRAM Rival eTap AXS 1x", variant: "40T", weight: 745, bikeType: "road", teeth: [40], speeds: "12-speed" },
    { id: "sram-rival-axs-1x-42", model: "SRAM Rival eTap AXS 1x", variant: "42T", weight: 752, bikeType: "road", teeth: [42], speeds: "12-speed" },

    // Force AXS (12-Speed)
    { id: "sram-force-axs-46-33", model: "SRAM Force eTap AXS", variant: "46/33T", weight: 738, bikeType: "road", teeth: [46, 33], speeds: "12-speed" },
    { id: "sram-force-axs-48-35", model: "SRAM Force eTap AXS", variant: "48/35T", weight: 740, bikeType: "road", teeth: [48, 35], speeds: "12-speed" },
    { id: "sram-force-axs-50-37", model: "SRAM Force eTap AXS", variant: "50/37T", weight: 747, bikeType: "road", teeth: [50, 37], speeds: "12-speed" },

    // Red AXS 2024 (12-Speed)
    { id: "sram-red-axs-2024-46-33", model: "SRAM Red AXS 2024", variant: "46/33T", weight: 589, bikeType: "road", teeth: [46, 33], speeds: "12-speed" },
    { id: "sram-red-axs-2024-48-35", model: "SRAM Red AXS 2024", variant: "48/35T", weight: 591, bikeType: "road", teeth: [48, 35], speeds: "12-speed" },
    { id: "sram-red-axs-2024-50-37", model: "SRAM Red AXS 2024", variant: "50/37T", weight: 598, bikeType: "road", teeth: [50, 37], speeds: "12-speed" },
    { id: "sram-red-axs-2024-1x-48", model: "SRAM Red AXS 2024 1x", variant: "48T", weight: 510, bikeType: "road", teeth: [48], speeds: "12-speed" },
    { id: "sram-red-axs-2024-1x-50", model: "SRAM Red AXS 2024 1x", variant: "50T", weight: 520, bikeType: "road", teeth: [50], speeds: "12-speed" },

    // ================================
    // SRAM GRAVEL CRANKSETS
    // ================================

    // Apex XPLR AXS (12-Speed) - ADDED
    { id: "sram-apex-xplr-axs-1x-40", model: "SRAM Apex XPLR AXS 1x", variant: "40T", weight: 698, bikeType: "gravel", teeth: [40], speeds: "12-speed" },

    // Rival XPLR AXS (12-Speed)
    { id: "sram-rival-xplr-axs-1x-40", model: "SRAM Rival XPLR AXS 1x", variant: "40T", weight: 705, bikeType: "gravel", teeth: [40], speeds: "12-speed" },
    { id: "sram-rival-xplr-axs-1x-42", model: "SRAM Rival XPLR AXS 1x", variant: "42T", weight: 712, bikeType: "gravel", teeth: [42], speeds: "12-speed" },

    // Force XPLR AXS (12-Speed) - Corrected Weight
    { id: "sram-force-xplr-axs-1x-40", model: "SRAM Force XPLR AXS 1x", variant: "40T", weight: 660, bikeType: "gravel", teeth: [40], speeds: "12-speed" },
    { id: "sram-force-xplr-axs-1x-44", model: "SRAM Force XPLR AXS 1x", variant: "44T", weight: 670, bikeType: "gravel", teeth: [44], speeds: "12-speed" },

    // ================================
    // SRAM MTB CRANKSETS
    // ================================

    // SX Eagle (12-Speed)
    { id: "sram-sx-eagle-30", model: "SRAM SX Eagle", variant: "30T", weight: 780, bikeType: "mtb", teeth: [30], speeds: "12-speed" },
    { id: "sram-sx-eagle-32", model: "SRAM SX Eagle", variant: "32T", weight: 785, bikeType: "mtb", teeth: [32], speeds: "12-speed" },

    // NX Eagle (12-Speed)
    { id: "sram-nx-eagle-30", model: "SRAM NX Eagle", variant: "30T", weight: 705, bikeType: "mtb", teeth: [30], speeds: "12-speed" },
    { id: "sram-nx-eagle", model: "SRAM NX Eagle", variant: "32T", weight: 712, bikeType: "mtb", teeth: [32], speeds: "12-speed" },

    // GX Eagle (12-Speed) - Consolidated
    { id: "sram-gx-eagle-30", model: "SRAM GX Eagle", variant: "30T", weight: 620, bikeType: "mtb", teeth: [30], speeds: "12-speed" },
    { id: "sram-gx-eagle", model: "SRAM GX Eagle", variant: "32T", weight: 630, bikeType: "mtb", teeth: [32], speeds: "12-speed" },
    { id: "sram-gx-eagle-34", model: "SRAM GX Eagle", variant: "34T", weight: 640, bikeType: "mtb", teeth: [34], speeds: "12-speed" },

    // X01 Eagle (12-Speed)
    { id: "sram-x01-eagle-32", model: "SRAM X01 Eagle", variant: "32T", weight: 486, bikeType: "mtb", teeth: [32], speeds: "12-speed" },
    { id: "sram-x01-eagle-34", model: "SRAM X01 Eagle", variant: "34T", weight: 494, bikeType: "mtb", teeth: [34], speeds: "12-speed" },

    // XX1 Eagle (12-Speed)
    { id: "sram-xx1-eagle-32", model: "SRAM XX1 Eagle", variant: "32T", weight: 422, bikeType: "mtb", teeth: [32], speeds: "12-speed" },
    { id: "sram-xx1-eagle-34", model: "SRAM XX1 Eagle", variant: "34T", weight: 431, bikeType: "mtb", teeth: [34], speeds: "12-speed" },

    // GX Eagle Transmission (T-Type)
    { id: "sram-gx-eagle-t-type-32", model: "SRAM GX Eagle T-Type", variant: "32T", weight: 716, bikeType: "mtb", teeth: [32], speeds: "12-speed" },
    
    // X0 Eagle Transmission (T-Type)
    { id: "sram-x0-eagle-t-type-32", model: "SRAM X0 Eagle T-Type", variant: "32T", weight: 595, bikeType: "mtb", teeth: [32], speeds: "12-speed" },
    
    // XX Eagle Transmission (T-Type)
    { id: "sram-xx-eagle-t-type-32", model: "SRAM XX Eagle T-Type", variant: "32T", weight: 493, bikeType: "mtb", teeth: [32], speeds: "12-speed" },
    
    // ================================
    // CAMPAGNOLO ROAD CRANKSETS
    // ================================

    // Chorus (12-Speed)
    { id: "campagnolo-chorus-48-32", model: "Campagnolo Chorus", variant: "48/32T", weight: 718, bikeType: "road", teeth: [48, 32], speeds: "12-speed" },
    { id: "campagnolo-chorus-50-34", model: "Campagnolo Chorus", variant: "50/34T", weight: 728, bikeType: "road", teeth: [50, 34], speeds: "12-speed" },
    { id: "campagnolo-chorus-52-36", model: "Campagnolo Chorus", variant: "52/36T", weight: 738, bikeType: "road", teeth: [52, 36], speeds: "12-speed" },

    // Record (12-Speed)
    { id: "campagnolo-record-50-34", model: "Campagnolo Record", variant: "50/34T", weight: 698, bikeType: "road", teeth: [50, 34], speeds: "12-speed" },
    { id: "campagnolo-record-52-36", model: "Campagnolo Record", variant: "52/36T", weight: 710, bikeType: "road", teeth: [52, 36], speeds: "12-speed" },

    // Super Record (12-Speed)
    { id: "campagnolo-super-record-50-34", model: "Campagnolo Super Record", variant: "50/34T", weight: 618, bikeType: "road", teeth: [50, 34], speeds: "12-speed" },
    { id: "campagnolo-super-record-52-36", model: "Campagnolo Super Record", variant: "52/36T", weight: 628, bikeType: "road", teeth: [52, 36], speeds: "12-speed" },

    // Super Record Wireless (13-Speed)
    { id: "campagnolo-super-record-wrl-48-32", model: "Campagnolo Super Record WRL", variant: "48/32T", weight: 605, bikeType: "road", teeth: [48, 32], speeds: "13-speed" },
    { id: "campagnolo-super-record-wrl-50-34", model: "Campagnolo Super Record WRL", variant: "50/34T", weight: 615, bikeType: "road", teeth: [50, 34], speeds: "13-speed" },

    // ================================
    // CAMPAGNOLO GRAVEL CRANKSETS
    // ================================

    // Ekar (13-Speed)
    { id: "campagnolo-ekar-38", model: "Campagnolo Ekar", variant: "38T", weight: 615, bikeType: "gravel", teeth: [38], speeds: "13-speed" },
    { id: "campagnolo-ekar-40", model: "Campagnolo Ekar", variant: "40T", weight: 620, bikeType: "gravel", teeth: [40], speeds: "13-speed" },
    { id: "campagnolo-ekar-42", model: "Campagnolo Ekar", variant: "42T", weight: 625, bikeType: "gravel", teeth: [42], speeds: "13-speed" },

    // Ekar GT (13-Speed)
    { id: "campagnolo-ekar-gt-38", model: "Campagnolo Ekar GT", variant: "38T", weight: 650, bikeType: "gravel", teeth: [38], speeds: "13-speed" },
    { id: "campagnolo-ekar-gt-40", model: "Campagnolo Ekar GT", variant: "40T", weight: 655, bikeType: "gravel", teeth: [40], speeds: "13-speed" },
    { id: "campagnolo-ekar-gt-42", model: "Campagnolo Ekar GT", variant: "42T", weight: 660, bikeType: "gravel", teeth: [42], speeds: "13-speed" },

    // ================================
    // FSA CRANKSETS - Corrected Speeds
    // ================================

    // FSA Gossamer Pro (Road)
    { id: "fsa-gossamer-pro-50-34", model: "FSA Gossamer Pro", variant: "50/34T", weight: 751, bikeType: "road", teeth: [50, 34], speeds: "10/11-speed" },
    { id: "fsa-gossamer-pro-52-36", model: "FSA Gossamer Pro", variant: "52/36T", weight: 760, bikeType: "road", teeth: [52, 36], speeds: "10/11-speed" },
    { id: "fsa-gossamer-pro-46-30", model: "FSA Gossamer Pro", variant: "46/30T", weight: 745, bikeType: "road", teeth: [46, 30], speeds: "10/11-speed" },
    
    // FSA SL-K Light (High-End Road)
    { id: "fsa-slk-light-50-34", model: "FSA SL-K Light", variant: "50/34T", weight: 619, bikeType: "road", teeth: [50, 34], speeds: "10/11-speed" },
    { id: "fsa-slk-light-52-36", model: "FSA SL-K Light", variant: "52/36T", weight: 625, bikeType: "road", teeth: [52, 36], speeds: "10/11-speed" },

    // FSA K-Force WE (Electronic)
    { id: "fsa-k-force-we-50-34", model: "FSA K-Force WE", variant: "50/34T", weight: 552, bikeType: "road", teeth: [50, 34], speeds: "12-speed" },
    { id: "fsa-k-force-we-52-36", model: "FSA K-Force WE", variant: "52/36T", weight: 560, bikeType: "road", teeth: [52, 36], speeds: "12-speed" },

    // FSA Gradient (Gravel)
    { id: "fsa-gradient-48-32", model: "FSA Gradient", variant: "48/32T", weight: 720, bikeType: "gravel", teeth: [48, 32], speeds: "10/11-speed" },
    { id: "fsa-gradient-1x-40", model: "FSA Gradient 1x", variant: "40T", weight: 635, bikeType: "gravel", teeth: [40], speeds: "10/11-speed" },

    // ================================
    // RACE FACE MTB CRANKSETS
    // ================================

    // Race Face Aeffect R (MTB)
    { id: "race-face-aeffect-r-30", model: "Race Face Aeffect R", variant: "30T", weight: 630, bikeType: "mtb", teeth: [30], speeds: "mtb" },
    { id: "race-face-aeffect-r-32", model: "Race Face Aeffect R", variant: "32T", weight: 635, bikeType: "mtb", teeth: [32], speeds: "mtb" },

    // Race Face Turbine (MTB)
    { id: "race-face-turbine-32", model: "Race Face Turbine", variant: "32T", weight: 595, bikeType: "mtb", teeth: [32], speeds: "mtb" },

    // Race Face Next SL G5 (High-End MTB)
    { id: "race-face-next-sl-32", model: "Race Face Next SL G5", variant: "32T", weight: 428, bikeType: "mtb", teeth: [32], speeds: "mtb" },
    { id: "race-face-next-sl-34", model: "Race Face Next SL G5", variant: "34T", weight: 435, bikeType: "mtb", teeth: [34], speeds: "mtb" },
  ],

  cassettes: [
    // ================================
    // SHIMANO ROAD CASSETTES
    // ================================

    // Entry Level (8-10 speed)
    { id: "shimano-claris-r2000-11-32", model: "Shimano Claris CS-HG50", variant: "11-32T", weight: 310, bikeType: "road", teeth: [11, 32], speeds: "8-speed" },
    { id: "shimano-sora-r3000-11-32", model: "Shimano Sora CS-HG400", variant: "11-32T", weight: 323, bikeType: "road", teeth: [11, 32], speeds: "9-speed" },
    { id: "shimano-tiagra-r4700-11-32", model: "Shimano Tiagra CS-HG500", variant: "11-32T", weight: 320, bikeType: "road", teeth: [11, 32], speeds: "10-speed" },
    
    // 105 R7000 (11-Speed)
    { id: "shimano-105-r7000-11-28", model: "Shimano 105 R7000", variant: "11-28T", weight: 284, bikeType: "road", teeth: [11, 28], speeds: "11-speed" },
    { id: "shimano-105-r7000-11-30", model: "Shimano 105 R7000", variant: "11-30T", weight: 304, bikeType: "road", teeth: [11, 30], speeds: "11-speed" },
    { id: "shimano-105-r7000-11-32", model: "Shimano 105 R7000", variant: "11-32T", weight: 320, bikeType: "road", teeth: [11, 32], speeds: "11-speed" },
    { id: "shimano-105-r7000-11-34", model: "Shimano 105 R7000", variant: "11-34T", weight: 379, bikeType: "road", teeth: [11, 34], speeds: "11-speed" },

    // 105 R7100 (12-Speed)
    { id: "shimano-105-r7100-11-34", model: "Shimano 105 R7100", variant: "11-34T", weight: 361, bikeType: "road", teeth: [11, 34], speeds: "12-speed" },
    { id: "shimano-105-r7100-11-36", model: "Shimano 105 R7100", variant: "11-36T", weight: 391, bikeType: "road", teeth: [11, 36], speeds: "12-speed" },

    // Ultegra R8000 (11-Speed)
    { id: "shimano-ultegra-r8000-11-28", model: "Shimano Ultegra R8000", variant: "11-28T", weight: 251, bikeType: "road", teeth: [11, 28], speeds: "11-speed" },
    { id: "shimano-ultegra-r8000-11-30", model: "Shimano Ultegra R8000", variant: "11-30T", weight: 269, bikeType: "road", teeth: [11, 30], speeds: "11-speed" },
    { id: "shimano-ultegra-r8000-11-32", model: "Shimano Ultegra R8000", variant: "11-32T", weight: 292, bikeType: "road", teeth: [11, 32], speeds: "11-speed" },
    { id: "shimano-ultegra-r8000-11-34", model: "Shimano Ultegra R8000", variant: "11-34T", weight: 335, bikeType: "road", teeth: [11, 34], speeds: "11-speed" },

    // Ultegra R8100 (12-Speed)
    { id: "shimano-ultegra-r8100-11-30", model: "Shimano Ultegra R8100", variant: "11-30T", weight: 297, bikeType: "road", teeth: [11, 30], speeds: "12-speed" },
    { id: "shimano-ultegra-r8100-11-34", model: "Shimano Ultegra R8100", variant: "11-34T", weight: 345, bikeType: "road", teeth: [11, 34], speeds: "12-speed" },

    // Dura-Ace R9100 (11-Speed)
    { id: "shimano-dura-ace-r9100-11-28", model: "Shimano Dura-Ace R9100", variant: "11-28T", weight: 193, bikeType: "road", teeth: [11, 28], speeds: "11-speed" },
    { id: "shimano-dura-ace-r9100-11-30", model: "Shimano Dura-Ace R9100", variant: "11-30T", weight: 211, bikeType: "road", teeth: [11, 30], speeds: "11-speed" },

    // Dura-Ace R9200 (12-Speed)
    { id: "shimano-dura-ace-r9200-11-30", model: "Shimano Dura-Ace R9200", variant: "11-30T", weight: 223, bikeType: "road", teeth: [11, 30], speeds: "12-speed" },
    { id: "shimano-dura-ace-r9200-11-34", model: "Shimano Dura-Ace R9200", variant: "11-34T", weight: 253, bikeType: "road", teeth: [11, 34], speeds: "12-speed" },

    // ================================
    // SHIMANO GRAVEL CASSETTES
    // ================================

    // GRX (11-Speed & 12-Speed)
    { id: "shimano-grx-rx600-11-42", model: "Shimano SLX M7000", variant: "11-42T", weight: 482, bikeType: "gravel", teeth: [11, 42], speeds: "11-speed" },
    { id: "shimano-grx-rx810-11-34", model: "Shimano Ultegra R8000", variant: "11-34T", weight: 335, bikeType: "gravel", teeth: [11, 34], speeds: "11-speed" },
    { id: "shimano-grx-12s-10-45", model: "Shimano XT M8100", variant: "10-45T", weight: 461, bikeType: "gravel", teeth: [10, 45], speeds: "12-speed" },
    { id: "shimano-grx-12s-10-51", model: "Shimano XT M8100", variant: "10-51T", weight: 470, bikeType: "gravel", teeth: [10, 51], speeds: "12-speed" },

    // ================================
    // SHIMANO MTB CASSETTES
    // ================================
    
    // CUES Linkglide
    { id: "shimano-cues-lg400-11-46", model: "Shimano CUES LG400", variant: "11-46T", weight: 512, bikeType: "mtb", teeth: [11, 46], speeds: "9-speed" },
    { id: "shimano-cues-lg600-11-50", model: "Shimano CUES LG600", variant: "11-50T", weight: 634, bikeType: "mtb", teeth: [11, 50], speeds: "10-speed" },
    { id: "shimano-xt-m8130-11-50", model: "Shimano XT M8130 LinkGlide", variant: "11-50T", weight: 630, bikeType: "mtb", teeth: [11, 50], speeds: "11-speed" },

    // Deore M5100 (11-Speed)
    { id: "shimano-deore-m5100-11-51", model: "Shimano Deore M5100", variant: "11-51T", weight: 623, bikeType: "mtb", teeth: [11, 51], speeds: "11-speed" },

    // Deore M6100 (12-Speed)
    { id: "shimano-deore-m6100-10-51", model: "Shimano Deore M6100", variant: "10-51T", weight: 593, bikeType: "mtb", teeth: [10, 51], speeds: "12-speed" },
    
    // SLX M7100 (12-Speed)
    { id: "shimano-slx-m7100-10-45", model: "Shimano SLX M7100", variant: "10-45T", weight: 513, bikeType: "mtb", teeth: [10, 45], speeds: "12-speed" },
    { id: "shimano-slx-m7100-10-51", model: "Shimano SLX M7100", variant: "10-51T", weight: 534, bikeType: "mtb", teeth: [10, 51], speeds: "12-speed" },
    
    // XT M8100 (12-Speed)
    { id: "shimano-xt-m8100-10-45", model: "Shimano XT M8100", variant: "10-45T", weight: 461, bikeType: "mtb", teeth: [10, 45], speeds: "12-speed" },
    { id: "shimano-xt-m8100-10-51", model: "Shimano XT M8100", variant: "10-51T", weight: 470, bikeType: "mtb", teeth: [10, 51], speeds: "12-speed" },

    // XTR M9100 (12-Speed)
    { id: "shimano-xtr-m9100-10-45", model: "Shimano XTR M9100", variant: "10-45T", weight: 357, bikeType: "mtb", teeth: [10, 45], speeds: "12-speed" },
    { id: "shimano-xtr-m9100-10-51", model: "Shimano XTR M9100", variant: "10-51T", weight: 367, bikeType: "mtb", teeth: [10, 51], speeds: "12-speed" },

    // ================================
    // SRAM ROAD & GRAVEL CASSETTES
    // ================================

    // Apex 12-Speed (XPLR & Eagle) - ADDED
    { id: "sram-apex-xplr-pg1231-11-44", model: "SRAM Apex PG-1231", variant: "11-44T", weight: 426, bikeType: "gravel", teeth: [11, 44], speeds: "12-speed" },
    { id: "sram-apex-eagle-pg1210-11-50", model: "SRAM Apex PG-1210", variant: "11-50T", weight: 630, bikeType: "gravel", teeth: [11, 50], speeds: "12-speed" },

    // Rival AXS (12-Speed)
    { id: "sram-rival-xg1250-10-30", model: "SRAM Rival XG-1250", variant: "10-30T", weight: 282, bikeType: "road", teeth: [10, 30], speeds: "12-speed" },
    { id: "sram-rival-xg1250-10-36", model: "SRAM Rival XG-1250", variant: "10-36T", weight: 338, bikeType: "road", teeth: [10, 36], speeds: "12-speed" },
    { id: "sram-rival-xplr-xg1251-10-44", model: "SRAM Rival XPLR XG-1251", variant: "10-44T", weight: 412, bikeType: "gravel", teeth: [10, 44], speeds: "12-speed" },

    // Force AXS (12-Speed)
    { id: "sram-force-xg1270-10-28", model: "SRAM Force XG-1270", variant: "10-28T", weight: 227, bikeType: "road", teeth: [10, 28], speeds: "12-speed" },
    { id: "sram-force-xg1270-10-33", model: "SRAM Force XG-1270", variant: "10-33T", weight: 261, bikeType: "road", teeth: [10, 33], speeds: "12-speed" },
    { id: "sram-force-xplr-xg1271-10-44", model: "SRAM Force XPLR XG-1271", variant: "10-44T", weight: 373, bikeType: "gravel", teeth: [10, 44], speeds: "12-speed" },
    
    // Red AXS 2024 (12-Speed)
    { id: "sram-red-xg1290-2024-10-28", model: "SRAM Red XG-1290 2024", variant: "10-28T", weight: 180, bikeType: "road", teeth: [10, 28], speeds: "12-speed" },
    { id: "sram-red-xg1290-2024-10-33", model: "SRAM Red XG-1290 2024", variant: "10-33T", weight: 218, bikeType: "road", teeth: [10, 33], speeds: "12-speed" },
    { id: "sram-red-xg1290-2024-10-36", model: "SRAM Red XG-1290 2024", variant: "10-36T", weight: 232, bikeType: "road", teeth: [10, 36], speeds: "12-speed" },

    // ================================
    // SRAM MTB CASSETTES
    // ================================

    // SX Eagle (12-Speed)
    { id: "sram-sx-eagle-11-50", model: "SRAM SX Eagle PG-1210", variant: "11-50T", weight: 630, bikeType: "mtb", teeth: [11, 50], speeds: "12-speed" },

    // NX Eagle (12-Speed)
    { id: "sram-nx-eagle-11-50", model: "SRAM NX Eagle PG-1230", variant: "11-50T", weight: 615, bikeType: "mtb", teeth: [11, 50], speeds: "12-speed" },

    // GX Eagle (12-Speed)
    { id: "sram-gx-eagle-10-50", model: "SRAM GX Eagle XG-1275", variant: "10-50T", weight: 450, bikeType: "mtb", teeth: [10, 50], speeds: "12-speed" },
    { id: "sram-gx-eagle-10-52", model: "SRAM GX Eagle XG-1275", variant: "10-52T", weight: 452, bikeType: "mtb", teeth: [10, 52], speeds: "12-speed" },

    // X01 Eagle (12-Speed)
    { id: "sram-x01-eagle-10-52", model: "SRAM X01 Eagle XG-1295", variant: "10-52T", weight: 357, bikeType: "mtb", teeth: [10, 52], speeds: "12-speed" },

    // XX1 Eagle (12-Speed)
    { id: "sram-xx1-eagle-10-52", model: "SRAM XX1 Eagle XG-1299", variant: "10-52T", weight: 353, bikeType: "mtb", teeth: [10, 52], speeds: "12-speed" },

    // Transmission T-Type Cassettes
    { id: "sram-gx-eagle-t-type-10-52", model: "SRAM GX Eagle T-Type XS-1275", variant: "10-52T", weight: 445, bikeType: "mtb", teeth: [10, 52], speeds: "12-speed" },
    { id: "sram-x0-eagle-t-type-10-52", model: "SRAM X0 Eagle T-Type XS-1295", variant: "10-52T", weight: 385, bikeType: "mtb", teeth: [10, 52], speeds: "12-speed" },
    { id: "sram-xx-eagle-t-type-10-52", model: "SRAM XX Eagle T-Type XS-1297", variant: "10-52T", weight: 350, bikeType: "mtb", teeth: [10, 52], speeds: "12-speed" },

    // ================================
    // CAMPAGNOLO CASSETTES
    // ================================

    // Chorus (12-Speed)
    { id: "campagnolo-chorus-11-29", model: "Campagnolo Chorus", variant: "11-29T", weight: 305, bikeType: "road", teeth: [11, 29], speeds: "12-speed" },
    { id: "campagnolo-chorus-11-32", model: "Campagnolo Chorus", variant: "11-32T", weight: 325, bikeType: "road", teeth: [11, 32], speeds: "12-speed" },
    { id: "campagnolo-chorus-11-34", model: "Campagnolo Chorus", variant: "11-34T", weight: 345, bikeType: "road", teeth: [11, 34], speeds: "12-speed" },

    // Record (12-Speed)
    { id: "campagnolo-record-11-29", model: "Campagnolo Record", variant: "11-29T", weight: 266, bikeType: "road", teeth: [11, 29], speeds: "12-speed" },
    { id: "campagnolo-record-11-32", model: "Campagnolo Record", variant: "11-32T", weight: 288, bikeType: "road", teeth: [11, 32], speeds: "12-speed" },
    
    // Super Record (12-Speed)
    { id: "campagnolo-super-record-11-29", model: "Campagnolo Super Record", variant: "11-29T", weight: 266, bikeType: "road", teeth: [11, 29], speeds: "12-speed" },
    { id: "campagnolo-super-record-11-32", model: "Campagnolo Super Record", variant: "11-32T", weight: 288, bikeType: "road", teeth: [11, 32], speeds: "12-speed" },

    // Super Record Wireless (13-Speed)
    { id: "campagnolo-super-record-wrl-10-29", model: "Campagnolo Super Record WRL", variant: "10-29T", weight: 295, bikeType: "road", teeth: [10, 29], speeds: "13-speed" },

    // Ekar (13-Speed Gravel)
    { id: "campagnolo-ekar-9-36", model: "Campagnolo Ekar", variant: "9-36T", weight: 340, bikeType: "gravel", teeth: [9, 36], speeds: "13-speed" },
    { id: "campagnolo-ekar-9-42", model: "Campagnolo Ekar", variant: "9-42T", weight: 390, bikeType: "gravel", teeth: [9, 42], speeds: "13-speed" },
    { id: "campagnolo-ekar-10-44", model: "Campagnolo Ekar", variant: "10-44T", weight: 410, bikeType: "gravel", teeth: [10, 44], speeds: "13-speed" },

    // Ekar GT (13-Speed Gravel)
    { id: "campagnolo-ekar-gt-10-48", model: "Campagnolo Ekar GT", variant: "10-48T", weight: 435, bikeType: "gravel", teeth: [10, 48], speeds: "13-speed" },
  ]
};

export const getComponentsForBikeType = (bikeType) => {
  const relevantBikeTypes = [bikeType];
  if (bikeType === 'gravel') {
    // Allow gravel bikes to use MTB components for 'mullet' setups
    relevantBikeTypes.push('mtb');
  }

  const cranksets = componentDatabase.cranksets.filter(c => relevantBikeTypes.includes(c.bikeType));
  const cassettes = componentDatabase.cassettes.filter(c => relevantBikeTypes.includes(c.bikeType));

  return {
    cranksets,
    cassettes,
  };
};
```

### lib/validation.js
```
// lib/validation.js - Input validation utilities for CrankSmith
import { bikeConfig } from './components';

/**
 * Email validation with comprehensive checks
 */
export const validateEmail = (email) => {
  const errors = [];
  
  // Basic presence check
  if (!email || typeof email !== 'string') {
    errors.push('Email is required');
    return { isValid: false, errors, sanitized: null };
  }
  
  // Trim and lowercase for consistency
  const sanitized = email.trim().toLowerCase();
  
  // Length checks
  if (sanitized.length === 0) {
    errors.push('Email cannot be empty');
    return { isValid: false, errors, sanitized: null };
  }
  
  if (sanitized.length > 254) {
    errors.push('Email is too long (max 254 characters)');
    return { isValid: false, errors, sanitized: null };
  }
  
  // Format validation with comprehensive regex
  const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
  
  if (!emailRegex.test(sanitized)) {
    errors.push('Please enter a valid email address');
    return { isValid: false, errors, sanitized: null };
  }
  
  // Check for common typos in domain
  const domain = sanitized.split('@')[1];
  const commonDomainTypos = {
    'gmai.com': 'gmail.com',
    'gmial.com': 'gmail.com',
    'gmail.co': 'gmail.com',
    'yahoo.co': 'yahoo.com',
    'hotmial.com': 'hotmail.com',
    'outlok.com': 'outlook.com'
  };
  
  if (commonDomainTypos[domain]) {
    errors.push(`Did you mean ${sanitized.replace(domain, commonDomainTypos[domain])}?`);
    return { isValid: false, errors, sanitized: null, suggestion: sanitized.replace(domain, commonDomainTypos[domain]) };
  }
  
  return { isValid: true, errors: [], sanitized };
};

/**
 * Numeric input validation
 */
export const validateNumeric = (value, options = {}) => {
  const { min, max, integer = false, positive = false, field = 'value' } = options;
  const errors = [];
  
  if (value === null || value === undefined || value === '') {
    if (options.required) {
      errors.push(`${field} is required`);
    }
    return { isValid: !options.required, errors, sanitized: null };
  }
  
  const num = Number(value);
  
  if (isNaN(num)) {
    errors.push(`${field} must be a valid number`);
    return { isValid: false, errors, sanitized: null };
  }
  
  if (integer && !Number.isInteger(num)) {
    errors.push(`${field} must be a whole number`);
    return { isValid: false, errors, sanitized: null };
  }
  
  if (positive && num <= 0) {
    errors.push(`${field} must be positive`);
    return { isValid: false, errors, sanitized: null };
  }
  
  if (min !== undefined && num < min) {
    errors.push(`${field} must be at least ${min}`);
    return { isValid: false, errors, sanitized: null };
  }
  
  if (max !== undefined && num > max) {
    errors.push(`${field} must be no more than ${max}`);
    return { isValid: false, errors, sanitized: null };
  }
  
  return { isValid: true, errors: [], sanitized: num };
};

/**
 * Bike type validation
 */
export const validateBikeType = (bikeType) => {
  const errors = [];
  
  if (!bikeType || typeof bikeType !== 'string') {
    errors.push('Bike type is required');
    return { isValid: false, errors, sanitized: null };
  }
  
  const sanitized = bikeType.trim().toLowerCase();
  const validTypes = Object.keys(bikeConfig);
  
  if (!validTypes.includes(sanitized)) {
    errors.push(`Bike type must be one of: ${validTypes.join(', ')}`);
    return { isValid: false, errors, sanitized: null };
  }
  
  return { isValid: true, errors: [], sanitized };
};

/**
 * Component validation
 */
export const validateComponent = (component, type = 'component') => {
  const errors = [];
  
  if (!component) {
    return { isValid: true, errors: [], sanitized: null }; // Components are optional
  }
  
  if (typeof component !== 'object') {
    errors.push(`${type} must be a valid component object`);
    return { isValid: false, errors, sanitized: null };
  }
  
  // Required fields for components
  const requiredFields = ['id', 'model', 'weight'];
  const missingFields = requiredFields.filter(field => !component[field]);
  
  if (missingFields.length > 0) {
    errors.push(`${type} is missing required fields: ${missingFields.join(', ')}`);
    return { isValid: false, errors, sanitized: null };
  }
  
  // Validate weight is numeric and reasonable
  const weightValidation = validateNumeric(component.weight, { 
    min: 1, 
    max: 10000, 
    positive: true,
    field: `${type} weight`
  });
  
  if (!weightValidation.isValid) {
    errors.push(...weightValidation.errors);
    return { isValid: false, errors, sanitized: null };
  }
  
  return { isValid: true, errors: [], sanitized: component };
};

/**
 * Setup validation (wheel, tire, crankset, cassette)
 */
export const validateSetup = (setup, bikeType) => {
  const errors = [];
  const sanitized = {};
  
  if (!setup || typeof setup !== 'object') {
    errors.push('Setup must be a valid object');
    return { isValid: false, errors, sanitized: null };
  }
  
  // Validate bike type first
  const bikeTypeValidation = validateBikeType(bikeType);
  if (!bikeTypeValidation.isValid) {
    errors.push(...bikeTypeValidation.errors);
    return { isValid: false, errors, sanitized: null };
  }
  
  const config = bikeConfig[bikeTypeValidation.sanitized];
  
  // Validate wheel size
  if (setup.wheel) {
    if (!config.wheelSizes.includes(setup.wheel)) {
      errors.push(`Wheel size must be one of: ${config.wheelSizes.join(', ')}`);
    } else {
      sanitized.wheel = setup.wheel;
    }
  }
  
  // Validate tire width
  if (setup.tire) {
    const tireValidation = validateNumeric(setup.tire, {
      field: 'tire width',
      positive: true
    });
    
    if (!tireValidation.isValid) {
      errors.push(...tireValidation.errors);
    } else if (!config.tireWidths.includes(tireValidation.sanitized)) {
      errors.push(`Tire width must be one of: ${config.tireWidths.join(', ')}`);
    } else {
      sanitized.tire = tireValidation.sanitized.toString();
    }
  }
  
  // Validate crankset
  const cranksetValidation = validateComponent(setup.crankset, 'crankset');
  if (!cranksetValidation.isValid) {
    errors.push(...cranksetValidation.errors);
  } else {
    sanitized.crankset = cranksetValidation.sanitized;
  }
  
  // Validate cassette
  const cassetteValidation = validateComponent(setup.cassette, 'cassette');
  if (!cassetteValidation.isValid) {
    errors.push(...cassetteValidation.errors);
  } else {
    sanitized.cassette = cassetteValidation.sanitized;
  }
  
  return { 
    isValid: errors.length === 0, 
    errors, 
    sanitized: errors.length === 0 ? sanitized : null 
  };
};

/**
 * Request body validation for API routes
 */
export const validateRequestBody = (body, schema) => {
  const errors = [];
  const sanitized = {};
  
  if (!body || typeof body !== 'object') {
    errors.push('Request body must be a valid object');
    return { isValid: false, errors, sanitized: null };
  }
  
  for (const [field, rules] of Object.entries(schema)) {
    const value = body[field];
    
    if (rules.required && (value === undefined || value === null || value === '')) {
      errors.push(`${field} is required`);
      continue;
    }
    
    if (value === undefined || value === null || value === '') {
      continue; // Skip optional empty fields
    }
    
    if (rules.type === 'email') {
      const validation = validateEmail(value);
      if (!validation.isValid) {
        errors.push(...validation.errors);
      } else {
        sanitized[field] = validation.sanitized;
      }
    } else if (rules.type === 'string') {
      if (typeof value !== 'string') {
        errors.push(`${field} must be a string`);
      } else {
        const sanitizedValue = value.trim();
        
        if (rules.minLength && sanitizedValue.length < rules.minLength) {
          errors.push(`${field} must be at least ${rules.minLength} characters`);
        }
        
        if (rules.maxLength && sanitizedValue.length > rules.maxLength) {
          errors.push(`${field} must be no more than ${rules.maxLength} characters`);
        }
        
        if (errors.length === 0) {
          sanitized[field] = sanitizedValue;
        }
      }
    } else if (rules.type === 'number') {
      const validation = validateNumeric(value, rules);
      if (!validation.isValid) {
        errors.push(...validation.errors);
      } else {
        sanitized[field] = validation.sanitized;
      }
    }
  }
  
  return { 
    isValid: errors.length === 0, 
    errors, 
    sanitized: errors.length === 0 ? sanitized : null 
  };
};

/**
 * Sanitize string input to prevent XSS
 */
export const sanitizeString = (str) => {
  if (typeof str !== 'string') return str;
  
  return str
    .trim()
    .replace(/<script[^>]*>.*?<\/script>/gi, '') // Remove script tags
    .replace(/javascript:/gi, '') // Remove javascript: protocols
    .replace(/on\w+\s*=/gi, '') // Remove event handlers
    .slice(0, 1000); // Limit length
}; ```

### lib/pwa-utils.js
```
// lib/pwa-utils.js - FIXED VERSION
// Critical Bug Fix: Simplified mobile detection and improved service worker handling
// Quick Win: Non-intrusive mobile suggestions

let swRegistration = null;
let updateAvailable = false;
let updateInterval = null;

// Improved mobile detection
export const isMobileDevice = () => {
  if (typeof window === 'undefined') return false;
  
  // Check user agent
  const userAgent = navigator.userAgent || navigator.vendor || window.opera;
  const mobileRegex = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i;
  
  // Check screen size
  const isSmallScreen = window.innerWidth <= 768;
  
  // Check touch capability
  const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  
  return mobileRegex.test(userAgent) || (isSmallScreen && isTouchDevice);
};

// FIXED: Robust service worker registration
export const registerServiceWorker = () => {
  if (typeof window !== 'undefined' && 'serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        swRegistration = await navigator.serviceWorker.register('/sw.js', {
          scope: '/'
        });
        
        console.log('ServiceWorker registered:', swRegistration.scope);
        
        // Handle updates
        swRegistration.addEventListener('updatefound', handleUpdateFound);
        navigator.serviceWorker.addEventListener('controllerchange', handleControllerChange);
        
        // Check for updates every 10 minutes (reduced frequency)
        updateInterval = setInterval(() => {
          if (swRegistration && !updateAvailable && !document.hidden) {
            swRegistration.update().catch(error => {
              console.warn('SW update check failed:', error);
            });
          }
        }, 600000); // 10 minutes
        
        // Check for updates when page becomes visible
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden && swRegistration && !updateAvailable) {
            swRegistration.update().catch(() => {
              // Silently fail - not critical
            });
          }
        });
        
      } catch (error) {
        console.warn('ServiceWorker registration failed:', error);
        // Continue without service worker - app still works
      }
    });
  }
};

const handleUpdateFound = () => {
  const newWorker = swRegistration.installing;
  if (!newWorker) return;
  
  updateAvailable = true;
  
  newWorker.addEventListener('statechange', () => {
    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
      // New content available - show subtle notification
      showUpdateNotification();
    }
  });
};

const handleControllerChange = () => {
  // Reload page when new service worker takes control
  window.location.reload();
};

// Subtle update notification
const showUpdateNotification = () => {
  // Only show if user isn't actively calculating
  if (document.hidden) return;
  
  const notification = document.createElement('div');
  notification.className = 'fixed top-4 right-4 bg-blue-600 text-white p-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full';
  notification.innerHTML = `
    <div class="flex items-center gap-2">
      <span>üîÑ</span>
      <span class="text-sm">Update available</span>
      <button onclick="window.location.reload()" class="bg-white text-blue-600 px-2 py-1 rounded text-xs font-medium ml-2">
        Update
      </button>
      <button onclick="this.parentElement.parentElement.remove()" class="text-white/80 hover:text-white ml-1">
        ‚úï
      </button>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  // Slide in
  setTimeout(() => {
    notification.classList.remove('translate-x-full');
  }, 100);
  
  // Auto-remove after 10 seconds
  setTimeout(() => {
    if (notification.parentElement) {
      notification.classList.add('translate-x-full');
      setTimeout(() => notification.remove(), 300);
    }
  }, 10000);
};

// Mobile user preferences management
const MOBILE_PREFERENCES = {
  DESKTOP_PREFERRED: 'cranksmith_desktop_preference',
  MOBILE_SUGGESTED_TODAY: 'cranksmith_mobile_suggested_today',
  LAST_SUGGESTION_DATE: 'cranksmith_last_suggestion_date'
};

// Check if we should show mobile suggestion today
const shouldShowMobileSuggestionToday = () => {
  if (typeof window === 'undefined') return false;
  
  const today = new Date().toDateString();
  const lastSuggestionDate = localStorage.getItem(MOBILE_PREFERENCES.LAST_SUGGESTION_DATE);
  const hasSeenToday = localStorage.getItem(MOBILE_PREFERENCES.MOBILE_SUGGESTED_TODAY) === 'true';
  
  // Reset daily flag if it's a new day
  if (lastSuggestionDate !== today) {
    localStorage.removeItem(MOBILE_PREFERENCES.MOBILE_SUGGESTED_TODAY);
    return true;
  }
  
  return !hasSeenToday;
};

// Mark mobile suggestion as shown for today
const markMobileSuggestionShown = () => {
  if (typeof window === 'undefined') return;
  
  const today = new Date().toDateString();
  localStorage.setItem(MOBILE_PREFERENCES.MOBILE_SUGGESTED_TODAY, 'true');
  localStorage.setItem(MOBILE_PREFERENCES.LAST_SUGGESTION_DATE, today);
};

// User preference management
export const getUserMobilePreference = () => {
  if (typeof window === 'undefined') return null;
  return localStorage.getItem(MOBILE_PREFERENCES.DESKTOP_PREFERRED);
};

export const setUserPrefersMobile = () => {
  if (typeof window === 'undefined') return;
  localStorage.removeItem(MOBILE_PREFERENCES.DESKTOP_PREFERRED);
};

export const setUserPrefersDesktop = () => {
  if (typeof window === 'undefined') return;
  localStorage.setItem(MOBILE_PREFERENCES.DESKTOP_PREFERRED, 'true');
  markMobileSuggestionShown();
};

// FIXED: Non-intrusive mobile routing with Toast notifications
export const handleMobileRouting = (router) => {
  if (typeof window === 'undefined') return;
  
  const isMobile = isMobileDevice();
  const isOnMobilePage = router.pathname.startsWith('/mobile');
  
  // Don't show suggestions if:
  // 1. Not on mobile device
  // 2. Already on mobile page
  // 3. User prefers desktop
  // 4. Already suggested today
  if (!isMobile || isOnMobilePage) return;
  
  const userPrefersDesktop = getUserMobilePreference() === 'true';
  const canShowToday = shouldShowMobileSuggestionToday();
  
  if (userPrefersDesktop || !canShowToday) return;
  
  // Only suggest on calculator and specific useful pages
  const suggestOnPages = ['/calculator', '/bike-fit', '/garage', '/builder'];
  const shouldSuggest = suggestOnPages.includes(router.pathname);
  
  if (shouldSuggest) {
    // Use a small delay to ensure page is loaded
    setTimeout(() => {
      showMobileSuggestionToast(router);
    }, 2000);
  }
};

// Toast-based mobile suggestion (non-intrusive)
const showMobileSuggestionToast = (router) => {
  // Mark as shown to prevent repeat suggestions today
  markMobileSuggestionShown();
  
  // Create a custom toast notification
  const toastEvent = new CustomEvent('show-mobile-suggestion', {
    detail: {
      message: 'üì± Better mobile experience available',
      type: 'info',
      duration: 8000,
      actions: [
        {
          label: 'Try Mobile',
          variant: 'primary',
          onClick: () => {
            router.push('/mobile' + router.pathname);
          }
        },
        {
          label: 'Stay on Desktop',
          variant: 'secondary',
          onClick: () => {
            setUserPrefersDesktop();
          }
        }
      ]
    }
  });
  
  // Dispatch to toast system
  if (typeof window !== 'undefined') {
    window.dispatchEvent(toastEvent);
  }
};

// Simple mobile app detection for routing
export const isMobileApp = (pathname) => {
  return pathname && pathname.startsWith('/mobile');
};

// PWA install detection
export const useInstallPrompt = () => {
  const [installPrompt, setInstallPrompt] = useState(null);
  
  useEffect(() => {
    const handleBeforeInstallPrompt = (e) => {
      e.preventDefault();
      setInstallPrompt(e);
    };
    
    window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
    
    return () => {
      window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
    };
  }, []);
  
  return installPrompt;
};

// Check if app is installed
export const isAppInstalled = () => {
  return window.matchMedia('(display-mode: standalone)').matches ||
         window.navigator.standalone === true;
};

// Missing PWA utility functions for compatibility
let deferredPrompt = null;

export const checkIfPWA = () => {
  if (typeof window === 'undefined') return false;
  return isAppInstalled();
};

export const canInstall = () => {
  if (typeof window === 'undefined') return false;
  return deferredPrompt !== null;
};

export const getInstallPrompt = () => {
  return deferredPrompt;
};

export const installPWA = async (prompt) => {
  if (!prompt) return false;
  
  try {
    const result = await prompt.prompt();
    const outcome = await result.userChoice;
    
    if (outcome === 'accepted') {
      deferredPrompt = null;
      return true;
    }
    return false;
  } catch (error) {
    console.error('Error installing PWA:', error);
    return false;
  }
};

export const isIOS = () => {
  if (typeof window === 'undefined') return false;
  return /iPad|iPhone|iPod/.test(navigator.userAgent);
};

// Initialize prompt handling
if (typeof window !== 'undefined') {
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
  });
}

// Cleanup function for unmounting
export const cleanup = () => {
  if (updateInterval) {
    clearInterval(updateInterval);
    updateInterval = null;
  }
  
  if (swRegistration) {
    swRegistration.removeEventListener('updatefound', handleUpdateFound);
    swRegistration = null;
  }
};```

### lib/pwa-enhanced.ts
```
// lib/pwa-enhanced.ts - Enhanced PWA utilities with offline support and background sync
import { ServiceWorkerMessage } from '../types';

let swRegistration: ServiceWorkerRegistration | null = null;
let installPromptEvent: any = null;

// Enhanced service worker registration
export async function registerEnhancedServiceWorker(): Promise<void> {
  if (typeof window === 'undefined' || !('serviceWorker' in navigator)) {
    console.log('Service Worker not supported');
    return;
  }

  try {
    // Unregister old service worker first
    const registrations = await navigator.serviceWorker.getRegistrations();
    for (const registration of registrations) {
      if (registration.scope.includes('sw.js')) {
        await registration.unregister();
        console.log('Unregistered old service worker');
      }
    }

    // Register enhanced service worker
    swRegistration = await navigator.serviceWorker.register('/sw-enhanced.js', {
      scope: '/',
      updateViaCache: 'none'
    });

    console.log('Enhanced Service Worker registered successfully');

    // Handle service worker updates
    swRegistration.addEventListener('updatefound', () => {
      const newWorker = swRegistration?.installing;
      if (newWorker) {
        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            // New version available
            showUpdatePrompt();
          }
        });
      }
    });

    // Listen for messages from service worker
    navigator.serviceWorker.addEventListener('message', handleServiceWorkerMessage);

    // Cache component data for offline use
    await cacheComponentData();

  } catch (error) {
    console.error('Enhanced Service Worker registration failed:', error);
  }
}

// Handle messages from service worker
function handleServiceWorkerMessage(event: MessageEvent<ServiceWorkerMessage>): void {
  const { type, payload } = event.data;

  switch (type) {
    case 'CACHE_UPDATED':
      console.log('Cache updated:', payload);
      break;
    case 'OFFLINE_READY':
      showOfflineReadyNotification();
      break;
    case 'UPDATE_AVAILABLE':
      showUpdatePrompt();
      break;
  }
}

// Cache component data for offline calculations
export async function cacheComponentData(): Promise<void> {
  if (!swRegistration) return;

  try {
    // Import component data
    const { componentDatabase } = await import('./components');
    
    // Send to service worker for caching
    if (swRegistration.active) {
      swRegistration.active.postMessage({
        type: 'CACHE_COMPONENT_DATA',
        payload: componentDatabase
      });
    }

    console.log('Component data sent to service worker for caching');
  } catch (error) {
    console.error('Failed to cache component data:', error);
  }
}

// Enhanced PWA install functionality
export function initializeEnhancedPWA(): void {
  // Listen for install prompt
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    installPromptEvent = e;
    console.log('PWA install prompt captured');
  });

  // Handle app installed
  window.addEventListener('appinstalled', () => {
    console.log('PWA installed successfully');
    installPromptEvent = null;
    
    // Track installation
    if (typeof (window as any).gtag !== 'undefined') {
      (window as any).gtag('event', 'pwa_install', {
        event_category: 'engagement',
        event_label: 'PWA Installation'
      });
    }
  });

  // Register service worker
  registerEnhancedServiceWorker();
}

// Enhanced install PWA function
export async function installEnhancedPWA(): Promise<boolean> {
  if (!installPromptEvent) {
    console.log('No install prompt available');
    return false;
  }

  try {
    const result = await installPromptEvent.prompt();
    const userChoice = await result.userChoice;
    
    if (userChoice === 'accepted') {
      console.log('User accepted PWA install');
      return true;
    } else {
      console.log('User dismissed PWA install');
      return false;
    }
  } catch (error) {
    console.error('PWA install failed:', error);
    return false;
  } finally {
    installPromptEvent = null;
  }
}

// Check if PWA install is available
export function canInstallEnhancedPWA(): boolean {
  return !!installPromptEvent;
}

// Offline configuration management
export async function saveConfigurationOffline(config: any): Promise<void> {
  if (!swRegistration?.active) {
    console.warn('Service worker not available for offline save');
    return;
  }

  try {
    swRegistration.active.postMessage({
      type: 'SAVE_OFFLINE_CONFIG',
      payload: config
    });

    console.log('Configuration saved for offline sync');
  } catch (error) {
    console.error('Failed to save configuration offline:', error);
  }
}

// Get cache status
export async function getCacheStatus(): Promise<any> {
  return new Promise((resolve) => {
    if (!swRegistration?.active) {
      resolve({ hasOfflineData: false, hasPendingSync: false });
      return;
    }

    const messageChannel = new MessageChannel();
    messageChannel.port1.onmessage = (event) => {
      if (event.data.type === 'CACHE_STATUS') {
        resolve(event.data.payload);
      }
    };

    swRegistration.active.postMessage(
      { type: 'REQUEST_CACHE_STATUS' },
      [messageChannel.port2]
    );

    // Timeout after 5 seconds
    setTimeout(() => {
      resolve({ hasOfflineData: false, hasPendingSync: false });
    }, 5000);
  });
}

// Connection status management
export class ConnectionManager {
  private static instance: ConnectionManager;
  private isOnline: boolean = navigator.onLine;
  private listeners: Set<(online: boolean) => void> = new Set();

  private constructor() {
    window.addEventListener('online', this.handleOnline.bind(this));
    window.addEventListener('offline', this.handleOffline.bind(this));
  }

  static getInstance(): ConnectionManager {
    if (!ConnectionManager.instance) {
      ConnectionManager.instance = new ConnectionManager();
    }
    return ConnectionManager.instance;
  }

  private handleOnline(): void {
    this.isOnline = true;
    this.notifyListeners();
    console.log('Connection restored');
  }

  private handleOffline(): void {
    this.isOnline = false;
    this.notifyListeners();
    console.log('Connection lost');
  }

  private notifyListeners(): void {
    this.listeners.forEach(listener => listener(this.isOnline));
  }

  public addListener(listener: (online: boolean) => void): void {
    this.listeners.add(listener);
  }

  public removeListener(listener: (online: boolean) => void): void {
    this.listeners.delete(listener);
  }

  public get online(): boolean {
    return this.isOnline;
  }
}

// Enhanced notifications
function showOfflineReadyNotification(): void {
  if ('toast' in window) {
    (window as any).toast.success('App is ready to work offline!', 3000);
  }
}

function showUpdatePrompt(): void {
  if ('toast' in window) {
    (window as any).toast.info('A new version is available. Refresh to update.', 8000);
  }
}

// Network-aware fetch wrapper
export async function networkAwareFetch(
  url: string, 
  options: RequestInit = {}
): Promise<Response> {
  try {
    const response = await fetch(url, {
      ...options,
      cache: 'no-cache'
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    return response;
  } catch (error) {
    console.warn('Network request failed, checking cache:', url);
    
    // Try to get cached version if available
    if ('caches' in window) {
      const cache = await caches.open('cranksmith-components-v2.0.0');
      const cached = await cache.match(url);
      
      if (cached) {
        console.log('Returning cached response for:', url);
        return cached;
      }
    }

    throw error;
  }
}

// Offline-first calculation wrapper
export async function offlineCalculateResults(
  currentSetup: any,
  proposedSetup: any,
  speedUnit: string
): Promise<any> {
  try {
    // Try to import calculation function directly
    const { calculateRealPerformance } = await import('./calculateRealPerformance');
    return calculateRealPerformance(currentSetup, proposedSetup, speedUnit);
  } catch (error) {
    console.error('Offline calculation failed:', error);
    throw new Error('Calculation temporarily unavailable');
  }
}

// Export singleton connection manager instance
export const connectionManager = ConnectionManager.getInstance();```

### lib/supabase.js
```
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://your-project.supabase.co'
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'your-anon-key'

export const supabase = createClient(supabaseUrl, supabaseAnonKey)

// For beta testing without Supabase, we'll use local storage
export const localStorageDB = {
  async saveConfig(config) {
    try {
      const configs = JSON.parse(localStorage.getItem('cranksmith_configs') || '[]')
      const newConfig = {
        ...config,
        id: Date.now().toString(),
        created_at: new Date().toISOString()
      }
      configs.push(newConfig)
      localStorage.setItem('cranksmith_configs', JSON.stringify(configs))
      return { data: newConfig, error: null }
    } catch (error) {
      return { data: null, error }
    }
  },
  
  async getConfigs() {
    try {
      const configs = JSON.parse(localStorage.getItem('cranksmith_configs') || '[]')
      return { data: configs, error: null }
    } catch (error) {
      return { data: [], error }
    }
  },
  
  async deleteConfig(id) {
    try {
      const configs = JSON.parse(localStorage.getItem('cranksmith_configs') || '[]')
      const filtered = configs.filter(c => c.id !== id)
      localStorage.setItem('cranksmith_configs', JSON.stringify(filtered))
      return { error: null }
    } catch (error) {
      return { error }
    }
  }
}```

### lib/rileyAI.js
```
// lib/rileyAI.js - Enhanced Riley with gear analysis integration and PWA optimization
// UPDATED: Added contextual gear analysis, compatibility checking, and mobile-optimized responses

const RILEY_SYSTEM_PROMPT = `
You are Riley, a master bike mechanic with 20+ years of experience working on road, gravel, and mountain bikes. You work at CrankSmith, helping cyclists optimize their setups and solve technical problems.

PERSONALITY & TONE:
- Professional but humble - you're knowledgeable without being boastful
- Ask clarifying questions when assumptions might be wrong
- Use specific but measured language ("I've worked on several of these" vs "hundreds")
- Acknowledge when something is generally good quality, even when discussing issues
- Format responses with line breaks for readability
- Keep responses concise for mobile users (150-250 words ideal)

EXPERTISE AREAS:
- Component compatibility (drivetrains, wheels, brakes)
- Performance optimization for different riding styles
- Troubleshooting mechanical issues
- Upgrade recommendations within budget constraints
- Real-world pros/cons of component choices
- Installation tips and potential gotchas
- Gear ratio analysis and terrain suitability

RESPONSE STYLE:
- Start with a direct answer to their question
- Provide context/reasoning ("Here's why that matters...")
- Include practical tips when relevant
- End with actionable next steps
- Stay helpful and curious rather than assuming you know everything
- Keep responses conversational but informative
- Use mobile-friendly formatting (short paragraphs, bullet points)

FORMATTING GUIDELINES:
- Use <br><br> between major sections for mobile readability
- Use bullet points with - for lists
- Keep paragraphs to 2-3 sentences max
- Bold key recommendations with **text**

GEAR ANALYSIS INTEGRATION:
When provided with gear analysis data, focus on:
- Practical implications of the gear ratios
- Terrain suitability based on gear inches
- Compatibility concerns and solutions
- Performance trade-offs explained simply
- Specific recommendations for the user's riding style

COMPATIBILITY EXPERTISE:
You understand derailleur capacity calculations, chain line issues, speed compatibility, and can explain complex compatibility problems in simple terms.

IMPORTANT GUIDELINES:
- Always prioritize safety and proper installation
- Mention when professional installation is recommended
- Be honest about limitations and compatibility issues
- If unsure about something specific, say so and suggest consulting local shop
- Reference the user's CrankSmith analysis when applicable
- Optimize responses for mobile reading (shorter sentences, clear structure)

Remember: You're here to genuinely help cyclists make informed decisions about their gear setups.
`;

export class RileyAI {
  constructor(apiKey, componentDatabase) {
    this.apiKey = apiKey;
    this.componentDatabase = componentDatabase;
    this.conversationHistory = [];
  }

  async askRiley(userQuestion, userSetup = null, analysisResults = null, bikeType = null) {
    try {
      const context = this.buildEnhancedContext(userSetup, analysisResults, bikeType);
      const fullPrompt = `${RILEY_SYSTEM_PROMPT}

CURRENT CONTEXT: ${context}

CONVERSATION HISTORY:
${this.conversationHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n')}

USER QUESTION: ${userQuestion}

Please respond as Riley, the expert bike mechanic. Keep it mobile-friendly and actionable:`;

      // Call your API route
      const response = await fetch('/api/riley', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          prompt: fullPrompt
        }),
      });

      const data = await response.json();

      if (data.success) {
        // Add to conversation history
        this.conversationHistory.push(
          { role: "user", content: userQuestion },
          { role: "assistant", content: data.response }
        );
        
        // Keep history manageable for mobile
        if (this.conversationHistory.length > 10) {
          this.conversationHistory = this.conversationHistory.slice(-10);
        }

        // Process response for affiliate links and mobile optimization
        const processedResponse = this.processResponseForMobile(data.response);

        return {
          success: true,
          response: processedResponse,
          timestamp: data.timestamp
        };
      } else {
        throw new Error(data.error);
      }

    } catch (error) {
      console.error('Riley AI Error:', error);
      return {
        success: false,
        error: 'Sorry, I\'m having trouble connecting right now. Try asking again in a moment.',
        timestamp: new Date().toISOString()
      };
    }
  }

  buildEnhancedContext(userSetup, analysisResults, bikeType) {
    let context = "";
    
    if (bikeType) {
      context += `BIKE TYPE: ${bikeType.charAt(0).toUpperCase() + bikeType.slice(1)} bike\n`;
    }
    
    if (userSetup) {
      context += `USER'S SETUP:
- Wheel: ${userSetup.wheel || 'Not specified'}
- Tire: ${userSetup.tire || 'Not specified'}mm
- Crankset: ${this.formatComponent(userSetup.crankset)}
- Cassette: ${this.formatComponent(userSetup.cassette)}
`;
    }

    if (analysisResults) {
      const { current, proposed, comparison } = analysisResults;
      
      context += `
CRANKSMITH ANALYSIS RESULTS:
Performance Comparison:
- Current top speed: ${current?.metrics?.highSpeed || 'N/A'} mph
- Proposed top speed: ${proposed?.metrics?.highSpeed || 'N/A'} mph
- Current climbing speed: ${current?.metrics?.lowSpeed || 'N/A'} mph  
- Proposed climbing speed: ${proposed?.metrics?.lowSpeed || 'N/A'} mph
- Weight change: ${comparison?.weightChange || 'N/A'}g
- Speed improvement: ${comparison?.speedChange || 'N/A'} mph
- Range change: ${comparison?.rangeChange || 'N/A'}%

Current Setup Analysis:
- Weight: ${current?.totalWeight || 'N/A'}g
- Gear range: ${current?.gearRange || 'N/A'}%
- High ratio: ${current?.metrics?.highRatio || 'N/A'}
- Low ratio: ${current?.metrics?.lowRatio || 'N/A'}

Proposed Setup Analysis:
- Weight: ${proposed?.totalWeight || 'N/A'}g  
- Gear range: ${proposed?.gearRange || 'N/A'}%
- High ratio: ${proposed?.metrics?.highRatio || 'N/A'}
- Low ratio: ${proposed?.metrics?.lowRatio || 'N/A'}

Compatibility Status: ${this.assessCompatibility(userSetup, analysisResults)}
`;

      // Add terrain suitability analysis
      context += this.generateTerrainAnalysis(analysisResults, bikeType);
    }

    return context || "No current setup information available.";
  }

  formatComponent(component) {
    if (!component) return 'Not selected';
    return `${component.model || 'Unknown'} ${component.variant || ''}`.trim();
  }

  assessCompatibility(userSetup, analysisResults) {
    if (!userSetup?.crankset || !userSetup?.cassette) return 'Cannot assess - incomplete setup';
    
    const warnings = [];
    
    // Check derailleur capacity
    if (userSetup.cassette?.teeth) {
      const cassetteRange = Math.max(...userSetup.cassette.teeth) - Math.min(...userSetup.cassette.teeth);
      if (cassetteRange > 36) {
        warnings.push('Large cassette range may require long-cage derailleur');
      }
    }
    
    // Check speed compatibility
    if (userSetup.crankset?.speeds && userSetup.cassette?.speeds) {
      const cranksetSpeed = this.extractSpeedCount(userSetup.crankset.speeds);
      const cassetteSpeed = this.extractSpeedCount(userSetup.cassette.speeds);
      
      if (cranksetSpeed !== cassetteSpeed && cranksetSpeed !== 0 && cassetteSpeed !== 0) {
        warnings.push(`Speed mismatch: ${cranksetSpeed}-speed crankset with ${cassetteSpeed}-speed cassette`);
      }
    }
    
    return warnings.length > 0 ? `Warnings: ${warnings.join(', ')}` : 'Compatible';
  }

  extractSpeedCount(speedString) {
    if (!speedString) return 0;
    const match = speedString.match(/(\d+)-speed/);
    return match ? parseInt(match[1]) : 0;
  }

  generateTerrainAnalysis(analysisResults, bikeType) {
    const { proposed } = analysisResults;
    if (!proposed?.metrics) return '';
    
    const lowRatio = parseFloat(proposed.metrics.lowRatio);
    const highRatio = parseFloat(proposed.metrics.highRatio);
    
    let analysis = '\nTERRAIN SUITABILITY:\n';
    
    // Climbing analysis
    if (lowRatio < 1.5) {
      analysis += '- Excellent for steep mountain climbs (15%+ grades)\n';
    } else if (lowRatio < 2.0) {
      analysis += '- Good for moderate to steep climbs (8-15% grades)\n';
    } else if (lowRatio < 2.5) {
      analysis += '- Suitable for rolling hills and moderate climbs (5-10% grades)\n';
    } else {
      analysis += '- Best for flat to rolling terrain (0-5% grades)\n';
    }
    
    // Speed analysis
    if (highRatio > 4.5) {
      analysis += '- High top speed capability for racing/fast group rides\n';
    } else if (highRatio > 3.5) {
      analysis += '- Good top speed for recreational riding and touring\n';
    } else {
      analysis += '- Moderate top speed, prioritizes climbing over speed\n';
    }
    
    // Bike type specific insights
    if (bikeType === 'gravel') {
      analysis += '- Setup optimized for mixed terrain and adventure riding\n';
    } else if (bikeType === 'mtb') {
      analysis += '- Configuration suited for technical trail riding\n';
    } else if (bikeType === 'road') {
      analysis += '- Road-focused setup for pavement efficiency\n';
    }
    
    return analysis;
  }

  processResponseForMobile(response) {
    // Add mobile-friendly affiliate buttons
    const buttonsHtml = `
      <div class="flex flex-col gap-3 mt-4 p-4 rounded-lg" style="background: var(--surface-elevated); border: 1px solid var(--border-subtle);">
        <div class="text-sm font-medium" style="color: var(--text-secondary);">Shop Components:</div>
        <div class="grid grid-cols-1 gap-2">
          <a href="https://www.jensonusa.com/?utm_source=cranksmith&utm_medium=riley_chat" 
             target="_blank"
             class="px-4 py-3 rounded-lg font-medium transition-all text-sm flex items-center justify-center gap-2"
             style="background: var(--accent-blue); color: white;">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m-9 9a9 9 0 019-9"/>
            </svg>
            Jenson USA
          </a>
          <a href="https://www.competitivecyclist.com/?utm_source=cranksmith&utm_medium=riley_chat" 
             target="_blank"
             class="px-4 py-3 rounded-lg font-medium transition-all text-sm flex items-center justify-center gap-2"
             style="background: var(--surface-elevated); color: var(--text-primary); border: 1px solid var(--border-subtle);">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m-9 9a9 9 0 019-9"/>
            </svg>
            Competitive Cyclist
          </a>
        </div>
      </div>
    `;

    return response + buttonsHtml;
  }

  clearHistory() {
    this.conversationHistory = [];
  }

  // Enhanced quick questions based on context
  getContextualQuestions(userSetup = null, analysisResults = null, bikeType = null) {
    const baseQuestions = [
      "What's the best upgrade for climbing performance?",
      "Is my current setup compatible?", 
      "How do I reduce chain drop issues?",
      "What's the most cost-effective upgrade?",
      "Should I upgrade cassette or crankset first?",
    ];

    const contextQuestions = [];

    if (bikeType === 'gravel') {
      contextQuestions.push(
        "What tire width should I run for gravel?",
        "1x vs 2x for gravel adventures?",
        "Best components for bikepacking?"
      );
    } else if (bikeType === 'mtb') {
      contextQuestions.push(
        "What's the ideal gear range for trail riding?",
        "Should I go with a larger cassette?",
        "How low should my climbing gear be?"
      );
    } else if (bikeType === 'road') {
      contextQuestions.push(
        "What gear ratios for hill climbs?",
        "Compact vs standard crankset?",
        "Best setup for long rides?"
      );
    }

    if (analysisResults?.comparison?.weightChange > 50) {
      contextQuestions.push("Is this weight increase worth it?");
    }

    if (analysisResults?.comparison?.speedChange > 2) {
      contextQuestions.push("Will I notice this speed difference?");
    }

    return [...baseQuestions, ...contextQuestions].slice(0, 8); // Limit for mobile
  }
}

// Enhanced React Component with better mobile UX
import { useState, useRef, useEffect } from 'react';

export function RileyChat({ userSetup, analysisResults, componentDatabase, bikeType }) {
  const [messages, setMessages] = useState([
    {
      type: 'riley',
      content: getWelcomeMessage(userSetup, analysisResults, bikeType),
      timestamp: new Date().toISOString()
    }
  ]);
  const [currentMessage, setCurrentMessage] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [riley] = useState(new RileyAI(process.env.NEXT_PUBLIC_ANTHROPIC_API_KEY, componentDatabase));
  const quickQuestionTimeout = useRef(null);

  // Generate contextual welcome message
  function getWelcomeMessage(setup, results, type) {
    if (results) {
      const speedChange = results.comparison?.speedChange || 0;
      const weightChange = results.comparison?.weightChange || 0;
      
      if (speedChange > 1) {
        return `Hey! I see you're looking at a setup that could give you ${speedChange.toFixed(1)} mph more top speed. That's a solid improvement! What would you like to know about this configuration?`;
      } else if (weightChange < -100) {
        return `Nice! This setup saves you ${Math.abs(weightChange)}g. Every gram counts, especially on climbs. What questions do you have about these components?`;
      } else {
        return `I've analyzed your ${type || ''} bike setup. The gear ratios look interesting! What specific aspects would you like me to explain or optimize?`;
      }
    } else if (setup?.crankset || setup?.cassette) {
      return `I can see you're working on a ${type || ''} bike setup. Need help with compatibility, performance, or choosing the right components?`;
    }
    
    return "Hey there! I'm Riley, your bike tech expert. I can help with component compatibility, gear ratios, upgrade recommendations, or any cycling tech questions. What's on your mind?";
  }

  const sendMessage = async () => {
    if (!currentMessage.trim() || isLoading) return;

    const userMessage = {
      type: 'user',
      content: currentMessage,
      timestamp: new Date().toISOString()
    };

    setMessages(prev => [...prev, userMessage]);
    setCurrentMessage('');
    setIsLoading(true);

    const response = await riley.askRiley(currentMessage, userSetup, analysisResults, bikeType);

    const rileyMessage = {
      type: 'riley',
      content: response.success ? response.response : response.error,
      timestamp: response.timestamp
    };

    setMessages(prev => [...prev, rileyMessage]);
    setIsLoading(false);
  };

  const handleQuickQuestion = (question) => {
    setCurrentMessage(question);
    // Auto-send after brief delay with cleanup
    if (quickQuestionTimeout.current) {
      clearTimeout(quickQuestionTimeout.current);
    }
    quickQuestionTimeout.current = setTimeout(() => {
      sendMessage();
    }, 100);
  };

  // Cleanup timeout on unmount
  useEffect(() => {
    return () => {
      if (quickQuestionTimeout.current) {
        clearTimeout(quickQuestionTimeout.current);
      }
    };
  }, []);

  const quickQuestions = riley.getContextualQuestions(userSetup, analysisResults, bikeType);

  return (
    <div className="card max-w-4xl mx-auto">
      {/* Mobile-optimized header */}
      <div className="flex items-center gap-3 mb-6 pb-4" style={{ borderBottom: '1px solid var(--border-subtle)' }}>
        <div className="w-10 h-10 rounded-full flex items-center justify-center text-xl"
             style={{ background: 'linear-gradient(135deg, var(--accent-blue) 0%, #5856d6 100%)' }}>
          üîß
        </div>
        <div className="flex-1">
          <h3 className="text-lg font-semibold" style={{ color: 'var(--text-primary)' }}>
            Ask Riley
          </h3>
          <p className="text-sm" style={{ color: 'var(--text-tertiary)' }}>
            {analysisResults ? 'Analyzing your gear setup' : 'Your bike tech expert'}
          </p>
        </div>
        {analysisResults && (
          <div className="text-xs px-2 py-1 rounded" style={{ background: 'var(--accent-blue)', color: 'white' }}>
            Analysis Ready
          </div>
        )}
      </div>

      {/* Contextual quick questions */}
      <div className="mb-6">
        <p className="text-sm mb-3" style={{ color: 'var(--text-secondary)' }}>Quick questions:</p>
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
          {quickQuestions.map((question, index) => (
            <button
              key={index}
              onClick={() => handleQuickQuestion(question)}
              className="px-3 py-2 text-sm text-left rounded-lg transition-colors"
              style={{ 
                background: 'var(--surface-elevated)',
                color: 'var(--text-tertiary)',
                border: '1px solid var(--border-subtle)'
              }}
              onMouseEnter={(e) => {
                e.target.style.background = 'var(--accent-blue)';
                e.target.style.color = 'white';
              }}
              onMouseLeave={(e) => {
                e.target.style.background = 'var(--surface-elevated)';
                e.target.style.color = 'var(--text-tertiary)';
              }}
            >
              {question}
            </button>
          ))}
        </div>
      </div>

      {/* Mobile-optimized chat messages */}
      <div className="space-y-4 mb-6 max-h-96 overflow-y-auto">
        {messages.map((message, index) => (
          <div key={index} className={`flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}`}>
            <div className={`max-w-[85%] px-4 py-3 rounded-lg ${
              message.type === 'user' 
                ? 'text-white' 
                : ''
            }`}
            style={{
              background: message.type === 'user' 
                ? 'linear-gradient(135deg, var(--accent-blue) 0%, #5856d6 100%)'
                : 'var(--surface-elevated)',
              border: message.type === 'riley' ? '1px solid var(--border-subtle)' : 'none',
              color: message.type === 'riley' ? 'var(--text-primary)' : 'white'
            }}>
              <div className="text-sm leading-relaxed"
                   dangerouslySetInnerHTML={{ 
                     __html: message.content.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="underline">$1</a>')
                   }} 
              />
            </div>
          </div>
        ))}
        
        {isLoading && (
          <div className="flex justify-start">
            <div className="px-4 py-3 rounded-lg" style={{ background: 'var(--surface-elevated)' }}>
              <div className="flex items-center gap-2" style={{ color: 'var(--text-tertiary)' }}>
                <div className="w-2 h-2 rounded-full bg-current animate-pulse"></div>
                <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0.2s' }}></div>
                <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0.4s' }}></div>
                <span className="text-sm ml-2">Riley is thinking...</span>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Mobile-optimized input */}
      <div className="flex gap-3">
        <input
          type="text"
          value={currentMessage}
          onChange={(e) => setCurrentMessage(e.target.value)}
          onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
          placeholder="Ask about compatibility, performance, upgrades..."
          className="input-field flex-1 text-base"
          style={{ fontSize: '16px' }} // Prevent zoom on iOS
          disabled={isLoading}
        />
        <button
          onClick={sendMessage}
          disabled={!currentMessage.trim() || isLoading}
          className="btn-primary px-4 py-2 min-w-[60px]"
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
          </svg>
        </button>
      </div>

      {/* Mobile disclaimer */}
      <div className="mt-4 p-3 rounded-lg text-xs" style={{ background: 'var(--surface-elevated)', color: 'var(--text-tertiary)' }}>
        <strong>üí° Disclaimer:</strong> Riley can make mistakes. Always verify important compatibility and safety info.
      </div>
    </div>
  );
}```

### lib/calculateRealPerformance.js
```
// calculateRealPerformance.js - Real calculations using component data
export function calculateRealPerformance(currentSetup, proposedSetup, speedUnit = 'mph') {
  // REMOVED: Debug logging for production performance

  // Calculate current setup metrics
  const currentMetrics = calculateSetupMetrics(currentSetup, speedUnit);
  const proposedMetrics = calculateSetupMetrics(proposedSetup, speedUnit);

  // Calculate comparison
  const comparison = {
    speedChange: proposedMetrics.highSpeed - currentMetrics.highSpeed,
    weightChange: proposedMetrics.totalWeight - currentMetrics.totalWeight,
    rangeChange: proposedMetrics.gearRange - currentMetrics.gearRange,
    speedUnit: speedUnit
  };

  console.log('üìä Results calculated:', {
    current: currentMetrics,
    proposed: proposedMetrics,
    comparison
  });

  return {
    current: {
      metrics: {
        highSpeed: currentMetrics.highSpeed.toFixed(1),
        lowSpeed: currentMetrics.lowSpeed.toFixed(1),
        highRatio: currentMetrics.highRatio.toFixed(2),
        lowRatio: currentMetrics.lowRatio.toFixed(2)
      },
      totalWeight: currentMetrics.totalWeight,
      gearRange: currentMetrics.gearRange.toFixed(0),
      setup: currentSetup
    },
    proposed: {
      metrics: {
        highSpeed: proposedMetrics.highSpeed.toFixed(1),
        lowSpeed: proposedMetrics.lowSpeed.toFixed(1),
        highRatio: proposedMetrics.highRatio.toFixed(2),
        lowRatio: proposedMetrics.lowRatio.toFixed(2)
      },
      totalWeight: proposedMetrics.totalWeight,
      gearRange: proposedMetrics.gearRange.toFixed(0),
      setup: proposedSetup
    },
    comparison
  };
}

function calculateSetupMetrics(setup, speedUnit) {
  // Get component data
  const crankset = setup.crankset;
  const cassette = setup.cassette;
  const wheelSize = setup.wheel;
  const tireWidth = setup.tire;

  if (!crankset || !cassette || !wheelSize) {
    throw new Error('Missing required components for calculation');
  }

  // Calculate gear ratios
  const chainringTeeth = crankset.teeth || [];
  const cassetteRange = cassette.teeth || [11, 28]; // fallback

  // High gear = largest chainring / smallest cassette cog
  const highRatio = Math.max(...chainringTeeth) / Math.min(...cassetteRange);
  
  // Low gear = smallest chainring / largest cassette cog  
  const lowRatio = Math.min(...chainringTeeth) / Math.max(...cassetteRange);

  // Calculate wheel circumference (in meters)
  const wheelCircumference = getWheelCircumference(wheelSize, tireWidth);

  // Calculate speeds at 90 RPM
  const cadence = 90; // RPM
  const highSpeed = calculateSpeed(highRatio, cadence, wheelCircumference, speedUnit);
  const lowSpeed = calculateSpeed(lowRatio, cadence, wheelCircumference, speedUnit);

  // Calculate total weight
  const totalWeight = (crankset.weight || 0) + (cassette.weight || 0);

  // Calculate gear range percentage
  const gearRange = ((highRatio / lowRatio) - 1) * 100;

  return {
    highSpeed,
    lowSpeed,
    highRatio,
    lowRatio,
    totalWeight,
    gearRange
  };
}

function getWheelCircumference(wheelSize, tireWidth) {
  // Wheel diameter in mm, then add tire width to get total diameter
  const wheelDiameters = {
    '700c': 622,      // ISO 622mm
    '650b': 584,      // ISO 584mm  
    '29-inch': 622,   // Same as 700c
    '27.5-inch': 584, // Same as 650b
    '26-inch': 559    // ISO 559mm
  };

  const wheelDiameter = wheelDiameters[wheelSize] || 622; // Default to 700c
  const tireWidthNum = parseFloat(tireWidth) || 25; // Default to 25mm
  
  // Total diameter = wheel + (2 √ó tire width)
  const totalDiameter = wheelDiameter + (2 * tireWidthNum);
  
  // Circumference in meters
  return (totalDiameter * Math.PI) / 1000;
}

function calculateSpeed(gearRatio, cadenceRPM, wheelCircumference, speedUnit) {
  // Distance per revolution = gear ratio √ó wheel circumference
  const distancePerRev = gearRatio * wheelCircumference; // meters
  
  // Distance per minute = distance per rev √ó cadence
  const distancePerMinute = distancePerRev * cadenceRPM; // meters/minute
  
  // Convert to speed
  const speedMS = distancePerMinute / 60; // meters/second
  
  if (speedUnit.toLowerCase() === 'mph') {
    return speedMS * 2.237; // Convert to mph
  } else {
    return speedMS * 3.6; // Convert to km/h
  }
}

// Helper function to validate setup completeness
export function validateSetupComplete(setup) {
  const required = ['wheel', 'tire', 'crankset', 'cassette'];
  const missing = required.filter(field => {
    const value = setup[field];
    if (field === 'crankset' || field === 'cassette') {
      return !value || typeof value !== 'object' || !value.teeth;
    }
    return !value || (typeof value === 'string' && value.trim() === '');
  });

  const completion = ((required.length - missing.length) / required.length) * 100;

  return {
    isComplete: missing.length === 0,
    missing,
    completion
  };
} ```

### lib/compatibilityChecker.js
```
// lib/compatibilityChecker.js - Enhanced compatibility checking with detailed explanations
// UPDATED: Added comprehensive derailleur capacity, chain line, and speed compatibility checks

export class CompatibilityChecker {
    constructor() {
      // Define derailleur capacity limits by bike type
      this.derailleurLimits = {
        road: {
          shortCage: { maxCapacity: 29, maxCog: 32 },
          mediumCage: { maxCapacity: 35, maxCog: 36 },
          longCage: { maxCapacity: 41, maxCog: 42 }
        },
        gravel: {
          mediumCage: { maxCapacity: 35, maxCog: 42 },
          longCage: { maxCapacity: 41, maxCog: 50 }
        },
        mtb: {
          mediumCage: { maxCapacity: 35, maxCog: 46 },
          longCage: { maxCapacity: 41, maxCog: 52 },
          extraLongCage: { maxCapacity: 47, maxCog: 52 }
        }
      };
  
      // Chain line compatibility ranges (mm from center)
      this.chainLineStandards = {
        'road': { ideal: 43.5, tolerance: 2.5 },
        'gravel': { ideal: 45, tolerance: 3 },
        'mtb': { ideal: 52, tolerance: 4 }
      };
    }
  
    /**
     * Comprehensive compatibility check
     * @param {Object} setup - Complete bike setup
     * @param {string} bikeType - road, gravel, or mtb
     * @returns {Object} Detailed compatibility analysis
     */
    checkCompatibility(setup, bikeType) {
      const results = {
        status: 'compatible',
        criticalIssues: [],
        minorWarnings: [],
        actionItems: [],
        checks: {
          derailleurCapacity: true,
          chainLength: true,
          speedCompatibility: true,
          chainLine: true
        }
      };
  
      if (!setup.crankset || !setup.cassette) {
        return results;
      }
  
      // Check derailleur capacity (bike-type specific)
      this.checkDerailleurCapacity(setup, bikeType, results);
      
      // Check chain length requirements
      this.checkChainLength(setup, results);
      
      // Check speed compatibility
      this.checkSpeedCompatibility(setup, results);
      
      // Check chain line issues
      this.checkChainLine(setup, bikeType, results);
  
      // Determine overall status
      if (results.criticalIssues.length > 0) {
        results.status = 'error';
      } else if (results.minorWarnings.length > 0) {
        results.status = 'warning';
      }
  
      return results;
    }
  
    /**
     * Check derailleur capacity requirements
     */
    checkDerailleurCapacity(setup, bikeType, results) {
      const { crankset, cassette } = setup;
      
      if (!crankset.teeth || !cassette.teeth) return;
  
      const maxChainring = Math.max(...crankset.teeth);
      const minChainring = Math.min(...crankset.teeth);
      const maxCog = Math.max(...cassette.teeth);
      const minCog = Math.min(...cassette.teeth);
      
      const totalCapacity = (maxChainring - minChainring) + (maxCog - minCog);
      const limits = this.derailleurLimits[bikeType];
  
      // Check against bike-type appropriate limits
      let recommendedCage = null;
      let isCompatible = false;
  
      Object.entries(limits).forEach(([cageType, limit]) => {
        if (totalCapacity <= limit.maxCapacity && maxCog <= limit.maxCog) {
          if (!recommendedCage) recommendedCage = cageType;
          isCompatible = true;
        }
      });
  
      if (!isCompatible) {
        results.criticalIssues.push(`Total capacity (${totalCapacity}T) exceeds ${bikeType} derailleur limits`);
        results.actionItems.push(`Consider smaller cassette range or different crankset for ${bikeType} setup`);
        results.checks.derailleurCapacity = false;
      } else if (recommendedCage === 'longCage' || recommendedCage === 'extraLongCage') {
        results.minorWarnings.push(`${recommendedCage.replace('Cage', '-cage')} derailleur recommended for this range`);
      }
  
      // Large cassette warnings (bike-type specific)
      if (bikeType === 'road' && maxCog > 36) {
        results.minorWarnings.push('Large cassette may require GRX or MTB derailleur for road bikes');
      } else if (bikeType === 'gravel' && maxCog > 50) {
        results.minorWarnings.push('Very large cassette - ensure derailleur can handle range');
      }
    }
  
    /**
     * Check speed compatibility between components
     */
    checkSpeedCompatibility(setup, results) {
      const { crankset, cassette } = setup;
      
      if (!crankset.speeds || !cassette.speeds) return;
  
      const cranksetSpeed = this.extractSpeedCount(crankset.speeds);
      const cassetteSpeed = this.extractSpeedCount(cassette.speeds);
  
      if (cranksetSpeed === 0 || cassetteSpeed === 0) {
        results.minorWarnings.push('Speed compatibility cannot be determined - missing speed information');
        results.actionItems.push('Verify component speeds match (e.g., both 11-speed)');
        return;
      }
  
      if (cranksetSpeed !== cassetteSpeed) {
        results.criticalIssues.push(`Speed mismatch: ${cranksetSpeed}-speed crankset with ${cassetteSpeed}-speed cassette`);
        results.actionItems.push(`Use matching ${cassetteSpeed}-speed crankset or ${cranksetSpeed}-speed cassette`);
        
        // Suggest specific compatibility solutions
        if (Math.abs(cranksetSpeed - cassetteSpeed) === 1) {
          results.actionItems.push('Components may work with chain and derailleur adjustments (not recommended for optimal performance)');
        }
      } else {
        results.actionItems.push(`${cranksetSpeed}-speed components are perfectly matched`);
      }
  
      // Check for outdated speeds
      if (cranksetSpeed < 10 && cassetteSpeed < 10) {
        results.minorWarnings.push('Older drivetrain technology - consider 11-12 speed upgrade');
        results.actionItems.push('Modern 11-12 speed drivetrains offer better performance and availability');
      }
    }
  
    /**
     * Analyze chain line compatibility
     */
    checkChainLine(setup, bikeType, results) {
      const { crankset, cassette } = setup;
      
      if (!crankset.teeth || !cassette.teeth) return;
  
      const standard = this.chainLineStandards[bikeType] || this.chainLineStandards['road'];
      
      // Analyze gear combinations for potential chain line issues
      if (crankset.teeth.length > 1) {
        const smallRing = Math.min(...crankset.teeth);
        const bigRing = Math.max(...crankset.teeth);
        const smallCog = Math.min(...cassette.teeth);
        const bigCog = Math.max(...cassette.teeth);
        
        // Big ring to big cog (avoid)
        const extremeRatio1 = bigRing / bigCog;
        // Small ring to small cog (avoid)
        const extremeRatio2 = smallRing / smallCog;
        
        if (extremeRatio1 < 1.5 || extremeRatio2 > 3.5) {
          results.minorWarnings.push('Some gear combinations may cause poor chain line');
          results.actionItems.push('Avoid big ring + big cassette and small ring + small cassette combinations');
        }
      }
      
      // 1x specific analysis
      if (crankset.teeth.length === 1) {
        const chainring = crankset.teeth[0];
        const cassetteRange = Math.max(...cassette.teeth) / Math.min(...cassette.teeth);
        
        if (cassetteRange > 5) {
          results.minorWarnings.push('Wide range cassette with 1x may have chain line issues at extremes');
          results.actionItems.push('Consider narrow-wide chainring and clutch derailleur for chain retention');
        }
        
        results.actionItems.push('1x drivetrain offers excellent chain line in middle gears');
      }
    }
  
    /**
     * Analyze gear ratios for practical usage
     */
    analyzeGearRatios(setup, bikeType) {
      const result = {
        warnings: [],
        recommendations: [],
        analysis: {}
      };
  
      if (!setup.crankset?.teeth || !setup.cassette?.teeth) {
        return result;
      }
  
      const crankTeeth = setup.crankset.teeth;
      const cassetteTeeth = setup.cassette.teeth;
      
      // Calculate gear ratios
      const allRatios = [];
      crankTeeth.forEach(chainring => {
        cassetteTeeth.forEach(cog => {
          allRatios.push(chainring / cog);
        });
      });
      
      const minRatio = Math.min(...allRatios);
      const maxRatio = Math.max(...allRatios);
      const ratioSpread = maxRatio / minRatio;
      
      result.analysis = {
        minRatio: minRatio.toFixed(2),
        maxRatio: maxRatio.toFixed(2),
        ratioSpread: ratioSpread.toFixed(1),
        totalGears: allRatios.length
      };
  
      // Analyze based on bike type
      const recommendations = this.getBikeTypeRecommendations(bikeType, minRatio, maxRatio, ratioSpread);
      result.warnings.push(...recommendations.warnings);
      result.recommendations.push(...recommendations.suggestions);
  
      // Check for gear overlaps in 2x systems
      if (crankTeeth.length === 2) {
        const gearOverlap = this.analyzeGearOverlap(crankTeeth, cassetteTeeth);
        if (gearOverlap.percentage > 30) {
          result.warnings.push(`${gearOverlap.percentage}% gear overlap between chainrings`);
          result.recommendations.push('Consider 1x drivetrain for simpler shifting');
        }
      }
  
      return result;
    }
  
    /**
     * Get bike type specific recommendations
     */
    getBikeTypeRecommendations(bikeType, minRatio, maxRatio, ratioSpread) {
      const warnings = [];
      const suggestions = [];
  
      switch (bikeType) {
        case 'road':
          if (minRatio > 1.5) {
            warnings.push('May struggle on steep climbs (consider lower gearing)');
            suggestions.push('Add larger cassette or compact crankset for better climbing');
          }
          if (maxRatio < 3.5) {
            warnings.push('Limited top speed potential');
            suggestions.push('Consider larger chainrings for higher top speed');
          }
          if (ratioSpread > 4.5) {
            suggestions.push('Excellent gear range for varied terrain');
          }
          break;
  
        case 'gravel':
          if (minRatio > 1.2) {
            warnings.push('May need easier gears for loose/steep gravel climbs');
            suggestions.push('Consider wider range cassette (11-42T or larger)');
          }
          if (ratioSpread < 3.5) {
            warnings.push('Limited gear range for adventure riding');
            suggestions.push('Gravel benefits from wide gear range for varied terrain');
          }
          suggestions.push('Setup well-suited for mixed terrain adventure riding');
          break;
  
        case 'mtb':
          if (minRatio > 1.0) {
            warnings.push('May need easier gears for technical climbs');
            suggestions.push('Consider larger cassette (10-50T+) for steep technical terrain');
          }
          if (maxRatio > 3.0) {
            suggestions.push('Good top-end for XC racing and fire roads');
          }
          suggestions.push('Mountain bike gearing optimized for trail efficiency');
          break;
      }
  
      return { warnings, suggestions };
    }
  
    /**
     * Analyze gear overlap in 2x systems
     */
    analyzeGearOverlap(crankTeeth, cassetteTeeth) {
      if (crankTeeth.length !== 2) return { percentage: 0, overlaps: [] };
  
      const [smallRing, bigRing] = crankTeeth.sort((a, b) => a - b);
      const overlaps = [];
      let overlapCount = 0;
  
      cassetteTeeth.forEach(cog => {
        const smallRingRatio = smallRing / cog;
        const bigRingRatio = bigRing / cog;
        
        // Check if this cog creates overlapping ratios
        cassetteTeeth.forEach(otherCog => {
          if (cog === otherCog) return;
          
          const otherSmallRatio = smallRing / otherCog;
          const otherBigRatio = bigRing / otherCog;
          
          if (Math.abs(smallRingRatio - otherBigRatio) < 0.1) {
            overlaps.push(`${smallRing}√ó${cog} ‚âà ${bigRing}√ó${otherCog}`);
            overlapCount++;
          }
        });
      });
  
      const totalCombinations = cassetteTeeth.length * 2;
      const percentage = Math.round((overlapCount / totalCombinations) * 100);
  
      return { percentage, overlaps };
    }
  
    /**
     * Assess installation complexity
     */
    assessInstallationComplexity(setup) {
      const result = {
        complexity: 'moderate',
        recommendations: [],
        requiredTools: [],
        estimatedTime: '1-2 hours'
      };
  
      const complexityFactors = [];
  
      // Check for electronic components
      if (setup.crankset?.speeds?.includes('Di2') || setup.cassette?.speeds?.includes('Di2')) {
        complexityFactors.push('electronic');
        result.recommendations.push('Electronic shifting requires cable routing and battery setup');
        result.requiredTools.push('Di2 specific tools and software');
      }
  
      // Check for bottom bracket compatibility
      if (setup.crankset?.model?.includes('BB30') || setup.crankset?.model?.includes('PF30')) {
        complexityFactors.push('press-fit-bb');
        result.recommendations.push('Press-fit bottom bracket may require professional installation');
        result.requiredTools.push('Bottom bracket press/removal tools');
      }
  
      // Check for cassette type
      if (setup.cassette?.model?.includes('XDR') || setup.cassette?.model?.includes('XD')) {
        complexityFactors.push('xd-driver');
        result.recommendations.push('XD/XDR cassette requires compatible freehub body');
        result.requiredTools.push('XD cassette tool');
      }
  
      // Determine overall complexity
      if (complexityFactors.length === 0) {
        result.complexity = 'basic';
        result.estimatedTime = '30-60 minutes';
        result.recommendations.push('Standard installation - suitable for home mechanics');
        result.requiredTools.push('Basic bike tools', 'Chain whip', 'Cassette tool');
      } else if (complexityFactors.length <= 2) {
        result.complexity = 'moderate';
        result.estimatedTime = '1-2 hours';
        result.recommendations.push('Moderate complexity - some special tools required');
      } else {
        result.complexity = 'advanced';
        result.estimatedTime = '2-3 hours';
        result.recommendations.push('Complex installation - consider professional help');
      }
  
      // Always recommend professional help for safety-critical items
      result.recommendations.push('Professional installation recommended for optimal performance and safety');
  
      return result;
    }
  
    /**
     * Extract speed count from speed string
     */
    extractSpeedCount(speedString) {
      if (!speedString) return 0;
      const match = speedString.match(/(\d+)-speed/);
      return match ? parseInt(match[1]) : 0;
    }
  
    /**
     * Generate compatibility summary for UI display
     */
    generateCompatibilitySummary(compatibilityResults) {
      // Support both new and old result shapes for safety
      const status = compatibilityResults.status || compatibilityResults.overall || 'compatible';
      const criticalIssues = compatibilityResults.criticalIssues || compatibilityResults.issues || [];
      const minorWarnings = compatibilityResults.minorWarnings || compatibilityResults.warnings || [];
      const actionItems = compatibilityResults.actionItems || compatibilityResults.recommendations || [];

      const summary = {
        status,
        title: this.getStatusTitle(status),
        message: this.getStatusMessage(status, criticalIssues, minorWarnings),
        actionItems: actionItems.slice(0, 3), // Top 3 recommendations
        criticalIssues,
        minorWarnings
      };

      return summary;
    }
  
    getStatusTitle(status) {
      switch (status) {
        case 'compatible': return '‚úÖ Components Compatible';
        case 'warning': return '‚ö†Ô∏è Compatible with Considerations';
        case 'error': return '‚ùå Compatibility Issues';
        case 'incomplete': return 'üìù Incomplete Setup';
        default: return 'Unknown Status';
      }
    }
  
    getStatusMessage(status, issues, warnings) {
      switch (status) {
        case 'compatible':
          return 'All components work together perfectly. Ready to ride!';
        case 'warning':
          return `Components are compatible but consider ${warnings.length} optimization${warnings.length > 1 ? 's' : ''}.`;
        case 'error':
          return `${issues.length} critical issue${issues.length > 1 ? 's' : ''} prevent${issues.length === 1 ? 's' : ''} this combination from working.`;
        case 'incomplete':
          return 'Add all components to check compatibility.';
        default:
          return 'Compatibility status unknown.';
      }
    }
  
    checkChainLength(setup, results) {
      const { crankset, cassette } = setup;
      
      if (!crankset.teeth || !cassette.teeth) return;

      const maxChainring = Math.max(...crankset.teeth);
      const maxCog = Math.max(...cassette.teeth);
      
      // Only warn about chain length for extreme combinations
      if (crankset.teeth.length > 1 && maxCog > 46) {
        results.minorWarnings.push('Wide range setup may require longer chain');
        results.actionItems.push('Check chain length when installing');
      }
    }
  }```

### hooks/useCalculatorState.js
```
import { useState, useCallback, useMemo } from 'react';
import { calculateRealPerformance, validateSetupComplete } from '../lib/calculateRealPerformance';
import { toast } from '../components/Toast';

const initialSetup = {
  wheel: '',
  tire: '',
  crankset: null,
  cassette: null
};

export const useCalculatorState = () => {
  const [bikeType, setBikeType] = useState('');
  const [currentSetup, setCurrentSetup] = useState(initialSetup);
  const [proposedSetup, setProposedSetup] = useState(initialSetup);
  const [results, setResults] = useState(null);
  const [loading, setLoading] = useState(false);
  const [speedUnit, setSpeedUnit] = useState('mph');
  const [compatibilityResults, setCompatibilityResults] = useState(null);

  // Memoized validation
  const validation = useMemo(() => {
    const currentValidation = validateSetupComplete(currentSetup);
    const proposedValidation = validateSetupComplete(proposedSetup);
    
    const totalCompletion = (currentValidation.completion + proposedValidation.completion) / 2;
    
    return {
      current: currentValidation,
      proposed: proposedValidation,
      canAnalyze: currentValidation.isComplete && proposedValidation.isComplete,
      totalCompletion: isNaN(totalCompletion) ? 0 : totalCompletion
    };
  }, [currentSetup, proposedSetup]);

  // Optimized setup update functions
  const updateCurrentSetup = useCallback((updates) => {
    setCurrentSetup(prev => ({ ...prev, ...updates }));
  }, []);

  const updateProposedSetup = useCallback((updates) => {
    setProposedSetup(prev => ({ ...prev, ...updates }));
  }, []);

  // Reset function
  const resetCalculator = useCallback(() => {
    setBikeType('');
    setCurrentSetup(initialSetup);
    setProposedSetup(initialSetup);
    setResults(null);
    setCompatibilityResults(null);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }, []);

  // Calculate function with race condition prevention
  const calculateResults = useCallback(async () => {
    if (!validation.canAnalyze) {
      toast.warning('Please complete both setups before analyzing');
      return;
    }

    // Prevent concurrent calculations
    if (loading) {
      console.log('Calculation already in progress, skipping...');
      return;
    }

    setLoading(true);
    try {
      // Simulate API delay
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      const realResults = calculateRealPerformance(currentSetup, proposedSetup, speedUnit);
      setResults(realResults);
      toast.success('Analysis complete! Check your results below.');
      
      return realResults;
    } catch (error) {
      console.error('Error calculating results:', error);
      toast.error('Error calculating results. Please check your component selections and try again.');
      throw error;
    } finally {
      setLoading(false);
    }
  }, [currentSetup, proposedSetup, speedUnit, validation.canAnalyze, loading]);

  return {
    // State
    bikeType,
    currentSetup,
    proposedSetup,
    results,
    loading,
    speedUnit,
    compatibilityResults,
    validation,
    
    // Actions
    setBikeType,
    updateCurrentSetup,
    updateProposedSetup,
    setResults,
    setSpeedUnit,
    setCompatibilityResults,
    resetCalculator,
    calculateResults
  };
}; ```

### hooks/useComponentDatabase.js
```
import { useState, useEffect, useMemo } from 'react';
import { getComponentsForBikeType } from '../lib/components';

export const useComponentDatabase = (bikeType) => {
  const [components, setComponents] = useState({ cranksets: [], cassettes: [] });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  useEffect(() => {
    if (!bikeType) {
      setComponents({ cranksets: [], cassettes: [] });
      return;
    }

    const loadComponents = async () => {
      setLoading(true);
      setError(null);
      
      try {
        
        // Direct function call instead of dynamic import
        const loadedComponents = getComponentsForBikeType(bikeType);
        
        
        // Validate that we got components
        if (!loadedComponents.cranksets || !loadedComponents.cassettes) {
          throw new Error(`Invalid component data structure for bikeType: ${bikeType}`);
        }
        
        if (loadedComponents.cranksets.length === 0 && loadedComponents.cassettes.length === 0) {
          
        }
        
        setComponents(loadedComponents);
      } catch (err) {
        // Keep error logging for debugging purposes but only in development
        if (process.env.NODE_ENV === 'development') {
          console.error('üö® useComponentDatabase error:', err);
        }
        setError(err.message);
        setComponents({ cranksets: [], cassettes: [] });
      } finally {
        setLoading(false);
      }
    };

    loadComponents();
  }, [bikeType]);

  // Memoize the final result to prevent unnecessary re-renders
  const memoizedComponents = useMemo(() => ({
    ...components,
    loading,
    error
  }), [components, loading, error]);

  return memoizedComponents;
}; ```

### hooks/useFormValidation.js
```
// hooks/useFormValidation.js - React hook for form validation
import { useState, useCallback, useMemo } from 'react';
import { validateEmail, validateNumeric, validateBikeType, validateSetup } from '../lib/validation';

export const useFormValidation = (initialValues = {}) => {
  const [values, setValues] = useState(initialValues);
  const [errors, setErrors] = useState({});
  const [touched, setTouched] = useState({});

  // Update a single field value
  const setValue = useCallback((field, value) => {
    setValues(prev => ({ ...prev, [field]: value }));
    
    // Clear error when user starts typing
    if (errors[field]) {
      setErrors(prev => ({ ...prev, [field]: null }));
    }
  }, [errors]);

  // Mark a field as touched (for showing validation errors)
  const setTouched = useCallback((field) => {
    setTouched(prev => ({ ...prev, [field]: true }));
  }, []);

  // Validate a specific field
  const validateField = useCallback((field, value, validationRules) => {
    if (!validationRules) return { isValid: true, errors: [] };

    const { type, required, min, max, ...options } = validationRules;

    switch (type) {
      case 'email':
        return validateEmail(value);
      
      case 'number':
        return validateNumeric(value, { required, min, max, ...options, field });
      
      case 'bikeType':
        return validateBikeType(value);
      
      default:
        if (required && (!value || value.toString().trim() === '')) {
          return { isValid: false, errors: [`${field} is required`] };
        }
        return { isValid: true, errors: [] };
    }
  }, []);

  // Validate all fields
  const validateForm = useCallback((validationSchema) => {
    const newErrors = {};
    let isFormValid = true;

    for (const [field, rules] of Object.entries(validationSchema)) {
      const validation = validateField(field, values[field], rules);
      if (!validation.isValid) {
        newErrors[field] = validation.errors[0]; // Take first error
        isFormValid = false;
      }
    }

    setErrors(newErrors);
    return { isValid: isFormValid, errors: newErrors };
  }, [values, validateField]);

  // Handle field blur (mark as touched and validate)
  const handleBlur = useCallback((field, validationRules) => {
    setTouched(prev => ({ ...prev, [field]: true }));
    
    if (validationRules) {
      const validation = validateField(field, values[field], validationRules);
      if (!validation.isValid) {
        setErrors(prev => ({ ...prev, [field]: validation.errors[0] }));
      }
    }
  }, [values, validateField]);

  // Handle field change
  const handleChange = useCallback((field, value, validationRules) => {
    setValue(field, value);
    
    // Real-time validation for touched fields
    if (touched[field] && validationRules) {
      const validation = validateField(field, value, validationRules);
      if (validation.isValid) {
        setErrors(prev => ({ ...prev, [field]: null }));
      }
    }
  }, [setValue, touched, validateField]);

  // Reset form
  const resetForm = useCallback((newInitialValues = {}) => {
    setValues(newInitialValues);
    setErrors({});
    setTouched({});
  }, []);

  // Get field props for easy integration with inputs
  const getFieldProps = useCallback((field, validationRules = null) => ({
    value: values[field] || '',
    onChange: (e) => {
      const value = e.target ? e.target.value : e;
      handleChange(field, value, validationRules);
    },
    onBlur: () => handleBlur(field, validationRules),
    error: touched[field] ? errors[field] : null,
    hasError: Boolean(touched[field] && errors[field])
  }), [values, errors, touched, handleChange, handleBlur]);

  // Check if form has any errors
  const hasErrors = useMemo(() => {
    return Object.values(errors).some(error => error !== null && error !== undefined);
  }, [errors]);

  // Check if form is valid (no errors and required fields are filled)
  const isValid = useMemo(() => {
    return !hasErrors && Object.keys(touched).length > 0;
  }, [hasErrors, touched]);

  return {
    values,
    errors,
    touched,
    hasErrors,
    isValid,
    setValue,
    setTouched,
    validateField,
    validateForm,
    handleBlur,
    handleChange,
    resetForm,
    getFieldProps
  };
};

// Specialized hook for calculator validation
export const useCalculatorValidation = () => {
  const [setupErrors, setSetupErrors] = useState({});

  const validateCalculatorSetup = useCallback((currentSetup, proposedSetup, bikeType) => {
    const errors = {};

    if (!bikeType) {
      errors.bikeType = 'Please select a bike type';
      return { isValid: false, errors };
    }

    // Validate current setup
    const currentValidation = validateSetup(currentSetup, bikeType);
    if (!currentValidation.isValid) {
      errors.currentSetup = currentValidation.errors;
    }

    // Validate proposed setup
    const proposedValidation = validateSetup(proposedSetup, bikeType);
    if (!proposedValidation.isValid) {
      errors.proposedSetup = proposedValidation.errors;
    }

    // Check if setups are complete enough for analysis
    const requiredFields = ['wheel', 'tire', 'crankset', 'cassette'];
    const currentComplete = requiredFields.every(field => currentSetup[field]);
    const proposedComplete = requiredFields.every(field => proposedSetup[field]);

    if (!currentComplete) {
      errors.currentSetup = [...(errors.currentSetup || []), 'Please complete all current setup fields'];
    }

    if (!proposedComplete) {
      errors.proposedSetup = [...(errors.proposedSetup || []), 'Please complete all proposed setup fields'];
    }

    setSetupErrors(errors);
    return { 
      isValid: Object.keys(errors).length === 0, 
      errors,
      canAnalyze: currentComplete && proposedComplete && Object.keys(errors).length === 0
    };
  }, []);

  const clearSetupErrors = useCallback(() => {
    setSetupErrors({});
  }, []);

  return {
    setupErrors,
    validateCalculatorSetup,
    clearSetupErrors
  };
}; ```

### store/calculatorStore.js
```
// store/calculatorStore.js - COMPLETE FILE
import { create } from 'zustand';
import { devtools, persist } from 'zustand/middleware';
import { calculateRealPerformance, validateSetupComplete } from '../lib/calculateRealPerformance';
import { toast } from '../components/Toast';

const initialSetup = {
  wheel: '',
  tire: '',
  crankset: null,
  cassette: null
};

const useCalculatorStore = create(
  devtools(
    persist(
      (set, get) => ({
        // State
        bikeType: '',
        currentSetup: initialSetup,
        proposedSetup: initialSetup,
        results: null,
        loading: false,
        speedUnit: 'mph',
        compatibilityResults: null,
        savedConfigs: [],

        // Actions
        setBikeType: (bikeType) => set({ bikeType }),
        
        updateCurrentSetup: (updates) => set((state) => ({
          currentSetup: { ...state.currentSetup, ...updates }
        })),
        
        updateProposedSetup: (updates) => set((state) => ({
          proposedSetup: { ...state.proposedSetup, ...updates }
        })),
        
        setResults: (results) => set({ results }),
        
        setSpeedUnit: (speedUnit) => {
          set({ speedUnit });
          localStorage.setItem('cranksmith_speed_unit', speedUnit);
        },
        
        setCompatibilityResults: (compatibilityResults) => set({ compatibilityResults }),
        
        resetCalculator: () => set({
          bikeType: '',
          currentSetup: initialSetup,
          proposedSetup: initialSetup,
          results: null,
          compatibilityResults: null
        }),

        // Computed values
        get validation() {
          const state = get();
          const currentValidation = validateSetupComplete(state.currentSetup);
          const proposedValidation = validateSetupComplete(state.proposedSetup);
          
          const totalCompletion = (currentValidation.completion + proposedValidation.completion) / 2;
          
          return {
            current: currentValidation,
            proposed: proposedValidation,
            canAnalyze: currentValidation.isComplete && proposedValidation.isComplete,
            totalCompletion: isNaN(totalCompletion) ? 0 : totalCompletion
          };
        },

        // Async actions with race condition prevention
        calculateResults: async () => {
          const state = get();
          const validation = state.validation;
          
          if (!validation.canAnalyze) {
            toast.warning('Please complete both setups before analyzing');
            return null;
          }

          // Prevent concurrent calculations
          if (state.loading) {
            console.log('Calculation already in progress, skipping...');
            return null;
          }

          set({ loading: true });
          
          try {
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const realResults = calculateRealPerformance(
              state.currentSetup, 
              state.proposedSetup, 
              state.speedUnit
            );
            
            set({ results: realResults });
            toast.success('Analysis complete! Check your results below.');
            return realResults;
          } catch (error) {
            console.error('Error calculating results:', error);
            toast.error('Error calculating results. Please check your component selections and try again.');
            throw error;
          } finally {
            set({ loading: false });
          }
        },

        // Saved configurations
        loadSavedConfigs: () => {
          try {
            const saved = localStorage.getItem('cranksmith_configs');
            if (saved) {
              set({ savedConfigs: JSON.parse(saved) });
            }
          } catch (error) {
            console.error('Error loading saved configs:', error);
          }
        },

        saveConfiguration: (config) => {
          const state = get();
          const newConfig = {
            ...config,
            id: Date.now().toString(),
            created_at: new Date().toISOString()
          };
          
          const updatedConfigs = [...state.savedConfigs, newConfig];
          set({ savedConfigs: updatedConfigs });
          
          try {
            localStorage.setItem('cranksmith_configs', JSON.stringify(updatedConfigs));
            return { success: true };
          } catch (error) {
            console.error('Error saving config:', error);
            return { success: false, error: error.message };
          }
        },

        deleteConfiguration: (id) => {
          const state = get();
          const updatedConfigs = state.savedConfigs.filter(config => config.id !== id);
          set({ savedConfigs: updatedConfigs });
          
          try {
            localStorage.setItem('cranksmith_configs', JSON.stringify(updatedConfigs));
            return { success: true };
          } catch (error) {
            console.error('Error deleting config:', error);
            return { success: false, error: error.message };
          }
        },

        loadConfiguration: (config) => {
          set({
            bikeType: config.bikeType,
            currentSetup: config.currentSetup,
            proposedSetup: config.proposedSetup,
            results: config.results,
            compatibilityResults: config.compatibilityResults
          });
        }
      }),
      {
        name: 'cranksmith-calculator',
        partialize: (state) => ({
          speedUnit: state.speedUnit,
          savedConfigs: state.savedConfigs
        })
      }
    )
  )
);

export default useCalculatorStore;
```

### styles/globals.css
```
@tailwind base;
@tailwind components;
@tailwind utilities;

/* 
==========================================================================
  CRANKSMITH V2 - PREMIUM DESIGN SYSTEM
  Precision-engineered CSS for serious cyclists
==========================================================================
*/

@layer base {
:root {
    /* --- Core Colors --- */
    --white: 255 255 255;
    --black: 0 0 0;
    
    /* --- Neutral Palette (RGB values for opacity support) --- */
    --neutral-50: 250 250 250;
    --neutral-100: 245 245 245;
    --neutral-200: 229 229 229;
    --neutral-300: 212 212 212;
    --neutral-400: 163 163 163;
    --neutral-500: 115 115 115;
    --neutral-600: 82 82 82;
    --neutral-700: 64 64 64;
    --neutral-800: 38 38 38;
    --neutral-900: 23 23 23;
    --neutral-950: 10 10 10;

    /* --- Brand Colors --- */
    --brand-orange: 255 107 53;  /* #FF6B35 - Energy */
    --brand-yellow: 247 147 30;  /* #F7931E - Warning */
    --brand-blue: 0 122 255;     /* #007AFF - Primary */
    --brand-purple: 88 86 214;   /* #5856D6 - Premium */
    --brand-green: 52 199 89;    /* #34C759 - Success */
    --brand-red: 255 59 48;      /* #FF3B30 - Error */

    /* --- Semantic Colors (Light Mode) --- */
    --bg-primary: var(--white);
    --bg-secondary: var(--neutral-50);
    --bg-tertiary: var(--neutral-100);
    --bg-elevated: var(--white);
    --bg-inverse: var(--neutral-950);
    
    --text-primary: var(--neutral-900);
    --text-secondary: var(--neutral-700);     /* Improved from 600 for better contrast */
    --text-tertiary: var(--neutral-600);     /* Improved from 500 for better contrast */
    --text-placeholder: var(--neutral-500);  /* Dedicated placeholder color */
    --text-disabled: var(--neutral-400);     /* Dedicated disabled text color */
    --text-inverse: var(--white);
    
    --border-primary: var(--neutral-200);
    --border-secondary: var(--neutral-300);
    --border-focus: var(--brand-blue);
    
    /* --- Gradients --- */
    --gradient-performance: linear-gradient(135deg, rgb(var(--brand-orange)) 0%, rgb(var(--brand-yellow)) 100%);
    --gradient-premium: linear-gradient(135deg, rgb(var(--brand-blue)) 0%, rgb(var(--brand-purple)) 100%);
    --gradient-success: linear-gradient(135deg, rgb(var(--brand-green)) 0%, rgb(52 199 89 / 0.8) 100%);
    
    /* --- Shadows --- */
    --shadow-xs: 0 1px 2px rgb(0 0 0 / 0.05);
    --shadow-sm: 0 2px 4px rgb(0 0 0 / 0.06);
    --shadow-md: 0 4px 12px rgb(0 0 0 / 0.08);
    --shadow-lg: 0 8px 24px rgb(0 0 0 / 0.12);
    --shadow-xl: 0 16px 48px rgb(0 0 0 / 0.16);
    
    /* --- Spacing Scale --- */
    --space-xs: 0.5rem;   /* 8px */
    --space-sm: 0.75rem;  /* 12px */
    --space-md: 1rem;     /* 16px */
    --space-lg: 1.5rem;   /* 24px */
    --space-xl: 2rem;     /* 32px */
    --space-2xl: 3rem;    /* 48px */
    --space-3xl: 4rem;    /* 64px */
    
    /* --- Typography Scale --- */
    --text-xs: 0.75rem;    /* 12px */
    --text-sm: 0.875rem;   /* 14px */
    --text-base: 1rem;     /* 16px */
    --text-lg: 1.125rem;   /* 18px */
    --text-xl: 1.25rem;    /* 20px */
    --text-2xl: 1.5rem;    /* 24px */
    --text-3xl: 1.875rem;  /* 30px */
    --text-4xl: 2.25rem;   /* 36px */
    --text-5xl: 3rem;      /* 48px */
    --text-6xl: 3.75rem;   /* 60px */
    
    /* --- Animation --- */
    --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
    --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
    --duration-fast: 150ms;
    --duration-base: 250ms;
    --duration-slow: 350ms;

  /* --- Radius --- */
    --radius-sm: 0.375rem;  /* 6px */
    --radius-md: 0.5rem;    /* 8px */
    --radius-lg: 0.75rem;   /* 12px */
    --radius-xl: 1rem;      /* 16px */
    --radius-2xl: 1.5rem;   /* 24px */
    --radius-full: 9999px;
  }

  /* Dark Mode */
  [data-theme="dark"] {
    --bg-primary: var(--neutral-950);
    --bg-secondary: var(--neutral-900);
    --bg-tertiary: var(--neutral-800);
    --bg-elevated: var(--neutral-900);
    --bg-inverse: var(--white);
    
    --text-primary: var(--white);
    --text-secondary: var(--neutral-200);  /* Improved from 300 for better contrast */
    --text-tertiary: var(--neutral-300);   /* Improved from 400 for better contrast */
    --text-placeholder: var(--neutral-400); /* Dedicated placeholder color for dark mode */
    --text-disabled: var(--neutral-500);    /* Dedicated disabled text color for dark mode */
    --text-inverse: var(--neutral-950);
    
    --border-primary: var(--neutral-800);
    --border-secondary: var(--neutral-700);
    
    --shadow-xs: 0 1px 2px rgb(0 0 0 / 0.2);
    --shadow-sm: 0 2px 4px rgb(0 0 0 / 0.3);
    --shadow-md: 0 4px 12px rgb(0 0 0 / 0.4);
    --shadow-lg: 0 8px 24px rgb(0 0 0 / 0.5);
    --shadow-xl: 0 16px 48px rgb(0 0 0 / 0.6);
  }

  /* System Font Stack */
  html {
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    font-feature-settings: "kern" 1, "liga" 1, "calt" 1;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
  }

  /* Smooth Scrolling */
  html {
    scroll-behavior: smooth;
  }

  /* Focus Visible */
  :focus-visible {
    outline: 2px solid rgb(var(--brand-blue));
    outline-offset: 2px;
  }

  /* Selection */
  ::selection {
    background: rgb(var(--brand-blue) / 0.2);
    color: rgb(var(--text-primary));
  }
}

@layer components {
  /* --- Premium Card Component --- */
  .card-premium {
    @apply relative overflow-hidden rounded-2xl;
    background: rgb(var(--bg-elevated));
    border: 1px solid rgb(var(--border-primary));
    box-shadow: var(--shadow-sm);
    transition: all var(--duration-base) var(--ease-out);
  }
  
  .card-premium:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    border-color: rgb(var(--border-secondary));
  }
  
  /* --- Glass Card Component --- */
  .card-glass {
    @apply relative overflow-hidden rounded-2xl;
    background: rgb(var(--bg-elevated) / 0.7);
    backdrop-filter: blur(20px);
    border: 1px solid rgb(var(--border-primary) / 0.5);
    box-shadow: var(--shadow-md);
  }
  
  /* --- Primary Button --- */
  .btn-primary {
    @apply relative inline-flex items-center justify-center px-6 py-3 text-base font-semibold rounded-xl;
    background: var(--gradient-premium);
    color: rgb(var(--white));
    box-shadow: 0 4px 14px rgb(var(--brand-blue) / 0.3);
    transition: all var(--duration-base) var(--ease-out);
    transform-style: preserve-3d;
  }
  
  .btn-primary::before {
    @apply absolute inset-0 rounded-xl;
    content: '';
    background: linear-gradient(to bottom, rgba(255,255,255,0.2), transparent);
    opacity: 0;
    transition: opacity var(--duration-base) var(--ease-out);
  }
  
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgb(var(--brand-blue) / 0.4);
  }
  
  .btn-primary:hover::before {
    opacity: 1;
  }
  
  .btn-primary:active {
    transform: translateY(0);
  }
  
  /* --- Secondary Button --- */
  .btn-secondary {
    @apply relative inline-flex items-center justify-center px-6 py-3 text-base font-semibold rounded-xl;
    background: rgb(var(--bg-secondary));
    color: rgb(var(--text-primary));
    border: 1px solid rgb(var(--border-primary));
    transition: all var(--duration-base) var(--ease-out);
  }
  
  .btn-secondary:hover {
    background: rgb(var(--bg-tertiary));
    border-color: rgb(var(--border-secondary));
    transform: translateY(-1px);
  }
  
  /* --- Input Field --- */
  .input-premium {
    @apply w-full px-4 py-3 text-base rounded-xl;
    background: rgb(var(--bg-elevated));
    border: 1px solid rgb(var(--border-primary));
    color: rgb(var(--text-primary));
    transition: all var(--duration-fast) var(--ease-out);
  }
  
  .input-premium::placeholder {
    color: rgb(var(--text-placeholder));
  }
  
  .input-premium:hover {
    border-color: rgb(var(--border-secondary));
    background: rgb(var(--bg-secondary));
  }
  
  .input-premium:focus {
    outline: none;
    border-color: rgb(var(--brand-blue));
    background: rgb(var(--bg-elevated));
    box-shadow: 0 0 0 3px rgb(var(--brand-blue) / 0.1);
  }
  
  .input-premium:disabled {
    background: rgb(var(--bg-tertiary));
    color: rgb(var(--text-disabled));
    border-color: rgb(var(--border-primary));
    cursor: not-allowed;
  }
  
  /* --- Badge --- */
  .badge {
    @apply inline-flex items-center px-3 py-1 text-xs font-medium rounded-full;
    background: rgb(var(--bg-tertiary));
    color: rgb(var(--text-secondary));
  }
  
  .badge-success {
    background: rgb(var(--brand-green) / 0.1);
    color: rgb(var(--brand-green));
  }
  
  .badge-warning {
    background: rgb(var(--brand-yellow) / 0.1);
    color: rgb(var(--brand-yellow));
  }
  
  .badge-error {
    background: rgb(var(--brand-red) / 0.1);
    color: rgb(var(--brand-red));
  }
  
  /* --- Metric Display --- */
  .metric-display {
    @apply relative overflow-hidden;
  }
  
  .metric-value {
    @apply text-4xl font-bold tracking-tight;
    font-variant-numeric: tabular-nums;
    background: var(--gradient-performance);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .metric-label {
    @apply text-sm font-medium;
    color: rgb(var(--text-tertiary));
    letter-spacing: 0.05em;
  }
  
  /* --- Loading States --- */
  .skeleton {
    @apply relative overflow-hidden;
    background: rgb(var(--bg-tertiary));
  }
  
  .skeleton::after {
    @apply absolute inset-0;
    content: '';
    background: linear-gradient(
      90deg,
      transparent,
      rgb(var(--bg-secondary) / 0.5),
      transparent
    );
    animation: skeleton-wave 2s ease-in-out infinite;
  }
  
  @keyframes skeleton-wave {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }
  
  /* --- Animations --- */
  .fade-in {
    animation: fadeIn var(--duration-slow) var(--ease-out);
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .slide-up {
    animation: slideUp var(--duration-base) var(--ease-out);
  }
  
  @keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* --- Responsive Container --- */
  .container-responsive {
    @apply w-full px-4 mx-auto;
    max-width: 1440px;
  }
  
  @media (min-width: 640px) {
    .container-responsive { @apply px-6; }
  }
  
  @media (min-width: 1024px) {
    .container-responsive { @apply px-8; }
  }
  
  /* --- Grid System --- */
  .grid-responsive {
    @apply grid gap-4;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  }
  
  @media (min-width: 768px) {
    .grid-responsive { @apply gap-6; }
  }
  
  /* --- Performance Optimizations --- */
  .gpu-accelerated {
    transform: translateZ(0);
    will-change: transform;
    backface-visibility: hidden;
  }
  
  .scroll-smooth {
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
  }
}

@layer utilities {
  /* --- Text Gradients --- */
  .text-gradient-performance {
    background: var(--gradient-performance);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .text-gradient-premium {
    background: var(--gradient-premium);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  /* --- Backdrop Filters --- */
  .backdrop-blur-premium {
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
  }
  
  /* --- Custom Shadows --- */
  .shadow-glow-blue {
    box-shadow: 0 0 40px rgb(var(--brand-blue) / 0.3);
  }
  
  .shadow-glow-orange {
    box-shadow: 0 0 40px rgb(var(--brand-orange) / 0.3);
  }
  
  /* --- Hover Effects --- */
  .hover-lift {
    transition: transform var(--duration-base) var(--ease-out);
  }
  
  .hover-lift:hover {
    transform: translateY(-4px);
  }
  
  /* --- Loading Spinner --- */
  .spinner {
    @apply inline-block w-5 h-5 border-2 rounded-full;
    border-color: rgb(var(--brand-blue) / 0.2);
    border-top-color: rgb(var(--brand-blue));
    animation: spin 0.8s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  /* --- Responsive Typography --- */
  .text-responsive-xs { font-size: clamp(0.75rem, 1.5vw, 0.875rem); }
  .text-responsive-sm { font-size: clamp(0.875rem, 2vw, 1rem); }
  .text-responsive-base { font-size: clamp(1rem, 2.5vw, 1.125rem); }
  .text-responsive-lg { font-size: clamp(1.125rem, 3vw, 1.25rem); }
  .text-responsive-xl { font-size: clamp(1.25rem, 3.5vw, 1.5rem); }
  .text-responsive-2xl { font-size: clamp(1.5rem, 4vw, 2rem); }
  .text-responsive-3xl { font-size: clamp(1.875rem, 5vw, 2.5rem); }
  .text-responsive-4xl { font-size: clamp(2.25rem, 6vw, 3rem); }
  .text-responsive-5xl { font-size: clamp(3rem, 8vw, 4rem); }
  
  /* --- Aspect Ratios --- */
  .aspect-golden { aspect-ratio: 1.618 / 1; }
  .aspect-photo { aspect-ratio: 3 / 2; }
  .aspect-hero { aspect-ratio: 21 / 9; }
}

/* --- Enhanced Form Styles with Better Specificity --- */
.input-field, 
select.input-field, 
input[type="text"].input-field, 
input[type="email"].input-field,
input[type="number"].input-field {
  @apply w-full px-4 py-3 text-base rounded-xl;
  background: rgb(var(--bg-elevated));
  border: 1px solid rgb(var(--border-primary));
  color: rgb(var(--text-primary));
  transition: all var(--duration-fast) var(--ease-out);
}

.input-field::placeholder, 
input.input-field::placeholder {
  color: rgb(var(--text-placeholder));
}

.input-field:hover:not(:focus) {
  border-color: rgb(var(--border-secondary));
  background: rgb(var(--bg-secondary));
}

.input-field:focus {
  outline: none;
  border-color: rgb(var(--brand-blue));
  background: rgb(var(--bg-elevated));
  box-shadow: 0 0 0 3px rgb(var(--brand-blue) / 0.1);
}

/* Form Labels */
.form-label, 
.mobile-label,
label.form-label {
  @apply block text-sm font-medium mb-2;
  color: rgb(var(--text-secondary));
}

/* Card Styles */
.card {
  @apply relative overflow-hidden rounded-2xl p-6;
  background: rgb(var(--bg-elevated));
  border: 1px solid rgb(var(--border-primary));
  box-shadow: var(--shadow-sm);
  transition: all var(--duration-base) var(--ease-out);
}

.card:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
  border-color: rgb(var(--border-secondary));
}

/* Override for cards containing dropdowns - allows dropdown content to be visible outside card */
.card:has(.searchable-dropdown),
.card.dropdown-container {
  overflow: visible !important;
}

/* Ensure searchable dropdowns appear above all other content */
.searchable-dropdown {
  z-index: 9999 !important;
  position: relative;
}

/* Button Enhancements */
button.btn-primary:disabled, 
button.btn-secondary:disabled,
.btn-primary:disabled,
.btn-secondary:disabled {
  background: rgb(var(--bg-tertiary));
  color: rgb(var(--text-disabled));
  border-color: rgb(var(--border-primary));
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

/* Mobile Label */
.mobile-label {
  @apply block text-sm font-medium mb-2;
  color: rgb(var(--text-secondary)) !important;
}

/* Better contrast for spans and divs */
span, div, p {
  color: inherit;
}

/* Ensure proper text hierarchy */
h1, h2, h3, h4, h5, h6 {
  color: rgb(var(--text-primary)) !important;
}

/* Placeholder text for all inputs */
input::placeholder, textarea::placeholder {
  color: rgb(var(--text-placeholder)) !important;
  opacity: 1;
}

/* Dropdown option items */
.cursor-pointer.selected {
  background: rgb(var(--brand-blue)) !important;
  color: white !important;
}

.cursor-pointer:hover {
  background: rgb(var(--bg-secondary)) !important;
}

/* --- Custom Scrollbar --- */
::-webkit-scrollbar {
  width: 12px;
  height: 12px;
}

::-webkit-scrollbar-track {
  background: rgb(var(--bg-secondary));
}

::-webkit-scrollbar-thumb {
  background: rgb(var(--text-tertiary) / 0.3);
  border-radius: 6px;
  border: 3px solid rgb(var(--bg-secondary));
}

::-webkit-scrollbar-thumb:hover {
  background: rgb(var(--text-tertiary) / 0.5);
}

/* --- Print Styles --- */
@media print {
  .no-print { display: none !important; }
  
  body {
    font-size: 12pt;
    line-height: 1.5;
    color: black;
    background: white;
  }
  
  .card-premium {
    break-inside: avoid;
    page-break-inside: avoid;
  }
}

/* --- High Contrast Mode --- */
@media (prefers-contrast: high) {
  :root {
    --border-primary: var(--neutral-400);
    --border-secondary: var(--neutral-500);
  }
  
  .btn-primary {
    border: 2px solid currentColor;
  }
}

/* --- Reduced Motion --- */
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}
```

### types/index.ts
```
// types/index.ts - Cleaned and Organized Type Definitions

// ============================================================================
// CORE BIKE CALCULATOR TYPES
// ============================================================================

export interface WheelSize {
  id: string;
  label: string;
  iso: number;
}

export interface BikeType {
  id: 'road' | 'gravel' | 'mtb';
  name: string;
  description: string;
  wheelSizes: string[];
  tireWidths: number[];
  defaultSetup: BikeSetup;
}

export interface Component {
  id: string;
  model: string;
  variant: string;
  weight: number;
  bikeType: string;
  speeds: string;
}

export interface Crankset extends Component {
  teeth: number[];
}

export interface Cassette extends Component {
  teeth: number[];
}

export interface BikeSetup {
  wheel: string;
  tire: string;
  crankset: Crankset | null;
  cassette: Cassette | null;
}

export interface GearMetrics {
  highSpeed: string;
  lowSpeed: string;
  highRatio: string;
  lowRatio: string;
}

export interface SetupAnalysis {
  metrics: GearMetrics;
  totalWeight: number;
  gearRange: string;
  setup: BikeSetup;
}

export interface ComparisonResults {
  speedChange: number;
  weightChange: number;
  rangeChange: number;
  speedUnit: string;
}

export interface AnalysisResults {
  current: SetupAnalysis;
  proposed: SetupAnalysis;
  comparison: ComparisonResults;
  compatibility?: CompatibilitySummary;
}

// ============================================================================
// COMPATIBILITY SYSTEM TYPES
// ============================================================================

export interface CompatibilitySummary {
  status: 'compatible' | 'warning' | 'error' | 'incomplete';
  title: string;
  message: string;
  criticalIssues: string[];
  minorWarnings: string[];
  actionItems: string[];
}

// ============================================================================
// TOAST NOTIFICATION SYSTEM
// ============================================================================

export type ToastType = 'success' | 'error' | 'warning' | 'info';

export interface ToastAction {
  label: string;
  onClick: () => void;
  variant?: 'primary' | 'secondary';
}

export interface Toast {
  id: number;
  type: ToastType;
  message: string;
  duration: number;
  actions?: ToastAction[];
}

export interface ToastAPI {
  success: (message: string, duration?: number) => void;
  error: (message: string, duration?: number) => void;
  warning: (message: string, duration?: number) => void;
  info: (message: string, duration?: number) => void;
}

// ============================================================================
// DROPDOWN COMPONENT TYPES
// ============================================================================

export interface DropdownOption {
  id: string;
  label: string;
  model?: string;
  variant?: string;
  teeth?: number[];
  speeds?: string;
  weight?: number;
  bikeType?: string;
  subtitle?: string;
  value?: any;
}

export interface GroupedOptions {
  [groupName: string]: DropdownOption[];
}

// ============================================================================
// CALCULATOR STATE MANAGEMENT
// ============================================================================

export interface ValidationResult {
  isComplete: boolean;
  missing: string[];
  completion: number;
}

export interface CalculatorState {
  bikeType: string;
  currentSetup: BikeSetup;
  proposedSetup: BikeSetup;
  results: AnalysisResults | null;
  loading: boolean;
  speedUnit: 'mph' | 'kmh';
  compatibilityResults: CompatibilitySummary | null;
  validation: {
    current: ValidationResult;
    proposed: ValidationResult;
    canAnalyze: boolean;
    totalCompletion: number;
  };
}

// ============================================================================
// BIKE FIT CALCULATOR TYPES
// ============================================================================

export type FlexibilityLevel = 'low' | 'average' | 'high';
export type RidingStyle = 'comfort' | 'endurance' | 'sport' | 'aggressive' | 'racing';
export type ExperienceLevel = 'beginner' | 'intermediate' | 'advanced' | 'professional';
export type MeasurementUnits = 'metric' | 'imperial';

export interface BodyMeasurements {
  inseam: number | null;
  torso: number | null;
  armLength: number | null;
  flexibility: FlexibilityLevel;
  ridingStyle: RidingStyle;
  experience: ExperienceLevel;
  units: MeasurementUnits;
}

// Validation ranges for body measurements (in cm)
export interface MeasurementValidationRanges {
  inseam: { min: number; max: number };
  torso: { min: number; max: number };
  armLength: { min: number; max: number };
}

export interface BikeFitResults {
  saddleHeight: {
    lemond: number;
    holmes: number;
    hamley: number;
    competitive: number;
  };
  reach: number;
  stack: number;
  handlebarDrop: {
    comfort: number;
    sport: number;
    aggressive: number;
  };
}

export interface BikeFitCalculations {
  saddleHeight: {
    lemond: (inseam: number) => number;
    holmes: (inseam: number) => number;
    hamley: (inseam: number) => number;
    competitive: (inseam: number) => number;
  };
  reach: (torso: number, armLength: number, flexibility: FlexibilityLevel, ridingStyle: RidingStyle) => number;
  stack: (torso: number, flexibility: FlexibilityLevel, ridingStyle: RidingStyle, experience: ExperienceLevel) => number;
}

// ============================================================================
// PWA AND SERVICE WORKER TYPES
// ============================================================================

export interface ServiceWorkerMessage {
  type: 'CACHE_UPDATED' | 'OFFLINE_READY' | 'UPDATE_AVAILABLE';
  payload?: any;
}

// ============================================================================
// DATA PERSISTENCE TYPES (FOR FUTURE USE)
// ============================================================================

/**
 * Configuration data that can be saved/loaded by users
 * Note: Currently used in localStorage, may be moved to database in future
 */
export interface SavedConfiguration {
  id: string | number;
  name: string;
  bikeType: string;
  currentSetup: BikeSetup;
  proposedSetup: BikeSetup;
  results: AnalysisResults;
  compatibilityResults?: CompatibilitySummary;
  created_at: string;
}

/**
 * Riley AI message format
 * Note: Used in Ask Riley chat interface
 */
export interface RileyMessage {
  type: 'user' | 'riley';
  content: string;
  timestamp: string;
}

// ============================================================================
// API RESPONSE TYPES (FOR FUTURE API ENDPOINTS)
// ============================================================================

/**
 * Standard API response wrapper
 * Note: Prepared for future backend API integration
 */
export interface APIResponse<T = any> {
  success: boolean;
  data?: T;
  error?: string;
  timestamp: string;
}

/**
 * Riley AI API response format
 * Note: Used by Riley AI chat endpoint
 */
export interface RileyAPIResponse extends APIResponse {
  response?: string;
}

// ============================================================================
// MEASUREMENT VALIDATION TYPES
// ============================================================================

export interface MeasurementValidationResult {
  isValid: boolean;
  valueInMm: number | null;
  error?: string;
}
```

### data/early-access.json
```
[
  {
    "email": "meastt09@gmail.com",
    "timestamp": "2025-06-07T01:45:11.292Z",
    "source": "landing_page"
  },
  {
    "email": "meastt09@gmail.com",
    "timestamp": "2025-06-07T01:49:24.473Z",
    "source": "landing_page"
  },
  {
    "email": "mike.east@electricbikereview.com",
    "timestamp": "2025-06-07T01:49:48.253Z",
    "source": "landing_page"
  }
]```

### public/manifest.json
```
{
  "name": "CrankSmith - Bike Gear Calculator",
  "short_name": "CrankSmith",
  "description": "The ultimate bike gear calculator and compatibility checker for cyclists",
  "start_url": "/",
  "display": "standalone",
  "orientation": "portrait",
  "theme_color": "#3B82F6",
  "background_color": "#010309",
  "categories": ["sports", "utilities", "lifestyle"],
  "lang": "en-US",
  "scope": "/",
  "icons": [
    {
      "src": "/icon-192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "maskable any"
    },
    {
      "src": "/icon-512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "maskable any"
    },
    {
      "src": "/apple-touch-icon.png",
      "sizes": "180x180",
      "type": "image/png",
      "purpose": "any"
    },
    {
      "src": "/favicon-32x32.png",
      "sizes": "32x32",
      "type": "image/png",
      "purpose": "any"
    },
    {
      "src": "/favicon-16x16.png",
      "sizes": "16x16",
      "type": "image/png",
      "purpose": "any"
    }
  ],
  "screenshots": [
    {
      "src": "/screenshot-mobile-1.png",
      "sizes": "390x844",
      "type": "image/png",
      "form_factor": "narrow",
      "label": "Bike type selection screen"
    },
    {
      "src": "/screenshot-mobile-2.png",
      "sizes": "390x844",
      "type": "image/png",
      "form_factor": "narrow",
      "label": "Component selection interface"
    },
    {
      "src": "/screenshot-mobile-3.png",
      "sizes": "390x844",
      "type": "image/png",
      "form_factor": "narrow",
      "label": "Performance analysis results"
    }
  ],
  "shortcuts": [
    {
      "name": "New Analysis",
      "short_name": "Calculate",
      "description": "Start a new gear analysis",
      "url": "/mobile?action=new",
      "icons": [
        {
          "src": "/icon-192.png",
          "sizes": "192x192",
          "type": "image/png"
        }
      ]
    },
    {
      "name": "My Garage",
      "short_name": "Garage",
      "description": "View saved configurations",
      "url": "/mobile?tab=garage",
      "icons": [
        {
          "src": "/icon-192.png",
          "sizes": "192x192",
          "type": "image/png"
        }
      ]
    }
  ],
  "share_target": {
    "action": "/mobile",
    "method": "GET",
    "params": {
      "title": "title",
      "text": "text",
      "url": "url"
    }
  },
  "prefer_related_applications": false,
  "edge_side_panel": {
    "preferred_width": 400
  }
}```

### public/sw.js
```
// public/sw.js - Service Worker for PWA offline support
const CACHE_NAME = 'cranksmith-v1.0.0';
const STATIC_CACHE_NAME = 'cranksmith-static-v1.0.0';
const DYNAMIC_CACHE_NAME = 'cranksmith-dynamic-v1.0.0';

// Files to cache immediately
const STATIC_ASSETS = [
  '/mobile',
  '/manifest.json',
  '/icon-192.png',
  '/icon-512.png',
  '/apple-touch-icon.png',
  '/favicon-32x32.png',
  '/favicon-16x16.png',
  // Add your CSS and JS files here
  '/_next/static/css/',
  '/_next/static/chunks/',
  // Component data that should work offline
  '/api/components-data.json' // If you create this endpoint
];

// API endpoints that can be cached
const CACHEABLE_APIS = [
  '/api/components-data',
  '/api/calculations'
];

// Install event - cache static assets
self.addEventListener('install', (event) => {
  console.log('Service Worker: Installing...');
  
  event.waitUntil(
    caches.open(STATIC_CACHE_NAME)
      .then((cache) => {
        console.log('Service Worker: Caching static assets');
        // Only cache files that exist - filter out non-existent files
        const existingAssets = STATIC_ASSETS.filter(asset => {
          // Skip dynamic paths that might not exist
          return !asset.includes('_next/static/') && !asset.includes('api/');
        });
        return cache.addAll(existingAssets);
      })
      .catch((error) => {
        console.error('Service Worker: Failed to cache static assets', error);
        // Continue installation even if caching fails
        return Promise.resolve();
      })
  );
  
  // Force the waiting service worker to become the active service worker
  self.skipWaiting();
});

// Message event - handle skip waiting requests
self.addEventListener('message', (event) => {
  if (event.data && event.data.type === 'SKIP_WAITING') {
    self.skipWaiting();
  }
});

// Activate event - clean up old caches
self.addEventListener('activate', (event) => {
  console.log('Service Worker: Activating...');
  
  event.waitUntil(
    caches.keys()
      .then((cacheNames) => {
        return Promise.all(
          cacheNames.map((cacheName) => {
            // Delete old caches
            if (cacheName !== STATIC_CACHE_NAME && 
                cacheName !== DYNAMIC_CACHE_NAME && 
                cacheName !== CACHE_NAME) {
              console.log('Service Worker: Deleting old cache', cacheName);
              return caches.delete(cacheName);
            }
          })
        );
      })
  );
  
  // Take control of all pages immediately
  self.clients.claim();
});

// Fetch event - serve from cache when offline
self.addEventListener('fetch', (event) => {
  const { request } = event;
  const url = new URL(request.url);
  
  // Skip non-GET requests
  if (request.method !== 'GET') {
    return;
  }
  
  // Skip external requests (CDNs, APIs from other domains)
  if (!url.origin.includes(self.location.origin)) {
    return;
  }

  event.respondWith(
    // Strategy: Cache First for static assets, Network First for dynamic content
    handleRequest(request)
  );
});

async function handleRequest(request) {
  const url = new URL(request.url);
  
  // Strategy 1: Cache First (for static assets and app shell)
  if (isStaticAsset(url.pathname)) {
    return cacheFirst(request);
  }
  
  // Strategy 2: Network First (for API calls and dynamic content)
  if (isApiCall(url.pathname) || isDynamicContent(url.pathname)) {
    return networkFirst(request);
  }
  
  // Strategy 3: Stale While Revalidate (for components data)
  if (isComponentData(url.pathname)) {
    return staleWhileRevalidate(request);
  }
  
  // Default: Network First
  return networkFirst(request);
}

// Cache First Strategy - for static assets
async function cacheFirst(request) {
  try {
    const cache = await caches.open(STATIC_CACHE_NAME);
    const cachedResponse = await cache.match(request);
    
    if (cachedResponse) {
      return cachedResponse;
    }
    
    const networkResponse = await fetch(request);
    
    if (networkResponse.ok) {
      cache.put(request, networkResponse.clone());
    }
    
    return networkResponse;
  } catch (error) {
    console.error('Cache First failed:', error);
    return new Response('Offline - Asset not available', { 
      status: 503,
      statusText: 'Service Unavailable'
    });
  }
}

// Network First Strategy - for dynamic content
async function networkFirst(request) {
  try {
    const networkResponse = await fetch(request);
    
    if (networkResponse.ok) {
      const cache = await caches.open(DYNAMIC_CACHE_NAME);
      cache.put(request, networkResponse.clone());
    }
    
    return networkResponse;
  } catch (error) {
    console.log('Network failed, trying cache:', error);
    
    const cache = await caches.open(DYNAMIC_CACHE_NAME);
    const cachedResponse = await cache.match(request);
    
    if (cachedResponse) {
      return cachedResponse;
    }
    
    // Return offline page for navigation requests
    if (request.mode === 'navigate') {
      return caches.match('/mobile') || new Response(
        getOfflineHTML(),
        { 
          headers: { 'Content-Type': 'text/html' },
          status: 200 
        }
      );
    }
    
    return new Response('Offline - Content not available', { 
      status: 503,
      statusText: 'Service Unavailable'
    });
  }
}

// Stale While Revalidate - for component data
async function staleWhileRevalidate(request) {
  const cache = await caches.open(DYNAMIC_CACHE_NAME);
  const cachedResponse = await cache.match(request);
  
  // Fetch in background to update cache
  const fetchPromise = fetch(request).then((networkResponse) => {
    if (networkResponse.ok) {
      cache.put(request, networkResponse.clone());
    }
    return networkResponse;
  }).catch(() => {
    // Network failed, but we might have cache
    return cachedResponse;
  });
  
  // Return cache immediately if available, otherwise wait for network
  return cachedResponse || fetchPromise;
}

// Helper functions to categorize requests
function isStaticAsset(pathname) {
  return pathname.includes('/_next/static/') ||
         pathname.includes('/icon-') ||
         pathname.includes('/manifest.json') ||
         pathname.endsWith('.png') ||
         pathname.endsWith('.jpg') ||
         pathname.endsWith('.css') ||
         pathname.endsWith('.js');
}

function isApiCall(pathname) {
  return pathname.startsWith('/api/');
}

function isDynamicContent(pathname) {
  return pathname.includes('/mobile') && !isStaticAsset(pathname);
}

function isComponentData(pathname) {
  return pathname.includes('components') || pathname.includes('calculations');
}

// Offline HTML fallback
function getOfflineHTML() {
  return `
    <!DOCTYPE html>
    <html>
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>CrankSmith - Offline</title>
        <style>
          body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #010309;
            color: white;
            margin: 0;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
          }
          .offline-container {
            max-width: 400px;
            padding: 40px 20px;
          }
          .offline-icon {
            font-size: 64px;
            margin-bottom: 20px;
          }
          h1 {
            font-size: 24px;
            margin-bottom: 16px;
            color: #3B82F6;
          }
          p {
            font-size: 16px;
            line-height: 1.5;
            color: #9CA3AF;
            margin-bottom: 24px;
          }
          .retry-btn {
            background: #3B82F6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
          }
        </style>
      </head>
      <body>
        <div class="offline-container">
          <div class="offline-icon">üì¥</div>
          <h1>You're Offline</h1>
          <p>
            No internet connection detected. Some features may not be available, 
            but you can still use cached calculations and view saved configurations.
          </p>
          <button class="retry-btn" onclick="window.location.reload()">
            Try Again
          </button>
        </div>
      </body>
    </html>
  `;
}

// Background sync for saving data when back online
self.addEventListener('sync', (event) => {
  if (event.tag === 'background-sync-configs') {
    event.waitUntil(syncPendingConfigs());
  }
});

async function syncPendingConfigs() {
  // Handle any pending configuration saves when back online
  console.log('Service Worker: Syncing pending configurations...');
  
  // This would integrate with your data saving logic
  // For now, just log that sync happened
  try {
    // Check if there are pending saves in IndexedDB or localStorage
    // Send them to the server when online
    console.log('Service Worker: Sync completed');
  } catch (error) {
    console.error('Service Worker: Sync failed', error);
  }
}

// Push notifications (for future features)
self.addEventListener('push', (event) => {
  if (event.data) {
    const data = event.data.json();
    
    const options = {
      body: data.body,
      icon: '/icon-192.png',
      badge: '/icon-192.png',
      vibrate: [100, 50, 100],
      data: {
        dateOfArrival: Date.now(),
        primaryKey: data.primaryKey
      },
      actions: [
        {
          action: 'explore',
          title: 'Open CrankSmith',
          icon: '/icon-192.png'
        },
        {
          action: 'close',
          title: 'Close',
          icon: '/icon-192.png'
        }
      ]
    };
    
    event.waitUntil(
      self.registration.showNotification(data.title, options)
    );
  }
});

// Handle notification clicks
self.addEventListener('notificationclick', (event) => {
  event.notification.close();
  
  if (event.action === 'explore') {
    event.waitUntil(
      clients.openWindow('/mobile')
    );
  }
});
```

### public/sw-enhanced.js
```
// public/sw-enhanced.js - Advanced Service Worker for PWA with offline capabilities
const CACHE_VERSION = '2.1.1'; // Incremented for cache cleanup fix
const STATIC_CACHE_NAME = `cranksmith-static-v${CACHE_VERSION}`;
const DYNAMIC_CACHE_NAME = `cranksmith-dynamic-v${CACHE_VERSION}`;
const COMPONENTS_CACHE_NAME = `cranksmith-components-v${CACHE_VERSION}`;
const CALCULATIONS_CACHE_NAME = `cranksmith-calculations-v${CACHE_VERSION}`;
const OFFLINE_REQUESTS_CACHE = `cranksmith-offline-requests-v${CACHE_VERSION}`;

// Critical files for offline functionality
const STATIC_ASSETS = [
  '/',
  '/mobile',
  '/calculator',
  '/manifest.json',
  '/icon-192.png',
  '/icon-512.png',
  '/offline.html' // Essential offline fallback
];

// Component data endpoints to cache
const COMPONENT_ENDPOINTS = [
  '/api/components-data',
  '/lib/components.js'
];

// POST endpoints that support offline queuing
const OFFLINE_POST_ENDPOINTS = [
  '/api/save-config',
  '/api/user-preferences',
  '/api/analytics',
  '/api/feedback'
];

// Retry configuration for failed sync operations
const RETRY_CONFIG = {
  maxRetries: 5,
  baseDelay: 1000, // 1 second
  maxDelay: 32000, // 32 seconds
  backoffMultiplier: 2
};

// Cache validation configuration
const CACHE_VALIDATION = {
  maxCacheAge: 24 * 60 * 60 * 1000, // 24 hours
  requiredAssets: ['/offline.html', '/', '/calculator', '/mobile'],
  criticalEndpoints: ['/lib/components.js']
};

// Install event - cache critical assets with validation
self.addEventListener('install', (event) => {
  console.log('Enhanced SW: Installing...');
  
  event.waitUntil(
    installAndValidateCaches()
      .then(() => {
        console.log('Enhanced SW: Installation completed successfully');
        self.skipWaiting();
      })
      .catch(error => {
        console.error('Enhanced SW: Installation failed', error);
        // Don't skip waiting if installation fails
        throw error;
      })
  );
});

// Enhanced installation with cache validation
async function installAndValidateCaches() {
  try {
    // Install caches in parallel but validate each one
    const cachePromises = await Promise.allSettled([
      installStaticCache(),
      installComponentsCache(),
      installOfflineRequestsCache()
    ]);

    // Check if any critical cache installation failed
    const failed = cachePromises.filter(result => result.status === 'rejected');
    if (failed.length > 0) {
      console.warn('Enhanced SW: Some caches failed to install:', failed);
      // Continue installation but log warnings
    }

    // Validate that critical assets are cached
    const validationResult = await validateNewCaches();
    if (!validationResult.isValid) {
      throw new Error(`Cache validation failed: ${validationResult.errors.join(', ')}`);
    }

    console.log('Enhanced SW: All caches installed and validated successfully');
    return true;

  } catch (error) {
    console.error('Enhanced SW: Cache installation and validation failed:', error);
    throw error;
  }
}

// Install static cache with error handling
async function installStaticCache() {
  try {
    const cache = await caches.open(STATIC_CACHE_NAME);
    console.log('Enhanced SW: Caching static assets');
    
    // Cache assets individually to identify which ones fail
    const cacheResults = await Promise.allSettled(
      STATIC_ASSETS.map(async (asset) => {
        try {
          await cache.add(asset);
          console.log(`Enhanced SW: Cached ${asset}`);
        } catch (error) {
          console.warn(`Enhanced SW: Failed to cache ${asset}:`, error);
          throw error;
        }
      })
    );

    // Check for critical failures
    const failed = cacheResults.filter(result => result.status === 'rejected');
    if (failed.length > 0) {
      console.warn(`Enhanced SW: ${failed.length}/${STATIC_ASSETS.length} static assets failed to cache`);
      
      // Critical assets that must be cached
      const criticalAssets = ['/offline.html'];
      for (const asset of criticalAssets) {
        const cached = await cache.match(asset);
        if (!cached) {
          throw new Error(`Critical asset ${asset} not cached`);
        }
      }
    }

    return cache;
  } catch (error) {
    console.error('Enhanced SW: Static cache installation failed:', error);
    throw error;
  }
}

// Install components cache
async function installComponentsCache() {
  try {
    const cache = await caches.open(COMPONENTS_CACHE_NAME);
    console.log('Enhanced SW: Pre-caching component data');
    
    // Try to cache component data
    try {
      await cache.add('/lib/components.js');
      console.log('Enhanced SW: Component data cached successfully');
    } catch (error) {
      console.warn('Enhanced SW: Failed to cache component data:', error);
      // Non-critical, continue installation
    }

    return cache;
  } catch (error) {
    console.error('Enhanced SW: Components cache creation failed:', error);
    throw error;
  }
}

// Install offline requests cache
async function installOfflineRequestsCache() {
  try {
    const cache = await caches.open(OFFLINE_REQUESTS_CACHE);
    console.log('Enhanced SW: Initialized offline requests cache');
    return cache;
  } catch (error) {
    console.error('Enhanced SW: Offline requests cache creation failed:', error);
    throw error;
  }
}

// Validate that new caches contain required assets
async function validateNewCaches() {
  const errors = [];
  
  try {
    // Check static cache for critical assets
    const staticCache = await caches.open(STATIC_CACHE_NAME);
    for (const asset of CACHE_VALIDATION.requiredAssets) {
      const cached = await staticCache.match(asset);
      if (!cached) {
        errors.push(`Required asset ${asset} not found in static cache`);
      }
    }

    // Check components cache for critical endpoints
    const componentsCache = await caches.open(COMPONENTS_CACHE_NAME);
    for (const endpoint of CACHE_VALIDATION.criticalEndpoints) {
      const cached = await componentsCache.match(endpoint);
      if (!cached) {
        console.warn(`Critical endpoint ${endpoint} not found in components cache`);
        // Warning only, not fatal
      }
    }

    // Verify cache accessibility
    const cacheNames = await caches.keys();
    const expectedCaches = [
      STATIC_CACHE_NAME,
      COMPONENTS_CACHE_NAME,
      OFFLINE_REQUESTS_CACHE
    ];

    for (const expectedCache of expectedCaches) {
      if (!cacheNames.includes(expectedCache)) {
        errors.push(`Expected cache ${expectedCache} not found`);
      }
    }

    return {
      isValid: errors.length === 0,
      errors,
      warnings: errors.length
    };

  } catch (error) {
    errors.push(`Cache validation error: ${error.message}`);
    return {
      isValid: false,
      errors,
      warnings: 0
    };
  }
}

// Enhanced activate event with safe cache cleanup
self.addEventListener('activate', (event) => {
  console.log('Enhanced SW: Activating...');
  
  event.waitUntil(
    safeActivateAndCleanup()
      .then(() => {
        console.log('Enhanced SW: Activation completed successfully');
      })
      .catch(error => {
        console.error('Enhanced SW: Activation failed:', error);
        // Continue anyway to avoid breaking the service worker
      })
  );
});

// Safe activation with comprehensive cache validation and cleanup
async function safeActivateAndCleanup() {
  try {
    // Step 1: Validate current caches before any cleanup
    console.log('Enhanced SW: Validating current caches...');
    const validation = await validateCurrentCaches();
    
    if (!validation.hasMinimalOfflineSupport) {
      console.warn('Enhanced SW: Minimal offline support not available, preserving old caches');
      await self.clients.claim();
      return;
    }

    // Step 2: Get all cache names and identify old caches
    const allCacheNames = await caches.keys();
    const oldCaches = allCacheNames.filter(cacheName => 
      cacheName.includes('cranksmith') && 
      !cacheName.includes(CACHE_VERSION)
    );

    // Step 3: Verify new caches are fully functional before cleanup
    const newCacheValidation = await validateNewCaches();
    if (!newCacheValidation.isValid) {
      console.warn('Enhanced SW: New caches not fully valid, attempting repair...');
      
      try {
        await repairCaches();
        const retryValidation = await validateNewCaches();
        if (!retryValidation.isValid) {
          throw new Error('Cache repair failed: ' + retryValidation.errors.join(', '));
        }
      } catch (repairError) {
        console.error('Enhanced SW: Cache repair failed, preserving old caches:', repairError);
        await self.clients.claim();
        return;
      }
    }

    // Step 4: Perform safe cache cleanup only after validation
    if (oldCaches.length > 0) {
      console.log(`Enhanced SW: Safely cleaning up ${oldCaches.length} old caches`);
      
      const cleanupResults = await Promise.allSettled(
        oldCaches.map(async (cacheName) => {
          try {
            await caches.delete(cacheName);
            console.log(`Enhanced SW: Deleted old cache: ${cacheName}`);
          } catch (error) {
            console.warn(`Enhanced SW: Failed to delete cache ${cacheName}:`, error);
            throw error;
          }
        })
      );

      const failedCleanups = cleanupResults.filter(result => result.status === 'rejected');
      if (failedCleanups.length > 0) {
        console.warn(`Enhanced SW: ${failedCleanups.length} cache cleanups failed`);
      }
    }

    // Step 5: Final validation and client notification
    await self.clients.claim();
    
    const finalValidation = await validateCurrentCaches();
    await notifyClients({
      type: 'CACHE_UPDATE_COMPLETE',
      payload: {
        version: CACHE_VERSION,
        hasOfflineSupport: finalValidation.hasMinimalOfflineSupport,
        cleanedCaches: oldCaches.length,
        validation: finalValidation
      }
    });

    console.log('Enhanced SW: Cache cleanup and activation completed successfully');

  } catch (error) {
    console.error('Enhanced SW: Safe activation failed:', error);
    
    // Attempt emergency fallback
    await emergencyFallbackActivation();
    throw error;
  }
}

// Validate current caches for minimal offline functionality
async function validateCurrentCaches() {
  try {
    const validation = {
      hasMinimalOfflineSupport: false,
      hasOfflinePage: false,
      hasStaticAssets: false,
      hasComponentData: false,
      cacheCount: 0,
      errors: []
    };

    const cacheNames = await caches.keys();
    validation.cacheCount = cacheNames.length;

    // Check for offline page (critical)
    const staticCache = await caches.open(STATIC_CACHE_NAME);
    const offlinePage = await staticCache.match('/offline.html');
    validation.hasOfflinePage = !!offlinePage;

    // Check for basic navigation pages
    const navigationPages = await Promise.all([
      staticCache.match('/'),
      staticCache.match('/calculator'),
      staticCache.match('/mobile')
    ]);
    validation.hasStaticAssets = navigationPages.some(page => !!page);

    // Check for component data
    const componentsCache = await caches.open(COMPONENTS_CACHE_NAME);
    const componentData = await componentsCache.match('/lib/components.js');
    validation.hasComponentData = !!componentData;

    // Minimal offline support = offline page + at least one navigation page
    validation.hasMinimalOfflineSupport = validation.hasOfflinePage && validation.hasStaticAssets;

    if (!validation.hasMinimalOfflineSupport) {
      validation.errors.push('Missing minimal offline support (offline page and/or navigation pages)');
    }

    return validation;

  } catch (error) {
    console.error('Enhanced SW: Cache validation error:', error);
    return {
      hasMinimalOfflineSupport: false,
      hasOfflinePage: false,
      hasStaticAssets: false,
      hasComponentData: false,
      cacheCount: 0,
      errors: [`Validation error: ${error.message}`]
    };
  }
}

// Repair caches by re-caching critical assets
async function repairCaches() {
  console.log('Enhanced SW: Attempting cache repair...');
  
  try {
    // Repair static cache with critical assets
    const staticCache = await caches.open(STATIC_CACHE_NAME);
    const criticalAssets = ['/offline.html', '/', '/calculator'];
    
    for (const asset of criticalAssets) {
      try {
        const cached = await staticCache.match(asset);
        if (!cached) {
          console.log(`Enhanced SW: Re-caching critical asset: ${asset}`);
          await staticCache.add(asset);
        }
      } catch (error) {
        console.warn(`Enhanced SW: Failed to repair cache for ${asset}:`, error);
        // Continue with other assets
      }
    }

    // Attempt to repair component cache
    const componentsCache = await caches.open(COMPONENTS_CACHE_NAME);
    try {
      const componentData = await componentsCache.match('/lib/components.js');
      if (!componentData) {
        console.log('Enhanced SW: Re-caching component data');
        await componentsCache.add('/lib/components.js');
      }
    } catch (error) {
      console.warn('Enhanced SW: Failed to repair component cache:', error);
      // Non-critical, continue
    }

    console.log('Enhanced SW: Cache repair completed');

  } catch (error) {
    console.error('Enhanced SW: Cache repair failed:', error);
    throw error;
  }
}

// Emergency fallback activation when normal activation fails
async function emergencyFallbackActivation() {
  console.warn('Enhanced SW: Performing emergency fallback activation');
  
  try {
    // Claim clients immediately
    await self.clients.claim();
    
    // Try to ensure offline.html is available
    const staticCache = await caches.open(STATIC_CACHE_NAME);
    try {
      const offlinePage = await staticCache.match('/offline.html');
      if (!offlinePage) {
        await staticCache.add('/offline.html');
      }
    } catch (error) {
      console.error('Enhanced SW: Emergency offline page caching failed:', error);
    }

    // Notify clients of emergency state
    await notifyClients({
      type: 'EMERGENCY_ACTIVATION',
      payload: {
        message: 'Service worker activated in emergency mode',
        limitedOfflineSupport: true
      }
    });

  } catch (error) {
    console.error('Enhanced SW: Emergency fallback activation failed:', error);
  }
}

// Enhanced fetch event - handles both GET and POST requests with better fallbacks
self.addEventListener('fetch', (event) => {
  const { request } = event;
  const url = new URL(request.url);

  // Handle GET requests
  if (request.method === 'GET') {
    if (url.pathname.includes('/api/riley')) {
      // Riley API - cache successful responses
      event.respondWith(rileyAPIStrategy(request));
    } else if (url.pathname.includes('/api/') || url.pathname.includes('/lib/components')) {
      // API requests - cache with network first strategy
      event.respondWith(networkFirstStrategy(request, COMPONENTS_CACHE_NAME));
    } else if (STATIC_ASSETS.some(asset => url.pathname.includes(asset))) {
      // Static assets - cache first strategy
      event.respondWith(cacheFirstStrategy(request, STATIC_CACHE_NAME));
    } else if (url.pathname.includes('/_next/')) {
      // Next.js assets - cache first with long TTL
      event.respondWith(cacheFirstStrategy(request, DYNAMIC_CACHE_NAME));
    } else {
      // Other requests - network first with robust fallback
      event.respondWith(networkFirstWithRobustFallback(request));
    }
  } 
  // Handle POST requests with offline support
  else if (request.method === 'POST') {
    event.respondWith(handlePostRequest(request));
  }
  // Handle other HTTP methods
  else {
    event.respondWith(networkFirstWithRobustFallback(request));
  }
});

// Enhanced POST request handler with offline queuing
async function handlePostRequest(request) {
  const url = new URL(request.url);
  
  try {
    // Attempt network request first
    const response = await fetch(request.clone());
    
    if (response.ok) {
      return response;
    } else {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
  } catch (error) {
    console.log('POST request failed, checking for offline support:', url.pathname);
    
    // Check if this endpoint supports offline queuing
    if (OFFLINE_POST_ENDPOINTS.some(endpoint => url.pathname.includes(endpoint))) {
      return await queueOfflineRequest(request);
    } else {
      // Return appropriate offline response for unsupported endpoints
      return new Response(JSON.stringify({
        success: false,
        error: 'This action requires an internet connection',
        offline: true,
        canRetry: false
      }), {
        status: 200,
        headers: { 'Content-Type': 'application/json' }
      });
    }
  }
}

// Queue offline POST request for later sync
async function queueOfflineRequest(request) {
  try {
    const requestData = {
      id: generateRequestId(),
      url: request.url,
      method: request.method,
      headers: Object.fromEntries(request.headers.entries()),
      body: await request.text(),
      timestamp: Date.now(),
      retryCount: 0
    };
    
    // Store in offline cache
    const cache = await caches.open(OFFLINE_REQUESTS_CACHE);
    const queueKey = `offline-request-${requestData.id}`;
    
    await cache.put(queueKey, new Response(JSON.stringify(requestData)));
    
    // Register for background sync
    try {
      await self.registration.sync.register('sync-offline-requests');
    } catch (syncError) {
      console.warn('Background sync not supported, will retry on next service worker event');
    }
    
    console.log('Enhanced SW: POST request queued for sync', request.url);
    
    return new Response(JSON.stringify({
      success: true,
      message: 'Request saved for when you\'re back online',
      offline: true,
      requestId: requestData.id
    }), {
      status: 200,
      headers: { 'Content-Type': 'application/json' }
    });
    
  } catch (error) {
    console.error('Failed to queue offline request:', error);
    return new Response(JSON.stringify({
      success: false,
      error: 'Failed to save request for offline sync',
      offline: true
    }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' }
    });
  }
}

// Generate unique request ID
function generateRequestId() {
  return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
}

// Cache-first strategy for static assets with fallback
async function cacheFirstStrategy(request, cacheName) {
  try {
    const cache = await caches.open(cacheName);
    const cached = await cache.match(request);
    
    if (cached) {
      // Return cached version and update in background
      fetchAndCache(request, cacheName).catch(error => {
        console.warn('Background cache update failed:', error);
      });
      return cached;
    }
    
    return await fetchAndCache(request, cacheName);
  } catch (error) {
    console.error('Cache-first strategy failed:', error);
    return await createOfflineResponse(request);
  }
}

// Network-first strategy for dynamic content with better fallback
async function networkFirstStrategy(request, cacheName) {
  try {
    const response = await fetch(request);
    
    if (response.ok) {
      const cache = await caches.open(cacheName);
      cache.put(request, response.clone()).catch(error => {
        console.warn('Failed to cache response:', error);
      });
    }
    
    return response;
  } catch (error) {
    console.log('Network failed, checking cache:', request.url);
    const cache = await caches.open(cacheName);
    const cached = await cache.match(request);
    
    if (cached) {
      return cached;
    }
    
    // Return appropriate offline response for failed API calls
    return new Response(JSON.stringify({
      success: false,
      error: 'This feature requires an internet connection',
      offline: true,
      cached: false
    }), {
      status: 200,
      headers: { 'Content-Type': 'application/json' }
    });
  }
}

// Enhanced network-first with robust offline fallback
async function networkFirstWithRobustFallback(request) {
  try {
    return await fetch(request);
  } catch (error) {
    console.log('Network failed for:', request.url);
    return await createOfflineResponse(request);
  }
}

// Create appropriate offline response based on request type
async function createOfflineResponse(request) {
  // For navigation requests, return offline page
  if (request.mode === 'navigate') {
    try {
      const cache = await caches.open(STATIC_CACHE_NAME);
      const offlinePage = await cache.match('/offline.html');
      
      if (offlinePage) {
        return offlinePage;
      } else {
        // Fallback: create basic offline page
        return new Response(`
          <!DOCTYPE html>
          <html><head><title>Offline - CrankSmith</title></head>
          <body>
            <h1>You're offline</h1>
            <p>Please check your internet connection and try again.</p>
            <button onclick="window.location.reload()">Retry</button>
          </body></html>
        `, {
          status: 200,
          headers: { 'Content-Type': 'text/html' }
        });
      }
    } catch (cacheError) {
      console.error('Failed to access offline cache:', cacheError);
      return new Response('Offline - Service Unavailable', { status: 503 });
    }
  }
  
  // For other requests, return JSON error
  return new Response(JSON.stringify({
    success: false,
    error: 'Network unavailable',
    offline: true
  }), {
    status: 200,
    headers: { 'Content-Type': 'application/json' }
  });
}

// Fetch and cache helper with error handling
async function fetchAndCache(request, cacheName) {
  try {
    const response = await fetch(request);
    
    if (response.ok) {
      const cache = await caches.open(cacheName);
      await cache.put(request, response.clone());
    }
    
    return response;
  } catch (error) {
    console.error('Fetch and cache failed:', error);
    throw error;
  }
}

// Riley API specific strategy with better caching
async function rileyAPIStrategy(request) {
  try {
    const response = await fetch(request);
    
    if (response.ok) {
      // Cache successful Riley responses for offline fallback
      const cache = await caches.open(COMPONENTS_CACHE_NAME);
      cache.put(request, response.clone()).catch(error => {
        console.warn('Failed to cache Riley response:', error);
      });
    }
    
    return response;
  } catch (error) {
    // Return helpful offline message for Riley
    return new Response(JSON.stringify({
      success: false,
      message: "Riley is currently offline. Please check your internet connection and try again.",
      offline: true,
      canRetry: true
    }), {
      status: 200,
      headers: { 'Content-Type': 'application/json' }
    });
  }
}

// Enhanced background sync with exponential backoff retry
self.addEventListener('sync', (event) => {
  console.log('Enhanced SW: Background sync triggered', event.tag);
  
  if (event.tag === 'sync-offline-requests') {
    event.waitUntil(syncOfflineRequests());
  } else if (event.tag === 'sync-saved-configs') {
    event.waitUntil(syncSavedConfigurations());
  }
});

// Robust sync with exponential backoff retry logic
async function syncOfflineRequests() {
  try {
    const cache = await caches.open(OFFLINE_REQUESTS_CACHE);
    const cacheKeys = await cache.keys();
    
    // Find all offline requests
    const requestKeys = cacheKeys.filter(key => 
      key.url.includes('offline-request-')
    );
    
    if (requestKeys.length === 0) {
      console.log('Enhanced SW: No offline requests to sync');
      return;
    }
    
    console.log(`Enhanced SW: Syncing ${requestKeys.length} offline requests`);
    
    const syncResults = await Promise.allSettled(
      requestKeys.map(key => syncSingleRequest(cache, key))
    );
    
    // Count successful and failed syncs
    const successful = syncResults.filter(result => result.status === 'fulfilled').length;
    const failed = syncResults.filter(result => result.status === 'rejected').length;
    
    console.log(`Enhanced SW: Sync complete - ${successful} successful, ${failed} failed`);
    
    // Notify clients of sync results
    await notifyClients({
      type: 'SYNC_COMPLETE',
      payload: {
        total: requestKeys.length,
        successful,
        failed
      }
    });
    
  } catch (error) {
    console.error('Background sync failed:', error);
    
    // Schedule retry with exponential backoff
    try {
      await self.registration.sync.register('sync-offline-requests');
    } catch (retryError) {
      console.warn('Failed to schedule sync retry');
    }
  }
}

// Sync a single request with exponential backoff retry logic
async function syncSingleRequest(cache, requestKey) {
  try {
    const response = await cache.match(requestKey);
    if (!response) {
      throw new Error('Request not found in cache');
    }
    
    const requestData = await response.json();
    
    // Check if we've exceeded max retry attempts
    if (requestData.retryCount >= RETRY_CONFIG.maxRetries) {
      console.warn(`Enhanced SW: Request ${requestData.id} exceeded max retries, removing`);
      await cache.delete(requestKey);
      return { success: false, reason: 'max_retries_exceeded' };
    }
    
    // Calculate delay for exponential backoff
    if (requestData.retryCount > 0) {
      const delay = Math.min(
        RETRY_CONFIG.baseDelay * Math.pow(RETRY_CONFIG.backoffMultiplier, requestData.retryCount - 1),
        RETRY_CONFIG.maxDelay
      );
      await new Promise(resolve => setTimeout(resolve, delay));
    }
    
    // Attempt to replay the request
    const fetchResponse = await fetch(requestData.url, {
      method: requestData.method,
      headers: requestData.headers,
      body: requestData.body
    });
    
    if (fetchResponse.ok) {
      // Success - remove from cache
      await cache.delete(requestKey);
      console.log(`Enhanced SW: Successfully synced request ${requestData.id}`);
      return { success: true, requestId: requestData.id };
    } else {
      // Update retry count and store back
      requestData.retryCount++;
      await cache.put(requestKey, new Response(JSON.stringify(requestData)));
      throw new Error(`HTTP ${fetchResponse.status}: ${fetchResponse.statusText}`);
    }
  } catch (error) {
    const cachedResponse = await cache.match(requestKey);
    if (!cachedResponse) {
      console.warn('Cached request not found:', requestKey.url);
      return;
    }
    
    const requestData = await cachedResponse.json();
    
    // Check if we've exceeded max retries
    if (requestData.retryCount >= RETRY_CONFIG.maxRetries) {
      console.warn(`Max retries exceeded for request ${requestData.id}`);
      await cache.delete(requestKey);
      return;
    }
    
    // Calculate delay for exponential backoff
    const delay = Math.min(
      RETRY_CONFIG.baseDelay * Math.pow(RETRY_CONFIG.backoffMultiplier, requestData.retryCount),
      RETRY_CONFIG.maxDelay
    );
    
    // Apply delay if this is a retry
    if (requestData.retryCount > 0) {
      console.log(`Retrying request ${requestData.id} after ${delay}ms delay`);
      await new Promise(resolve => setTimeout(resolve, delay));
    }
    
    // Attempt to sync the request
    const response = await fetch(requestData.url, {
      method: requestData.method,
      headers: requestData.headers,
      body: requestData.body
    });
    
    if (response.ok) {
      console.log(`Successfully synced request ${requestData.id}`);
      await cache.delete(requestKey);
    } else {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
  } catch (error) {
    console.warn(`Failed to sync request ${requestKey.url}:`, error.message);
    
    // Update retry count and re-queue
    const cachedResponse = await cache.match(requestKey);
    if (cachedResponse) {
      const requestData = await cachedResponse.json();
      requestData.retryCount++;
      requestData.lastRetry = Date.now();
      
      if (requestData.retryCount < RETRY_CONFIG.maxRetries) {
        await cache.put(requestKey, new Response(JSON.stringify(requestData)));
        console.log(`Request ${requestData.id} queued for retry ${requestData.retryCount}/${RETRY_CONFIG.maxRetries}`);
      } else {
        console.warn(`Abandoning request ${requestData.id} after ${RETRY_CONFIG.maxRetries} retries`);
        await cache.delete(requestKey);
      }
    }
    
    throw error;
  }
}

// Legacy sync function for saved configurations (enhanced with retry logic)
async function syncSavedConfigurations() {
  try {
    const cache = await caches.open(CALCULATIONS_CACHE_NAME);
    const pendingConfigs = await cache.match('/pending-sync-configs');
    
    if (pendingConfigs) {
      const configs = await pendingConfigs.json();
      console.log(`Enhanced SW: Syncing ${configs.length} saved configurations`);
      
      let successCount = 0;
      let failCount = 0;
      
      // Attempt to sync each configuration with retry logic
      for (const config of configs) {
        let success = false;
        let retries = 0;
        
        while (!success && retries < RETRY_CONFIG.maxRetries) {
          try {
            if (retries > 0) {
              const delay = Math.min(
                RETRY_CONFIG.baseDelay * Math.pow(RETRY_CONFIG.backoffMultiplier, retries - 1),
                RETRY_CONFIG.maxDelay
              );
              await new Promise(resolve => setTimeout(resolve, delay));
            }
            
            const response = await fetch('/api/save-config', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(config)
            });
            
            if (response.ok) {
              success = true;
              successCount++;
            } else {
              throw new Error(`HTTP ${response.status}`);
            }
          } catch (error) {
            retries++;
            if (retries >= RETRY_CONFIG.maxRetries) {
              console.warn(`Failed to sync config ${config.id} after ${retries} retries`);
              failCount++;
            }
          }
        }
      }
      
      // Clear pending sync cache only if all succeeded
      if (failCount === 0) {
        await cache.delete('/pending-sync-configs');
      } else {
        // Keep failed configs for next sync attempt
        const failedConfigs = configs.filter((_, index) => index >= successCount);
        await cache.put('/pending-sync-configs', new Response(JSON.stringify(failedConfigs)));
      }
      
      // Notify all clients
      await notifyClients({
        type: 'CONFIG_SYNC_COMPLETE',
        payload: { 
          total: configs.length,
          successful: successCount,
          failed: failCount
        }
      });
    }
  } catch (error) {
    console.error('Configuration sync failed:', error);
  }
}

// Helper function to notify all clients
async function notifyClients(message) {
  try {
    const clients = await self.clients.matchAll();
    clients.forEach(client => {
      client.postMessage(message);
    });
  } catch (error) {
    console.error('Failed to notify clients:', error);
  }
}

// Message handling for communication with main thread
self.addEventListener('message', (event) => {
  const { type, payload } = event.data;
  
  switch (type) {
    case 'CACHE_COMPONENT_DATA':
      cacheComponentData(payload);
      break;
    case 'SAVE_OFFLINE_CONFIG':
      saveOfflineConfiguration(payload);
      break;
    case 'REQUEST_CACHE_STATUS':
      sendCacheStatus(event.source);
      break;
    case 'FORCE_SYNC':
      forceSyncOfflineRequests();
      break;
    case 'CLEAR_OFFLINE_QUEUE':
      clearOfflineQueue();
      break;
    case 'VALIDATE_CACHES':
      validateAndReportCaches(event.source);
      break;
    case 'REPAIR_CACHES':
      repairCachesManually(event.source);
      break;
  }
});

// Validate caches and report status
async function validateAndReportCaches(client) {
  try {
    const validation = await validateCurrentCaches();
    const newCacheValidation = await validateNewCaches();
    
    client.postMessage({
      type: 'CACHE_VALIDATION_RESULT',
      payload: {
        current: validation,
        new: newCacheValidation,
        timestamp: Date.now()
      }
    });
  } catch (error) {
    client.postMessage({
      type: 'CACHE_VALIDATION_ERROR',
      payload: {
        error: error.message,
        timestamp: Date.now()
      }
    });
  }
}

// Manual cache repair triggered by client
async function repairCachesManually(client) {
  try {
    await repairCaches();
    const validation = await validateCurrentCaches();
    
    client.postMessage({
      type: 'CACHE_REPAIR_COMPLETE',
      payload: {
        success: true,
        validation,
        timestamp: Date.now()
      }
    });
  } catch (error) {
    client.postMessage({
      type: 'CACHE_REPAIR_ERROR',
      payload: {
        success: false,
        error: error.message,
        timestamp: Date.now()
      }
    });
  }
}

// Force sync for manual retry
async function forceSyncOfflineRequests() {
  console.log('Enhanced SW: Force sync triggered');
  await syncOfflineRequests();
}

// Clear offline request queue
async function clearOfflineQueue() {
  try {
    const cache = await caches.open(OFFLINE_REQUESTS_CACHE);
    const keys = await cache.keys();
    
    await Promise.all(
      keys.map(key => cache.delete(key))
    );
    
    console.log('Enhanced SW: Offline queue cleared');
    
    await notifyClients({
      type: 'OFFLINE_QUEUE_CLEARED',
      payload: { clearedCount: keys.length }
    });
  } catch (error) {
    console.error('Failed to clear offline queue:', error);
  }
}

// Cache component data for offline use
async function cacheComponentData(data) {
  try {
    const cache = await caches.open(COMPONENTS_CACHE_NAME);
    await cache.put('/cached-components', new Response(JSON.stringify(data)));
    console.log('Enhanced SW: Component data cached for offline use');
  } catch (error) {
    console.error('Failed to cache component data:', error);
  }
}

// Save configuration for background sync
async function saveOfflineConfiguration(config) {
  try {
    const cache = await caches.open(CALCULATIONS_CACHE_NAME);
    const existing = await cache.match('/pending-sync-configs');
    
    let configs = [];
    if (existing) {
      configs = await existing.json();
    }
    
    configs.push({
      ...config,
      id: Date.now(),
      timestamp: new Date().toISOString()
    });
    
    await cache.put('/pending-sync-configs', new Response(JSON.stringify(configs)));
    
    // Register for background sync
    try {
      await self.registration.sync.register('sync-saved-configs');
    } catch (syncError) {
      console.warn('Background sync registration failed');
    }
    
    console.log('Enhanced SW: Configuration saved for sync');
  } catch (error) {
    console.error('Failed to save offline configuration:', error);
  }
}

// Enhanced cache status with offline request queue info and validation
async function sendCacheStatus(client) {
  try {
    const cacheNames = await caches.keys();
    const currentValidation = await validateCurrentCaches();
    const newValidation = await validateNewCaches();
    
    const status = {
      hasOfflineData: cacheNames.some(name => name.includes('components')),
      hasPendingSync: false,
      cacheSize: cacheNames.length,
      offlineRequestCount: 0,
      pendingConfigCount: 0,
      version: CACHE_VERSION,
      validation: currentValidation,
      newCacheValidation: newValidation,
      hasMinimalOfflineSupport: currentValidation.hasMinimalOfflineSupport
    };
    
    // Check for pending sync data
    const calcCache = await caches.open(CALCULATIONS_CACHE_NAME);
    const pending = await calcCache.match('/pending-sync-configs');
    if (pending) {
      const configs = await pending.json();
      status.hasPendingSync = configs.length > 0;
      status.pendingConfigCount = configs.length;
    }
    
    // Check for offline requests
    const offlineCache = await caches.open(OFFLINE_REQUESTS_CACHE);
    const offlineKeys = await offlineCache.keys();
    const requestKeys = offlineKeys.filter(key => key.url.includes('offline-request-'));
    status.offlineRequestCount = requestKeys.length;
    
    if (status.offlineRequestCount > 0 || status.pendingConfigCount > 0) {
      status.hasPendingSync = true;
    }
    
    client.postMessage({
      type: 'CACHE_STATUS',
      payload: status
    });
  } catch (error) {
    console.error('Failed to get cache status:', error);
    client.postMessage({
      type: 'CACHE_STATUS_ERROR',
      payload: {
        error: error.message,
        timestamp: Date.now()
      }
    });
  }
}```
